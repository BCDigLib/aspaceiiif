/*
 * jQuery Cookie Plugin v1.1
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2011, Klaus Hartl
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.opensource.org/licenses/GPL-2.0
 */
(function(e,b){var a=/\+/g;function d(f){return f}function c(f){return decodeURIComponent(f.replace(a," "))}e.cookie=function(k,j,o){if(arguments.length>1&&(!/Object/.test(Object.prototype.toString.call(j))||j==null)){o=e.extend({},e.cookie.defaults,o);if(j==null){o.expires=-1}if(typeof o.expires==="number"){var l=o.expires,n=o.expires=new Date();n.setDate(n.getDate()+l)}j=String(j);return(b.cookie=[encodeURIComponent(k),"=",o.raw?j:encodeURIComponent(j),o.expires?"; expires="+o.expires.toUTCString():"",o.path?"; path="+o.path:"",o.domain?"; domain="+o.domain:"",o.secure?"; secure":""].join(""))}o=j||e.cookie.defaults||{};var f=o.raw?d:c;var m=b.cookie.split("; ");for(var h=0,g;(g=m[h]&&m[h].split("="));h++){if(f(g.shift())===k){return f(g.join("="))}}return null};e.cookie.defaults={}})(jQuery,document);
/*
 * jQuery hashchange event - v1.3 - 7/21/2010
 * http://benalman.com/projects/jquery-hashchange-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
(function($,e,b){var c="hashchange",h=document,f,g=$.event.special,i=h.documentMode,d="on"+c in e&&(i===b||i>7);function a(j){j=j||location.href;return"#"+j.replace(/^[^#]*#?(.*)$/,"$1")}$.fn[c]=function(j){return j?this.bind(c,j):this.trigger(c)};$.fn[c].delay=50;g[c]=$.extend(g[c],{setup:function(){if(d){return false}$(f.start)},teardown:function(){if(d){return false}$(f.stop)}});f=(function(){var j={},p,m=a(),k=function(q){return q},l=k,o=k;j.start=function(){p||n()};j.stop=function(){p&&clearTimeout(p);p=b};function n(){var r=a(),q=o(m);if(r!==m){l(m=r,q);$(e).trigger(c)}else{if(q!==m){location.href=location.href.replace(/#.*/,"")+q}}p=setTimeout(n,$.fn[c].delay)}$.browser.msie&&!d&&(function(){var q,r;j.start=function(){if(!q){r=$.fn[c].src;r=r&&r+a();q=$('<iframe tabindex="-1" title="empty"/>').hide().one("load",function(){r||l(a());n()}).attr("src",r||"javascript:0").insertAfter("body")[0].contentWindow;h.onpropertychange=function(){try{if(event.propertyName==="title"){q.document.title=h.title}}catch(s){}}}};j.stop=k;o=function(){return a(q.location.href)};l=function(v,s){var u=q.document,t=$.fn[c].domain;if(v!==s){u.title=h.title;u.open();t&&u.write('<script>document.domain="'+t+'"<\/script>');u.close();q.location.hash=v}}})();return j})()})(jQuery,this);(function(a){if(typeof define==="function"&&define.amd){define(["jquery"],a)}else{if(typeof module!=="undefined"&&module.exports){module.exports=a(require("jquery"))}else{a(jQuery)}}}(function(i,e){
/*
 * jsTree 3.2.1
 * http://jstree.com/
 *
 * Copyright (c) 2014 Ivan Bozhanov (http://vakata.com)
 *
 * Licensed same as jquery - under the terms of the MIT License
 *   http://www.opensource.org/licenses/mit-license.php
 */
/*
 * if using jslint please allow for the jQuery global and use following options:
 * jslint: browser: true, ass: true, bitwise: true, continue: true, nomen: true, plusplus: true, regexp: true, unparam: true, todo: true, white: true
 */
if(i.jstree){return}var c=0,d=false,l=false,j=false,n=[],a=i("script:last").attr("src"),o=window.document,q=o.createElement("LI"),g,f;q.setAttribute("role","treeitem");g=o.createElement("I");g.className="jstree-icon jstree-ocl";g.setAttribute("role","presentation");q.appendChild(g);g=o.createElement("A");g.className="jstree-anchor";g.setAttribute("href","#");g.setAttribute("tabindex","-1");f=o.createElement("I");f.className="jstree-icon jstree-themeicon";f.setAttribute("role","presentation");g.appendChild(f);q.appendChild(g);g=f=null;i.jstree={version:"3.2.1",defaults:{plugins:[]},plugins:{},path:a&&a.indexOf("/")!==-1?a.replace(/\/[^\/]+$/,""):"",idregex:/[\\:&!^|()\[\]<>@*'+~#";.,=\- \/${}%?`]/g,root:"#"};i.jstree.create=function(u,r){var t=new i.jstree.core(++c),s=r;r=i.extend(true,{},i.jstree.defaults,r);if(s&&s.plugins){r.plugins=s.plugins}i.each(r.plugins,function(w,v){if(w!=="core"){t=t.plugin(v,r[v])}});i(u).data("jstree",t);t.init(u,r);return t};i.jstree.destroy=function(){i(".jstree:jstree").jstree("destroy");i(o).off(".jstree")};i.jstree.core=function(r){this._id=r;this._cnt=0;this._wrk=null;this._data={core:{themes:{name:false,dots:false,icons:false},selected:[],last_error:{},working:false,worker_queue:[],focused:null}}};i.jstree.reference=function(t){var r=null,s=null;if(t&&t.id&&(!t.tagName||!t.nodeType)){t=t.id}if(!s||!s.length){try{s=i(t)}catch(u){}}if(!s||!s.length){try{s=i("#"+t.replace(i.jstree.idregex,"\\$&"))}catch(u){}}if(s&&s.length&&(s=s.closest(".jstree")).length&&(s=s.data("jstree"))){r=s}else{i(".jstree").each(function(){var v=i(this).data("jstree");if(v&&v._model.data[t]){r=v;return false}})}return r};i.fn.jstree=function(s){var u=(typeof s==="string"),t=Array.prototype.slice.call(arguments,1),r=null;if(s===true&&!this.length){return false}this.each(function(){var v=i.jstree.reference(this),w=u&&v?v[s]:null;r=u&&w?w.apply(v,t):null;if(!v&&!u&&(s===e||i.isPlainObject(s))){i.jstree.create(this,s)}if((v&&!u)||s===true){r=v||false}if(r!==null&&r!==e){return false}});return r!==null&&r!==e?r:this};i.expr[":"].jstree=i.expr.createPseudo(function(r){return function(s){return i(s).hasClass("jstree")&&i(s).data("jstree")!==e}});i.jstree.defaults.core={data:false,strings:false,check_callback:false,error:i.noop,animation:200,multiple:true,themes:{name:false,url:false,dir:false,dots:true,icons:true,stripes:false,variant:false,responsive:false},expand_selected_onload:true,worker:true,force_text:false,dblclick_toggle:true};i.jstree.core.prototype={plugin:function(t,s){var r=i.jstree.plugins[t];if(r){this._data[t]={};r.prototype=this;return new r(s,this)}return this},init:function(s,r){this._model={data:{},changed:[],force_full_redraw:false,redraw_timeout:false,default_state:{loaded:true,opened:false,selected:false,disabled:false}};this._model.data[i.jstree.root]={id:i.jstree.root,parent:null,parents:[],children:[],children_d:[],state:{loaded:false}};this.element=i(s).addClass("jstree jstree-"+this._id);this.settings=r;this._data.core.ready=false;this._data.core.loaded=false;this._data.core.rtl=(this.element.css("direction")==="rtl");this.element[this._data.core.rtl?"addClass":"removeClass"]("jstree-rtl");this.element.attr("role","tree");if(this.settings.core.multiple){this.element.attr("aria-multiselectable",true)}if(!this.element.attr("tabindex")){this.element.attr("tabindex","0")}this.bind();this.trigger("init");this._data.core.original_container_html=this.element.find(" > ul > li").clone(true);this._data.core.original_container_html.find("li").addBack().contents().filter(function(){return this.nodeType===3&&(!this.nodeValue||/^\s+$/.test(this.nodeValue))}).remove();this.element.html("<ul class='jstree-container-ul jstree-children' role='group'><li id='j"+this._id+"_loading' class='jstree-initial-node jstree-loading jstree-leaf jstree-last' role='tree-item'><i class='jstree-icon jstree-ocl'></i><a class='jstree-anchor' href='#'><i class='jstree-icon jstree-themeicon-hidden'></i>"+this.get_string("Loading ...")+"</a></li></ul>");this.element.attr("aria-activedescendant","j"+this._id+"_loading");this._data.core.li_height=this.get_container_ul().children("li").first().height()||24;this.trigger("loading");this.load_node(i.jstree.root)},destroy:function(r){if(this._wrk){try{window.URL.revokeObjectURL(this._wrk);this._wrk=null}catch(s){}}if(!r){this.element.empty()}this.teardown()},teardown:function(){this.unbind();this.element.removeClass("jstree").removeData("jstree").find("[class^='jstree']").addBack().attr("class",function(){return this.className.replace(/jstree[^ ]*|$/ig,"")});this.element=null},bind:function(){var s="",r=null,t=0;this.element.on("dblclick.jstree",function(v){if(v.target.tagName&&v.target.tagName.toLowerCase()==="input"){return true}if(o.selection&&o.selection.empty){o.selection.empty()}else{if(window.getSelection){var u=window.getSelection();try{u.removeAllRanges();u.collapse()}catch(w){}}}}).on("mousedown.jstree",i.proxy(function(u){if(u.target===this.element[0]){u.preventDefault();t=+(new Date())}},this)).on("mousedown.jstree",".jstree-ocl",function(u){u.preventDefault()}).on("click.jstree",".jstree-ocl",i.proxy(function(u){this.toggle_node(u.target)},this)).on("dblclick.jstree",".jstree-anchor",i.proxy(function(u){if(u.target.tagName&&u.target.tagName.toLowerCase()==="input"){return true}if(this.settings.core.dblclick_toggle){this.toggle_node(u.target)}},this)).on("click.jstree",".jstree-anchor",i.proxy(function(u){u.preventDefault();if(u.currentTarget!==o.activeElement){i(u.currentTarget).focus()}this.activate_node(u.currentTarget,u)},this)).on("keydown.jstree",".jstree-anchor",i.proxy(function(u){if(u.target.tagName&&u.target.tagName.toLowerCase()==="input"){return true}if(u.which!==32&&u.which!==13&&(u.shiftKey||u.ctrlKey||u.altKey||u.metaKey)){return true}var v=null;if(this._data.core.rtl){if(u.which===37){u.which=39}else{if(u.which===39){u.which=37}}}switch(u.which){case 32:if(u.ctrlKey){u.type="click";i(u.currentTarget).trigger(u)}break;case 13:u.type="click";i(u.currentTarget).trigger(u);break;case 37:u.preventDefault();if(this.is_open(u.currentTarget)){this.close_node(u.currentTarget)}else{v=this.get_parent(u.currentTarget);if(v&&v.id!==i.jstree.root){this.get_node(v,true).children(".jstree-anchor").focus()}}break;case 38:u.preventDefault();v=this.get_prev_dom(u.currentTarget);if(v&&v.length){v.children(".jstree-anchor").focus()}break;case 39:u.preventDefault();if(this.is_closed(u.currentTarget)){this.open_node(u.currentTarget,function(w){this.get_node(w,true).children(".jstree-anchor").focus()})}else{if(this.is_open(u.currentTarget)){v=this.get_node(u.currentTarget,true).children(".jstree-children")[0];if(v){i(this._firstChild(v)).children(".jstree-anchor").focus()}}}break;case 40:u.preventDefault();v=this.get_next_dom(u.currentTarget);if(v&&v.length){v.children(".jstree-anchor").focus()}break;case 106:this.open_all();break;case 36:u.preventDefault();v=this._firstChild(this.get_container_ul()[0]);if(v){i(v).children(".jstree-anchor").filter(":visible").focus()}break;case 35:u.preventDefault();this.element.find(".jstree-anchor").filter(":visible").last().focus();break;
/*
							// delete
							case 46:
								e.preventDefault();
								o = this.get_node(e.currentTarget);
								if(o && o.id && o.id !== $.jstree.root) {
									o = this.is_selected(o) ? this.get_selected() : o;
									this.delete_node(o);
								}
								break;
							// f2
							case 113:
								e.preventDefault();
								o = this.get_node(e.currentTarget);
								if(o && o.id && o.id !== $.jstree.root) {
									// this.edit(o);
								}
								break;
							default:
								// console.log(e.which);
								break;
							*/
}},this)).on("load_node.jstree",i.proxy(function(v,u){if(u.status){if(u.node.id===i.jstree.root&&!this._data.core.loaded){this._data.core.loaded=true;if(this._firstChild(this.get_container_ul()[0])){this.element.attr("aria-activedescendant",this._firstChild(this.get_container_ul()[0]).id)}this.trigger("loaded")}if(!this._data.core.ready){setTimeout(i.proxy(function(){if(this.element&&!this.get_container_ul().find(".jstree-loading").length){this._data.core.ready=true;if(this._data.core.selected.length){if(this.settings.core.expand_selected_onload){var y=[],x,w;for(x=0,w=this._data.core.selected.length;x<w;x++){y=y.concat(this._model.data[this._data.core.selected[x]].parents)}y=i.vakata.array_unique(y);for(x=0,w=y.length;x<w;x++){this.open_node(y[x],false,0)}}this.trigger("changed",{action:"ready",selected:this._data.core.selected})}this.trigger("ready")}},this),0)}}},this)).on("keypress.jstree",i.proxy(function(y){if(y.target.tagName&&y.target.tagName.toLowerCase()==="input"){return true}if(r){clearTimeout(r)}r=setTimeout(function(){s=""},500);var w=String.fromCharCode(y.which).toLowerCase(),v=this.element.find(".jstree-anchor").filter(":visible"),x=v.index(o.activeElement)||0,u=false;s+=w;if(s.length>1){v.slice(x).each(i.proxy(function(A,z){if(i(z).text().toLowerCase().indexOf(s)===0){i(z).focus();u=true;return false}},this));if(u){return}v.slice(0,x).each(i.proxy(function(A,z){if(i(z).text().toLowerCase().indexOf(s)===0){i(z).focus();u=true;return false}},this));if(u){return}}if(new RegExp("^"+w.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+"+$").test(s)){v.slice(x+1).each(i.proxy(function(A,z){if(i(z).text().toLowerCase().charAt(0)===w){i(z).focus();u=true;return false}},this));if(u){return}v.slice(0,x+1).each(i.proxy(function(A,z){if(i(z).text().toLowerCase().charAt(0)===w){i(z).focus();u=true;return false}},this));if(u){return}}},this)).on("init.jstree",i.proxy(function(){var u=this.settings.core.themes;this._data.core.themes.dots=u.dots;this._data.core.themes.stripes=u.stripes;this._data.core.themes.icons=u.icons;this.set_theme(u.name||"default",u.url);this.set_theme_variant(u.variant)},this)).on("loading.jstree",i.proxy(function(){this[this._data.core.themes.dots?"show_dots":"hide_dots"]();this[this._data.core.themes.icons?"show_icons":"hide_icons"]();this[this._data.core.themes.stripes?"show_stripes":"hide_stripes"]()},this)).on("blur.jstree",".jstree-anchor",i.proxy(function(u){this._data.core.focused=null;i(u.currentTarget).filter(".jstree-hovered").mouseleave();this.element.attr("tabindex","0")},this)).on("focus.jstree",".jstree-anchor",i.proxy(function(v){var u=this.get_node(v.currentTarget);if(u&&u.id){this._data.core.focused=u.id}this.element.find(".jstree-hovered").not(v.currentTarget).mouseleave();i(v.currentTarget).mouseenter();this.element.attr("tabindex","-1")},this)).on("focus.jstree",i.proxy(function(){if(+(new Date())-t>500&&!this._data.core.focused){t=0;var u=this.get_node(this.element.attr("aria-activedescendant"),true);if(u){u.find("> .jstree-anchor").focus()}}},this)).on("mouseenter.jstree",".jstree-anchor",i.proxy(function(u){this.hover_node(u.currentTarget)},this)).on("mouseleave.jstree",".jstree-anchor",i.proxy(function(u){this.dehover_node(u.currentTarget)},this))},unbind:function(){this.element.off(".jstree");i(o).off(".jstree-"+this._id)},trigger:function(r,s){if(!s){s={}}s.instance=this;this.element.triggerHandler(r.replace(".jstree","")+".jstree",s)},get_container:function(){return this.element},get_container_ul:function(){return this.element.children(".jstree-children").first()},get_string:function(s){var r=this.settings.core.strings;if(i.isFunction(r)){return r.call(this,s)}if(r&&r[s]){return r[s]}return s},_firstChild:function(r){r=r?r.firstChild:null;while(r!==null&&r.nodeType!==1){r=r.nextSibling}return r},_nextSibling:function(r){r=r?r.nextSibling:null;while(r!==null&&r.nodeType!==1){r=r.nextSibling}return r},_previousSibling:function(r){r=r?r.previousSibling:null;while(r!==null&&r.nodeType!==1){r=r.previousSibling}return r},get_node:function(t,r){if(t&&t.id){t=t.id}var u;try{if(this._model.data[t]){t=this._model.data[t]}else{if(typeof t==="string"&&this._model.data[t.replace(/^#/,"")]){t=this._model.data[t.replace(/^#/,"")]}else{if(typeof t==="string"&&(u=i("#"+t.replace(i.jstree.idregex,"\\$&"),this.element)).length&&this._model.data[u.closest(".jstree-node").attr("id")]){t=this._model.data[u.closest(".jstree-node").attr("id")]}else{if((u=i(t,this.element)).length&&this._model.data[u.closest(".jstree-node").attr("id")]){t=this._model.data[u.closest(".jstree-node").attr("id")]}else{if((u=i(t,this.element)).length&&u.hasClass("jstree")){t=this._model.data[i.jstree.root]}else{return false}}}}}if(r){t=t.id===i.jstree.root?this.element:i("#"+t.id.replace(i.jstree.idregex,"\\$&"),this.element)}return t}catch(s){return false}},get_path:function(w,u,t){w=w.parents?w:this.get_node(w);if(!w||w.id===i.jstree.root||!w.parents){return false}var s,r,v=[];v.push(t?w.id:w.text);for(s=0,r=w.parents.length;s<r;s++){v.push(t?w.parents[s]:this.get_text(w.parents[s]))}v=v.reverse().slice(1);return u?v.join(u):v},get_next_dom:function(t,r){var s;t=this.get_node(t,true);if(t[0]===this.element[0]){s=this._firstChild(this.get_container_ul()[0]);while(s&&s.offsetHeight===0){s=this._nextSibling(s)}return s?i(s):false}if(!t||!t.length){return false}if(r){s=t[0];do{s=this._nextSibling(s)}while(s&&s.offsetHeight===0);return s?i(s):false}if(t.hasClass("jstree-open")){s=this._firstChild(t.children(".jstree-children")[0]);while(s&&s.offsetHeight===0){s=this._nextSibling(s)}if(s!==null){return i(s)}}s=t[0];do{s=this._nextSibling(s)}while(s&&s.offsetHeight===0);if(s!==null){return i(s)}return t.parentsUntil(".jstree",".jstree-node").nextAll(".jstree-node:visible").first()},get_prev_dom:function(t,r){var s;t=this.get_node(t,true);if(t[0]===this.element[0]){s=this.get_container_ul()[0].lastChild;while(s&&s.offsetHeight===0){s=this._previousSibling(s)}return s?i(s):false}if(!t||!t.length){return false}if(r){s=t[0];do{s=this._previousSibling(s)}while(s&&s.offsetHeight===0);return s?i(s):false}s=t[0];do{s=this._previousSibling(s)}while(s&&s.offsetHeight===0);if(s!==null){t=i(s);while(t.hasClass("jstree-open")){t=t.children(".jstree-children").first().children(".jstree-node:visible:last")}return t}s=t[0].parentNode.parentNode;return s&&s.className&&s.className.indexOf("jstree-node")!==-1?i(s):false},get_parent:function(r){r=this.get_node(r);if(!r||r.id===i.jstree.root){return false}return r.parent},get_children_dom:function(r){r=this.get_node(r,true);if(r[0]===this.element[0]){return this.get_container_ul().children(".jstree-node")}if(!r||!r.length){return false}return r.children(".jstree-children").children(".jstree-node")},is_parent:function(r){r=this.get_node(r);return r&&(r.state.loaded===false||r.children.length>0)},is_loaded:function(r){r=this.get_node(r);return r&&r.state.loaded},is_loading:function(r){r=this.get_node(r);return r&&r.state&&r.state.loading},is_open:function(r){r=this.get_node(r);return r&&r.state.opened},is_closed:function(r){r=this.get_node(r);return r&&this.is_parent(r)&&!r.state.opened},is_leaf:function(r){return !this.is_parent(r)},load_node:function(v,x){var s,r,u,t,w;if(i.isArray(v)){this._load_nodes(v.slice(),x);return true}v=this.get_node(v);if(!v){if(x){x.call(this,v,false)}return false}if(v.state.loaded){v.state.loaded=false;for(s=0,r=v.children_d.length;s<r;s++){for(u=0,t=v.parents.length;u<t;u++){this._model.data[v.parents[u]].children_d=i.vakata.array_remove_item(this._model.data[v.parents[u]].children_d,v.children_d[s])}if(this._model.data[v.children_d[s]].state.selected){w=true;this._data.core.selected=i.vakata.array_remove_item(this._data.core.selected,v.children_d[s])}delete this._model.data[v.children_d[s]]}v.children=[];v.children_d=[];if(w){this.trigger("changed",{action:"load_node",node:v,selected:this._data.core.selected})}}v.state.failed=false;v.state.loading=true;this.get_node(v,true).addClass("jstree-loading").attr("aria-busy",true);this._load_node(v,i.proxy(function(z){v=this._model.data[v.id];v.state.loading=false;v.state.loaded=z;v.state.failed=!v.state.loaded;var D=this.get_node(v,true),C=0,A=0,y=this._model.data,B=false;for(C=0,A=v.children.length;C<A;C++){if(y[v.children[C]]&&!y[v.children[C]].state.hidden){B=true;break}}if(v.state.loaded&&!B&&D&&D.length&&!D.hasClass("jstree-leaf")){D.removeClass("jstree-closed jstree-open").addClass("jstree-leaf")}D.removeClass("jstree-loading").attr("aria-busy",false);this.trigger("load_node",{node:v,status:z});if(x){x.call(this,v,z)}},this));return true},_load_nodes:function(t,A,z){var s=true,y=function(){this._load_nodes(t,A,true)},u=this._model.data,x,v,w=[];for(x=0,v=t.length;x<v;x++){if(u[t[x]]&&((!u[t[x]].state.loaded&&!u[t[x]].state.failed)||!z)){if(!this.is_loading(t[x])){this.load_node(t[x],y)}s=false}}if(s){for(x=0,v=t.length;x<v;x++){if(u[t[x]]&&u[t[x]].state.loaded){w.push(t[x])}}if(A&&!A.done){A.call(this,w);A.done=true}}},load_all:function(v,x){if(!v){v=i.jstree.root}v=this.get_node(v);if(!v){return false}var u=[],r=this._model.data,w=r[v.id].children_d,t,s;if(v.state&&!v.state.loaded){u.push(v.id)}for(t=0,s=w.length;t<s;t++){if(r[w[t]]&&r[w[t]].state&&!r[w[t]].state.loaded){u.push(w[t])}}if(u.length){this._load_nodes(u,function(){this.load_all(v,x)})}else{if(x){x.call(this,v)}this.trigger("load_all",{node:v})}},_load_node:function(v,w){var u=this.settings.core.data,r;if(!u){if(v.id===i.jstree.root){return this._append_html_data(v,this._data.core.original_container_html.clone(true),function(s){w.call(this,s)})}else{return w.call(this,false)}}if(i.isFunction(u)){return u.call(this,v,i.proxy(function(s){if(s===false){w.call(this,false)}this[typeof s==="string"?"_append_html_data":"_append_json_data"](v,typeof s==="string"?i(i.parseHTML(s)).filter(function(){return this.nodeType!==3}):s,function(t){w.call(this,t)})},this))}if(typeof u==="object"){if(u.url){u=i.extend(true,{},u);if(i.isFunction(u.url)){u.url=u.url.call(this,v)}if(i.isFunction(u.data)){u.data=u.data.call(this,v)}return i.ajax(u).done(i.proxy(function(A,y,s){var z=s.getResponseHeader("Content-Type");if((z&&z.indexOf("json")!==-1)||typeof A==="object"){return this._append_json_data(v,A,function(t){w.call(this,t)})}if((z&&z.indexOf("html")!==-1)||typeof A==="string"){return this._append_html_data(v,i(i.parseHTML(A)).filter(function(){return this.nodeType!==3}),function(t){w.call(this,t)})}this._data.core.last_error={error:"ajax",plugin:"core",id:"core_04",reason:"Could not load node",data:JSON.stringify({id:v.id,xhr:s})};this.settings.core.error.call(this,this._data.core.last_error);return w.call(this,false)},this)).fail(i.proxy(function(s){w.call(this,false);this._data.core.last_error={error:"ajax",plugin:"core",id:"core_04",reason:"Could not load node",data:JSON.stringify({id:v.id,xhr:s})};this.settings.core.error.call(this,this._data.core.last_error)},this))}r=(i.isArray(u)||i.isPlainObject(u))?JSON.parse(JSON.stringify(u)):u;if(v.id===i.jstree.root){return this._append_json_data(v,r,function(s){w.call(this,s)})}else{this._data.core.last_error={error:"nodata",plugin:"core",id:"core_05",reason:"Could not load node",data:JSON.stringify({id:v.id})};this.settings.core.error.call(this,this._data.core.last_error);return w.call(this,false)}}if(typeof u==="string"){if(v.id===i.jstree.root){return this._append_html_data(v,i(i.parseHTML(u)).filter(function(){return this.nodeType!==3}),function(s){w.call(this,s)})}else{this._data.core.last_error={error:"nodata",plugin:"core",id:"core_06",reason:"Could not load node",data:JSON.stringify({id:v.id})};this.settings.core.error.call(this,this._data.core.last_error);return w.call(this,false)}}return w.call(this,false)},_node_changed:function(r){r=this.get_node(r);if(r){this._model.changed.push(r.id)}},_append_html_data:function(w,z,u){w=this.get_node(w);w.children=[];w.children_d=[];var C=z.is("ul")?z.children():z,B=w.id,E=[],A=[],t=this._model.data,r=t[B],D=this._data.core.selected.length,y,x,v;C.each(i.proxy(function(F,s){y=this._parse_model_from_html(i(s),B,r.parents.concat());if(y){E.push(y);A.push(y);if(t[y].children_d.length){A=A.concat(t[y].children_d)}}},this));r.children=E;r.children_d=A;for(x=0,v=r.parents.length;x<v;x++){t[r.parents[x]].children_d=t[r.parents[x]].children_d.concat(A)}this.trigger("model",{nodes:A,parent:B});if(B!==i.jstree.root){this._node_changed(B);this.redraw()}else{this.get_container_ul().children(".jstree-initial-node").remove();this.redraw(true)}if(this._data.core.selected.length!==D){this.trigger("changed",{action:"model",selected:this._data.core.selected})}u.call(this,true)},_append_json_data:function(t,u,s,v){if(this.element===null){return}t=this.get_node(t);t.children=[];t.children_d=[];if(u.d){u=u.d;if(typeof u==="string"){u=JSON.parse(u)}}if(!i.isArray(u)){u=[u]}var A=null,y={df:this._model.default_state,dat:u,par:t.id,m:this._model.data,t_id:this._id,t_cnt:this._cnt,sel:this._data.core.selected},r=function(S,B){if(S.data){S=S.data}var N=S.dat,G=S.par,w=[],C=[],H=[],O=S.df,E=S.t_id,F=S.t_cnt,J=S.m,I=J[G],K=S.sel,Q,M,L,P,R=function(aa,U,T){if(!T){T=[]}else{T=T.concat()}if(U){T.unshift(U)}var V=aa.id.toString(),Y,W,ab,Z,X={id:V,text:aa.text||"",icon:aa.icon!==B?aa.icon:true,parent:U,parents:T,children:aa.children||[],children_d:aa.children_d||[],data:aa.data,state:{},li_attr:{id:false},a_attr:{href:"#"},original:false};for(Y in O){if(O.hasOwnProperty(Y)){X.state[Y]=O[Y]}}if(aa&&aa.data&&aa.data.jstree&&aa.data.jstree.icon){X.icon=aa.data.jstree.icon}if(X.icon===B||X.icon===null||X.icon===""){X.icon=true}if(aa&&aa.data){X.data=aa.data;if(aa.data.jstree){for(Y in aa.data.jstree){if(aa.data.jstree.hasOwnProperty(Y)){X.state[Y]=aa.data.jstree[Y]}}}}if(aa&&typeof aa.state==="object"){for(Y in aa.state){if(aa.state.hasOwnProperty(Y)){X.state[Y]=aa.state[Y]}}}if(aa&&typeof aa.li_attr==="object"){for(Y in aa.li_attr){if(aa.li_attr.hasOwnProperty(Y)){X.li_attr[Y]=aa.li_attr[Y]}}}if(!X.li_attr.id){X.li_attr.id=V}if(aa&&typeof aa.a_attr==="object"){for(Y in aa.a_attr){if(aa.a_attr.hasOwnProperty(Y)){X.a_attr[Y]=aa.a_attr[Y]}}}if(aa&&aa.children&&aa.children===true){X.state.loaded=false;X.children=[];X.children_d=[]}J[X.id]=X;for(Y=0,W=X.children.length;Y<W;Y++){ab=R(J[X.children[Y]],X.id,T);Z=J[ab];X.children_d.push(ab);if(Z.children_d.length){X.children_d=X.children_d.concat(Z.children_d)}}delete aa.data;delete aa.children;J[X.id].original=aa;if(X.state.selected){H.push(X.id)}return X.id},D=function(aa,U,T){if(!T){T=[]}else{T=T.concat()}if(U){T.unshift(U)}var V=false,Y,W,ab,Z,X;do{V="j"+E+"_"+(++F)}while(J[V]);X={id:false,text:typeof aa==="string"?aa:"",icon:typeof aa==="object"&&aa.icon!==B?aa.icon:true,parent:U,parents:T,children:[],children_d:[],data:null,state:{},li_attr:{id:false},a_attr:{href:"#"},original:false};for(Y in O){if(O.hasOwnProperty(Y)){X.state[Y]=O[Y]}}if(aa&&aa.id){X.id=aa.id.toString()}if(aa&&aa.text){X.text=aa.text}if(aa&&aa.data&&aa.data.jstree&&aa.data.jstree.icon){X.icon=aa.data.jstree.icon}if(X.icon===B||X.icon===null||X.icon===""){X.icon=true}if(aa&&aa.data){X.data=aa.data;if(aa.data.jstree){for(Y in aa.data.jstree){if(aa.data.jstree.hasOwnProperty(Y)){X.state[Y]=aa.data.jstree[Y]}}}}if(aa&&typeof aa.state==="object"){for(Y in aa.state){if(aa.state.hasOwnProperty(Y)){X.state[Y]=aa.state[Y]}}}if(aa&&typeof aa.li_attr==="object"){for(Y in aa.li_attr){if(aa.li_attr.hasOwnProperty(Y)){X.li_attr[Y]=aa.li_attr[Y]}}}if(X.li_attr.id&&!X.id){X.id=X.li_attr.id.toString()}if(!X.id){X.id=V}if(!X.li_attr.id){X.li_attr.id=X.id}if(aa&&typeof aa.a_attr==="object"){for(Y in aa.a_attr){if(aa.a_attr.hasOwnProperty(Y)){X.a_attr[Y]=aa.a_attr[Y]}}}if(aa&&aa.children&&aa.children.length){for(Y=0,W=aa.children.length;Y<W;Y++){ab=D(aa.children[Y],X.id,T);Z=J[ab];X.children.push(ab);if(Z.children_d.length){X.children_d=X.children_d.concat(Z.children_d)}}X.children_d=X.children_d.concat(X.children)}if(aa&&aa.children&&aa.children===true){X.state.loaded=false;X.children=[];X.children_d=[]}delete aa.data;delete aa.children;X.original=aa;J[X.id]=X;if(X.state.selected){H.push(X.id)}return X.id};if(N.length&&N[0].id!==B&&N[0].parent!==B){for(M=0,L=N.length;M<L;M++){if(!N[M].children){N[M].children=[]}J[N[M].id.toString()]=N[M]}for(M=0,L=N.length;M<L;M++){J[N[M].parent.toString()].children.push(N[M].id.toString());I.children_d.push(N[M].id.toString())}for(M=0,L=I.children.length;M<L;M++){Q=R(J[I.children[M]],G,I.parents.concat());C.push(Q);if(J[Q].children_d.length){C=C.concat(J[Q].children_d)}}for(M=0,L=I.parents.length;M<L;M++){J[I.parents[M]].children_d=J[I.parents[M]].children_d.concat(C)}P={cnt:F,mod:J,sel:K,par:G,dpc:C,add:H}}else{for(M=0,L=N.length;M<L;M++){Q=D(N[M],G,I.parents.concat());if(Q){w.push(Q);C.push(Q);if(J[Q].children_d.length){C=C.concat(J[Q].children_d)}}}I.children=w;I.children_d=C;for(M=0,L=I.parents.length;M<L;M++){J[I.parents[M]].children_d=J[I.parents[M]].children_d.concat(C)}P={cnt:F,mod:J,sel:K,par:G,dpc:C,add:H}}if(typeof window==="undefined"||typeof window.document==="undefined"){postMessage(P)}else{return P}},z=function(C,H){if(this.element===null){return}this._cnt=C.cnt;this._model.data=C.mod;if(H){var E,D,B=C.add,G=C.sel,F=this._data.core.selected.slice(),w=this._model.data;if(G.length!==F.length||i.vakata.array_unique(G.concat(F)).length!==G.length){for(E=0,D=G.length;E<D;E++){if(i.inArray(G[E],B)===-1&&i.inArray(G[E],F)===-1){w[G[E]].state.selected=false}}for(E=0,D=F.length;E<D;E++){if(i.inArray(F[E],G)===-1){w[F[E]].state.selected=true}}}}if(C.add.length){this._data.core.selected=this._data.core.selected.concat(C.add)}this.trigger("model",{nodes:C.dpc,parent:C.par});if(C.par!==i.jstree.root){this._node_changed(C.par);this.redraw()}else{this.redraw(true)}if(C.add.length){this.trigger("changed",{action:"model",selected:this._data.core.selected})}s.call(this,true)};if(this.settings.core.worker&&window.Blob&&window.URL&&window.Worker){try{if(this._wrk===null){this._wrk=window.URL.createObjectURL(new window.Blob(["self.onmessage = "+r.toString()],{type:"text/javascript"}))}if(!this._data.core.working||v){this._data.core.working=true;A=new window.Worker(this._wrk);A.onmessage=i.proxy(function(w){z.call(this,w.data,true);try{A.terminate();A=null}catch(B){}if(this._data.core.worker_queue.length){this._append_json_data.apply(this,this._data.core.worker_queue.shift())}else{this._data.core.working=false}},this);if(!y.par){if(this._data.core.worker_queue.length){this._append_json_data.apply(this,this._data.core.worker_queue.shift())}else{this._data.core.working=false}}else{A.postMessage(y)}}else{this._data.core.worker_queue.push([t,u,s,true])}}catch(x){z.call(this,r(y),false);if(this._data.core.worker_queue.length){this._append_json_data.apply(this,this._data.core.worker_queue.shift())}else{this._data.core.working=false}}}else{z.call(this,r(y),false)}},_parse_model_from_html:function(z,s,r){if(!r){r=[]}else{r=[].concat(r)}if(s){r.unshift(s)}var A,y,t=this._model.data,w={id:false,text:false,icon:true,parent:s,parents:r,children:[],children_d:[],data:null,state:{},li_attr:{id:false},a_attr:{href:"#"},original:false},x,v,u;for(x in this._model.default_state){if(this._model.default_state.hasOwnProperty(x)){w.state[x]=this._model.default_state[x]}}v=i.vakata.attributes(z,true);i.each(v,function(C,B){B=i.trim(B);if(!B.length){return true}w.li_attr[C]=B;if(C==="id"){w.id=B.toString()}});v=z.children("a").first();if(v.length){v=i.vakata.attributes(v,true);i.each(v,function(C,B){B=i.trim(B);if(B.length){w.a_attr[C]=B}})}v=z.children("a").first().length?z.children("a").first().clone():z.clone();v.children("ins, i, ul").remove();v=v.html();v=i("<div />").html(v);w.text=this.settings.core.force_text?v.text():v.html();v=z.data();w.data=v?i.extend(true,{},v):null;w.state.opened=z.hasClass("jstree-open");w.state.selected=z.children("a").hasClass("jstree-clicked");w.state.disabled=z.children("a").hasClass("jstree-disabled");if(w.data&&w.data.jstree){for(x in w.data.jstree){if(w.data.jstree.hasOwnProperty(x)){w.state[x]=w.data.jstree[x]}}}v=z.children("a").children(".jstree-themeicon");if(v.length){w.icon=v.hasClass("jstree-themeicon-hidden")?false:v.attr("rel")}if(w.state.icon!==e){w.icon=w.state.icon}if(w.icon===e||w.icon===null||w.icon===""){w.icon=true}v=z.children("ul").children("li");do{u="j"+this._id+"_"+(++this._cnt)}while(t[u]);w.id=w.li_attr.id?w.li_attr.id.toString():u;if(v.length){v.each(i.proxy(function(C,B){A=this._parse_model_from_html(i(B),w.id,r);y=this._model.data[A];w.children.push(A);if(y.children_d.length){w.children_d=w.children_d.concat(y.children_d)}},this));w.children_d=w.children_d.concat(w.children)}else{if(z.hasClass("jstree-closed")){w.state.loaded=false}}if(w.li_attr["class"]){w.li_attr["class"]=w.li_attr["class"].replace("jstree-closed","").replace("jstree-open","")}if(w.a_attr["class"]){w.a_attr["class"]=w.a_attr["class"].replace("jstree-clicked","").replace("jstree-disabled","")}t[w.id]=w;if(w.state.selected){this._data.core.selected.push(w.id)}return w.id},_parse_model_from_flat_json:function(z,s,r){if(!r){r=[]}else{r=r.concat()}if(s){r.unshift(s)}var u=z.id.toString(),t=this._model.data,B=this._model.default_state,x,v,A,y,w={id:u,text:z.text||"",icon:z.icon!==e?z.icon:true,parent:s,parents:r,children:z.children||[],children_d:z.children_d||[],data:z.data,state:{},li_attr:{id:false},a_attr:{href:"#"},original:false};for(x in B){if(B.hasOwnProperty(x)){w.state[x]=B[x]}}if(z&&z.data&&z.data.jstree&&z.data.jstree.icon){w.icon=z.data.jstree.icon}if(w.icon===e||w.icon===null||w.icon===""){w.icon=true}if(z&&z.data){w.data=z.data;if(z.data.jstree){for(x in z.data.jstree){if(z.data.jstree.hasOwnProperty(x)){w.state[x]=z.data.jstree[x]}}}}if(z&&typeof z.state==="object"){for(x in z.state){if(z.state.hasOwnProperty(x)){w.state[x]=z.state[x]}}}if(z&&typeof z.li_attr==="object"){for(x in z.li_attr){if(z.li_attr.hasOwnProperty(x)){w.li_attr[x]=z.li_attr[x]}}}if(!w.li_attr.id){w.li_attr.id=u}if(z&&typeof z.a_attr==="object"){for(x in z.a_attr){if(z.a_attr.hasOwnProperty(x)){w.a_attr[x]=z.a_attr[x]}}}if(z&&z.children&&z.children===true){w.state.loaded=false;w.children=[];w.children_d=[]}t[w.id]=w;for(x=0,v=w.children.length;x<v;x++){A=this._parse_model_from_flat_json(t[w.children[x]],w.id,r);y=t[A];w.children_d.push(A);if(y.children_d.length){w.children_d=w.children_d.concat(y.children_d)}}delete z.data;delete z.children;t[w.id].original=z;if(w.state.selected){this._data.core.selected.push(w.id)}return w.id},_parse_model_from_json:function(z,s,r){if(!r){r=[]}else{r=r.concat()}if(s){r.unshift(s)}var u=false,x,v,A,y,t=this._model.data,B=this._model.default_state,w;do{u="j"+this._id+"_"+(++this._cnt)}while(t[u]);w={id:false,text:typeof z==="string"?z:"",icon:typeof z==="object"&&z.icon!==e?z.icon:true,parent:s,parents:r,children:[],children_d:[],data:null,state:{},li_attr:{id:false},a_attr:{href:"#"},original:false};for(x in B){if(B.hasOwnProperty(x)){w.state[x]=B[x]}}if(z&&z.id){w.id=z.id.toString()}if(z&&z.text){w.text=z.text}if(z&&z.data&&z.data.jstree&&z.data.jstree.icon){w.icon=z.data.jstree.icon}if(w.icon===e||w.icon===null||w.icon===""){w.icon=true}if(z&&z.data){w.data=z.data;if(z.data.jstree){for(x in z.data.jstree){if(z.data.jstree.hasOwnProperty(x)){w.state[x]=z.data.jstree[x]}}}}if(z&&typeof z.state==="object"){for(x in z.state){if(z.state.hasOwnProperty(x)){w.state[x]=z.state[x]}}}if(z&&typeof z.li_attr==="object"){for(x in z.li_attr){if(z.li_attr.hasOwnProperty(x)){w.li_attr[x]=z.li_attr[x]}}}if(w.li_attr.id&&!w.id){w.id=w.li_attr.id.toString()}if(!w.id){w.id=u}if(!w.li_attr.id){w.li_attr.id=w.id}if(z&&typeof z.a_attr==="object"){for(x in z.a_attr){if(z.a_attr.hasOwnProperty(x)){w.a_attr[x]=z.a_attr[x]}}}if(z&&z.children&&z.children.length){for(x=0,v=z.children.length;x<v;x++){A=this._parse_model_from_json(z.children[x],w.id,r);y=t[A];w.children.push(A);if(y.children_d.length){w.children_d=w.children_d.concat(y.children_d)}}w.children_d=w.children_d.concat(w.children)}if(z&&z.children&&z.children===true){w.state.loaded=false;w.children=[];w.children_d=[]}delete z.data;delete z.children;w.original=z;t[w.id]=w;if(w.state.selected){this._data.core.selected.push(w.id)}return w.id},_redraw:function(){var r=this._model.force_full_redraw?this._model.data[i.jstree.root].children.concat([]):this._model.changed.concat([]),w=o.createElement("UL"),v,u,t,s=this._data.core.focused;for(u=0,t=r.length;u<t;u++){v=this.redraw_node(r[u],true,this._model.force_full_redraw);if(v&&this._model.force_full_redraw){w.appendChild(v)}}if(this._model.force_full_redraw){w.className=this.get_container_ul()[0].className;w.setAttribute("role","group");this.element.empty().append(w)}if(s!==null){v=this.get_node(s,true);if(v&&v.length&&v.children(".jstree-anchor")[0]!==o.activeElement){v.children(".jstree-anchor").focus()}else{this._data.core.focused=null}}this._model.force_full_redraw=false;this._model.changed=[];this.trigger("redraw",{nodes:r})},redraw:function(r){if(r){this._model.force_full_redraw=true}this._redraw()},draw_children:function(u){var v=this.get_node(u),t=false,s=false,r=false,w=o;if(!v){return false}if(v.id===i.jstree.root){return this.redraw(true)}u=this.get_node(u,true);if(!u||!u.length){return false}u.children(".jstree-children").remove();u=u[0];if(v.children.length&&v.state.loaded){r=w.createElement("UL");r.setAttribute("role","group");r.className="jstree-children";for(t=0,s=v.children.length;t<s;t++){r.appendChild(this.redraw_node(v.children[t],true,true))}u.appendChild(r)}},redraw_node:function(C,H,u,K){var x=this.get_node(C),B=false,w=false,r=false,I=false,G=false,F=false,M="",L=o,D=this._model.data,J=false,A=false,N=null,y=0,E=0,z=false,v=false;if(!x){return false}if(x.id===i.jstree.root){return this.redraw(true)}H=H||x.children.length===0;C=!o.querySelector?o.getElementById(x.id):this.element[0].querySelector("#"+("0123456789".indexOf(x.id[0])!==-1?"\\3"+x.id[0]+" "+x.id.substr(1).replace(i.jstree.idregex,"\\$&"):x.id.replace(i.jstree.idregex,"\\$&")));if(!C){H=true;if(!u){B=x.parent!==i.jstree.root?i("#"+x.parent.replace(i.jstree.idregex,"\\$&"),this.element)[0]:null;if(B!==null&&(!B||!D[x.parent].state.opened)){return false}w=i.inArray(x.id,B===null?D[i.jstree.root].children:D[x.parent].children)}}else{C=i(C);if(!u){B=C.parent().parent()[0];if(B===this.element[0]){B=null}w=C.index()}if(!H&&x.children.length&&!C.children(".jstree-children").length){H=true}if(!H){r=C.children(".jstree-children")[0]}J=C.children(".jstree-anchor")[0]===o.activeElement;C.remove()}C=q.cloneNode(true);M="jstree-node ";for(I in x.li_attr){if(x.li_attr.hasOwnProperty(I)){if(I==="id"){continue}if(I!=="class"){C.setAttribute(I,x.li_attr[I])}else{M+=x.li_attr[I]}}}if(!x.a_attr.id){x.a_attr.id=x.id+"_anchor"}C.setAttribute("aria-selected",!!x.state.selected);C.setAttribute("aria-level",x.parents.length);C.setAttribute("aria-labelledby",x.a_attr.id);if(x.state.disabled){C.setAttribute("aria-disabled",true)}for(I=0,G=x.children.length;I<G;I++){if(!D[x.children[I]].state.hidden){z=true;break}}if(x.parent!==null&&D[x.parent]&&!x.state.hidden){I=i.inArray(x.id,D[x.parent].children);v=x.id;if(I!==-1){I++;for(G=D[x.parent].children.length;I<G;I++){if(!D[D[x.parent].children[I]].state.hidden){v=D[x.parent].children[I]}if(v!==x.id){break}}}}if(x.state.hidden){M+=" jstree-hidden"}if(x.state.loaded&&!z){M+=" jstree-leaf"}else{M+=x.state.opened&&x.state.loaded?" jstree-open":" jstree-closed";C.setAttribute("aria-expanded",(x.state.opened&&x.state.loaded))}if(v===x.id){M+=" jstree-last"}C.id=x.id;C.className=M;M=(x.state.selected?" jstree-clicked":"")+(x.state.disabled?" jstree-disabled":"");for(G in x.a_attr){if(x.a_attr.hasOwnProperty(G)){if(G==="href"&&x.a_attr[G]==="#"){continue}if(G!=="class"){C.childNodes[1].setAttribute(G,x.a_attr[G])}else{M+=" "+x.a_attr[G]}}}if(M.length){C.childNodes[1].className="jstree-anchor "+M}if((x.icon&&x.icon!==true)||x.icon===false){if(x.icon===false){C.childNodes[1].childNodes[0].className+=" jstree-themeicon-hidden"}else{if(x.icon.indexOf("/")===-1&&x.icon.indexOf(".")===-1){C.childNodes[1].childNodes[0].className+=" "+x.icon+" jstree-themeicon-custom"}else{C.childNodes[1].childNodes[0].style.backgroundImage="url("+x.icon+")";C.childNodes[1].childNodes[0].style.backgroundPosition="center center";C.childNodes[1].childNodes[0].style.backgroundSize="auto";C.childNodes[1].childNodes[0].className+=" jstree-themeicon-custom"}}}if(this.settings.core.force_text){C.childNodes[1].appendChild(L.createTextNode(x.text))}else{C.childNodes[1].innerHTML+=x.text}if(H&&x.children.length&&(x.state.opened||K)&&x.state.loaded){F=L.createElement("UL");F.setAttribute("role","group");F.className="jstree-children";for(I=0,G=x.children.length;I<G;I++){F.appendChild(this.redraw_node(x.children[I],H,true))}C.appendChild(F)}if(r){C.appendChild(r)}if(!u){if(!B){B=this.element[0]}for(I=0,G=B.childNodes.length;I<G;I++){if(B.childNodes[I]&&B.childNodes[I].className&&B.childNodes[I].className.indexOf("jstree-children")!==-1){N=B.childNodes[I];break}}if(!N){N=L.createElement("UL");N.setAttribute("role","group");N.className="jstree-children";B.appendChild(N)}B=N;if(w<B.childNodes.length){B.insertBefore(C,B.childNodes[w])}else{B.appendChild(C)}if(J){y=this.element[0].scrollTop;E=this.element[0].scrollLeft;C.childNodes[1].focus();this.element[0].scrollTop=y;this.element[0].scrollLeft=E}}if(x.state.opened&&!x.state.loaded){x.state.opened=false;setTimeout(i.proxy(function(){this.open_node(x.id,false,0)},this),0)}return C},open_node:function(w,y,v){var u,s,x,r;if(i.isArray(w)){w=w.slice();for(u=0,s=w.length;u<s;u++){this.open_node(w[u],y,v)}return true}w=this.get_node(w);if(!w||w.id===i.jstree.root){return false}v=v===e?this.settings.core.animation:v;if(!this.is_closed(w)){if(y){y.call(this,w,false)}return false}if(!this.is_loaded(w)){if(this.is_loading(w)){return setTimeout(i.proxy(function(){this.open_node(w,y,v)},this),500)}this.load_node(w,function(z,t){return t?this.open_node(z,y,v):(y?y.call(this,z,false):false)})}else{x=this.get_node(w,true);r=this;if(x.length){if(v&&x.children(".jstree-children").length){x.children(".jstree-children").stop(true,true)}if(w.children.length&&!this._firstChild(x.children(".jstree-children")[0])){this.draw_children(w)}if(!v){this.trigger("before_open",{node:w});x[0].className=x[0].className.replace("jstree-closed","jstree-open");x[0].setAttribute("aria-expanded",true)}else{this.trigger("before_open",{node:w});x.children(".jstree-children").css("display","none").end().removeClass("jstree-closed").addClass("jstree-open").attr("aria-expanded",true).children(".jstree-children").stop(true,true).slideDown(v,function(){this.style.display="";r.trigger("after_open",{node:w})})}}w.state.opened=true;if(y){y.call(this,w,true)}if(!x.length){this.trigger("before_open",{node:w})}this.trigger("open_node",{node:w});if(!v||!x.length){this.trigger("after_open",{node:w})}return true}},_open_to:function(u){u=this.get_node(u);if(!u||u.id===i.jstree.root){return false}var s,r,t=u.parents;for(s=0,r=t.length;s<r;s+=1){if(s!==i.jstree.root){this.open_node(t[s],false,0)}}return i("#"+u.id.replace(i.jstree.idregex,"\\$&"),this.element)},close_node:function(w,v){var u,s,r,x;if(i.isArray(w)){w=w.slice();for(u=0,s=w.length;u<s;u++){this.close_node(w[u],v)}return true}w=this.get_node(w);if(!w||w.id===i.jstree.root){return false}if(this.is_closed(w)){return false}v=v===e?this.settings.core.animation:v;r=this;x=this.get_node(w,true);if(x.length){if(!v){x[0].className=x[0].className.replace("jstree-open","jstree-closed");x.attr("aria-expanded",false).children(".jstree-children").remove()}else{x.children(".jstree-children").attr("style","display:block !important").end().removeClass("jstree-open").addClass("jstree-closed").attr("aria-expanded",false).children(".jstree-children").stop(true,true).slideUp(v,function(){this.style.display="";x.children(".jstree-children").remove();r.trigger("after_close",{node:w})})}}w.state.opened=false;this.trigger("close_node",{node:w});if(!v||!x.length){this.trigger("after_close",{node:w})}},toggle_node:function(t){var s,r;if(i.isArray(t)){t=t.slice();for(s=0,r=t.length;s<r;s++){this.toggle_node(t[s])}return true}if(this.is_closed(t)){return this.open_node(t)}if(this.is_open(t)){return this.close_node(t)}},open_all:function(v,u,r){if(!v){v=i.jstree.root}v=this.get_node(v);if(!v){return false}var w=v.id===i.jstree.root?this.get_container_ul():this.get_node(v,true),t,s,x;if(!w.length){for(t=0,s=v.children_d.length;t<s;t++){if(this.is_closed(this._model.data[v.children_d[t]])){this._model.data[v.children_d[t]].state.opened=true}}return this.trigger("open_all",{node:v})}r=r||w;x=this;w=this.is_closed(v)?w.find(".jstree-closed").addBack():w.find(".jstree-closed");w.each(function(){x.open_node(this,function(z,y){if(y&&this.is_parent(z)){this.open_all(z,u,r)}},u||0)});if(r.find(".jstree-closed").length===0){this.trigger("open_all",{node:this.get_node(r)})}},close_all:function(u,t){if(!u){u=i.jstree.root}u=this.get_node(u);if(!u){return false}var v=u.id===i.jstree.root?this.get_container_ul():this.get_node(u,true),w=this,s,r;if(v.length){v=this.is_open(u)?v.find(".jstree-open").addBack():v.find(".jstree-open");i(v.get().reverse()).each(function(){w.close_node(this,t||0)})}for(s=0,r=u.children_d.length;s<r;s++){this._model.data[u.children_d[s]].state.opened=false}this.trigger("close_all",{node:u})},is_disabled:function(r){r=this.get_node(r);return r&&r.state&&r.state.disabled},enable_node:function(t){var s,r;if(i.isArray(t)){t=t.slice();for(s=0,r=t.length;s<r;s++){this.enable_node(t[s])}return true}t=this.get_node(t);if(!t||t.id===i.jstree.root){return false}t.state.disabled=false;this.get_node(t,true).children(".jstree-anchor").removeClass("jstree-disabled").attr("aria-disabled",false);this.trigger("enable_node",{node:t})},disable_node:function(t){var s,r;if(i.isArray(t)){t=t.slice();for(s=0,r=t.length;s<r;s++){this.disable_node(t[s])}return true}t=this.get_node(t);if(!t||t.id===i.jstree.root){return false}t.state.disabled=true;this.get_node(t,true).children(".jstree-anchor").addClass("jstree-disabled").attr("aria-disabled",true);this.trigger("disable_node",{node:t})},hide_node:function(u,t){var s,r;if(i.isArray(u)){u=u.slice();for(s=0,r=u.length;s<r;s++){this.hide_node(u[s],true)}this.redraw();return true}u=this.get_node(u);if(!u||u.id===i.jstree.root){return false}if(!u.state.hidden){u.state.hidden=true;this._node_changed(u.parent);if(!t){this.redraw()}this.trigger("hide_node",{node:u})}},show_node:function(u,t){var s,r;if(i.isArray(u)){u=u.slice();for(s=0,r=u.length;s<r;s++){this.show_node(u[s],true)}this.redraw();return true}u=this.get_node(u);if(!u||u.id===i.jstree.root){return false}if(u.state.hidden){u.state.hidden=false;this._node_changed(u.parent);if(!t){this.redraw()}this.trigger("show_node",{node:u})}},hide_all:function(u){var s,r=this._model.data,t=[];for(s in r){if(r.hasOwnProperty(s)&&s!==i.jstree.root&&!r[s].state.hidden){r[s].state.hidden=true;t.push(s)}}this._model.force_full_redraw=true;if(!u){this.redraw()}this.trigger("hide_all",{nodes:t});return t},show_all:function(u){var s,r=this._model.data,t=[];for(s in r){if(r.hasOwnProperty(s)&&s!==i.jstree.root&&r[s].state.hidden){r[s].state.hidden=false;t.push(s)}}this._model.force_full_redraw=true;if(!u){this.redraw()}this.trigger("show_all",{nodes:t});return t},activate_node:function(w,v){if(this.is_disabled(w)){return false}if(!v||typeof v!=="object"){v={}}this._data.core.last_clicked=this._data.core.last_clicked&&this._data.core.last_clicked.id!==e?this.get_node(this._data.core.last_clicked.id):null;if(this._data.core.last_clicked&&!this._data.core.last_clicked.state.selected){this._data.core.last_clicked=null}if(!this._data.core.last_clicked&&this._data.core.selected.length){this._data.core.last_clicked=this.get_node(this._data.core.selected[this._data.core.selected.length-1])}if(!this.settings.core.multiple||(!v.metaKey&&!v.ctrlKey&&!v.shiftKey)||(v.shiftKey&&(!this._data.core.last_clicked||!this.get_parent(w)||this.get_parent(w)!==this._data.core.last_clicked.parent))){if(!this.settings.core.multiple&&(v.metaKey||v.ctrlKey||v.shiftKey)&&this.is_selected(w)){this.deselect_node(w,false,v)}else{this.deselect_all(true);this.select_node(w,false,false,v);this._data.core.last_clicked=this.get_node(w)}}else{if(v.shiftKey){var x=this.get_node(w).id,r=this._data.core.last_clicked.id,u=this.get_node(this._data.core.last_clicked.parent).children,y=false,t,s;for(t=0,s=u.length;t<s;t+=1){if(u[t]===x){y=!y}if(u[t]===r){y=!y}if(!this.is_disabled(u[t])&&(y||u[t]===x||u[t]===r)){this.select_node(u[t],true,false,v)}else{this.deselect_node(u[t],true,v)}}this.trigger("changed",{action:"select_node",node:this.get_node(w),selected:this._data.core.selected,event:v})}else{if(!this.is_selected(w)){this.select_node(w,false,false,v)}else{this.deselect_node(w,false,v)}}}this.trigger("activate_node",{node:this.get_node(w),event:v})},hover_node:function(s){s=this.get_node(s,true);if(!s||!s.length||s.children(".jstree-hovered").length){return false}var u=this.element.find(".jstree-hovered"),r=this.element;if(u&&u.length){this.dehover_node(u)}s.children(".jstree-anchor").addClass("jstree-hovered");this.trigger("hover_node",{node:this.get_node(s)});setTimeout(function(){r.attr("aria-activedescendant",s[0].id)},0)},dehover_node:function(r){r=this.get_node(r,true);if(!r||!r.length||!r.children(".jstree-hovered").length){return false}r.children(".jstree-anchor").removeClass("jstree-hovered");this.trigger("dehover_node",{node:this.get_node(r)})},select_node:function(w,y,r,v){var x,u,s,t;if(i.isArray(w)){w=w.slice();for(u=0,s=w.length;u<s;u++){this.select_node(w[u],y,r,v)}return true}w=this.get_node(w);if(!w||w.id===i.jstree.root){return false}x=this.get_node(w,true);if(!w.state.selected){w.state.selected=true;this._data.core.selected.push(w.id);if(!r){x=this._open_to(w)}if(x&&x.length){x.attr("aria-selected",true).children(".jstree-anchor").addClass("jstree-clicked")}this.trigger("select_node",{node:w,selected:this._data.core.selected,event:v});if(!y){this.trigger("changed",{action:"select_node",node:w,selected:this._data.core.selected,event:v})}}},deselect_node:function(u,w,t){var s,r,v;if(i.isArray(u)){u=u.slice();for(s=0,r=u.length;s<r;s++){this.deselect_node(u[s],w,t)}return true}u=this.get_node(u);if(!u||u.id===i.jstree.root){return false}v=this.get_node(u,true);if(u.state.selected){u.state.selected=false;this._data.core.selected=i.vakata.array_remove_item(this._data.core.selected,u.id);if(v.length){v.attr("aria-selected",false).children(".jstree-anchor").removeClass("jstree-clicked")}this.trigger("deselect_node",{node:u,selected:this._data.core.selected,event:t});if(!w){this.trigger("changed",{action:"deselect_node",node:u,selected:this._data.core.selected,event:t})}}},select_all:function(u){var t=this._data.core.selected.concat([]),s,r;this._data.core.selected=this._model.data[i.jstree.root].children_d.concat();for(s=0,r=this._data.core.selected.length;s<r;s++){if(this._model.data[this._data.core.selected[s]]){this._model.data[this._data.core.selected[s]].state.selected=true}}this.redraw(true);this.trigger("select_all",{selected:this._data.core.selected});if(!u){this.trigger("changed",{action:"select_all",selected:this._data.core.selected,old_selection:t})}},deselect_all:function(u){var t=this._data.core.selected.concat([]),s,r;for(s=0,r=this._data.core.selected.length;s<r;s++){if(this._model.data[this._data.core.selected[s]]){this._model.data[this._data.core.selected[s]].state.selected=false}}this._data.core.selected=[];this.element.find(".jstree-clicked").removeClass("jstree-clicked").parent().attr("aria-selected",false);this.trigger("deselect_all",{selected:this._data.core.selected,node:t});if(!u){this.trigger("changed",{action:"deselect_all",selected:this._data.core.selected,old_selection:t})}},is_selected:function(r){r=this.get_node(r);if(!r||r.id===i.jstree.root){return false}return r.state.selected},get_selected:function(r){return r?i.map(this._data.core.selected,i.proxy(function(s){return this.get_node(s)},this)):this._data.core.selected.slice()},get_top_selected:function(w){var v=this.get_selected(true),x={},u,t,s,r;for(u=0,t=v.length;u<t;u++){x[v[u].id]=v[u]}for(u=0,t=v.length;u<t;u++){for(s=0,r=v[u].children_d.length;s<r;s++){if(x[v[u].children_d[s]]){delete x[v[u].children_d[s]]}}}v=[];for(u in x){if(x.hasOwnProperty(u)){v.push(u)}}return w?i.map(v,i.proxy(function(y){return this.get_node(y)},this)):v},get_bottom_selected:function(u){var t=this.get_selected(true),v=[],s,r;for(s=0,r=t.length;s<r;s++){if(!t[s].children.length){v.push(t[s].id)}}return u?i.map(v,i.proxy(function(w){return this.get_node(w)},this)):v},get_state:function(){var s={core:{open:[],scroll:{left:this.element.scrollLeft(),top:this.element.scrollTop()},
/*
					'themes' : {
						'name' : this.get_theme(),
						'icons' : this._data.core.themes.icons,
						'dots' : this._data.core.themes.dots
					},
					*/
selected:[]}},r;for(r in this._model.data){if(this._model.data.hasOwnProperty(r)){if(r!==i.jstree.root){if(this._model.data[r].state.opened){s.core.open.push(r)}if(this._model.data[r].state.selected){s.core.selected.push(r)}}}}return s},set_state:function(v,y){if(v){if(v.core){var u,x,s,w,r;if(v.core.open){if(!i.isArray(v.core.open)||!v.core.open.length){delete v.core.open;this.set_state(v,y)}else{this._load_nodes(v.core.open,function(t){this.open_node(t,false,0);delete v.core.open;this.set_state(v,y)},true)}return false}if(v.core.scroll){if(v.core.scroll&&v.core.scroll.left!==e){this.element.scrollLeft(v.core.scroll.left)}if(v.core.scroll&&v.core.scroll.top!==e){this.element.scrollTop(v.core.scroll.top)}delete v.core.scroll;this.set_state(v,y);return false}if(v.core.selected){w=this;this.deselect_all();i.each(v.core.selected,function(z,t){w.select_node(t,false,true)});delete v.core.selected;this.set_state(v,y);return false}for(r in v){if(v.hasOwnProperty(r)&&r!=="core"&&i.inArray(r,this.settings.plugins)===-1){delete v[r]}}if(i.isEmptyObject(v.core)){delete v.core;this.set_state(v,y);return false}}if(i.isEmptyObject(v)){v=null;if(y){y.call(this)}this.trigger("set_state");return false}return true}return false},refresh:function(s,r){this._data.core.state=r===true?{}:this.get_state();if(r&&i.isFunction(r)){this._data.core.state=r.call(this,this._data.core.state)}this._cnt=0;this._model.data={};this._model.data[i.jstree.root]={id:i.jstree.root,parent:null,parents:[],children:[],children_d:[],state:{loaded:false}};this._data.core.selected=[];this._data.core.last_clicked=null;this._data.core.focused=null;var t=this.get_container_ul()[0].className;if(!s){this.element.html("<ul class='"+t+"' role='group'><li class='jstree-initial-node jstree-loading jstree-leaf jstree-last' role='treeitem' id='j"+this._id+"_loading'><i class='jstree-icon jstree-ocl'></i><a class='jstree-anchor' href='#'><i class='jstree-icon jstree-themeicon-hidden'></i>"+this.get_string("Loading ...")+"</a></li></ul>");this.element.attr("aria-activedescendant","j"+this._id+"_loading")}this.load_node(i.jstree.root,function(v,u){if(u){this.get_container_ul()[0].className=t;if(this._firstChild(this.get_container_ul()[0])){this.element.attr("aria-activedescendant",this._firstChild(this.get_container_ul()[0]).id)}this.set_state(i.extend(true,{},this._data.core.state),function(){this.trigger("refresh")})}this._data.core.state=null})},refresh_node:function(u){u=this.get_node(u);if(!u||u.id===i.jstree.root){return false}var v=[],r=[],t=this._data.core.selected.concat([]);r.push(u.id);if(u.state.opened===true){v.push(u.id)}this.get_node(u,true).find(".jstree-open").each(function(){v.push(this.id)});this._load_nodes(r,i.proxy(function(s){this.open_node(v,false,0);this.select_node(this._data.core.selected);this.trigger("refresh_node",{node:u,nodes:s})},this))},set_id:function(u,v){u=this.get_node(u);if(!u||u.id===i.jstree.root){return false}var t,s,r=this._model.data;v=v.toString();r[u.parent].children[i.inArray(u.id,r[u.parent].children)]=v;for(t=0,s=u.parents.length;t<s;t++){r[u.parents[t]].children_d[i.inArray(u.id,r[u.parents[t]].children_d)]=v}for(t=0,s=u.children.length;t<s;t++){r[u.children[t]].parent=v}for(t=0,s=u.children_d.length;t<s;t++){r[u.children_d[t]].parents[i.inArray(u.id,r[u.children_d[t]].parents)]=v}t=i.inArray(u.id,this._data.core.selected);if(t!==-1){this._data.core.selected[t]=v}t=this.get_node(u.id,true);if(t){t.attr("id",v).children(".jstree-anchor").attr("id",v+"_anchor").end().attr("aria-labelledby",v+"_anchor");if(this.element.attr("aria-activedescendant")===u.id){this.element.attr("aria-activedescendant",v)}}delete r[u.id];u.id=v;u.li_attr.id=v;r[v]=u;return true},get_text:function(r){r=this.get_node(r);return(!r||r.id===i.jstree.root)?false:r.text},set_text:function(t,u){var s,r;if(i.isArray(t)){t=t.slice();for(s=0,r=t.length;s<r;s++){this.set_text(t[s],u)}return true}t=this.get_node(t);if(!t||t.id===i.jstree.root){return false}t.text=u;if(this.get_node(t,true).length){this.redraw_node(t.id)}this.trigger("set_text",{obj:t,text:u});return true},get_json:function(v,s,w){v=this.get_node(v||i.jstree.root);if(!v){return false}if(s&&s.flat&&!w){w=[]}var u={id:v.id,text:v.text,icon:this.get_icon(v),li_attr:i.extend(true,{},v.li_attr),a_attr:i.extend(true,{},v.a_attr),state:{},data:s&&s.no_data?false:i.extend(true,{},v.data)},t,r;if(s&&s.flat){u.parent=v.parent}else{u.children=[]}if(!s||!s.no_state){for(t in v.state){if(v.state.hasOwnProperty(t)){u.state[t]=v.state[t]}}}if(s&&s.no_id){delete u.id;if(u.li_attr&&u.li_attr.id){delete u.li_attr.id}if(u.a_attr&&u.a_attr.id){delete u.a_attr.id}}if(s&&s.flat&&v.id!==i.jstree.root){w.push(u)}if(!s||!s.no_children){for(t=0,r=v.children.length;t<r;t++){if(s&&s.flat){this.get_json(v.children[t],s,w)}else{u.children.push(this.get_json(v.children[t],s))}}}return s&&s.flat?w:(v.id===i.jstree.root?u.children:u)},create_node:function(w,r,y,z,x){if(w===null){w=i.jstree.root}w=this.get_node(w);if(!w){return false}y=y===e?"last":y;if(!y.toString().match(/^(before|after)$/)&&!x&&!this.is_loaded(w)){return this.load_node(w,function(){this.create_node(w,r,y,z,true)})}if(!r){r={text:this.get_string("New node")}}if(typeof r==="string"){r={text:r}}if(r.text===e){r.text=this.get_string("New node")}var t,v,u,s;if(w.id===i.jstree.root){if(y==="before"){y="first"}if(y==="after"){y="last"}}switch(y){case"before":t=this.get_node(w.parent);y=i.inArray(w.id,t.children);w=t;break;case"after":t=this.get_node(w.parent);y=i.inArray(w.id,t.children)+1;w=t;break;case"inside":case"first":y=0;break;case"last":y=w.children.length;break;default:if(!y){y=0}break}if(y>w.children.length){y=w.children.length}if(!r.id){r.id=true}if(!this.check("create_node",r,w,y)){this.settings.core.error.call(this,this._data.core.last_error);return false}if(r.id===true){delete r.id}r=this._parse_model_from_json(r,w.id,w.parents.concat());if(!r){return false}t=this.get_node(r);v=[];v.push(r);v=v.concat(t.children_d);this.trigger("model",{nodes:v,parent:w.id});w.children_d=w.children_d.concat(v);for(u=0,s=w.parents.length;u<s;u++){this._model.data[w.parents[u]].children_d=this._model.data[w.parents[u]].children_d.concat(v)}r=t;t=[];for(u=0,s=w.children.length;u<s;u++){t[u>=y?u+1:u]=w.children[u]}t[y]=r.id;w.children=t;this.redraw_node(w,true);if(z){z.call(this,this.get_node(r))}this.trigger("create_node",{node:this.get_node(r),parent:w.id,position:y});return r.id},rename_node:function(u,v){var t,s,r;if(i.isArray(u)){u=u.slice();for(t=0,s=u.length;t<s;t++){this.rename_node(u[t],v)}return true}u=this.get_node(u);if(!u||u.id===i.jstree.root){return false}r=u.text;if(!this.check("rename_node",u,this.get_parent(u),v)){this.settings.core.error.call(this,this._data.core.last_error);return false}this.set_text(u,v);this.trigger("rename_node",{node:u,text:v,old:r});return true},delete_node:function(u){var y,x,z,C,v,w,t,s,r,A,B,D;if(i.isArray(u)){u=u.slice();for(y=0,x=u.length;y<x;y++){this.delete_node(u[y])}return true}u=this.get_node(u);if(!u||u.id===i.jstree.root){return false}z=this.get_node(u.parent);C=i.inArray(u.id,z.children);A=false;if(!this.check("delete_node",u,z,C)){this.settings.core.error.call(this,this._data.core.last_error);return false}if(C!==-1){z.children=i.vakata.array_remove(z.children,C)}v=u.children_d.concat([]);v.push(u.id);for(s=0,r=v.length;s<r;s++){for(w=0,t=u.parents.length;w<t;w++){C=i.inArray(v[s],this._model.data[u.parents[w]].children_d);if(C!==-1){this._model.data[u.parents[w]].children_d=i.vakata.array_remove(this._model.data[u.parents[w]].children_d,C)}}if(this._model.data[v[s]].state.selected){A=true;C=i.inArray(v[s],this._data.core.selected);if(C!==-1){this._data.core.selected=i.vakata.array_remove(this._data.core.selected,C)}}}this.trigger("delete_node",{node:u,parent:z.id});if(A){this.trigger("changed",{action:"delete_node",node:u,selected:this._data.core.selected,parent:z.id})}for(s=0,r=v.length;s<r;s++){delete this._model.data[v[s]]}if(i.inArray(this._data.core.focused,v)!==-1){this._data.core.focused=null;B=this.element[0].scrollTop;D=this.element[0].scrollLeft;if(z.id===i.jstree.root){this.get_node(this._model.data[i.jstree.root].children[0],true).children(".jstree-anchor").focus()}else{this.get_node(z,true).children(".jstree-anchor").focus()}this.element[0].scrollTop=B;this.element[0].scrollLeft=D}this.redraw_node(z,true);return true},check:function(r,v,u,x,t){v=v&&v.id?v:this.get_node(v);u=u&&u.id?u:this.get_node(u);var s=r.match(/^move_node|copy_node|create_node$/i)?u:v,w=this.settings.core.check_callback;if(r==="move_node"||r==="copy_node"){if((!t||!t.is_multi)&&(v.id===u.id||i.inArray(v.id,u.children)===x||i.inArray(u.id,v.children_d)!==-1)){this._data.core.last_error={error:"check",plugin:"core",id:"core_01",reason:"Moving parent inside child",data:JSON.stringify({chk:r,pos:x,obj:v&&v.id?v.id:false,par:u&&u.id?u.id:false})};return false}}if(s&&s.data){s=s.data}if(s&&s.functions&&(s.functions[r]===false||s.functions[r]===true)){if(s.functions[r]===false){this._data.core.last_error={error:"check",plugin:"core",id:"core_02",reason:"Node data prevents function: "+r,data:JSON.stringify({chk:r,pos:x,obj:v&&v.id?v.id:false,par:u&&u.id?u.id:false})}}return s.functions[r]}if(w===false||(i.isFunction(w)&&w.call(this,r,v,u,x,t)===false)||(w&&w[r]===false)){this._data.core.last_error={error:"check",plugin:"core",id:"core_03",reason:"User config for core.check_callback prevents function: "+r,data:JSON.stringify({chk:r,pos:x,obj:v&&v.id?v.id:false,par:u&&u.id?u.id:false})};return false}return true},last_error:function(){return this._data.core.last_error},move_node:function(z,B,u,s,A,H,K){var x,w,y,r,J,L,t,v,I,G,F,E,D,C;B=this.get_node(B);u=u===e?0:u;if(!B){return false}if(!u.toString().match(/^(before|after)$/)&&!A&&!this.is_loaded(B)){return this.load_node(B,function(){this.move_node(z,B,u,s,true,false,K)})}if(i.isArray(z)){if(z.length===1){z=z[0]}else{for(x=0,w=z.length;x<w;x++){if((I=this.move_node(z[x],B,u,s,A,false,K))){B=I;u="after"}}this.redraw();return true}}z=z&&z.id?z:this.get_node(z);if(!z||z.id===i.jstree.root){return false}y=(z.parent||i.jstree.root).toString();J=(!u.toString().match(/^(before|after)$/)||B.id===i.jstree.root)?B:this.get_node(B.parent);L=K?K:(this._model.data[z.id]?this:i.jstree.reference(z.id));t=!L||!L._id||(this._id!==L._id);r=L&&L._id&&y&&L._model.data[y]&&L._model.data[y].children?i.inArray(z.id,L._model.data[y].children):-1;if(L&&L._id){z=L._model.data[z.id]}if(t){if((I=this.copy_node(z,B,u,s,A,false,K))){if(L){L.delete_node(z)}return I}return false}if(B.id===i.jstree.root){if(u==="before"){u="first"}if(u==="after"){u="last"}}switch(u){case"before":u=i.inArray(B.id,J.children);break;case"after":u=i.inArray(B.id,J.children)+1;break;case"inside":case"first":u=0;break;case"last":u=J.children.length;break;default:if(!u){u=0}break}if(u>J.children.length){u=J.children.length}if(!this.check("move_node",z,J,u,{core:true,origin:K,is_multi:(L&&L._id&&L._id!==this._id),is_foreign:(!L||!L._id)})){this.settings.core.error.call(this,this._data.core.last_error);return false}if(z.parent===J.id){v=J.children.concat();I=i.inArray(z.id,v);if(I!==-1){v=i.vakata.array_remove(v,I);if(u>I){u--}}I=[];for(G=0,F=v.length;G<F;G++){I[G>=u?G+1:G]=v[G]}I[u]=z.id;J.children=I;this._node_changed(J.id);this.redraw(J.id===i.jstree.root)}else{I=z.children_d.concat();I.push(z.id);for(G=0,F=z.parents.length;G<F;G++){v=[];C=L._model.data[z.parents[G]].children_d;for(E=0,D=C.length;E<D;E++){if(i.inArray(C[E],I)===-1){v.push(C[E])}}L._model.data[z.parents[G]].children_d=v}L._model.data[y].children=i.vakata.array_remove_item(L._model.data[y].children,z.id);for(G=0,F=J.parents.length;G<F;G++){this._model.data[J.parents[G]].children_d=this._model.data[J.parents[G]].children_d.concat(I)}v=[];for(G=0,F=J.children.length;G<F;G++){v[G>=u?G+1:G]=J.children[G]}v[u]=z.id;J.children=v;J.children_d.push(z.id);J.children_d=J.children_d.concat(z.children_d);z.parent=J.id;I=J.parents.concat();I.unshift(J.id);C=z.parents.length;z.parents=I;I=I.concat();for(G=0,F=z.children_d.length;G<F;G++){this._model.data[z.children_d[G]].parents=this._model.data[z.children_d[G]].parents.slice(0,C*-1);Array.prototype.push.apply(this._model.data[z.children_d[G]].parents,I)}if(y===i.jstree.root||J.id===i.jstree.root){this._model.force_full_redraw=true}if(!this._model.force_full_redraw){this._node_changed(y);this._node_changed(J.id)}if(!H){this.redraw()}}if(s){s.call(this,z,J,u)}this.trigger("move_node",{node:z,parent:J.id,position:u,old_parent:y,old_position:r,is_multi:(L&&L._id&&L._id!==this._id),is_foreign:(!L||!L._id),old_instance:L,new_instance:this});return z.id},copy_node:function(y,A,t,s,z,E,H){var w,v,u,F,D,C,B,x,G,I,r;A=this.get_node(A);t=t===e?0:t;if(!A){return false}if(!t.toString().match(/^(before|after)$/)&&!z&&!this.is_loaded(A)){return this.load_node(A,function(){this.copy_node(y,A,t,s,true,false,H)})}if(i.isArray(y)){if(y.length===1){y=y[0]}else{for(w=0,v=y.length;w<v;w++){if((F=this.copy_node(y[w],A,t,s,z,true,H))){A=F;t="after"}}this.redraw();return true}}y=y&&y.id?y:this.get_node(y);if(!y||y.id===i.jstree.root){return false}x=(y.parent||i.jstree.root).toString();G=(!t.toString().match(/^(before|after)$/)||A.id===i.jstree.root)?A:this.get_node(A.parent);I=H?H:(this._model.data[y.id]?this:i.jstree.reference(y.id));r=!I||!I._id||(this._id!==I._id);if(I&&I._id){y=I._model.data[y.id]}if(A.id===i.jstree.root){if(t==="before"){t="first"}if(t==="after"){t="last"}}switch(t){case"before":t=i.inArray(A.id,G.children);break;case"after":t=i.inArray(A.id,G.children)+1;break;case"inside":case"first":t=0;break;case"last":t=G.children.length;break;default:if(!t){t=0}break}if(t>G.children.length){t=G.children.length}if(!this.check("copy_node",y,G,t,{core:true,origin:H,is_multi:(I&&I._id&&I._id!==this._id),is_foreign:(!I||!I._id)})){this.settings.core.error.call(this,this._data.core.last_error);return false}B=I?I.get_json(y,{no_id:true,no_data:true,no_state:true}):y;if(!B){return false}if(B.id===true){delete B.id}B=this._parse_model_from_json(B,G.id,G.parents.concat());if(!B){return false}F=this.get_node(B);if(y&&y.state&&y.state.loaded===false){F.state.loaded=false}u=[];u.push(B);u=u.concat(F.children_d);this.trigger("model",{nodes:u,parent:G.id});for(D=0,C=G.parents.length;D<C;D++){this._model.data[G.parents[D]].children_d=this._model.data[G.parents[D]].children_d.concat(u)}u=[];for(D=0,C=G.children.length;D<C;D++){u[D>=t?D+1:D]=G.children[D]}u[t]=F.id;G.children=u;G.children_d.push(F.id);G.children_d=G.children_d.concat(F.children_d);if(G.id===i.jstree.root){this._model.force_full_redraw=true}if(!this._model.force_full_redraw){this._node_changed(G.id)}if(!E){this.redraw(G.id===i.jstree.root)}if(s){s.call(this,F,G,t)}this.trigger("copy_node",{node:F,original:y,parent:G.id,position:t,old_parent:x,old_position:I&&I._id&&x&&I._model.data[x]&&I._model.data[x].children?i.inArray(y.id,I._model.data[x].children):-1,is_multi:(I&&I._id&&I._id!==this._id),is_foreign:(!I||!I._id),old_instance:I,new_instance:this});return F.id},cut:function(u){if(!u){u=this._data.core.selected.concat()}if(!i.isArray(u)){u=[u]}if(!u.length){return false}var r=[],v,t,s;for(t=0,s=u.length;t<s;t++){v=this.get_node(u[t]);if(v&&v.id&&v.id!==i.jstree.root){r.push(v)}}if(!r.length){return false}d=r;j=this;l="move_node";this.trigger("cut",{node:u})},copy:function(u){if(!u){u=this._data.core.selected.concat()}if(!i.isArray(u)){u=[u]}if(!u.length){return false}var r=[],v,t,s;for(t=0,s=u.length;t<s;t++){v=this.get_node(u[t]);if(v&&v.id&&v.id!==i.jstree.root){r.push(v)}}if(!r.length){return false}d=r;j=this;l="copy_node";this.trigger("copy",{node:u})},get_buffer:function(){return{mode:l,node:d,inst:j}},can_paste:function(){return l!==false&&d!==false},paste:function(r,s){r=this.get_node(r);if(!r||!l||!l.match(/^(copy_node|move_node)$/)||!d){return false}if(this[l](d,r,s,false,false,false,j)){this.trigger("paste",{parent:r.id,node:d,mode:l})}d=false;l=false;j=false},clear_buffer:function(){d=false;l=false;j=false;this.trigger("clear_buffer")},edit:function(u,A,D){var z,C,B,G,F,x,v,y,r,E=false;u=this.get_node(u);if(!u){return false}if(this.settings.core.check_callback===false){this._data.core.last_error={error:"check",plugin:"core",id:"core_07",reason:"Could not edit node because of check_callback"};this.settings.core.error.call(this,this._data.core.last_error);return false}r=u;A=typeof A==="string"?A:u.text;this.set_text(u,"");u=this._open_to(u);r.text=A;z=this._data.core.rtl;C=this.element.width();this._data.core.focused=r.id;B=u.children(".jstree-anchor").focus();G=i("<span>");
/*
			oi = obj.children("i:visible"),
			ai = a.children("i:visible"),
			w1 = oi.width() * oi.length,
			w2 = ai.width() * ai.length,
			*/
F=A;x=i("<div />",{css:{position:"absolute",top:"-200px",left:(z?"0px":"-1000px"),visibility:"hidden"}}).appendTo("body");v=i("<input />",{value:F,"class":"jstree-rename-input",css:{padding:"0",border:"1px solid silver","box-sizing":"border-box",display:"inline-block",height:(this._data.core.li_height)+"px",lineHeight:(this._data.core.li_height)+"px",width:"150px"},blur:i.proxy(function(I){I.stopImmediatePropagation();I.preventDefault();var w=G.children(".jstree-rename-input"),t=w.val(),H=this.settings.core.force_text,s;if(t===""){t=F}x.remove();G.replaceWith(B);G.remove();F=H?F:i("<div></div>").append(i.parseHTML(F)).html();this.set_text(u,F);s=!!this.rename_node(u,H?i("<div></div>").text(t).text():i("<div></div>").append(i.parseHTML(t)).html());if(!s){this.set_text(u,F)}this._data.core.focused=r.id;setTimeout(i.proxy(function(){var J=this.get_node(r.id,true);if(J.length){this._data.core.focused=r.id;J.children(".jstree-anchor").focus()}},this),0);if(D){D.call(this,r,s,E)}},this),keydown:function(t){var s=t.which;if(s===27){E=true;this.value=F}if(s===27||s===13||s===37||s===38||s===39||s===40||s===32){t.stopImmediatePropagation()}if(s===27||s===13){t.preventDefault();this.blur()}},click:function(s){s.stopImmediatePropagation()},mousedown:function(s){s.stopImmediatePropagation()},keyup:function(s){v.width(Math.min(x.text("pW"+this.value).width(),C))},keypress:function(s){if(s.which===13){return false}}});y={fontFamily:B.css("fontFamily")||"",fontSize:B.css("fontSize")||"",fontWeight:B.css("fontWeight")||"",fontStyle:B.css("fontStyle")||"",fontStretch:B.css("fontStretch")||"",fontVariant:B.css("fontVariant")||"",letterSpacing:B.css("letterSpacing")||"",wordSpacing:B.css("wordSpacing")||""};G.attr("class",B.attr("class")).append(B.contents().clone()).append(v);B.replaceWith(G);x.css(y);v.css(y).width(Math.min(x.text("pW"+v[0].value).width(),C))[0].select()},set_theme:function(t,r){if(!t){return false}if(r===true){var s=this.settings.core.themes.dir;if(!s){s=i.jstree.path+"/themes"}r=s+"/"+t+"/style.css"}if(r&&i.inArray(r,n)===-1){i("head").append('<link rel="stylesheet" href="'+r+'" type="text/css" />');n.push(r)}if(this._data.core.themes.name){this.element.removeClass("jstree-"+this._data.core.themes.name)}this._data.core.themes.name=t;this.element.addClass("jstree-"+t);this.element[this.settings.core.themes.responsive?"addClass":"removeClass"]("jstree-"+t+"-responsive");this.trigger("set_theme",{theme:t})},get_theme:function(){return this._data.core.themes.name},set_theme_variant:function(r){if(this._data.core.themes.variant){this.element.removeClass("jstree-"+this._data.core.themes.name+"-"+this._data.core.themes.variant)}this._data.core.themes.variant=r;if(r){this.element.addClass("jstree-"+this._data.core.themes.name+"-"+this._data.core.themes.variant)}},get_theme_variant:function(){return this._data.core.themes.variant},show_stripes:function(){this._data.core.themes.stripes=true;this.get_container_ul().addClass("jstree-striped")},hide_stripes:function(){this._data.core.themes.stripes=false;this.get_container_ul().removeClass("jstree-striped")},toggle_stripes:function(){if(this._data.core.themes.stripes){this.hide_stripes()}else{this.show_stripes()}},show_dots:function(){this._data.core.themes.dots=true;this.get_container_ul().removeClass("jstree-no-dots")},hide_dots:function(){this._data.core.themes.dots=false;this.get_container_ul().addClass("jstree-no-dots")},toggle_dots:function(){if(this._data.core.themes.dots){this.hide_dots()}else{this.show_dots()}},show_icons:function(){this._data.core.themes.icons=true;this.get_container_ul().removeClass("jstree-no-icons")},hide_icons:function(){this._data.core.themes.icons=false;this.get_container_ul().addClass("jstree-no-icons")},toggle_icons:function(){if(this._data.core.themes.icons){this.hide_icons()}else{this.show_icons()}},set_icon:function(v,t){var u,s,w,r;if(i.isArray(v)){v=v.slice();for(u=0,s=v.length;u<s;u++){this.set_icon(v[u],t)}return true}v=this.get_node(v);if(!v||v.id===i.jstree.root){return false}r=v.icon;v.icon=t===true||t===null||t===e||t===""?true:t;w=this.get_node(v,true).children(".jstree-anchor").children(".jstree-themeicon");if(t===false){this.hide_icon(v)}else{if(t===true||t===null||t===e||t===""){w.removeClass("jstree-themeicon-custom "+r).css("background","").removeAttr("rel");if(r===false){this.show_icon(v)}}else{if(t.indexOf("/")===-1&&t.indexOf(".")===-1){w.removeClass(r).css("background","");w.addClass(t+" jstree-themeicon-custom").attr("rel",t);if(r===false){this.show_icon(v)}}else{w.removeClass(r).css("background","");w.addClass("jstree-themeicon-custom").css("background","url('"+t+"') center center no-repeat").attr("rel",t);if(r===false){this.show_icon(v)}}}}return true},get_icon:function(r){r=this.get_node(r);return(!r||r.id===i.jstree.root)?false:r.icon},hide_icon:function(t){var s,r;if(i.isArray(t)){t=t.slice();for(s=0,r=t.length;s<r;s++){this.hide_icon(t[s])}return true}t=this.get_node(t);if(!t||t===i.jstree.root){return false}t.icon=false;this.get_node(t,true).children(".jstree-anchor").children(".jstree-themeicon").addClass("jstree-themeicon-hidden");return true},show_icon:function(t){var s,r,u;if(i.isArray(t)){t=t.slice();for(s=0,r=t.length;s<r;s++){this.show_icon(t[s])}return true}t=this.get_node(t);if(!t||t===i.jstree.root){return false}u=this.get_node(t,true);t.icon=u.length?u.children(".jstree-anchor").children(".jstree-themeicon").attr("rel"):true;if(!t.icon){t.icon=true}u.children(".jstree-anchor").children(".jstree-themeicon").removeClass("jstree-themeicon-hidden");return true}};i.vakata={};i.vakata.attributes=function(s,t){s=i(s)[0];var r=t?{}:[];if(s&&s.attributes){i.each(s.attributes,function(w,u){if(i.inArray(u.name.toLowerCase(),["style","contenteditable","hasfocus","tabindex"])!==-1){return}if(u.value!==null&&i.trim(u.value)!==""){if(t){r[u.name]=u.value}else{r.push(u.name)}}})}return r};i.vakata.array_unique=function(w){var s=[],u,t,r,v={};for(u=0,r=w.length;u<r;u++){if(v[w[u]]===e){s.push(w[u]);v[w[u]]=true}}return s};i.vakata.array_remove=function(u,t,s){var r=u.slice((s||t)+1||u.length);u.length=t<0?u.length+t:t;u.push.apply(u,r);return u};i.vakata.array_remove_item=function(t,s){var r=i.inArray(s,t);return r!==-1?i.vakata.array_remove(t,r):t};i.jstree.plugins.changed=function(r,s){var t=[];this.trigger=function(x,y){var w,u;if(!y){y={}}if(x.replace(".jstree","")==="changed"){y.changed={selected:[],deselected:[]};var v={};for(w=0,u=t.length;w<u;w++){v[t[w]]=1}for(w=0,u=y.selected.length;w<u;w++){if(!v[y.selected[w]]){y.changed.selected.push(y.selected[w])}else{v[y.selected[w]]=2}}for(w=0,u=t.length;w<u;w++){if(v[t[w]]===1){y.changed.deselected.push(t[w])}}t=y.selected.slice()}s.trigger.call(this,x,y)};this.refresh=function(v,u){t=[];return s.refresh.apply(this,arguments)}};var h=o.createElement("I");h.className="jstree-icon jstree-checkbox";h.setAttribute("role","presentation");i.jstree.defaults.checkbox={visible:true,three_state:true,whole_node:true,keep_selected_style:true,cascade:"",tie_selection:true};i.jstree.plugins.checkbox=function(r,s){this.bind=function(){s.bind.call(this);this._data.checkbox.uto=false;this._data.checkbox.selected=[];if(this.settings.checkbox.three_state){this.settings.checkbox.cascade="up+down+undetermined"}this.element.on("init.jstree",i.proxy(function(){this._data.checkbox.visible=this.settings.checkbox.visible;if(!this.settings.checkbox.keep_selected_style){this.element.addClass("jstree-checkbox-no-clicked")}if(this.settings.checkbox.tie_selection){this.element.addClass("jstree-checkbox-selection")}},this)).on("loading.jstree",i.proxy(function(){this[this._data.checkbox.visible?"show_checkboxes":"hide_checkboxes"]()},this));if(this.settings.checkbox.cascade.indexOf("undetermined")!==-1){this.element.on("changed.jstree uncheck_node.jstree check_node.jstree uncheck_all.jstree check_all.jstree move_node.jstree copy_node.jstree redraw.jstree open_node.jstree",i.proxy(function(){if(this._data.checkbox.uto){clearTimeout(this._data.checkbox.uto)}this._data.checkbox.uto=setTimeout(i.proxy(this._undetermined,this),50)},this))}if(!this.settings.checkbox.tie_selection){this.element.on("model.jstree",i.proxy(function(y,w){var t=this._model.data,x=t[w.parent],z=w.nodes,v,u;for(v=0,u=z.length;v<u;v++){t[z[v]].state.checked=t[z[v]].state.checked||(t[z[v]].original&&t[z[v]].original.state&&t[z[v]].original.state.checked);if(t[z[v]].state.checked){this._data.checkbox.selected.push(z[v])}}},this))}if(this.settings.checkbox.cascade.indexOf("up")!==-1||this.settings.checkbox.cascade.indexOf("down")!==-1){this.element.on("model.jstree",i.proxy(function(D,A){var v=this._model.data,u=v[A.parent],C=A.nodes,H=[],E,B,y,x,w,z,G=this.settings.checkbox.cascade,F=this.settings.checkbox.tie_selection;if(G.indexOf("down")!==-1){if(u.state[F?"selected":"checked"]){for(B=0,y=C.length;B<y;B++){v[C[B]].state[F?"selected":"checked"]=true}this._data[F?"core":"checkbox"].selected=this._data[F?"core":"checkbox"].selected.concat(C)}else{for(B=0,y=C.length;B<y;B++){if(v[C[B]].state[F?"selected":"checked"]){for(x=0,w=v[C[B]].children_d.length;x<w;x++){v[v[C[B]].children_d[x]].state[F?"selected":"checked"]=true}this._data[F?"core":"checkbox"].selected=this._data[F?"core":"checkbox"].selected.concat(v[C[B]].children_d)}}}}if(G.indexOf("up")!==-1){for(B=0,y=u.children_d.length;B<y;B++){if(!v[u.children_d[B]].children.length){H.push(v[u.children_d[B]].parent)}}H=i.vakata.array_unique(H);for(x=0,w=H.length;x<w;x++){u=v[H[x]];while(u&&u.id!==i.jstree.root){E=0;for(B=0,y=u.children.length;B<y;B++){E+=v[u.children[B]].state[F?"selected":"checked"]}if(E===y){u.state[F?"selected":"checked"]=true;this._data[F?"core":"checkbox"].selected.push(u.id);z=this.get_node(u,true);if(z&&z.length){z.attr("aria-selected",true).children(".jstree-anchor").addClass(F?"jstree-clicked":"jstree-checked")}}else{break}u=this.get_node(u.parent)}}}this._data[F?"core":"checkbox"].selected=i.vakata.array_unique(this._data[F?"core":"checkbox"].selected)},this)).on(this.settings.checkbox.tie_selection?"select_node.jstree":"check_node.jstree",i.proxy(function(B,z){var y=z.node,u=this._model.data,C=this.get_node(y.parent),v=this.get_node(y,true),A,w,D,x,F=this.settings.checkbox.cascade,E=this.settings.checkbox.tie_selection;if(F.indexOf("down")!==-1){this._data[E?"core":"checkbox"].selected=i.vakata.array_unique(this._data[E?"core":"checkbox"].selected.concat(y.children_d));for(A=0,w=y.children_d.length;A<w;A++){x=u[y.children_d[A]];x.state[E?"selected":"checked"]=true;if(x&&x.original&&x.original.state&&x.original.state.undetermined){x.original.state.undetermined=false}}}if(F.indexOf("up")!==-1){while(C&&C.id!==i.jstree.root){D=0;for(A=0,w=C.children.length;A<w;A++){D+=u[C.children[A]].state[E?"selected":"checked"]}if(D===w){C.state[E?"selected":"checked"]=true;this._data[E?"core":"checkbox"].selected.push(C.id);x=this.get_node(C,true);if(x&&x.length){x.attr("aria-selected",true).children(".jstree-anchor").addClass(E?"jstree-clicked":"jstree-checked")}}else{break}C=this.get_node(C.parent)}}if(F.indexOf("down")!==-1&&v.length){v.find(".jstree-anchor").addClass(E?"jstree-clicked":"jstree-checked").parent().attr("aria-selected",true)}},this)).on(this.settings.checkbox.tie_selection?"deselect_all.jstree":"uncheck_all.jstree",i.proxy(function(z,x){var y=this.get_node(i.jstree.root),t=this._model.data,w,u,v;for(w=0,u=y.children_d.length;w<u;w++){v=t[y.children_d[w]];if(v&&v.original&&v.original.state&&v.original.state.undetermined){v.original.state.undetermined=false}}},this)).on(this.settings.checkbox.tie_selection?"deselect_node.jstree":"uncheck_node.jstree",i.proxy(function(A,x){var w=x.node,u=this.get_node(w,true),y,v,z,C=this.settings.checkbox.cascade,B=this.settings.checkbox.tie_selection;if(w&&w.original&&w.original.state&&w.original.state.undetermined){w.original.state.undetermined=false}if(C.indexOf("down")!==-1){for(y=0,v=w.children_d.length;y<v;y++){z=this._model.data[w.children_d[y]];z.state[B?"selected":"checked"]=false;if(z&&z.original&&z.original.state&&z.original.state.undetermined){z.original.state.undetermined=false}}}if(C.indexOf("up")!==-1){for(y=0,v=w.parents.length;y<v;y++){z=this._model.data[w.parents[y]];z.state[B?"selected":"checked"]=false;if(z&&z.original&&z.original.state&&z.original.state.undetermined){z.original.state.undetermined=false}z=this.get_node(w.parents[y],true);if(z&&z.length){z.attr("aria-selected",false).children(".jstree-anchor").removeClass(B?"jstree-clicked":"jstree-checked")}}}z=[];for(y=0,v=this._data[B?"core":"checkbox"].selected.length;y<v;y++){if((C.indexOf("down")===-1||i.inArray(this._data[B?"core":"checkbox"].selected[y],w.children_d)===-1)&&(C.indexOf("up")===-1||i.inArray(this._data[B?"core":"checkbox"].selected[y],w.parents)===-1)){z.push(this._data[B?"core":"checkbox"].selected[y])}}this._data[B?"core":"checkbox"].selected=i.vakata.array_unique(z);if(C.indexOf("down")!==-1&&u.length){u.find(".jstree-anchor").removeClass(B?"jstree-clicked":"jstree-checked").parent().attr("aria-selected",false)}},this))}if(this.settings.checkbox.cascade.indexOf("up")!==-1){this.element.on("delete_node.jstree",i.proxy(function(A,x){var u=this.get_node(x.parent),v=this._model.data,y,w,B,z,C=this.settings.checkbox.tie_selection;while(u&&u.id!==i.jstree.root&&!u.state[C?"selected":"checked"]){B=0;for(y=0,w=u.children.length;y<w;y++){B+=v[u.children[y]].state[C?"selected":"checked"]}if(w>0&&B===w){u.state[C?"selected":"checked"]=true;this._data[C?"core":"checkbox"].selected.push(u.id);z=this.get_node(u,true);if(z&&z.length){z.attr("aria-selected",true).children(".jstree-anchor").addClass(C?"jstree-clicked":"jstree-checked")}}else{break}u=this.get_node(u.parent)}},this)).on("move_node.jstree",i.proxy(function(D,B){var x=B.is_multi,C=B.old_parent,u=this.get_node(B.parent),w=this._model.data,v,E,A,y,z,F=this.settings.checkbox.tie_selection;if(!x){v=this.get_node(C);while(v&&v.id!==i.jstree.root&&!v.state[F?"selected":"checked"]){E=0;for(A=0,y=v.children.length;A<y;A++){E+=w[v.children[A]].state[F?"selected":"checked"]}if(y>0&&E===y){v.state[F?"selected":"checked"]=true;this._data[F?"core":"checkbox"].selected.push(v.id);z=this.get_node(v,true);if(z&&z.length){z.attr("aria-selected",true).children(".jstree-anchor").addClass(F?"jstree-clicked":"jstree-checked")}}else{break}v=this.get_node(v.parent)}}v=u;while(v&&v.id!==i.jstree.root){E=0;for(A=0,y=v.children.length;A<y;A++){E+=w[v.children[A]].state[F?"selected":"checked"]}if(E===y){if(!v.state[F?"selected":"checked"]){v.state[F?"selected":"checked"]=true;this._data[F?"core":"checkbox"].selected.push(v.id);z=this.get_node(v,true);if(z&&z.length){z.attr("aria-selected",true).children(".jstree-anchor").addClass(F?"jstree-clicked":"jstree-checked")}}}else{if(v.state[F?"selected":"checked"]){v.state[F?"selected":"checked"]=false;this._data[F?"core":"checkbox"].selected=i.vakata.array_remove_item(this._data[F?"core":"checkbox"].selected,v.id);z=this.get_node(v,true);if(z&&z.length){z.attr("aria-selected",false).children(".jstree-anchor").removeClass(F?"jstree-clicked":"jstree-checked")}}else{break}}v=this.get_node(v.parent)}},this))}};this._undetermined=function(){if(this.element===null){return}var A,z,y,x,v={},w=this._model.data,C=this.settings.checkbox.tie_selection,D=this._data[C?"core":"checkbox"].selected,u=[],B=this;for(A=0,z=D.length;A<z;A++){if(w[D[A]]&&w[D[A]].parents){for(y=0,x=w[D[A]].parents.length;y<x;y++){if(v[w[D[A]].parents[y]]===e&&w[D[A]].parents[y]!==i.jstree.root){v[w[D[A]].parents[y]]=true;u.push(w[D[A]].parents[y])}}}}this.element.find(".jstree-closed").not(":has(.jstree-children)").each(function(){var t=B.get_node(this),E;if(!t.state.loaded){if(t.original&&t.original.state&&t.original.state.undetermined&&t.original.state.undetermined===true){if(v[t.id]===e&&t.id!==i.jstree.root){v[t.id]=true;u.push(t.id)}for(y=0,x=t.parents.length;y<x;y++){if(v[t.parents[y]]===e&&t.parents[y]!==i.jstree.root){v[t.parents[y]]=true;u.push(t.parents[y])}}}}else{for(A=0,z=t.children_d.length;A<z;A++){E=w[t.children_d[A]];if(!E.state.loaded&&E.original&&E.original.state&&E.original.state.undetermined&&E.original.state.undetermined===true){if(v[E.id]===e&&E.id!==i.jstree.root){v[E.id]=true;u.push(E.id)}for(y=0,x=E.parents.length;y<x;y++){if(v[E.parents[y]]===e&&E.parents[y]!==i.jstree.root){v[E.parents[y]]=true;u.push(E.parents[y])}}}}}});this.element.find(".jstree-undetermined").removeClass("jstree-undetermined");for(A=0,z=u.length;A<z;A++){if(!w[u[A]].state[C?"selected":"checked"]){D=this.get_node(u[A],true);if(D&&D.length){D.children(".jstree-anchor").children(".jstree-checkbox").addClass("jstree-undetermined")}}}};this.redraw_node=function(A,t,x,z){A=s.redraw_node.apply(this,arguments);if(A){var w,u,v=null,y=null;for(w=0,u=A.childNodes.length;w<u;w++){if(A.childNodes[w]&&A.childNodes[w].className&&A.childNodes[w].className.indexOf("jstree-anchor")!==-1){v=A.childNodes[w];break}}if(v){if(!this.settings.checkbox.tie_selection&&this._model.data[A.id].state.checked){v.className+=" jstree-checked"}y=h.cloneNode(false);if(this._model.data[A.id].state.checkbox_disabled){y.className+=" jstree-checkbox-disabled"}v.insertBefore(y,v.childNodes[0])}}if(!x&&this.settings.checkbox.cascade.indexOf("undetermined")!==-1){if(this._data.checkbox.uto){clearTimeout(this._data.checkbox.uto)}this._data.checkbox.uto=setTimeout(i.proxy(this._undetermined,this),50)}return A};this.show_checkboxes=function(){this._data.core.themes.checkboxes=true;this.get_container_ul().removeClass("jstree-no-checkboxes")};this.hide_checkboxes=function(){this._data.core.themes.checkboxes=false;this.get_container_ul().addClass("jstree-no-checkboxes")};this.toggle_checkboxes=function(){if(this._data.core.themes.checkboxes){this.hide_checkboxes()}else{this.show_checkboxes()}};this.is_undetermined=function(z){z=this.get_node(z);var y=this.settings.checkbox.cascade,x,v,w=this.settings.checkbox.tie_selection,A=this._data[w?"core":"checkbox"].selected,u=this._model.data;if(!z||z.state[w?"selected":"checked"]===true||y.indexOf("undetermined")===-1||(y.indexOf("down")===-1&&y.indexOf("up")===-1)){return false}if(!z.state.loaded&&z.original.state.undetermined===true){return true}for(x=0,v=z.children_d.length;x<v;x++){if(i.inArray(z.children_d[x],A)!==-1||(!u[z.children_d[x]].state.loaded&&u[z.children_d[x]].original.state.undetermined)){return true}}return false};this.disable_checkbox=function(v){var u,t,w;if(i.isArray(v)){v=v.slice();for(u=0,t=v.length;u<t;u++){this.disable_checkbox(v[u])}return true}v=this.get_node(v);if(!v||v.id===i.jstree.root){return false}w=this.get_node(v,true);if(!v.state.checkbox_disabled){v.state.checkbox_disabled=true;if(w&&w.length){w.children(".jstree-anchor").children(".jstree-checkbox").addClass("jstree-checkbox-disabled")}this.trigger("disable_checkbox",{node:v})}};this.enable_checkbox=function(v){var u,t,w;if(i.isArray(v)){v=v.slice();for(u=0,t=v.length;u<t;u++){this.enable_checkbox(v[u])}return true}v=this.get_node(v);if(!v||v.id===i.jstree.root){return false}w=this.get_node(v,true);if(v.state.checkbox_disabled){v.state.checkbox_disabled=false;if(w&&w.length){w.children(".jstree-anchor").children(".jstree-checkbox").removeClass("jstree-checkbox-disabled")}this.trigger("enable_checkbox",{node:v})}};this.activate_node=function(u,t){if(i(t.target).hasClass("jstree-checkbox-disabled")){return false}if(this.settings.checkbox.tie_selection&&(this.settings.checkbox.whole_node||i(t.target).hasClass("jstree-checkbox"))){t.ctrlKey=true}if(this.settings.checkbox.tie_selection||(!this.settings.checkbox.whole_node&&!i(t.target).hasClass("jstree-checkbox"))){return s.activate_node.call(this,u,t)}if(this.is_disabled(u)){return false}if(this.is_checked(u)){this.uncheck_node(u,t)}else{this.check_node(u,t)}this.trigger("activate_node",{node:this.get_node(u)})};this.check_node=function(x,w){if(this.settings.checkbox.tie_selection){return this.select_node(x,false,true,w)}var y,v,t,u;if(i.isArray(x)){x=x.slice();for(v=0,t=x.length;v<t;v++){this.check_node(x[v],w)}return true}x=this.get_node(x);if(!x||x.id===i.jstree.root){return false}y=this.get_node(x,true);if(!x.state.checked){x.state.checked=true;this._data.checkbox.selected.push(x.id);if(y&&y.length){y.children(".jstree-anchor").addClass("jstree-checked")}this.trigger("check_node",{node:x,selected:this._data.checkbox.selected,event:w})}};this.uncheck_node=function(w,v){if(this.settings.checkbox.tie_selection){return this.deselect_node(w,false,v)}var u,t,x;if(i.isArray(w)){w=w.slice();for(u=0,t=w.length;u<t;u++){this.uncheck_node(w[u],v)}return true}w=this.get_node(w);if(!w||w.id===i.jstree.root){return false}x=this.get_node(w,true);if(w.state.checked){w.state.checked=false;this._data.checkbox.selected=i.vakata.array_remove_item(this._data.checkbox.selected,w.id);if(x.length){x.children(".jstree-anchor").removeClass("jstree-checked")}this.trigger("uncheck_node",{node:w,selected:this._data.checkbox.selected,event:v})}};this.check_all=function(){if(this.settings.checkbox.tie_selection){return this.select_all()}var v=this._data.checkbox.selected.concat([]),u,t;this._data.checkbox.selected=this._model.data[i.jstree.root].children_d.concat();for(u=0,t=this._data.checkbox.selected.length;u<t;u++){if(this._model.data[this._data.checkbox.selected[u]]){this._model.data[this._data.checkbox.selected[u]].state.checked=true}}this.redraw(true);this.trigger("check_all",{selected:this._data.checkbox.selected})};this.uncheck_all=function(){if(this.settings.checkbox.tie_selection){return this.deselect_all()}var v=this._data.checkbox.selected.concat([]),u,t;for(u=0,t=this._data.checkbox.selected.length;u<t;u++){if(this._model.data[this._data.checkbox.selected[u]]){this._model.data[this._data.checkbox.selected[u]].state.checked=false}}this._data.checkbox.selected=[];this.element.find(".jstree-checked").removeClass("jstree-checked");this.trigger("uncheck_all",{selected:this._data.checkbox.selected,node:v})};this.is_checked=function(t){if(this.settings.checkbox.tie_selection){return this.is_selected(t)}t=this.get_node(t);if(!t||t.id===i.jstree.root){return false}return t.state.checked};this.get_checked=function(t){if(this.settings.checkbox.tie_selection){return this.get_selected(t)}return t?i.map(this._data.checkbox.selected,i.proxy(function(u){return this.get_node(u)},this)):this._data.checkbox.selected};this.get_top_checked=function(y){if(this.settings.checkbox.tie_selection){return this.get_top_selected(y)}var x=this.get_checked(true),z={},w,v,u,t;for(w=0,v=x.length;w<v;w++){z[x[w].id]=x[w]}for(w=0,v=x.length;w<v;w++){for(u=0,t=x[w].children_d.length;u<t;u++){if(z[x[w].children_d[u]]){delete z[x[w].children_d[u]]}}}x=[];for(w in z){if(z.hasOwnProperty(w)){x.push(w)}}return y?i.map(x,i.proxy(function(A){return this.get_node(A)},this)):x};this.get_bottom_checked=function(w){if(this.settings.checkbox.tie_selection){return this.get_bottom_selected(w)}var v=this.get_checked(true),x=[],u,t;for(u=0,t=v.length;u<t;u++){if(!v[u].children.length){x.push(v[u].id)}}return w?i.map(x,i.proxy(function(y){return this.get_node(y)},this)):x};this.load_node=function(y,A){var u,t,x,v,z,w;if(!i.isArray(y)&&!this.settings.checkbox.tie_selection){w=this.get_node(y);if(w&&w.state.loaded){for(u=0,t=w.children_d.length;u<t;u++){if(this._model.data[w.children_d[u]].state.checked){z=true;this._data.checkbox.selected=i.vakata.array_remove_item(this._data.checkbox.selected,w.children_d[u])}}}}return s.load_node.apply(this,arguments)};this.get_state=function(){var t=s.get_state.apply(this,arguments);if(this.settings.checkbox.tie_selection){return t}t.checkbox=this._data.checkbox.selected.slice();return t};this.set_state=function(u,w){var t=s.set_state.apply(this,arguments);if(t&&u.checkbox){if(!this.settings.checkbox.tie_selection){this.uncheck_all();var v=this;i.each(u.checkbox,function(y,x){v.check_node(x)})}delete u.checkbox;this.set_state(u,w);return false}return t};this.refresh=function(u,t){if(!this.settings.checkbox.tie_selection){this._data.checkbox.selected=[]}return s.refresh.apply(this,arguments)}};i.jstree.defaults.conditionalselect=function(){return true};i.jstree.plugins.conditionalselect=function(r,s){this.activate_node=function(u,t){if(this.settings.conditionalselect.call(this,this.get_node(u),t)){s.activate_node.call(this,u,t)}}};i.jstree.defaults.contextmenu={select_node:true,show_at_node:true,items:function(s,r){return{create:{separator_before:false,separator_after:true,_disabled:false,label:"Create",action:function(u){var t=i.jstree.reference(u.reference),v=t.get_node(u.reference);t.create_node(v,{},"last",function(w){setTimeout(function(){t.edit(w)},0)})}},rename:{separator_before:false,separator_after:false,_disabled:false,label:"Rename",
/*
					"shortcut"			: 113,
					"shortcut_label"	: 'F2',
					"icon"				: "glyphicon glyphicon-leaf",
					*/
action:function(u){var t=i.jstree.reference(u.reference),v=t.get_node(u.reference);t.edit(v)}},remove:{separator_before:false,icon:false,separator_after:false,_disabled:false,label:"Delete",action:function(u){var t=i.jstree.reference(u.reference),v=t.get_node(u.reference);if(t.is_selected(v)){t.delete_node(t.get_selected())}else{t.delete_node(v)}}},ccp:{separator_before:true,icon:false,separator_after:false,label:"Edit",action:false,submenu:{cut:{separator_before:false,separator_after:false,label:"Cut",action:function(u){var t=i.jstree.reference(u.reference),v=t.get_node(u.reference);if(t.is_selected(v)){t.cut(t.get_top_selected())}else{t.cut(v)}}},copy:{separator_before:false,icon:false,separator_after:false,label:"Copy",action:function(u){var t=i.jstree.reference(u.reference),v=t.get_node(u.reference);if(t.is_selected(v)){t.copy(t.get_top_selected())}else{t.copy(v)}}},paste:{separator_before:false,icon:false,_disabled:function(t){return !i.jstree.reference(t.reference).can_paste()},separator_after:false,label:"Paste",action:function(u){var t=i.jstree.reference(u.reference),v=t.get_node(u.reference);t.paste(v)}}}}}}};i.jstree.plugins.contextmenu=function(r,s){this.bind=function(){s.bind.call(this);var t=0,w=null,v,u;this.element.on("contextmenu.jstree",".jstree-anchor",i.proxy(function(y,x){y.preventDefault();t=y.ctrlKey?+new Date():0;if(x||w){t=(+new Date())+10000}if(w){clearTimeout(w)}if(!this.is_loading(y.currentTarget)){this.show_contextmenu(y.currentTarget,y.pageX,y.pageY,y)}},this)).on("click.jstree",".jstree-anchor",i.proxy(function(x){if(this._data.contextmenu.visible&&(!t||(+new Date())-t>250)){i.vakata.context.hide()}t=0},this)).on("touchstart.jstree",".jstree-anchor",function(x){if(!x.originalEvent||!x.originalEvent.changedTouches||!x.originalEvent.changedTouches[0]){return}v=x.pageX;u=x.pageY;w=setTimeout(function(){i(x.currentTarget).trigger("contextmenu",true)},750)}).on("touchmove.vakata.jstree",function(x){if(w&&x.originalEvent&&x.originalEvent.changedTouches&&x.originalEvent.changedTouches[0]&&(Math.abs(v-x.pageX)>50||Math.abs(u-x.pageY)>50)){clearTimeout(w)}}).on("touchend.vakata.jstree",function(x){if(w){clearTimeout(w)}});
/*
			if(!('oncontextmenu' in document.body) && ('ontouchstart' in document.body)) {
				var el = null, tm = null;
				this.element
					.on("touchstart", ".jstree-anchor", function (e) {
						el = e.currentTarget;
						tm = +new Date();
						$(document).one("touchend", function (e) {
							e.target = document.elementFromPoint(e.originalEvent.targetTouches[0].pageX - window.pageXOffset, e.originalEvent.targetTouches[0].pageY - window.pageYOffset);
							e.currentTarget = e.target;
							tm = ((+(new Date())) - tm);
							if(e.target === el && tm > 600 && tm < 1000) {
								e.preventDefault();
								$(el).trigger('contextmenu', e);
							}
							el = null;
							tm = null;
						});
					});
			}
			*/
i(o).on("context_hide.vakata.jstree",i.proxy(function(){this._data.contextmenu.visible=false},this))};this.teardown=function(){if(this._data.contextmenu.visible){i.vakata.context.hide()}s.teardown.call(this)};this.show_contextmenu=function(v,C,A,w){v=this.get_node(v);if(!v||v.id===i.jstree.root){return false}var D=this.settings.contextmenu,z=this.get_node(v,true),B=z.children(".jstree-anchor"),t=false,u=false;if(D.show_at_node||C===e||A===e){t=B.offset();C=t.left;A=t.top+this._data.core.li_height}if(this.settings.contextmenu.select_node&&!this.is_selected(v)){this.activate_node(v,w)}u=D.items;if(i.isFunction(u)){u=u.call(this,v,i.proxy(function(x){this._show_contextmenu(v,C,A,x)},this))}if(i.isPlainObject(u)){this._show_contextmenu(v,C,A,u)}};this._show_contextmenu=function(w,t,A,v){var z=this.get_node(w,true),u=z.children(".jstree-anchor");i(o).one("context_show.vakata.jstree",i.proxy(function(B,y){var x="jstree-contextmenu jstree-"+this.get_theme()+"-contextmenu";i(y.element).addClass(x)},this));this._data.contextmenu.visible=true;i.vakata.context.show(u,{x:t,y:A},v);this.trigger("show_contextmenu",{node:w,x:t,y:A})}};(function(s){var t=false,r={element:false,reference:false,position_x:0,position_y:0,items:[],html:"",is_visible:false};s.vakata.context={settings:{hide_onmouseleave:0,icons:true},_trigger:function(u){s(o).triggerHandler("context_"+u+".vakata",{reference:r.reference,element:r.element,position:{x:r.position_x,y:r.position_y}})},_execute:function(u){u=r.items[u];return u&&(!u._disabled||(s.isFunction(u._disabled)&&!u._disabled({item:u,reference:r.reference,element:r.element})))&&u.action?u.action.call(null,{item:u,reference:r.reference,element:r.element,position:{x:r.position_x,y:r.position_y}}):false},_parse:function(y,w){if(!y){return false}if(!w){r.html="";r.items=[]}var x="",u=false,v;if(w){x+="<ul>"}s.each(y,function(z,A){if(!A){return true}r.items.push(A);if(!u&&A.separator_before){x+="<li class='vakata-context-separator'><a href='#' "+(s.vakata.context.settings.icons?"":'style="margin-left:0px;"')+">&#160;</a></li>"}u=false;x+="<li class='"+(A._class||"")+(A._disabled===true||(s.isFunction(A._disabled)&&A._disabled({item:A,reference:r.reference,element:r.element}))?" vakata-contextmenu-disabled ":"")+"' "+(A.shortcut?" data-shortcut='"+A.shortcut+"' ":"")+">";x+="<a href='#' rel='"+(r.items.length-1)+"'>";if(s.vakata.context.settings.icons){x+="<i ";if(A.icon){if(A.icon.indexOf("/")!==-1||A.icon.indexOf(".")!==-1){x+=" style='background:url(\""+A.icon+"\") center center no-repeat' "}else{x+=" class='"+A.icon+"' "}}x+="></i><span class='vakata-contextmenu-sep'>&#160;</span>"}x+=(s.isFunction(A.label)?A.label({item:z,reference:r.reference,element:r.element}):A.label)+(A.shortcut?' <span class="vakata-contextmenu-shortcut vakata-contextmenu-shortcut-'+A.shortcut+'">'+(A.shortcut_label||"")+"</span>":"")+"</a>";if(A.submenu){v=s.vakata.context._parse(A.submenu,true);if(v){x+=v}}x+="</li>";if(A.separator_after){x+="<li class='vakata-context-separator'><a href='#' "+(s.vakata.context.settings.icons?"":'style="margin-left:0px;"')+">&#160;</a></li>";u=true}});x=x.replace(/<li class\='vakata-context-separator'\><\/li\>$/,"");if(w){x+="</ul>"}if(!w){r.html=x;s.vakata.context._trigger("parse")}return x.length>10?x:false},_show_submenu:function(D){D=s(D);if(!D.length||!D.children("ul").length){return}var C=D.children("ul"),u=D.offset().left+D.outerWidth(),E=D.offset().top,v=C.width(),A=C.height(),z=s(window).width()+s(window).scrollLeft(),B=s(window).height()+s(window).scrollTop();if(t){D[u-(v+10+D.outerWidth())<0?"addClass":"removeClass"]("vakata-context-left")}else{D[u+v+10>z?"addClass":"removeClass"]("vakata-context-right")}if(E+A+10>B){C.css("bottom","-1px")}C.show()},show:function(z,C,A){var v,D,H,G,I,B,u,F,E=true;if(r.element&&r.element.length){r.element.width("")}switch(E){case (!C&&!z):return false;case (!!C&&!!z):r.reference=z;r.position_x=C.x;r.position_y=C.y;break;case (!C&&!!z):r.reference=z;v=z.offset();r.position_x=v.left+z.outerHeight();r.position_y=v.top;break;case (!!C&&!z):r.position_x=C.x;r.position_y=C.y;break}if(!!z&&!A&&s(z).data("vakata_contextmenu")){A=s(z).data("vakata_contextmenu")}if(s.vakata.context._parse(A)){r.element.html(r.html)}if(r.items.length){r.element.appendTo("body");D=r.element;H=r.position_x;G=r.position_y;I=D.width();B=D.height();u=s(window).width()+s(window).scrollLeft();F=s(window).height()+s(window).scrollTop();if(t){H-=(D.outerWidth()-s(z).outerWidth());if(H<s(window).scrollLeft()+20){H=s(window).scrollLeft()+20}}if(H+I+20>u){H=u-(I+20)}if(G+B+20>F){G=F-(B+20)}r.element.css({left:H,top:G}).show().find("a").first().focus().parent().addClass("vakata-context-hover");r.is_visible=true;s.vakata.context._trigger("show")}},hide:function(){if(r.is_visible){r.element.hide().find("ul").hide().end().find(":focus").blur().end().detach();r.is_visible=false;s.vakata.context._trigger("hide")}}};s(function(){t=s("body").css("direction")==="rtl";var u=false;r.element=s("<ul class='vakata-context'></ul>");r.element.on("mouseenter","li",function(v){v.stopImmediatePropagation();if(s.contains(this,v.relatedTarget)){return}if(u){clearTimeout(u)}r.element.find(".vakata-context-hover").removeClass("vakata-context-hover").end();s(this).siblings().find("ul").hide().end().end().parentsUntil(".vakata-context","li").addBack().addClass("vakata-context-hover");s.vakata.context._show_submenu(this)}).on("mouseleave","li",function(v){if(s.contains(this,v.relatedTarget)){return}s(this).find(".vakata-context-hover").addBack().removeClass("vakata-context-hover")}).on("mouseleave",function(v){s(this).find(".vakata-context-hover").removeClass("vakata-context-hover");if(s.vakata.context.settings.hide_onmouseleave){u=setTimeout((function(w){return function(){s.vakata.context.hide()}}(this)),s.vakata.context.settings.hide_onmouseleave)}}).on("click","a",function(v){v.preventDefault();if(!s(this).blur().parent().hasClass("vakata-context-disabled")&&s.vakata.context._execute(s(this).attr("rel"))!==false){s.vakata.context.hide()}}).on("keydown","a",function(v){var w=null;switch(v.which){case 13:case 32:v.type="mouseup";v.preventDefault();s(v.currentTarget).trigger(v);break;case 37:if(r.is_visible){r.element.find(".vakata-context-hover").last().closest("li").first().find("ul").hide().find(".vakata-context-hover").removeClass("vakata-context-hover").end().end().children("a").focus();v.stopImmediatePropagation();v.preventDefault()}break;case 38:if(r.is_visible){w=r.element.find("ul:visible").addBack().last().children(".vakata-context-hover").removeClass("vakata-context-hover").prevAll("li:not(.vakata-context-separator)").first();if(!w.length){w=r.element.find("ul:visible").addBack().last().children("li:not(.vakata-context-separator)").last()}w.addClass("vakata-context-hover").children("a").focus();v.stopImmediatePropagation();v.preventDefault()}break;case 39:if(r.is_visible){r.element.find(".vakata-context-hover").last().children("ul").show().children("li:not(.vakata-context-separator)").removeClass("vakata-context-hover").first().addClass("vakata-context-hover").children("a").focus();v.stopImmediatePropagation();v.preventDefault()}break;case 40:if(r.is_visible){w=r.element.find("ul:visible").addBack().last().children(".vakata-context-hover").removeClass("vakata-context-hover").nextAll("li:not(.vakata-context-separator)").first();if(!w.length){w=r.element.find("ul:visible").addBack().last().children("li:not(.vakata-context-separator)").first()}w.addClass("vakata-context-hover").children("a").focus();v.stopImmediatePropagation();v.preventDefault()}break;case 27:s.vakata.context.hide();v.preventDefault();break;default:break}}).on("keydown",function(w){w.preventDefault();var v=r.element.find(".vakata-contextmenu-shortcut-"+w.which).parent();if(v.parent().not(".vakata-context-disabled")){v.click()}});s(o).on("mousedown.vakata.jstree",function(v){if(r.is_visible&&!s.contains(r.element[0],v.target)){s.vakata.context.hide()}}).on("context_show.vakata.jstree",function(w,v){r.element.find("li:has(ul)").children("a").addClass("vakata-context-parent");if(t){r.element.addClass("vakata-context-rtl").css("direction","rtl")}r.element.find("ul").hide().end()})})}(i));i.jstree.defaults.dnd={copy:true,open_timeout:500,is_draggable:true,check_while_dragging:true,always_copy:false,inside_pos:0,drag_selection:true,touch:true,large_drop_target:false,large_drag_target:false};i.jstree.plugins.dnd=function(r,s){this.bind=function(){s.bind.call(this);this.element.on("mousedown.jstree touchstart.jstree",this.settings.dnd.large_drag_target?".jstree-node":".jstree-anchor",i.proxy(function(w){if(this.settings.dnd.large_drag_target&&i(w.target).closest(".jstree-node")[0]!==w.currentTarget){return true}if(w.type==="touchstart"&&(!this.settings.dnd.touch||(this.settings.dnd.touch==="selected"&&!i(w.currentTarget).closest(".jstree-node").children(".jstree-anchor").hasClass("jstree-clicked")))){return true}var v=this.get_node(w.target),u=this.is_selected(v)&&this.settings.dnd.drag_selection?this.get_top_selected().length:1,t=(u>1?u+" "+this.get_string("nodes"):this.get_text(w.currentTarget));if(this.settings.core.force_text){t=i.vakata.html.escape(t)}if(v&&v.id&&v.id!==i.jstree.root&&(w.which===1||w.type==="touchstart")&&(this.settings.dnd.is_draggable===true||(i.isFunction(this.settings.dnd.is_draggable)&&this.settings.dnd.is_draggable.call(this,(u>1?this.get_top_selected(true):[v]),w)))){this.element.trigger("mousedown.jstree");return i.vakata.dnd.start(w,{jstree:true,origin:this,obj:this.get_node(v,true),nodes:u>1?this.get_top_selected():[v.id]},'<div id="jstree-dnd" class="jstree-'+this.get_theme()+" jstree-"+this.get_theme()+"-"+this.get_theme_variant()+" "+(this.settings.core.themes.responsive?" jstree-dnd-responsive":"")+'"><i class="jstree-icon jstree-er"></i>'+t+'<ins class="jstree-copy" style="display:none;">+</ins></div>')}},this))}};i(function(){var v=false,u=false,s=false,t=false,r=i('<div id="jstree-marker">&#160;</div>').hide();i(o).on("dnd_start.vakata.jstree",function(x,w){v=false;s=false;if(!w||!w.data||!w.data.jstree){return}r.appendTo("body")}).on("dnd_move.vakata.jstree",function(N,Q){if(t){clearTimeout(t)}if(!Q||!Q.data||!Q.data.jstree){return}if(Q.event.target.id&&Q.event.target.id==="jstree-marker"){return}s=Q.event;var w=i.jstree.reference(Q.event.target),z=false,P=false,x=false,O,K,F,M,G,L,H,E,D,C,B,I,J,A,y;if(w&&w._data&&w._data.dnd){r.attr("class","jstree-"+w.get_theme()+(w.settings.core.themes.responsive?" jstree-dnd-responsive":""));Q.helper.children().attr("class","jstree-"+w.get_theme()+" jstree-"+w.get_theme()+"-"+w.get_theme_variant()+" "+(w.settings.core.themes.responsive?" jstree-dnd-responsive":"")).find(".jstree-copy").first()[Q.data.origin&&(Q.data.origin.settings.dnd.always_copy||(Q.data.origin.settings.dnd.copy&&(Q.event.metaKey||Q.event.ctrlKey)))?"show":"hide"]();if((Q.event.target===w.element[0]||Q.event.target===w.get_container_ul()[0])&&w.get_container_ul().children().length===0){E=true;for(D=0,C=Q.data.nodes.length;D<C;D++){E=E&&w.check((Q.data.origin&&(Q.data.origin.settings.dnd.always_copy||(Q.data.origin.settings.dnd.copy&&(Q.event.metaKey||Q.event.ctrlKey)))?"copy_node":"move_node"),(Q.data.origin&&Q.data.origin!==w?Q.data.origin.get_node(Q.data.nodes[D]):Q.data.nodes[D]),i.jstree.root,"last",{dnd:true,ref:w.get_node(i.jstree.root),pos:"i",origin:Q.data.origin,is_multi:(Q.data.origin&&Q.data.origin!==w),is_foreign:(!Q.data.origin)});if(!E){break}}if(E){v={ins:w,par:i.jstree.root,pos:"last"};r.hide();Q.helper.find(".jstree-icon").first().removeClass("jstree-er").addClass("jstree-ok");return}}else{z=w.settings.dnd.large_drop_target?i(Q.event.target).closest(".jstree-node").children(".jstree-anchor"):i(Q.event.target).closest(".jstree-anchor");if(z&&z.length&&z.parent().is(".jstree-closed, .jstree-open, .jstree-leaf")){P=z.offset();x=Q.event.pageY-P.top;M=z.outerHeight();if(x<M/3){H=["b","i","a"]}else{if(x>M-M/3){H=["a","i","b"]}else{H=x>M/2?["i","a","b"]:["i","b","a"]}}i.each(H,function(S,R){switch(R){case"b":K=P.left-6;F=P.top;G=w.get_parent(z);L=z.parent().index();break;case"i":A=w.settings.dnd.inside_pos;y=w.get_node(z.parent());K=P.left-2;F=P.top+M/2+1;G=y.id;L=A==="first"?0:(A==="last"?y.children.length:Math.min(A,y.children.length));break;case"a":K=P.left-6;F=P.top+M;G=w.get_parent(z);L=z.parent().index()+1;break}E=true;for(D=0,C=Q.data.nodes.length;D<C;D++){B=Q.data.origin&&(Q.data.origin.settings.dnd.always_copy||(Q.data.origin.settings.dnd.copy&&(Q.event.metaKey||Q.event.ctrlKey)))?"copy_node":"move_node";I=L;if(B==="move_node"&&R==="a"&&(Q.data.origin&&Q.data.origin===w)&&G===w.get_parent(Q.data.nodes[D])){J=w.get_node(G);if(I>i.inArray(Q.data.nodes[D],J.children)){I-=1}}E=E&&((w&&w.settings&&w.settings.dnd&&w.settings.dnd.check_while_dragging===false)||w.check(B,(Q.data.origin&&Q.data.origin!==w?Q.data.origin.get_node(Q.data.nodes[D]):Q.data.nodes[D]),G,I,{dnd:true,ref:w.get_node(z.parent()),pos:R,origin:Q.data.origin,is_multi:(Q.data.origin&&Q.data.origin!==w),is_foreign:(!Q.data.origin)}));if(!E){if(w&&w.last_error){u=w.last_error()}break}}if(R==="i"&&z.parent().is(".jstree-closed")&&w.settings.dnd.open_timeout){t=setTimeout((function(T,U){return function(){T.open_node(U)}}(w,z)),w.settings.dnd.open_timeout)}if(E){v={ins:w,par:G,pos:R==="i"&&A==="last"&&L===0&&!w.is_loaded(y)?"last":L};r.css({left:K+"px",top:F+"px"}).show();Q.helper.find(".jstree-icon").first().removeClass("jstree-er").addClass("jstree-ok");u={};H=true;return false}});if(H===true){return}}}}v=false;Q.helper.find(".jstree-icon").removeClass("jstree-ok").addClass("jstree-er");r.hide()}).on("dnd_scroll.vakata.jstree",function(x,w){if(!w||!w.data||!w.data.jstree){return}r.hide();v=false;s=false;w.helper.find(".jstree-icon").first().removeClass("jstree-ok").addClass("jstree-er")}).on("dnd_stop.vakata.jstree",function(A,z){if(t){clearTimeout(t)}if(!z||!z.data||!z.data.jstree){return}r.hide().detach();var y,x,w=[];if(v){for(y=0,x=z.data.nodes.length;y<x;y++){w[y]=z.data.origin?z.data.origin.get_node(z.data.nodes[y]):z.data.nodes[y]}v.ins[z.data.origin&&(z.data.origin.settings.dnd.always_copy||(z.data.origin.settings.dnd.copy&&(z.event.metaKey||z.event.ctrlKey)))?"copy_node":"move_node"](w,v.par,v.pos,false,false,false,z.data.origin)}else{y=i(z.event.target).closest(".jstree");if(y.length&&u&&u.error&&u.error==="check"){y=y.jstree(true);if(y){y.settings.core.error.call(this,u)}}}s=false;v=false}).on("keyup.jstree keydown.jstree",function(x,w){w=i.vakata.dnd._get();if(w&&w.data&&w.data.jstree){w.helper.find(".jstree-copy").first()[w.data.origin&&(w.data.origin.settings.dnd.always_copy||(w.data.origin.settings.dnd.copy&&(x.metaKey||x.ctrlKey)))?"show":"hide"]();if(s){s.metaKey=x.metaKey;s.ctrlKey=x.ctrlKey;i.vakata.dnd._trigger("move",s)}}})});(function(s){s.vakata.html={div:s("<div />"),escape:function(t){return s.vakata.html.div.text(t).html()},strip:function(t){return s.vakata.html.div.empty().append(s.parseHTML(t)).text()}};var r={element:false,target:false,is_down:false,is_drag:false,helper:false,helper_w:0,data:false,init_x:0,init_y:0,scroll_l:0,scroll_t:0,scroll_e:false,scroll_i:false,is_touch:false};s.vakata.dnd={settings:{scroll_speed:10,scroll_proximity:20,helper_left:5,helper_top:10,threshold:5,threshold_touch:50},_trigger:function(v,u){var t=s.vakata.dnd._get();t.event=u;s(o).triggerHandler("dnd_"+v+".vakata",t)},_get:function(){return{data:r.data,element:r.element,helper:r.helper}},_clean:function(){if(r.helper){r.helper.remove()}if(r.scroll_i){clearInterval(r.scroll_i);r.scroll_i=false}r={element:false,target:false,is_down:false,is_drag:false,helper:false,helper_w:0,data:false,init_x:0,init_y:0,scroll_l:0,scroll_t:0,scroll_e:false,scroll_i:false,is_touch:false};s(o).off("mousemove.vakata.jstree touchmove.vakata.jstree",s.vakata.dnd.drag);s(o).off("mouseup.vakata.jstree touchend.vakata.jstree",s.vakata.dnd.stop)},_scroll:function(v){if(!r.scroll_e||(!r.scroll_l&&!r.scroll_t)){if(r.scroll_i){clearInterval(r.scroll_i);r.scroll_i=false}return false}if(!r.scroll_i){r.scroll_i=setInterval(s.vakata.dnd._scroll,100);return false}if(v===true){return false}var u=r.scroll_e.scrollTop(),t=r.scroll_e.scrollLeft();r.scroll_e.scrollTop(u+r.scroll_t*s.vakata.dnd.settings.scroll_speed);r.scroll_e.scrollLeft(t+r.scroll_l*s.vakata.dnd.settings.scroll_speed);if(u!==r.scroll_e.scrollTop()||t!==r.scroll_e.scrollLeft()){s.vakata.dnd._trigger("scroll",r.scroll_e)}},start:function(v,u,t){if(v.type==="touchstart"&&v.originalEvent&&v.originalEvent.changedTouches&&v.originalEvent.changedTouches[0]){v.pageX=v.originalEvent.changedTouches[0].pageX;v.pageY=v.originalEvent.changedTouches[0].pageY;v.target=o.elementFromPoint(v.originalEvent.changedTouches[0].pageX-window.pageXOffset,v.originalEvent.changedTouches[0].pageY-window.pageYOffset)}if(r.is_drag){s.vakata.dnd.stop({})}try{v.currentTarget.unselectable="on";v.currentTarget.onselectstart=function(){return false};if(v.currentTarget.style){v.currentTarget.style.MozUserSelect="none"}}catch(w){}r.init_x=v.pageX;r.init_y=v.pageY;r.data=u;r.is_down=true;r.element=v.currentTarget;r.target=v.target;r.is_touch=v.type==="touchstart";if(t!==false){r.helper=s("<div id='vakata-dnd'></div>").html(t).css({display:"block",margin:"0",padding:"0",position:"absolute",top:"-2000px",lineHeight:"16px",zIndex:"10000"})}s(o).on("mousemove.vakata.jstree touchmove.vakata.jstree",s.vakata.dnd.drag);s(o).on("mouseup.vakata.jstree touchend.vakata.jstree",s.vakata.dnd.stop);return false},drag:function(A){if(A.type==="touchmove"&&A.originalEvent&&A.originalEvent.changedTouches&&A.originalEvent.changedTouches[0]){A.pageX=A.originalEvent.changedTouches[0].pageX;A.pageY=A.originalEvent.changedTouches[0].pageY;A.target=o.elementFromPoint(A.originalEvent.changedTouches[0].pageX-window.pageXOffset,A.originalEvent.changedTouches[0].pageY-window.pageYOffset)}if(!r.is_down){return}if(!r.is_drag){if(Math.abs(A.pageX-r.init_x)>(r.is_touch?s.vakata.dnd.settings.threshold_touch:s.vakata.dnd.settings.threshold)||Math.abs(A.pageY-r.init_y)>(r.is_touch?s.vakata.dnd.settings.threshold_touch:s.vakata.dnd.settings.threshold)){if(r.helper){r.helper.appendTo("body");r.helper_w=r.helper.outerWidth()}r.is_drag=true;s.vakata.dnd._trigger("start",A)}else{return}}var B=false,E=false,C=false,u=false,t=false,y=false,x=false,z=false,D=false,v=false;r.scroll_t=0;r.scroll_l=0;r.scroll_e=false;s(s(A.target).parentsUntil("body").addBack().get().reverse()).filter(function(){return(/^auto|scroll$/).test(s(this).css("overflow"))&&(this.scrollHeight>this.offsetHeight||this.scrollWidth>this.offsetWidth)}).each(function(){var w=s(this),F=w.offset();if(this.scrollHeight>this.offsetHeight){if(F.top+w.height()-A.pageY<s.vakata.dnd.settings.scroll_proximity){r.scroll_t=1}if(A.pageY-F.top<s.vakata.dnd.settings.scroll_proximity){r.scroll_t=-1}}if(this.scrollWidth>this.offsetWidth){if(F.left+w.width()-A.pageX<s.vakata.dnd.settings.scroll_proximity){r.scroll_l=1}if(A.pageX-F.left<s.vakata.dnd.settings.scroll_proximity){r.scroll_l=-1}}if(r.scroll_t||r.scroll_l){r.scroll_e=s(this);return false}});if(!r.scroll_e){B=s(o);E=s(window);C=B.height();u=E.height();t=B.width();y=E.width();x=B.scrollTop();z=B.scrollLeft();if(C>u&&A.pageY-x<s.vakata.dnd.settings.scroll_proximity){r.scroll_t=-1}if(C>u&&u-(A.pageY-x)<s.vakata.dnd.settings.scroll_proximity){r.scroll_t=1}if(t>y&&A.pageX-z<s.vakata.dnd.settings.scroll_proximity){r.scroll_l=-1}if(t>y&&y-(A.pageX-z)<s.vakata.dnd.settings.scroll_proximity){r.scroll_l=1}if(r.scroll_t||r.scroll_l){r.scroll_e=B}}if(r.scroll_e){s.vakata.dnd._scroll(true)}if(r.helper){D=parseInt(A.pageY+s.vakata.dnd.settings.helper_top,10);v=parseInt(A.pageX+s.vakata.dnd.settings.helper_left,10);if(C&&D+25>C){D=C-50}if(t&&v+r.helper_w>t){v=t-(r.helper_w+2)}r.helper.css({left:v+"px",top:D+"px"})}s.vakata.dnd._trigger("move",A);return false},stop:function(t){if(t.type==="touchend"&&t.originalEvent&&t.originalEvent.changedTouches&&t.originalEvent.changedTouches[0]){t.pageX=t.originalEvent.changedTouches[0].pageX;t.pageY=t.originalEvent.changedTouches[0].pageY;t.target=o.elementFromPoint(t.originalEvent.changedTouches[0].pageX-window.pageXOffset,t.originalEvent.changedTouches[0].pageY-window.pageYOffset)}if(r.is_drag){s.vakata.dnd._trigger("stop",t)}else{if(t.type==="touchend"&&t.target===r.target){var u=setTimeout(function(){s(t.target).click()},100);s(t.target).one("click",function(){if(u){clearTimeout(u)}})}}s.vakata.dnd._clean();return false}}}(i));i.jstree.defaults.massload=null;i.jstree.plugins.massload=function(r,s){this.init=function(u,t){s.init.call(this,u,t);this._data.massload={}};this._load_nodes=function(t,w,u){var v=this.settings.massload;if(u&&!i.isEmptyObject(this._data.massload)){return s._load_nodes.call(this,t,w,u)}if(i.isFunction(v)){return v.call(this,t,i.proxy(function(y){if(y){for(var x in y){if(y.hasOwnProperty(x)){this._data.massload[x]=y[x]}}}s._load_nodes.call(this,t,w,u)},this))}if(typeof v==="object"&&v&&v.url){v=i.extend(true,{},v);if(i.isFunction(v.url)){v.url=v.url.call(this,t)}if(i.isFunction(v.data)){v.data=v.data.call(this,t)}return i.ajax(v).done(i.proxy(function(B,A,y){if(B){for(var z in B){if(B.hasOwnProperty(z)){this._data.massload[z]=B[z]}}}s._load_nodes.call(this,t,w,u)},this)).fail(i.proxy(function(x){s._load_nodes.call(this,t,w,u)},this))}return s._load_nodes.call(this,t,w,u)};this._load_node=function(t,v){var u=this._data.massload[t.id];if(u){return this[typeof u==="string"?"_append_html_data":"_append_json_data"](t,typeof u==="string"?i(i.parseHTML(u)).filter(function(){return this.nodeType!==3}):u,function(w){v.call(this,w);delete this._data.massload[t.id]})}return s._load_node.call(this,t,v)}};i.jstree.defaults.search={ajax:false,fuzzy:false,case_sensitive:false,show_only_matches:false,show_only_matches_children:false,close_opened_onclear:true,search_leaves_only:false,search_callback:false};i.jstree.plugins.search=function(r,s){this.bind=function(){s.bind.call(this);this._data.search.str="";this._data.search.dom=i();this._data.search.res=[];this._data.search.opn=[];this._data.search.som=false;this._data.search.smc=false;this._data.search.hdn=[];this.element.on("search.jstree",i.proxy(function(y,w){if(this._data.search.som&&w.res.length){var t=this._model.data,v,u,x=[];for(v=0,u=w.res.length;v<u;v++){if(t[w.res[v]]&&!t[w.res[v]].state.hidden){x.push(w.res[v]);x=x.concat(t[w.res[v]].parents);if(this._data.search.smc){x=x.concat(t[w.res[v]].children_d)}}}x=i.vakata.array_remove_item(i.vakata.array_unique(x),i.jstree.root);this._data.search.hdn=this.hide_all(true);this.show_node(x)}},this)).on("clear_search.jstree",i.proxy(function(u,t){if(this._data.search.som&&t.res.length){this.show_node(this._data.search.hdn)}},this))};this.search=function(D,F,w,y,v,z){if(D===false||i.trim(D.toString())===""){return this.clear_search()}y=this.get_node(y);y=y&&y.id?y.id:null;D=D.toString();var G=this.settings.search,E=G.ajax?G.ajax:false,x=this._model.data,C=null,t=[],u=[],B,A;if(this._data.search.res.length&&!v){this.clear_search()}if(w===e){w=G.show_only_matches}if(z===e){z=G.show_only_matches_children}if(!F&&E!==false){if(i.isFunction(E)){return E.call(this,D,i.proxy(function(H){if(H&&H.d){H=H.d}this._load_nodes(!i.isArray(H)?[]:i.vakata.array_unique(H),function(){this.search(D,true,w,y,v)},true)},this),y)}else{E=i.extend({},E);if(!E.data){E.data={}}E.data.str=D;if(y){E.data.inside=y}return i.ajax(E).fail(i.proxy(function(){this._data.core.last_error={error:"ajax",plugin:"search",id:"search_01",reason:"Could not load search parents",data:JSON.stringify(E)};this.settings.core.error.call(this,this._data.core.last_error)},this)).done(i.proxy(function(H){if(H&&H.d){H=H.d}this._load_nodes(!i.isArray(H)?[]:i.vakata.array_unique(H),function(){this.search(D,true,w,y,v)},true)},this))}}if(!v){this._data.search.str=D;this._data.search.dom=i();this._data.search.res=[];this._data.search.opn=[];this._data.search.som=w;this._data.search.smc=z}C=new i.vakata.search(D,true,{caseSensitive:G.case_sensitive,fuzzy:G.fuzzy});i.each(x[y?y:i.jstree.root].children_d,function(J,I){var H=x[I];if(H.text&&(!G.search_leaves_only||(H.state.loaded&&H.children.length===0))&&((G.search_callback&&G.search_callback.call(this,D,H))||(!G.search_callback&&C.search(H.text).isMatch))){t.push(I);u=u.concat(H.parents)}});if(t.length){u=i.vakata.array_unique(u);for(B=0,A=u.length;B<A;B++){if(u[B]!==i.jstree.root&&x[u[B]]&&this.open_node(u[B],null,0)===true){this._data.search.opn.push(u[B])}}if(!v){this._data.search.dom=i(this.element[0].querySelectorAll("#"+i.map(t,function(H){return"0123456789".indexOf(H[0])!==-1?"\\3"+H[0]+" "+H.substr(1).replace(i.jstree.idregex,"\\$&"):H.replace(i.jstree.idregex,"\\$&")}).join(", #")));this._data.search.res=t}else{this._data.search.dom=this._data.search.dom.add(i(this.element[0].querySelectorAll("#"+i.map(t,function(H){return"0123456789".indexOf(H[0])!==-1?"\\3"+H[0]+" "+H.substr(1).replace(i.jstree.idregex,"\\$&"):H.replace(i.jstree.idregex,"\\$&")}).join(", #"))));this._data.search.res=i.vakata.array_unique(this._data.search.res.concat(t))}this._data.search.dom.children(".jstree-anchor").addClass("jstree-search")}this.trigger("search",{nodes:this._data.search.dom,str:D,res:this._data.search.res,show_only_matches:w})};this.clear_search=function(){if(this.settings.search.close_opened_onclear){this.close_node(this._data.search.opn,0)}this.trigger("clear_search",{nodes:this._data.search.dom,str:this._data.search.str,res:this._data.search.res});if(this._data.search.res.length){this._data.search.dom=i(this.element[0].querySelectorAll("#"+i.map(this._data.search.res,function(t){return"0123456789".indexOf(t[0])!==-1?"\\3"+t[0]+" "+t.substr(1).replace(i.jstree.idregex,"\\$&"):t.replace(i.jstree.idregex,"\\$&")}).join(", #")));this._data.search.dom.children(".jstree-anchor").removeClass("jstree-search")}this._data.search.str="";this._data.search.res=[];this._data.search.opn=[];this._data.search.dom=i()};this.redraw_node=function(y,t,z,x){y=s.redraw_node.apply(this,arguments);if(y){if(i.inArray(y.id,this._data.search.res)!==-1){var w,u,v=null;for(w=0,u=y.childNodes.length;w<u;w++){if(y.childNodes[w]&&y.childNodes[w].className&&y.childNodes[w].className.indexOf("jstree-anchor")!==-1){v=y.childNodes[w];break}}if(v){v.className+=" jstree-search"}}}return y}};(function(r){r.vakata.search=function(x,v,C){C=C||{};C=r.extend({},r.vakata.search.defaults,C);if(C.fuzzy!==false){C.fuzzy=true}x=C.caseSensitive?x:x.toLowerCase();var z=C.location,A=C.distance,y=C.threshold,s=x.length,t,u,w,B;if(s>32){C.fuzzy=false}if(C.fuzzy){t=1<<(s-1);u=(function(){var D={},E=0;for(E=0;E<s;E++){D[x.charAt(E)]=0}for(E=0;E<s;E++){D[x.charAt(E)]|=1<<(s-E-1)}return D}());w=function(G,D){var F=G/s,E=Math.abs(z-D);if(!A){return E?1:F}return F+(E/A)}}B=function(Q){Q=C.caseSensitive?Q:Q.toLowerCase();if(x===Q||Q.indexOf(x)!==-1){return{isMatch:true,score:0}}if(!C.fuzzy){return{isMatch:false,score:1}}var L,K,P=Q.length,H=y,J=Q.indexOf(x,z),N,G,E=s+P,D,F,O,S,R,I=1,M=[];if(J!==-1){H=Math.min(w(0,J),H);J=Q.lastIndexOf(x,z+s);if(J!==-1){H=Math.min(w(0,J),H)}}J=-1;for(L=0;L<s;L++){N=0;G=E;while(N<G){if(w(L,z+G)<=H){N=G}else{E=G}G=Math.floor((E-N)/2+N)}E=G;F=Math.max(1,z-G+1);O=Math.min(z+G,P)+s;S=new Array(O+2);S[O+1]=(1<<L)-1;for(K=O;K>=F;K--){R=u[Q.charAt(K-1)];if(L===0){S[K]=((S[K+1]<<1)|1)&R}else{S[K]=((S[K+1]<<1)|1)&R|(((D[K+1]|D[K])<<1)|1)|D[K+1]}if(S[K]&t){I=w(L,K-1);if(I<=H){H=I;J=K-1;M.push(J);if(J>z){F=Math.max(1,2*z-J)}else{break}}}}if(w(L+1,z)>H){break}D=S}return{isMatch:J>=0,score:I}};return v===true?{search:B}:B(v)};r.vakata.search.defaults={location:0,distance:100,threshold:0.6,fuzzy:false,caseSensitive:false}}(i));i.jstree.defaults.sort=function(s,r){return this.get_text(s)>this.get_text(r)?1:-1};i.jstree.plugins.sort=function(r,s){this.bind=function(){s.bind.call(this);this.element.on("model.jstree",i.proxy(function(u,t){this.sort(t.parent,true)},this)).on("rename_node.jstree create_node.jstree",i.proxy(function(u,t){this.sort(t.parent||t.node.parent,false);this.redraw_node(t.parent||t.node.parent,true)},this)).on("move_node.jstree copy_node.jstree",i.proxy(function(u,t){this.sort(t.parent,false);this.redraw_node(t.parent,true)},this))};this.sort=function(w,t){var v,u;w=this.get_node(w);if(w&&w.children&&w.children.length){w.children.sort(i.proxy(this.settings.sort,this));if(t){for(v=0,u=w.children_d.length;v<u;v++){this.sort(w.children_d[v],false)}}}}};var p=false;i.jstree.defaults.state={key:"jstree",events:"changed.jstree open_node.jstree close_node.jstree check_node.jstree uncheck_node.jstree",ttl:false,filter:false};i.jstree.plugins.state=function(r,s){this.bind=function(){s.bind.call(this);var t=i.proxy(function(){this.element.on(this.settings.state.events,i.proxy(function(){if(p){clearTimeout(p)}p=setTimeout(i.proxy(function(){this.save_state()},this),100)},this));this.trigger("state_ready")},this);this.element.on("ready.jstree",i.proxy(function(v,u){this.element.one("restore_state.jstree",t);if(!this.restore_state()){t()}},this))};this.save_state=function(){var t={state:this.get_state(),ttl:this.settings.state.ttl,sec:+(new Date())};i.vakata.storage.set(this.settings.state.key,JSON.stringify(t))};this.restore_state=function(){var t=i.vakata.storage.get(this.settings.state.key);if(!!t){try{t=JSON.parse(t)}catch(u){return false}}if(!!t&&t.ttl&&t.sec&&+(new Date())-t.sec>t.ttl){return false}if(!!t&&t.state){t=t.state}if(!!t&&i.isFunction(this.settings.state.filter)){t=this.settings.state.filter.call(this,t)}if(!!t){this.element.one("set_state.jstree",function(w,v){v.instance.trigger("restore_state",{state:i.extend(true,{},t)})});this.set_state(t);return true}return false};this.clear_state=function(){return i.vakata.storage.del(this.settings.state.key)}};(function(r,s){r.vakata.storage={set:function(t,u){return window.localStorage.setItem(t,u)},get:function(t){return window.localStorage.getItem(t)},del:function(t){return window.localStorage.removeItem(t)}}}(i));i.jstree.defaults.types={"default":{}};i.jstree.defaults.types[i.jstree.root]={};i.jstree.plugins.types=function(r,s){this.init=function(w,u){var v,t;if(u&&u.types&&u.types["default"]){for(v in u.types){if(v!=="default"&&v!==i.jstree.root&&u.types.hasOwnProperty(v)){for(t in u.types["default"]){if(u.types["default"].hasOwnProperty(t)&&u.types[v][t]===e){u.types[v][t]=u.types["default"][t]}}}}}s.init.call(this,w,u);this._model.data[i.jstree.root].type=i.jstree.root};this.refresh=function(u,t){s.refresh.call(this,u,t);this._model.data[i.jstree.root].type=i.jstree.root};this.bind=function(){this.element.on("model.jstree",i.proxy(function(z,y){var u=this._model.data,B=y.nodes,x=this.settings.types,w,v,A="default";for(w=0,v=B.length;w<v;w++){A="default";if(u[B[w]].original&&u[B[w]].original.type&&x[u[B[w]].original.type]){A=u[B[w]].original.type}if(u[B[w]].data&&u[B[w]].data.jstree&&u[B[w]].data.jstree.type&&x[u[B[w]].data.jstree.type]){A=u[B[w]].data.jstree.type}u[B[w]].type=A;if(u[B[w]].icon===true&&x[A].icon!==e){u[B[w]].icon=x[A].icon}}u[i.jstree.root].type=i.jstree.root},this));s.bind.call(this)};this.get_json=function(z,v,A){var y,u,t=this._model.data,x=v?i.extend(true,{},v,{no_id:false}):{},w=s.get_json.call(this,z,x,A);if(w===false){return false}if(i.isArray(w)){for(y=0,u=w.length;y<u;y++){w[y].type=w[y].id&&t[w[y].id]&&t[w[y].id].type?t[w[y].id].type:"default";if(v&&v.no_id){delete w[y].id;if(w[y].li_attr&&w[y].li_attr.id){delete w[y].li_attr.id}if(w[y].a_attr&&w[y].a_attr.id){delete w[y].a_attr.id}}}}else{w.type=w.id&&t[w.id]&&t[w.id].type?t[w.id].type:"default";if(v&&v.no_id){w=this._delete_ids(w)}}return w};this._delete_ids=function(v){if(i.isArray(v)){for(var u=0,t=v.length;u<t;u++){v[u]=this._delete_ids(v[u])}return v}delete v.id;if(v.li_attr&&v.li_attr.id){delete v.li_attr.id}if(v.a_attr&&v.a_attr.id){delete v.a_attr.id}if(v.children&&i.isArray(v.children)){v.children=this._delete_ids(v.children)}return v};this.check=function(B,w,z,C,A){if(s.check.call(this,B,w,z,C,A)===false){return false}w=w&&w.id?w:this.get_node(w);z=z&&z.id?z:this.get_node(z);var t=w&&w.id?(A&&A.origin?A.origin:i.jstree.reference(w.id)):null,x,y,v,u;t=t&&t._model&&t._model.data?t._model.data:null;switch(B){case"create_node":case"move_node":case"copy_node":if(B!=="move_node"||i.inArray(w.id,z.children)===-1){x=this.get_rules(z);if(x.max_children!==e&&x.max_children!==-1&&x.max_children===z.children.length){this._data.core.last_error={error:"check",plugin:"types",id:"types_01",reason:"max_children prevents function: "+B,data:JSON.stringify({chk:B,pos:C,obj:w&&w.id?w.id:false,par:z&&z.id?z.id:false})};return false}if(x.valid_children!==e&&x.valid_children!==-1&&i.inArray((w.type||"default"),x.valid_children)===-1){this._data.core.last_error={error:"check",plugin:"types",id:"types_02",reason:"valid_children prevents function: "+B,data:JSON.stringify({chk:B,pos:C,obj:w&&w.id?w.id:false,par:z&&z.id?z.id:false})};return false}if(t&&w.children_d&&w.parents){y=0;for(v=0,u=w.children_d.length;v<u;v++){y=Math.max(y,t[w.children_d[v]].parents.length)}y=y-w.parents.length+1}if(y<=0||y===e){y=1}do{if(x.max_depth!==e&&x.max_depth!==-1&&x.max_depth<y){this._data.core.last_error={error:"check",plugin:"types",id:"types_03",reason:"max_depth prevents function: "+B,data:JSON.stringify({chk:B,pos:C,obj:w&&w.id?w.id:false,par:z&&z.id?z.id:false})};return false}z=this.get_node(z.parent);x=this.get_rules(z);y++}while(z)}break}return true};this.get_rules=function(u){u=this.get_node(u);if(!u){return false}var t=this.get_type(u,true);if(t.max_depth===e){t.max_depth=-1}if(t.max_children===e){t.max_children=-1}if(t.valid_children===e){t.valid_children=-1}return t};this.get_type=function(t,u){t=this.get_node(t);return(!t)?false:(u?i.extend({type:t.type},this.settings.types[t.type]):t.type)};this.set_type=function(A,y){var w,z,x,v,u;if(i.isArray(A)){A=A.slice();for(z=0,x=A.length;z<x;z++){this.set_type(A[z],y)}return true}w=this.settings.types;A=this.get_node(A);if(!w[y]||!A){return false}v=A.type;u=this.get_icon(A);A.type=y;if(u===true||(w[v]&&w[v].icon!==e&&u===w[v].icon)){this.set_icon(A,w[y].icon!==e?w[y].icon:true)}return true}};i.jstree.defaults.unique={case_sensitive:false,duplicate:function(s,r){return s+" ("+r+")"}};i.jstree.plugins.unique=function(r,s){this.check=function(B,x,y,C,z){if(s.check.call(this,B,x,y,C,z)===false){return false}x=x&&x.id?x:this.get_node(x);y=y&&y.id?y:this.get_node(y);if(!y||!y.children){return true}var t=B==="rename_node"?C:x.text,A=[],D=this.settings.unique.case_sensitive,u=this._model.data,w,v;for(w=0,v=y.children.length;w<v;w++){A.push(D?u[y.children[w]].text:u[y.children[w]].text.toLowerCase())}if(!D){t=t.toLowerCase()}switch(B){case"delete_node":return true;case"rename_node":w=(i.inArray(t,A)===-1||(x.text&&x.text[D?"toString":"toLowerCase"]()===t));if(!w){this._data.core.last_error={error:"check",plugin:"unique",id:"unique_01",reason:"Child with name "+t+" already exists. Preventing: "+B,data:JSON.stringify({chk:B,pos:C,obj:x&&x.id?x.id:false,par:y&&y.id?y.id:false})}}return w;case"create_node":w=(i.inArray(t,A)===-1);if(!w){this._data.core.last_error={error:"check",plugin:"unique",id:"unique_04",reason:"Child with name "+t+" already exists. Preventing: "+B,data:JSON.stringify({chk:B,pos:C,obj:x&&x.id?x.id:false,par:y&&y.id?y.id:false})}}return w;case"copy_node":w=(i.inArray(t,A)===-1);if(!w){this._data.core.last_error={error:"check",plugin:"unique",id:"unique_02",reason:"Child with name "+t+" already exists. Preventing: "+B,data:JSON.stringify({chk:B,pos:C,obj:x&&x.id?x.id:false,par:y&&y.id?y.id:false})}}return w;case"move_node":w=((x.parent===y.id&&(!z||!z.is_multi))||i.inArray(t,A)===-1);if(!w){this._data.core.last_error={error:"check",plugin:"unique",id:"unique_03",reason:"Child with name "+t+" already exists. Preventing: "+B,data:JSON.stringify({chk:B,pos:C,obj:x&&x.id?x.id:false,par:y&&y.id?y.id:false})}}return w}return true};this.create_node=function(B,v,D,E,C){if(!v||v.text===e){if(B===null){B=i.jstree.root}B=this.get_node(B);if(!B){return s.create_node.call(this,B,v,D,E,C)}D=D===e?"last":D;if(!D.toString().match(/^(before|after)$/)&&!C&&!this.is_loaded(B)){return s.create_node.call(this,B,v,D,E,C)}if(!v){v={}}var z,t,A,y,x,u=this._model.data,F=this.settings.unique.case_sensitive,w=this.settings.unique.duplicate;t=z=this.get_string("New node");A=[];for(y=0,x=B.children.length;y<x;y++){A.push(F?u[B.children[y]].text:u[B.children[y]].text.toLowerCase())}y=1;while(i.inArray(F?t:t.toLowerCase(),A)!==-1){t=w.call(this,z,(++y)).toString()}v.text=t}return s.create_node.call(this,B,v,D,E,C)}};var b=o.createElement("DIV");b.setAttribute("unselectable","on");b.setAttribute("role","presentation");b.className="jstree-wholerow";b.innerHTML="&#160;";i.jstree.plugins.wholerow=function(r,s){this.bind=function(){s.bind.call(this);this.element.on("ready.jstree set_state.jstree",i.proxy(function(){this.hide_dots()},this)).on("init.jstree loading.jstree ready.jstree",i.proxy(function(){this.get_container_ul().addClass("jstree-wholerow-ul")},this)).on("deselect_all.jstree",i.proxy(function(u,t){this.element.find(".jstree-wholerow-clicked").removeClass("jstree-wholerow-clicked")},this)).on("changed.jstree",i.proxy(function(x,w){this.element.find(".jstree-wholerow-clicked").removeClass("jstree-wholerow-clicked");var v=false,u,t;for(u=0,t=w.selected.length;u<t;u++){v=this.get_node(w.selected[u],true);if(v&&v.length){v.children(".jstree-wholerow").addClass("jstree-wholerow-clicked")}}},this)).on("open_node.jstree",i.proxy(function(u,t){this.get_node(t.node,true).find(".jstree-clicked").parent().children(".jstree-wholerow").addClass("jstree-wholerow-clicked")},this)).on("hover_node.jstree dehover_node.jstree",i.proxy(function(u,t){if(u.type==="hover_node"&&this.is_disabled(t.node)){return}this.get_node(t.node,true).children(".jstree-wholerow")[u.type==="hover_node"?"addClass":"removeClass"]("jstree-wholerow-hovered")},this)).on("contextmenu.jstree",".jstree-wholerow",i.proxy(function(u){u.preventDefault();var t=i.Event("contextmenu",{metaKey:u.metaKey,ctrlKey:u.ctrlKey,altKey:u.altKey,shiftKey:u.shiftKey,pageX:u.pageX,pageY:u.pageY});i(u.currentTarget).closest(".jstree-node").children(".jstree-anchor").first().trigger(t)},this))
/*
				.on("mousedown.jstree touchstart.jstree", ".jstree-wholerow", function (e) {
						if(e.target === e.currentTarget) {
							var a = $(e.currentTarget).closest(".jstree-node").children(".jstree-anchor");
							e.target = a[0];
							a.trigger(e);
						}
					})
				*/
.on("click.jstree",".jstree-wholerow",function(u){u.stopImmediatePropagation();var t=i.Event("click",{metaKey:u.metaKey,ctrlKey:u.ctrlKey,altKey:u.altKey,shiftKey:u.shiftKey});i(u.currentTarget).closest(".jstree-node").children(".jstree-anchor").first().trigger(t).focus()}).on("click.jstree",".jstree-leaf > .jstree-ocl",i.proxy(function(u){u.stopImmediatePropagation();var t=i.Event("click",{metaKey:u.metaKey,ctrlKey:u.ctrlKey,altKey:u.altKey,shiftKey:u.shiftKey});i(u.currentTarget).closest(".jstree-node").children(".jstree-anchor").first().trigger(t).focus()},this)).on("mouseover.jstree",".jstree-wholerow, .jstree-icon",i.proxy(function(t){t.stopImmediatePropagation();if(!this.is_disabled(t.currentTarget)){this.hover_node(t.currentTarget)}return false},this)).on("mouseleave.jstree",".jstree-node",i.proxy(function(t){this.dehover_node(t.currentTarget)},this))};this.teardown=function(){if(this.settings.wholerow){this.element.find(".jstree-wholerow").remove()}s.teardown.call(this)};this.redraw_node=function(w,t,x,v){w=s.redraw_node.apply(this,arguments);if(w){var u=b.cloneNode(true);if(i.inArray(w.id,this._data.core.selected)!==-1){u.className+=" jstree-wholerow-clicked"}if(this._data.core.focused&&this._data.core.focused===w.id){u.className+=" jstree-wholerow-hovered"}w.insertBefore(u,w.childNodes[0])}return w}};if(o.registerElement&&Object&&Object.create){var k=Object.create(HTMLElement.prototype);k.createdCallback=function(){var s={core:{},plugins:[]},r;for(r in i.jstree.plugins){if(i.jstree.plugins.hasOwnProperty(r)&&this.attributes[r]){s.plugins.push(r);if(this.getAttribute(r)&&JSON.parse(this.getAttribute(r))){s[r]=JSON.parse(this.getAttribute(r))}}}for(r in i.jstree.defaults.core){if(i.jstree.defaults.core.hasOwnProperty(r)&&this.attributes[r]){s.core[r]=JSON.parse(this.getAttribute(r))||this.getAttribute(r)}}i(this).jstree(s)};try{o.registerElement("vakata-jstree",{prototype:k})}catch(m){}}}));(function(a){if(typeof define==="function"&&define.amd){define("jstree.primary_selected",["jquery","jstree"],a)}else{if(typeof exports==="object"){a(require("jquery"),require("jstree"))}else{a(jQuery,jQuery.jstree)}}}(function(b,a,c){if(b.jstree.plugins.primary_selected){return}b.jstree.plugins.primary_selected=function(d,e){this.ensure_sole_selected=function(f){f=this.get_node(f);if(this.get_selected()[0]==f.id){return}this.deselect_all();this.select_node(f)};this.primary=function(f){f(this.get_primary_selected(true))};this.get_primary_selected_dom=function(){return this.get_node(this.get_primary_selected(),true)};this.get_primary_selected=function(g){var f=this._data.core.primary_selected;if(typeof(f)==="undefined"){return false}return g?this.get_node(f):f};this.set_primary_selected=function(j,f){if(j==="#"){var h=this.get_node(j);j=h.children[0]}j=this.get_node(j);if(!j||j.id==="#"){return false}if(this._data.core.primary_selected){var g=this.get_node(this._data.core.primary_selected);if(g){g.state.primary_selected=false;var i=this.get_node(g,true);i.removeClass("primary-selected")}this._data.core.primary_selected=c}var k=this.get_node(j,true);if(!j.state.primary_selected){j.state.primary_selected=true;this._data.core.primary_selected=j.id;if(k&&k.length){k.addClass("primary-selected")}}this.ensure_sole_selected(j);if(typeof(f)!="undefined"){f(j)}};this.refresh_primary_selected=function(){this.set_primary_selected(this.get_primary_selected())}}}));(function(a){a.jstree.defaults.select_limit=20;a.jstree.plugins.select_limit=function(b,c){this.select_node=function(e,f,d){if(this.settings.select_limit>this.get_selected().length){c.select_node.call(this,e,f,d)}}}})(jQuery);$(function(){var p;var v=$("#archives_tree"),h=$("#object_container"),f=$("#archives_tree_toolbar");if(v.length===0){return}var G=[];var b=null;var s=[];$(document).bind("loadedrecordform.aspace",function(){if(!C.read_only){AS.tree_data.moveable=true}});if(v.length<1){return}var B;var C={root_object_id:v.data("root-id"),root:v.data("root"),root_node_type:v.data("root-node-type"),read_only:$(".archives-tree").data("read-only"),rules:$(".archives-tree").data("rules")};var t=function(O){h.html(O);var N=$("form",h);N.data("form_changed",false);$(".btn-primary",N).attr("disabled","disabled");$(".btn-cancel",N).attr("disabled","disabled");N.on("formchanged.aspace",function(){$(".btn-primary",N).removeAttr("disabled");$(".btn-cancel",N).removeAttr("disabled")});N.on("formreverted.aspace",function(P,Q){if($("form",h).data("form_changed")){var R=d(p.get_primary_selected());R.done(function(S){if(S){$(window).trigger("hashchange");$.scrollTo("header")}return})}});$(".btn-plus-one",N).click(function(P){P.preventDefault();P.stopImmediatePropagation();var Q=function(R,S){if(S.success){$(".archives-tree-container .add-sibling").trigger("click")}};N.data("createPlusOne",true);h.one("submitted",Q);N.triggerHandler("submit")});$(document).triggerHandler("loadedrecordform.aspace",[h]);$(".record-toolbar .revert-changes .btn",N).off().click(function(P){P.preventDefault();P.stopImmediatePropagation();N.trigger("formreverted.aspace")});$(".btn-cancel",N).html(AS.renderTemplate("tree_revert_changes_label_template")).off().click(function(P){P.preventDefault();P.stopImmediatePropagation();N.trigger("formreverted.aspace")});N.ajaxForm({data:{inline:true},beforeSubmit:function(P,Q){$(".btn-primary",Q).attr("disabled","disabled");if(Q.data("createPlusOne")){P.push({name:"plus_one",value:"true",required:false,type:"text"})}},success:function(R,P,S){var Q=t(R);if(Q.data("formErrors")){h.triggerHandler("submitted",{success:false});Q.data("form_changed",true);$(".btn-primary, .btn-cancel",Q).removeAttr("disabled")}else{Q.data("form_changed",false);h.triggerHandler("submitted",{success:true})}if(Q.data('"update-monitor-paused"')){Q.data("update-monitor-paused",false)}$.scrollTo("header")},error:function(R,Q,P){h.prepend("<div class='alert alert-error'><p>An error occurred saving this record.</p><pre>"+P+"</pre></div>");h.triggerHandler("submitted",{success:false});$(".btn-primary",N).removeAttr("disabled")}});AS.resetScrollSpy();return N};var n=function(){var N=$(AS.renderTemplate("tree_loading_notice_template"));N.hide();h.prepend(N);N.fadeIn();$(":input",h).attr("disabled","disabled")};var L=function(){$("#archives_tree_overlay").height("100%")};var E=function(){$("#archives_tree_overlay").height("0%")};var k=function(){$(".archives-tree-container .spinner").toggle()};var q=function(P,N){var O=N.match(/node_uri=([^&]*)/gm)[0].replace("node_uri=","");if(O==="root"){return P}else{if(O===P.record_uri){return(typeof(P.children)==="object"&&P.children.length>0)?P.children:[]}else{if(_.isUndefined(P)){return false}else{return q(_.find(P.children,function(Q){return(typeof(Q.children)==="object"&&Q.children.length>0)}),N)}}}};var F=function(){return p.get_primary_selected_dom()};var o=function(){return p.get_path(p.get_primary_selected(),false,true)};var A=function(P,O){P=P||false;var N=p.get_selected(P);if(P&&O){return _.sortBy(N,function(Q){return u(Q)})}else{return N}};var u=function(N){N=_.isString(N)?p.get_node(N):N;if(!N.parent){return false}return _(p.get_node(N.parent).children).findIndex(function(O){return O===N.id})};var c=function(){var N=$(".tree-loading-notice");N.fadeOut();N.remove();$(":input",h).removeAttr("disabled")};var D=function(N){N=_.isString(N)?p.get_node(N):N;return u(N)>(p.get_node(N.parent).children.length-2)};var w=function(N){return p.get_node(N.parent).children[u(N)-1]};var M=function(N){return p.get_node(N.parent).children[u(N)+1]};var r=function(O){var N=p.get_node(O,true);n();if(C.read_only){var R={};R.inline=true;R[C.root_node_type+"_id"]=C.root_object_id;$.ajax({url:APP_PATH+O.type+"s/"+O.id.replace(/.*_/,""),type:"GET",data:R,success:function(S){h.html(S);AS.resetScrollSpy();$(document).trigger("loadedrecordform.aspace",[h])},error:function(U,T,S){h.html("<div class='alert alert-error'><p>An error occurred loading this form.</p><pre>"+S+"</pre></div>")}});return}if(O.id==="new"){var P={inline:true};P[C.root_node_type+"_id"]=C.root_object_id;var Q=N.parents("li:first");if(Q.attr("rel")===N.attr("rel")){P[Q.attr("rel")+"_id"]=Q.data("id")}if(N.data("params")){P=$.extend({},P,N.data("params"))}$.ajax({url:APP_PATH+O.type+"s/new",data:P,type:"GET",success:function(S){t(S)},error:function(){h.html("<div class='alert alert-error'><p>An error occurred loading this form.</p><pre>"+errorDesc+"</pre></div>")}})}else{if(O.type){$.ajax({url:APP_PATH+O.type+"s/"+O.id.replace(/.*_/,"")+"/edit?inline=true",success:function(S){t(S)},error:function(U,T,S){h.html("<div class='alert alert-error'><p>An error occurred loading this record.</p><pre>"+S+"</pre></div>")}})}}};var J=function(P){var O=p.get_primary_selected(true);var Q={config:C};var N=u(O);if(N&&N!==0){Q.previous=w(O)}else{if(O.parent){Q.previous=O.parent}}if(O.children&&O.children.length>0){Q.next=O.children[0]}else{if(!D(O)){Q.next=M(O)}}$(".btn-toolbar",f).append(AS.renderTemplate("tree_nodenavigation_toolbar_template",Q))};var m=function(S){var S=p.get_node(S);var P=p.get_node(S,true);f.html(AS.renderTemplate("tree_toolbar_template"));J();if(C.read_only!==true&&P.attr("id")!="new"){var N={config:C,rules:C.rules[S.type],node_id:S.id.replace(/.*_/,""),root_object_id:C.root_object_id,up_level:S.parents.length>2};if(S.parent){var Q=p.get_node(p.get_parent(S));N.parent_id=Q.id;N.parent=Q;N.is_first=Q.children[0]===S.id;N.is_last=_.last(Q.children)===S.id;N.siblings=_(Q.children).filter(function(T){return T!=S.id}).map(function(T){T=p.get_node(T);return{id:T.id,title:T.original.title}}).value()}var O=$(AS.renderTemplate("tree_nodeactions_toolbar_template",N));$(".btn-toolbar",f).append(O);var R=$(AS.renderTemplate("tree_finish_action_template",N));$(".btn-success",R).click(function(U){U.preventDefault();U.stopImmediatePropagation();var T=$(this).attr("href");if($("form",h).data("form_changed")){var V=d(p.get_primary_selected_dom());V.done(function(W){if(W){window.location=T}})}else{window.location=T}});$(document).on("formclosed.aspace",function(){R.trigger("click")});$(".btn-toolbar",f).append(R);$("a",f).on("focus",function(){if($(this).parents("li.dropdown-submenu").length){$(".dropdown-menu",$(this).parent()).show()}else{$(".dropdown-submenu .dropdown-menu",$(this).parents(".nav")).css("display","")}});$(".dropdown-submenu > a",f).on("keyup",function(T){if(T.keyCode===39){$(".dropdown-menu a:first",$(this).parent()).focus()}});$(".dropdown-submenu > .dropdown-menu > li > a",f).on("keyup",function(){if(event.keyCode===37){$("> a",$(this).parents(".dropdown-submenu:first")).focus()}});if(v.data("clipboard")){if(!_.intersection(o(),v.data("clipboard")).length){$(".paste-node",f).removeAttr("disabled").removeClass("disabled")}}$(".cut-node",f).removeAttr("disabled").removeClass("disabled");e();$(document).trigger("loadedrecordform.aspace",[f])}};var z=function(N){if(N.indexOf("tree::")<0){tree_node_id="tree::"+N}else{tree_node_id=N}if(location.hash.length<1||location.hash==="#"+N||location.hash===N||location.hash===tree_node_id){j(tree_node_id)}else{location.hash=tree_node_id}};var j=function(N){$(window).data("ignore-hashchange",true);$(".locked").removeClass("locked");location.hash=N};var K=function(){var P;$(".locked").removeClass("locked");if($(":focus").length>0&&$(":focus").closest(f).length>0){P=$(":focus").attr("class")}if($(window).data("ignore-hashchange")){$(window).data("ignore-hashchange",false);return}if(!location.hash||location.hash.indexOf("tree::")===-1){return}var O=location.hash.replace("#tree::","");p.set_primary_selected(O,function(Q){if(!Q.state.opened){p.open_node(Q,function(R){r(R);m(R)})}else{r(Q);m(Q)}});if(P){var N=$("[class='"+P+"']");if(N.is("[disabled]")){$(".btn:not([disabled]):first",f).focus()}else{$("[class='"+P+"']").focus()}}};var I=function(P,S,Q,N){var O={id:"new",node_type:S,type:S,text:Q.record_label,icon:"glyphicon glyphicon-asterisk",a_attr:{href:"#new"},li_attr:{rel:S,"class":"new","data-params":N?N:""}};var R=p.create_node(P,O,"last");z("new")};var g=function(){var N=$("#archives_tree").parent().height()-f.outerHeight()-21;$("#archives_tree").height(N)};var e=function(){if(p.get_primary_selected(true).parents.length<3){$(".move-node-up-level",f).attr("disabled","disabled").addClass("disabled")}};var x=function(){$(".archives-tree-container").on("click",".add-child",function(){if(!p.get_primary_selected()){return}var N=p.get_primary_selected();var O=p.get_primary_selected(true).original.type;I(N,$(this).attr("rel"),C.rules[O].can_add_child)});$(".archives-tree-container").on("click",".add-sibling",function(){if(!p.get_primary_selected()){return}var O=p.get_primary_selected(true).parent;var N=p.get_primary_selected(true).type;var P=p.get_node(O).type;I(O,N,C.rules[P].can_add_child)});h.on("click",".btn-cancel",function(N){N.preventDefault();N.stopImmediatePropagation();if($(this).attr("disabled")){return}if(F().attr("id")==="new"){z(F().parents("li:first").attr("id"))}else{r(p.get_primary_selected(true))}});$(".archives-tree-container").on("click",".expand-tree .btn",function(){$(".archives-tree-container").addClass("expanded");$(".archives-tree-container").animate({width:$(".archives-tree-container").parents(".container:first").width()-5},500)});$(".archives-tree-container").on("click",".retract-tree .btn",function(){$(".archives-tree-container").animate({width:$(".archives-tree-container").parent().width()},500,function(){$(".archives-tree-container").removeClass("expanded");$(".archives-tree-container").css("width","auto")})});$(".archives-tree-container").on("click",".move-node",function(S){S.preventDefault();S.stopPropagation();var O;var P;var N=function(){O=A(true,true);P=O[0]};N();switch($(this).attr("rel")){case"down":if(P===undefined){N()}var Q=P.parent;var R=u(P)+O.length+1;p.move_node(O,Q,R);break;case"up":if(P===undefined){N()}var Q=P.parent;var R=u(P)-1;if(R>-1){p.move_node(O,Q,R)}break;case"down-into":var Q=$(this).data("target-node-id");p.move_node(O,Q,0);p.open_node(Q);break;case"up-level":var Q=p.get_path(P,false,true).slice(-3,-2);p.move_node(O,Q,0);break}});$(".archives-tree-container").on("click",".transfer-node",function(N){if($(".tree-transfer-form",".archives-tree-container")[0].style.display==="block"){$(".tree-transfer-form",".archives-tree-container").css("display","");$(".missing-ref-message",".archives-tree-container .tree-transfer-form form").hide();$(".token-input-dropdown").hide()}else{$(".tree-transfer-form",".archives-tree-container").css("display","block");$(".tree-transfer-form form",".archives-tree-container").unbind("submit").submit(function(O){if($(this).serializeObject()["transfer[ref]"]){return}else{O.stopPropagation();O.preventDefault();$(".missing-ref-message",".archives-tree-container .tree-transfer-form form").show();return true}});setTimeout(function(){$("#token-input-transfer_ref_",".archives-tree-container").focus()})}});$(".archives-tree-container").on("click",".tree-transfer-form :input",function(N){N.stopPropagation()});$(".archives-tree-container").on("click",".tree-transfer-form .dropdown-toggle",function(N){N.stopPropagation();$(this).parent().toggleClass("open")});$(".archives-tree-container").on("click",".tree-transfer-form .btn-cancel",function(N){$(".tree-transfer-form",".archives-tree-container").css("display","");$(".transfer-node",".archives-tree-container").parent().removeClass("open")});$(".archives-tree-container").on("click",".cut-node",function(N){N.preventDefault();if($(this).hasClass("disabled")){return}_.forEach(p.get_selected(),function(O){p.get_node(O,true).addClass("cut-to-clipboard")});$(".cut-to-clipboard",v).removeClass("cut-to-clipboard");v.data("clipboard",p.get_selected());$(this).addClass("disabled").addClass("btn-success")}).on("click",".paste-node",function(N){N.preventDefault();if($(this).hasClass("disabled")||!v.data("clipboard")){return}var O=p.get_primary_selected();p.move_node(v.data("clipboard"),O);v.data("clipboard",null);$(this).addClass("disabled");$(".cut-to-clipboard",v).removeClass("cut-to-clipboard")});$(".archives-tree-container").on("click",".add-children",function(){var N=F();if(N.length===0){return}$(document).triggerHandler("rdeshow.aspace",[N,$(this)])});$(".archives-tree-container").on("click",".refresh-tree",function(N){N.preventDefault();N.stopImmediatePropagation();p.refresh()});$(window).hashchange(K);$("#archives_tree").scroll(function(){if($(this).scrollTop()===0){$(this).removeClass("overflow")}else{$(this).addClass("overflow")}});if(AS.prefixed_cookie("archives-tree-container::height")){$(".archives-tree-container").height(AS.prefixed_cookie("archives-tree-container::height"))}else{$(".archives-tree-container").height(AS.DEFAULT_TREE_PANE_HEIGHT)}$(".archives-tree-container").resizable({handles:"s",minHeight:80,resize:function(N,O){AS.prefixed_cookie("archives-tree-container::height",O.size.height);g();$(window).triggerHandler("resize.tree")}})};var a=function(R){var Q;L();k();$(document).triggerHandler("lockform.aspace",[h]);if(typeof R[0]==="string"){R=_.map(R,function(U){return p.get_node(U)});Q=0}else{R=_.sortBy(R,function(U){return U.position});var P=R[0];Q=P.position;if((P.parent===P.old_parent)&&(P.position>P.old_position)){Q-=R.length-1}}var S=p.get_node(R[0].parent);var O=p.get_node(S,true);if(_.uniq(_.map(R,function(U){return U.parent})).length>1){return false}var N=_.map(R,function(U){if(_.has(U,"node")){return U.node.original.record_uri}else{return U.original.record_uri}});var T={children:N,index:Q};$.ajax({url:APP_PATH+S.type+"s/"+S.id.replace(/.*_/,"")+"/accept_children",type:"POST",data:T,success:function(W,U,V){if(T.index!==W.position){p.refresh();AS.openQuickModal(AS.renderTemplate("tree_unable_to_move_message_template"),V.responseText)}else{p.refresh_primary_selected();p.primary(function(aa){var X=p.get_node(aa,true);if(N.indexOf(aa.original.record_uri)>=0){var Z=$("input.hidden-parent-uri",h);if(S.type===aa.type){Z.attr("name",aa.type+"[parent][ref]");Z.val(S.original.record_uri)}else{Z.attr("name",aa.type+"[parent]");Z.val(null)}}$("#"+X.attr("rel")+"_position_",h).val(X.index());s=S.children;var Y=p.get_selected();setTimeout(function(){E();k();p.select_node(Y)},1000);if(S.parent==="#"){parent=p.get_node(p.get_parent(s[0]));p.refresh_node(parent)}else{p.refresh_node(S)}$(document).triggerHandler("unlockform.aspace",[h])})}},error:function(U,W,V){p.refresh();AS.openQuickModal(AS.renderTemplate("tree_unable_to_move_message_template"))}})};var d=function(Q){var P=p.get_node(Q);var N=p.get_node(P,true);var R=$.Deferred();var O;if(N.attr("id")==="new"){O=N.parents("li:first").attr("id")}AS.openCustomModal("saveYourChangesModal","Save Your Changes",AS.renderTemplate("save_changes_modal_template"));$("#saveChangesButton","#saveYourChangesModal").on("click",function(){var S=$("form",h);S.triggerHandler("submit");var T=function(){S.data("form_changed",false);z(P.id);$("#saveYourChangesModal").modal("hide");R.resolve(true)};var U=function(){$("#saveYourChangesModal").modal("hide");R.resolve(false)};h.one("submitted",function(V,W){if(W.success){T()}else{U()}})});$("#dismissChangesButton","#saveYourChangesModal").on("click",function(){$("form",h).data("form_changed",false);if(N.attr("id")!="new"){v.jstree("delete_node",$("#new",v))}$("#saveYourChangesModal").modal("hide");R.resolve(true)});$(".btn-cancel","#saveYourChangesModal").on("click",function(){if(N.attr("id")==="new"){v.jstree("delete_node",$("#new",v))}R.resolve(false)});return R.promise()};var y=function(){$(".selected",v).removeClass("selected");if(p.get_selected().length>1){$.each(p.get_selected(),function(O,P){$nodeEl=p.get_node(P,true);$nodeEl.addClass("selected");$(".selected-order",$nodeEl).html(O+1).show()});v.trigger("treemultipleselected.aspace")}else{if(p.get_selected().length===1){p.set_primary_selected(p.get_selected()[0]);var N=p.get_selected(true)[0];if(!N.state.opened){p.open_node(N)}if(N.id!="new"){p.delete_node("new")}z(p.get_primary_selected());$nodeEl=p.get_primary_selected_dom();$nodeEl.addClass("selected");$(".selected-order").empty();$(".selected-order:first",$nodeEl).html(1).show();p.hover_node(p.get_primary_selected());v.trigger("treesingleselected.aspace")}}};var H=function(){if(B){return B}if(location.hash){var P=location.hash.replace("tree::","");if(AS.tree_data.hasOwnProperty(P.replace("#",""))){B=[];var O=P.replace("#","");while(true){var N=AS.tree_data[O];B.push(O);if(N.hasOwnProperty("parent")){O=N.parent}else{B=B.reverse();B.pop();return B}}}}return[]};var i=function(N){if(_.isArray(N)){_.forEach(N,function(O){i(O)})}else{N.text=AS.renderTemplate("tree_node_"+N.node_type+"_template",{node:N});if(_.has(N,"children")&&_.isArray(N.children)){i(N.children)}}};var l=function(N){AS.tree_data={moveable:false};v.jstree({core:{data:function(Q,O){var P=v.data("tree-url");if(Q.id==="#"){P+="?node_uri=root&hash="+location.hash.replace("#","")}else{P+="?node_uri="+Q.original.record_uri}$.ajax(P,{success:function(R){_.tap(q(R,P),function(S){i(S);O(S)})}})},check_callback:function(O,P,R,Q){switch(O){case"create_node":return AS.tree_data.moveable;case"rename_node":return AS.tree_data.moveable;case"move_node":if(AS.tree_data.moveable){if(R.parent==null){return false}else{return true}}else{return false}case"delete_node":return P.id==="new";default:return AS.tree_data.moveable}},animation:0,html_titles:true},types:{"default":{icon:"glyphicon glyphicon-file"},archival_object:{icon:"glyphicon glyphicon-file"},resource:{icon:"glyphicon glyphicon-list-alt"},digital_object_component:{icon:"asicon icon-digital_object_component"},digital_object:{icon:"asicon icon-digital_object"},classification:{icon:"glyphicon glyphicon-file"},classification_term:{icon:"glyphicon glyphicon-file"}},themes:{name:"default",url:false,dots:true},dnd:{drop_target:false,drag_target:false},ui:{selected_parent_close:false,selected_parent_open:true,select_limit:-1,select_multiple_modifier:(navigator.appVersion.indexOf("Mac")!=-1)?"meta":"ctrl",disable_selecting_children:true},crrm:{move:{check_move:function(O){if(C.read_only){return false}if($(O.o[0]).hasClass(C.root_node_type)){return false}if($(O.np[0]).hasClass("archives-tree")){return false}return true}}},hotkeys:{up:false,down:false,"ctrl+up":function(){$(".move-node-up",f).trigger("click")},"shift+up":false,"ctrl+down":function(){$(".move-node-down",f).trigger("click")},"shift+down":false,"ctrl+left":function(){$(".move-node-up-level",f).trigger("click")},"shift+left":false,"ctrl+right":function(){$($(".move-node-down-into",f)[F().index()]).trigger("click")},"shift+right":false,space:false,"ctrl+space":false,"shift+space":false,f2:false,del:false,"return":function(){$(".jstree-hovered",v).trigger("click")}},plugins:["select_limit","primary_selected","types","themes","ui","html_data","crrm","dnd","hotkeys"]}).one("loaded.jstree",function(){p=v.jstree(true);AS._tree=p;if(location.hash){var O=location.hash.replace("#tree::","");p.select_node(O)}if(!p.get_primary_selected()){if(p.get_selected().length>0){p.set_primary_selected(p.get_selected()[0])}else{p.set_primary_selected("#")}}p.primary(function(P){p.open_node(P);m(P)});N()}).bind("select_node.jstree",function(O,P){if($("form",h).data("form_changed")&&P.node.id!=p.get_primary_selected()){var Q=d(p.get_primary_selected());Q.done(function(R){if(R){y()}else{p.refresh_primary_selected()}});Q.fail(function(R){console.log(R)})}else{y()}}).bind("deselect_node.jstree",function(P,Q){var O=v.jstree("get_node",Q.node,true);if(O.hasClass("primary-selected")){v.jstree("select_node",O)}else{O.removeClass("selected")}}).bind("move_node.jstree",function(O,P){if(b){clearTimeout(b)}G.push(P);b=setTimeout(function(){a(G);G=[];y()},50)}).bind("refreshtreenode.aspace",function(T,U){AS.tree_data.moveable=true;var P=U.title||U.text;U.text=AS.renderTemplate("tree_node_"+U.node_type+"_template",{node:U});U.type=U.node_type;var V=U.jsonmodel_type+"_"+U.id;if(U.replace_new_node){if(U.uri&&!U.record_uri){U.record_uri=U.uri}var O=("new"===p.get_primary_selected());var Q=p.get_node("new");var R=Q.parent;U.a_attr={href:"#"+V,title:P};U.li_attr={"data-id":U.id,"data-uri":U.uri,id:V,rel:U.node_type};U.id=V;p.delete_node(Q);var S=p.create_node(R,U,"last",function(W){if(O){p.set_primary_selected(W)}j("#tree::"+V);m(W)})}else{p.rename_node(V,U.text);$("a",p.get_node(V,true)).attr("title",P);p.refresh_primary_selected()}}).on("after_open.jstree",function(P,Q){var O=p.get_primary_selected_dom();if(O&&O.length){O.addClass("primary-selected")}}).on("click",".jstree-leaf a",function(O){if(typeof O.isTrigger=="undefined"){$(this).focus()}})};l(function(){g();p.primary(function(N){if(location.hash.length===0){$(window).data("ignore-hashchange",true)}r(N);setTimeout(function(){v.scrollTo($("#"+N.id),0,{offsetTop:v.height()/2})},0)})});x();AS.refreshTreeNode=function(N){v.triggerHandler("refreshtreenode.aspace",[N])};v.bind("refresh_node.jstree",function(N,O){if(s.length==0){return}var P=O.instance.get_node(O.node.id);happy_family=s.length==P.children.length&&s.every(function(R,Q){return R===P.children[Q]});if(happy_family===false){AS.openQuickModal(AS.renderTemplate("tree_move_ordering_problem_message_template"),s)}s=[]});$(document).bind("readonlytree.aspace",function(N){AS.tree_data.moveable=false});$(document).bind("formreverted.aspace",function(N){AS.tree_data.moveable=true;$(".refresh-tree").click()})});$(function(){var d=10000;var b="stale";var c="opened_for_editing";var e="repository_changed";var a=function(h){if(h.data("update-monitor")==="enabled"){return}h.data("update-monitor","enabled");h.data("update-monitor-paused",false);var i=h.data("update-monitor-url");var j=h.data("update-monitor-lock_version");var k=h.data("update-monitor-record-uri");var g=h.data("update-monitor-record-is-stale");$(document).trigger("clearupdatemonitorintervals.aspace");var m=function(q){$(".record-pane .update-monitor-error",h).remove();if(g||q.status===b){var p=AS.renderTemplate(g?"update_monitor_save_failed_with_stale_record_template":"update_monitor_stale_record_message_template");$("#form_messages",h).prepend(p);$(".record-pane .form-actions",h).prepend(p);$(".btn-primary, .btn-toolbar .btn",h).attr("disabled","disabled").addClass("disabled");clearInterval($(document).data("UPDATE_MONITOR_POLLING_INTERVAL"))}else{if(q.status===c){var n=[];$.each(q.edited_by,function(r,s){n.push(r)});var p=AS.renderTemplate("update_monitor_other_editors_message_template",{user_ids:n.join(", ")});$("#form_messages",h).prepend(p);$(".record-pane .form-actions",h).prepend(p)}else{if(q.status===e){var p=AS.renderTemplate("update_monitor_repository_changed_message_template");$("#form_messages",h).prepend(p);$(".record-pane .form-actions",h).prepend(p)}}}if($(".as-nav-list li.alert-error").length===0){$(".as-nav-list").prepend(AS.renderTemplate("as_nav_list_errors_item_template"))}var o=$(".as-nav-list li.alert-error");if(!o.hasClass("acknowledged")&&$(document).data("UPDATE_MONITOR_HIGHLIGHT_INTERVAL")==null){$(document).data("UPDATE_MONITOR_HIGHLIGHT_INTERVAL",setInterval(function(){o.toggleClass("active")},3000));o.hover(function(){clearInterval($(document).data("UPDATE_MONITOR_HIGHLIGHT_INTERVAL"));o.removeClass("active").addClass("acknowledged")},function(){})}};var f=function(){$(".update-monitor-error",h).remove()};var l=function(){if(g){m();return}if(h.data("update-monitor-paused")==true){return}$.post(i,{lock_version:j,uri:k},function(n,p,o){if(n.status===b||n.status===c||n.status===e){m(n)}else{f()}},"json").fail(function(n,p,o){if(n.status===500||n.status===403){window.location.replace(FRONTEND_URL)}})};l();$(document).data("UPDATE_MONITOR_POLLING_INTERVAL",setInterval(l,d))};$(document).bind("setupupdatemonitor.aspace",function(g,f){a(f)});$(document).bind("clearupdatemonitorintervals.aspace",function(f){clearInterval($(document).data("UPDATE_MONITOR_HIGHLIGHT_INTERVAL"));clearInterval($(document).data("UPDATE_MONITOR_POLLING_INTERVAL"))})});AS.LoginHelper={init:function(a){$(a).each(function(){var c=$(this);var b=function(e){$(".form-group",c).removeClass("has-error");$(".alert-success",c).show();c.trigger("loginsuccess.aspace",[e])};var d=function(){$(".form-group",c).addClass("has-error");$(".alert-danger",c).show();$("#login",c).removeAttr("disabled");c.trigger("loginerror.aspace")};c.ajaxForm({dataType:"json",beforeSubmit:function(){$("#login",c).attr("disabled","disabled")},success:function(f,e,g){if(f.session){b(f)}else{d()}},error:function(g,f,e){d()}})})}};$(function(){var a=function(){$(this).each(function(){var b=$(this);var c=function(d){$.ajax({url:APP_PATH+"has_session",async:false,data_type:"json",success:function(f){if(f.has_session){return true}else{d.preventDefault();d.stopImmediatePropagation();$(":input[type='submit']",b).removeAttr("disabled");var h=$(".modal.initialised");if(h.length){h.hide()}var e=AS.openAjaxModal(APP_PATH+"login");e.removeClass("inline-login-modal");var g=$("form",e);AS.LoginHelper.init(g);g.on("loginsuccess.aspace",function(i,j){$(":input[name=authenticity_token]").val(j.csrf_token);if(h.length===0){b.unbind("submit",c);b.submit()}else{e.hide();e.remove();h.show()}e.on("hidden",function(){e.remove()});setTimeout(function(){e.modal("hide")},1000);return false});return false}},error:function(){$(":input[type='submit']",b).removeAttr("disabled");return true}})};b.on("submit",c)})};$(document).bind("loadedrecordform.aspace",function(b,c){$.proxy(a,c.find("form.aspace-record-form:not(.public-form)").andSelf().filter("form.aspace-record-form:not(.public-form)"))()});$.proxy(a,$("form.aspace-record-form:not(.public-form)"))()});$(function(){var c=function(){$(this).each(function(){$(".form-overlay",$(this)).height("100%").fadeIn();$(this).addClass("locked")})};var b=function(){$(this).each(function(){var e=$(AS.renderTemplate("form_overlay_unlock_template"));e.on("click",function(f){f.preventDefault();f.stopImmediatePropagation();$(window).trigger("hashchange")});$("#archives_form_overlay",$(this)).append(e);$(".alert",e).fadeIn()})};var d=[37,39,9];var a=function(){$(this).each(function(){var e=$(this);if(e.data("changedDetectionEnabled")){return}e.data("form_changed",e.data("form_changed")||false);e.data("changedDetectionEnabled",true);$("> .form-context > .row > .col-md-9",e).prepend('<div id="archives_form_overlay"><div class="modal-backdrop in form-overlay"></div></div>');$("> .form-context > .row > .col-md-3 .form-actions",e).prepend('<div id="archives_form_actions_overlay" class="modal-backdrop in form-overlay"></div>');var g=function(h){if($(h.target).parents("*[data-no-change-tracking='true']").length===0){e.trigger("formchanged.aspace");e.trigger("readonlytree.aspace")}};e.on("change keyup",":input",function(h){if($(this).data("original_value")&&($(this).data("original_value")!==$(this).val())){g(h)}else{if($.inArray(h.keyCode,d)===-1){g(h)}}});var f=function(i){i.preventDefault();var h=$("<input>").attr("type","hidden").attr("name","ignorewarnings").val("true");$("form.aspace-record-form").append($(h));$("form.aspace-record-form").submit();return false};e.on("click",":radio, :checkbox",g);e.on("formchanged.aspace",function(h){if(e.data("form_changed")===true){h.stopPropagation()}else{$(document).bind("keydown","ctrl+s",f);$(":input",h.target).bind("keydown","ctrl+s",f)}e.data("form_changed",true);$(".record-toolbar",e).addClass("formchanged");$(".record-toolbar .btn-toolbar .btn",e).addClass("disabled").attr("disabled","disabled")});$(".createPlusOneBtn",e).on("click",function(){e.data("createPlusOne","true")});e.bind("submit",function(h){e.data("form_changed",false);e.data("update-monitor-paused",true);e.off("change keyup formchanged.aspace");$(document).unbind("keydown",f);$(":input[type='submit'], :input.btn-primary",e).attr("disabled","disabled");if($(this).data("createPlusOne")){var i=$("<input>").attr("type","hidden").attr("name","plus_one").val("true");$(e).append(i)}return true});$(".record-toolbar .revert-changes .btn",e).click(function(){e.data("form_changed",false);return true});$(".form-actions .btn-cancel",e).click(function(){e.data("form_changed",false);return true});$(window).bind("beforeunload",function(h){if(e.data("form_changed")===true){return"Please note you have some unsaved changes."}});if(e.data("update-monitor")){$(document).trigger("setupupdatemonitor.aspace",[e])}else{if(e.closest(".modal").length===0){$(document).trigger("clearupdatemonitorintervals.aspace",[e])}}})};$(document).bind("loadedrecordform.aspace",function(e,f){$.proxy(a,$("form.aspace-record-form",f))()});$(document).bind("lockform.aspace",function(e,f){$.proxy(c,[f])()});$(document).bind("unlockform.aspace",function(e,f){$.proxy(b,[f])()});$.proxy(a,$("form.aspace-record-form"))()});(function(d){var i={method:"GET",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,contentType:"json",prePopulate:null,processPrePopulate:false,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:true,theme:null,zindex:999,resultsLimit:null,enableHTML:true,resultsFormatter:function(l){var k=l[this.propertyToSearch];return"<li>"+(this.enableHTML?k:a(k))+"</li>"},tokenFormatter:function(l){var k=l[this.propertyToSearch];return"<li><p>"+(this.enableHTML?k:a(k))+"</p></li>"},tokenLimit:null,tokenDelimiter:",",preventDuplicates:false,tokenValue:"id",allowFreeTagging:false,onResult:null,onCachedResult:null,onAdd:null,onFreeTaggingAdd:null,onDelete:null,onReady:null,idPrefix:"token-input-",disabled:false,formatQueryParam:function(l,k){return l},caching:true};var f={tokenList:"token-input-list",token:"token-input-token",tokenReadOnly:"token-input-token-readonly",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token",focused:"token-input-focused",disabled:"token-input-disabled"};var h={BEFORE:0,AFTER:1,END:2};var e={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:null};var j={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};var g=/[&<>"'\/]/g;function c(k){return String((k===null||k===undefined)?"":k)}function a(k){return c(k).replace(g,function(l){return j[l]})}var b={init:function(k,l){var m=d.extend({},i,l||{});return this.each(function(){d(this).data("settings",m);d(this).data("tokenInputObject",new d.TokenList(this,k,m))})},clear:function(){this.data("tokenInputObject").clear();return this},add:function(k){this.data("tokenInputObject").add(k);return this},remove:function(k){this.data("tokenInputObject").remove(k);return this},get:function(){return this.data("tokenInputObject").getTokens()},toggleDisabled:function(k){this.data("tokenInputObject").toggleDisabled(k);return this},setOptions:function(k){d(this).data("settings",d.extend({},d(this).data("settings"),k||{}));return this}};d.fn.tokenInput=function(k){if(b[k]){return b[k].apply(this,Array.prototype.slice.call(arguments,1))}else{return b.init.apply(this,arguments)}};d.TokenList=function(o,y,Z){if(d.type(y)==="string"||d.type(y)==="function"){d(o).data("settings").url=y;var s=D();if(d(o).data("settings").crossDomain===undefined&&typeof s==="string"){if(s.indexOf("://")===-1){d(o).data("settings").crossDomain=false}else{d(o).data("settings").crossDomain=(location.href.split(/\/+/g)[1]!==s.split(/\/+/g)[1])}}}else{if(typeof(y)==="object"){d(o).data("settings").local_data=y}}if(d(o).data("settings").classes){d(o).data("settings").classes=d.extend({},f,d(o).data("settings").classes)}else{if(d(o).data("settings").theme){d(o).data("settings").classes={};d.each(f,function(af,ag){d(o).data("settings").classes[af]=ag+"-"+d(o).data("settings").theme})}else{d(o).data("settings").classes=f}}var L=[];var B=0;var x=new d.TokenList.Cache();var X;var T;var F=d('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",d(o).data("settings").idPrefix+o.id).focus(function(){if(d(o).data("settings").disabled){return false}else{if(d(o).data("settings").tokenLimit===null||d(o).data("settings").tokenLimit!==B){r()}}v.addClass(d(o).data("settings").classes.focused)}).blur(function(){M();d(this).val("");v.removeClass(d(o).data("settings").classes.focused);if(d(o).data("settings").allowFreeTagging){n()}else{d(this).val("")}v.removeClass(d(o).data("settings").classes.focused)}).bind("keyup keydown blur update",l).keydown(function(ag){var ai;var af;switch(ag.keyCode){case e.LEFT:return true;case e.RIGHT:return true;case e.UP:case e.DOWN:if(!d(this).val()){ai=t.prev();af=t.next();if((ai.length&&ai.get(0)===J)||(af.length&&af.get(0)===J)){if(ag.keyCode===e.LEFT||ag.keyCode===e.UP){Q(d(J),h.BEFORE)}else{Q(d(J),h.AFTER)}}else{if((ag.keyCode===e.LEFT||ag.keyCode===e.UP)&&ai.length){aa(d(ai.get(0)))}else{if((ag.keyCode===e.RIGHT||ag.keyCode===e.DOWN)&&af.length){aa(d(af.get(0)))}}}}else{var ah=null;if(ag.keyCode===e.DOWN||ag.keyCode===e.RIGHT){ah=d(V).next()}else{ah=d(V).prev()}if(ah.length){ad(ah)}}return false;case e.BACKSPACE:ai=t.prev();if(!d(this).val().length){if(J){q(d(J));K.change()}else{if(ai.length){aa(d(ai.get(0)))}}return false}else{if(d(this).val().length===1){M()}else{setTimeout(function(){I()},5)}}break;case e.TAB:return true;case e.ENTER:if(V){S(d(V).data("tokeninput"));K.change()}else{d(o).trigger("tokeninput.enter")}ag.stopPropagation();ag.preventDefault();break;case e.NUMPAD_ENTER:case e.COMMA:if(V){S(d(V).data("tokeninput"));K.change()}else{if(d(o).data("settings").allowFreeTagging){n()}ag.stopPropagation();ag.preventDefault()}return false;case e.ESCAPE:M();return true;default:if(String.fromCharCode(ag.which)){setTimeout(function(){I()},5)}break}});var K=d(o).hide().val("").focus(function(){ae(F)}).blur(function(){F.blur()});var J=null;var N=0;var V=null;var v=d("<ul />").addClass(d(o).data("settings").classes.tokenList).click(function(ag){var af=d(ag.target).closest("li");if(af&&af.get(0)&&d.data(af.get(0),"tokeninput")){ac(af)}else{if(J){Q(d(J),h.END)}ae(F)}}).mouseover(function(ag){var af=d(ag.target).closest("li");if(af&&J!==this){af.addClass(d(o).data("settings").classes.highlightedToken)}}).mouseout(function(ag){var af=d(ag.target).closest("li");if(af&&J!==this){af.removeClass(d(o).data("settings").classes.highlightedToken)}}).insertBefore(K);var t=d("<li />").addClass(d(o).data("settings").classes.inputToken).appendTo(v).append(F);var ab=d("<div>").addClass(d(o).data("settings").classes.dropdown).appendTo("body").hide();var R=d("<tester/>").insertAfter(F).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:F.css("fontSize"),fontFamily:F.css("fontFamily"),fontWeight:F.css("fontWeight"),letterSpacing:F.css("letterSpacing"),whiteSpace:"nowrap"});K.val("");var E=d(o).data("settings").prePopulate||K.data("pre");if(d(o).data("settings").processPrePopulate&&d.isFunction(d(o).data("settings").onResult)){E=d(o).data("settings").onResult.call(K,E)}if(E&&E.length){d.each(E,function(af,ag){p(ag);O()})}if(d(o).data("settings").disabled){H(true)}if(d.isFunction(d(o).data("settings").onReady)){d(o).data("settings").onReady.call()}this.clear=function(){v.children("li").each(function(){if(d(this).children("input").length===0){q(d(this))}})};this.add=function(af){S(af)};this.remove=function(af){v.children("li").each(function(){if(d(this).children("input").length===0){var ai=d(this).data("tokeninput");var ag=true;for(var ah in af){if(af[ah]!==ai[ah]){ag=false;break}}if(ag){q(d(this))}}})};this.getTokens=function(){return L};this.toggleDisabled=function(af){H(af)};function k(af){return d(o).data("settings").enableHTML?af:a(af)}function H(af){if(typeof af==="boolean"){d(o).data("settings").disabled=af}else{d(o).data("settings").disabled=!d(o).data("settings").disabled}F.attr("disabled",d(o).data("settings").disabled);v.toggleClass(d(o).data("settings").classes.disabled,d(o).data("settings").disabled);if(J){Q(d(J),h.END)}K.attr("disabled",d(o).data("settings").disabled)}function O(){if(d(o).data("settings").tokenLimit!==null&&B>=d(o).data("settings").tokenLimit){F.hide();M();return}}function l(){if(T===(T=F.val())){return}R.html(a(T));F.width(R.width()+30)}function Y(af){return((af>=48&&af<=90)||(af>=96&&af<=111)||(af>=186&&af<=192)||(af>=219&&af<=222))}function n(){var af=d.trim(F.val());var ag=af.split(d(o).data("settings").tokenDelimiter);d.each(ag,function(aj,ai){if(!ai){return}if(d.isFunction(d(o).data("settings").onFreeTaggingAdd)){ai=d(o).data("settings").onFreeTaggingAdd.call(K,ai)}var ah={};ah[d(o).data("settings").tokenValue]=ah[d(o).data("settings").propertyToSearch]=ai;S(ah)})}function p(ag){var ai=d(d(o).data("settings").tokenFormatter(ag));var af=ag.readonly===true?true:false;if(af){ai.addClass(d(o).data("settings").classes.tokenReadOnly)}ai.addClass(d(o).data("settings").classes.token).insertBefore(t);if(!af){d("<span>"+d(o).data("settings").deleteText+"</span>").addClass(d(o).data("settings").classes.tokenDelete).appendTo(ai).click(function(){if(!d(o).data("settings").disabled){q(d(this).parent());K.change();return false}})}var ah=ag;d.data(ai.get(0),"tokeninput",ag);L=L.slice(0,N).concat([ah]).concat(L.slice(N));N++;C(L,K);B+=1;if(d(o).data("settings").tokenLimit!==null&&B>=d(o).data("settings").tokenLimit){F.hide();M()}return ai}function S(af){var ah=d(o).data("settings").onAdd;if(B>0&&d(o).data("settings").preventDuplicates){var ag=null;v.children().each(function(){var aj=d(this);var ai=d.data(aj.get(0),"tokeninput");if(ai&&ai.id===af.id){ag=aj;return false}});if(ag){aa(ag);t.insertAfter(ag);ae(F);return}}if(d(o).data("settings").tokenLimit===null||B<d(o).data("settings").tokenLimit){p(af);O()}F.val("");M();if(d.isFunction(ah)){ah.call(K,af)}}function aa(af){if(!d(o).data("settings").disabled){af.addClass(d(o).data("settings").classes.selectedToken);J=af.get(0);F.val("");M()}}function Q(ag,af){ag.removeClass(d(o).data("settings").classes.selectedToken);J=null;if(af===h.BEFORE){t.insertBefore(ag);N--}else{if(af===h.AFTER){t.insertAfter(ag);N++}else{t.appendTo(v);N=B}}ae(F)}function ac(ag){var af=J;if(J){Q(d(J),h.END)}if(af===ag.get(0)){Q(ag,h.END)}else{aa(ag)}}function q(ag){var ah=d.data(ag.get(0),"tokeninput");var ai=d(o).data("settings").onDelete;var af=ag.prevAll().length;if(af>N){af--}ag.remove();J=null;ae(F);L=L.slice(0,af).concat(L.slice(af+1));if(af<N){N--}C(L,K);B-=1;if(d(o).data("settings").tokenLimit!==null){F.show().val("");ae(F)}if(d.isFunction(ai)){ai.call(K,ah)}}function C(ah,af){var ag=d.map(ah,function(ai){if(typeof d(o).data("settings").tokenValue=="function"){return d(o).data("settings").tokenValue.call(this,ai)}return ai[d(o).data("settings").tokenValue]});af.val(ag.join(d(o).data("settings").tokenDelimiter))}function M(){ab.hide().empty();V=null}function w(){ab.css({position:"absolute",top:d(v).offset().top+d(v).outerHeight(),left:d(v).offset().left,width:d(v).outerWidth(),"z-index":d(o).data("settings").zindex}).show()}function u(){if(d(o).data("settings").searchingText){ab.html("<p>"+k(d(o).data("settings").searchingText)+"</p>");w()}}function r(){if(d(o).data("settings").hintText){ab.html("<p>"+k(d(o).data("settings").hintText)+"</p>");w()}}var P=new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g");function W(af){return af.replace(P,"\\$&")}function A(ag,af){return ag.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+W(af)+")(?![^<>]*>)(?![^&;]+;)","gi"),function(ah,ai){return"<b>"+k(ai)+"</b>"})}function G(ag,ah,af){return ag.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+W(ah)+")(?![^<>]*>)(?![^&;]+;)","g"),A(ah,af))}function U(ah,af){if(af&&af.length){ab.empty();var ag=d("<ul>").appendTo(ab).mouseover(function(ai){ad(d(ai.target).closest("li"))}).mousedown(function(ai){S(d(ai.target).closest("li").data("tokeninput"));K.change();return false}).hide();if(d(o).data("settings").resultsLimit&&af.length>d(o).data("settings").resultsLimit){af=af.slice(0,d(o).data("settings").resultsLimit)}d.each(af,function(ai,aj){var ak=d(o).data("settings").resultsFormatter(aj);ak=G(ak,aj[d(o).data("settings").propertyToSearch],ah);ak=d(ak).appendTo(ag);if(ai%2){ak.addClass(d(o).data("settings").classes.dropdownItem)}else{ak.addClass(d(o).data("settings").classes.dropdownItem2)}if(ai===0){ad(ak)}d.data(ak.get(0),"tokeninput",aj)});w();if(d(o).data("settings").animateDropdown){ag.slideDown("fast")}else{ag.show()}}else{if(d(o).data("settings").noResultsText){ab.html("<p>"+k(d(o).data("settings").noResultsText)+"</p>");w()}}}function ad(af){if(af){if(V){m(d(V))}af.addClass(d(o).data("settings").classes.selectedDropdownItem);V=af.get(0)}}function m(af){af.removeClass(d(o).data("settings").classes.selectedDropdownItem);V=null}function I(){var af=F.val();if(af&&af.length){if(J){Q(d(J),h.AFTER)}if(af.length>=d(o).data("settings").minChars){u();clearTimeout(X);X=setTimeout(function(){z(af)},d(o).data("settings").searchDelay)}else{M()}}}function z(al){var ah=al+D();var af=x.get(ah);if(af){if(d.isFunction(d(o).data("settings").onCachedResult)){af=d(o).data("settings").onCachedResult.call(K,af)}U(al,af)}else{if(d(o).data("settings").url){var aj=D();var ai={};ai.data={};if(aj.indexOf("?")>-1){var am=aj.split("?");ai.url=am[0];var ag=am[1].split("&");d.each(ag,function(an,ap){var ao=ap.split("=");ai.data[ao[0]]=ao[1]})}else{ai.url=aj}ai.data[d(o).data("settings").queryParam]=d(o).data("settings").formatQueryParam(al,ai);ai.type=d(o).data("settings").method;ai.dataType=d(o).data("settings").contentType;if(d(o).data("settings").crossDomain){ai.dataType="jsonp"}ai.success=function(an){if(d(o).data("settings").caching){x.add(ah,d(o).data("settings").jsonContainer?an[d(o).data("settings").jsonContainer]:an)}if(d.isFunction(d(o).data("settings").onResult)){an=d(o).data("settings").onResult.call(K,an)}if(F.val()===al){U(al,d(o).data("settings").jsonContainer?an[d(o).data("settings").jsonContainer]:an)}};d.ajax(ai)}else{if(d(o).data("settings").local_data){var ak=d.grep(d(o).data("settings").local_data,function(an){return an[d(o).data("settings").propertyToSearch].toLowerCase().indexOf(al.toLowerCase())>-1});x.add(ah,ak);if(d.isFunction(d(o).data("settings").onResult)){ak=d(o).data("settings").onResult.call(K,ak)}U(al,ak)}}}}function D(){var af=d(o).data("settings").url;if(typeof d(o).data("settings").url=="function"){af=d(o).data("settings").url.call(d(o).data("settings"))}return af}function ae(af){setTimeout(function(){af.focus()},50)}};d.TokenList.Cache=function(l){var n=d.extend({max_size:500},l);var o={};var m=0;var k=function(){o={};m=0};this.add=function(q,p){if(m>n.max_size){k()}if(!o[q]){m+=1}o[q]=p};this.get=function(p){return o[p]}}}(jQuery));$(function(){$.fn.linker=function(){$(this).each(function(){var h=$(this);var l=h.parents(".linker-wrapper:first");if(h.hasClass("initialised")){return}h.addClass("initialised");$(".prelinker",l).remove();var a={url:decodeURIComponent(h.data("url")),browse_url:decodeURIComponent(h.data("browse-url")),format_template:h.data("format_template"),format_template_id:h.data("format_template_id"),format_property:h.data("format_property"),path:h.data("path"),name:h.data("name"),multiplicity:h.data("multiplicity")||"many",label:h.data("label"),label_plural:h.data("label_plural"),modal_id:h.data("modal_id")||(h.attr("id")+"_modal"),sortable:h.data("sortable")===true,types:h.data("types"),exclude_ids:h.data("exclude")||[]};a.allow_multiple=a.multiplicity==="many";if(a.format_template&&a.format_template.substring(0,2)!="${"){a.format_template="${"+a.format_template+"}"}var i=function(m){var n=$("#"+a.modal_id);var o=function(p){$(".linker-container",n).html(p);$("#createAndLinkButton",n).removeAttr("disabled");$("form",n).ajaxForm({data:{inline:true},beforeSubmit:function(){$("#createAndLinkButton",n).attr("disabled","disabled")},success:function(r,q,s){if($(r).is("form")){o(r)}else{if(a.multiplicity==="one"){e()}h.tokenInput("add",{id:r.uri,name:r.display_string||r.title,json:r});h.triggerHandler("change");n.modal("hide")}},error:function(s,r,q){$("#createAndLinkButton",n).removeAttr("disabled")}});n.scrollTo(".alert");n.trigger("resize");$(document).triggerHandler("loadedrecordform.aspace",[n])};$.ajax({url:m,success:o});$("#createAndLinkButton",n).click(function(){$("form",n).triggerHandler("submit")})};var f=function(){AS.openCustomModal(a.modal_id,"Create "+a.label,AS.renderTemplate("linker_createmodal_template",a),"large",{},this);if($(this).hasClass("linker-create-btn")){i($(this).data("target"))}else{i($(".linker-create-btn:first",l).data("target"))}return false};var j=function(){var o={};var n=function(p){$.each(h.tokenInput("get"),function(){o[this.id]=this.json});$.ajax({url:a.browse_url,data:{page:1,type:a.types,linker:true,exclude:a.exclude_ids,multiplicity:a.multiplicity},type:"GET",dataType:"html",success:function(s){var r=$("#"+a.modal_id);var t=$(".linker-container",r);var q=function(){$(":input[name=linker-item]",t).each(function(){var u=$(this);u.click(function(v){v.stopPropagation();if(!a.allow_multiple){o={};$("tr.selected",u.closest("table")).removeClass("selected")}if(o.hasOwnProperty(u.val())){delete o[u.val()];u.closest("tr").removeClass("selected")}else{o[u.val()]=u.data("object");u.closest("tr").addClass("selected")}});$("td",u.closest("tr")).click(function(v){v.preventDefault();u.trigger("click")})});$.each(o,function(u){$(":input[value='"+u+"']",t).attr("checked","checked").closest("tr").addClass("selected")});r.trigger("resize")};t.html(s);$(t).on("click","a",function(u){u.preventDefault();t.load(u.target.href,q)});$(t).on("submit","form",function(v){v.preventDefault();var u=$(v.target);var w=(u.attr("method")||"get").toUpperCase();if(w=="POST"){jQuery.post(u.attr("action")+".js",u.serializeArray(),function(x){t.html(x);q()})}else{t.load(u.attr("action")+".js?"+u.serialize(),q)}});q()}})};var m=function(){selectedItems=[];$(".token-input-delete-token",l).each(function(){$(this).triggerHandler("click")});$.each(o,function(q,p){h.tokenInput("add",{id:q,name:p.display_string||p.title,json:p})});$("#"+a.modal_id).modal("hide");h.triggerHandler("change")};AS.openCustomModal(a.modal_id,"Browse "+a.label_plural,AS.renderTemplate("linker_browsemodal_template",a),"large",{},this);n();$("#"+a.modal_id).on("click","#addSelectedButton",m);$("#"+a.modal_id).on("click",".linker-list .pagination .navigation a",function(){n($(this).attr("rel"))});return false};var g=function(o){var n=[];var m=[];$.each(h.tokenInput("get"),function(p){m.push(p.id)});$.each(o.search_data.results,function(p,q){if($.inArray(q.uri,m)===-1){n.push({name:q.display_string||q.title,id:q.id,json:q})}});return n};var b=function(){$(".linker-browse-btn",l).on("click",j);$(".linker-create-btn",l).on("click",f);l.one("mouseenter focus",".has-popover",function(){$(document).triggerHandler("init.popovers",[h.parent()])})};var e=function(){var o=$(".token-input-list",h.parent());for(var n=0;n<h.tokenInput("get").length;n++){var m=h.tokenInput("get")[n].id.replace(/\//g,"_");$("#"+m+" :input",o).remove()}h.tokenInput("clear")};var d=function(){if($(".token-input-list",l).data("sortable")){$(".token-input-list",l).sortable("destroy")}$(".token-input-list",l).sortable({items:"li.token-input-token"});$(".token-input-list",l).off("sortupdate").on("sortupdate",function(){h.parents("form:first").triggerHandler("formchanged.aspace")})};var c=function(){if(h.data("multiplicity")==="one"){if($.isEmptyObject(h.data("selected"))){return[]}return[{id:h.data("selected").uri,name:h.data("selected").display_string||h.data("selected").title,json:h.data("selected")}]}else{if(!h.data("selected")||h.data("selected").length===0){return[]}return h.data("selected").map(function(m){return{id:m.uri,name:m.display_string||m.title,json:m}})}};var k=function(){var m=$.extend({},AS.linker_locales,{animateDropdown:false,preventDuplicates:true,allowFreeTagging:false,tokenLimit:(a.multiplicity==="one"?1:null),caching:false,onCachedResult:g,onResult:g,zindex:1100,tokenFormatter:function(o){var n=$(AS.renderTemplate("linker_selectedtoken_template",{item:o,config:a}));$("input[name*=resolved]",n).val(JSON.stringify(o.json));return n},resultsFormatter:function(p){var o=p.name;var n=$("<span class='"+p.json.jsonmodel_type+"'>");n.text(o);n.prepend("<span class='icon-token'></span>");var q=$("<li>");q.append(n);return q[0].outerHTML},prePopulate:c(),onDelete:function(){h.triggerHandler("change")},onAdd:function(n){if(a.sortable&&a.allow_multiple){d()}$(document).triggerHandler("init.popovers",[h.parent()])},formatQueryParam:function(p,o){if(h.tokenInput("get").length>0||a.exclude_ids.length>0){var n=$.merge([],a.exclude_ids);$.each(h.tokenInput("get"),function(q,r){n.push(r.id)});o.data["exclude[]"]=n}if(a.types&&a.types.length>0){o.data.type=a.types}return(p+"*").toLowerCase()}});setTimeout(function(){h.tokenInput(a.url,m);$("> :input[type=text]",$(".token-input-input-token",h.parent())).attr("placeholder",AS.linker_locales.hintText);$("> :input[type=text]",$(".token-input-input-token",h.parent())).addClass("form-control");h.parent().addClass("multiplicity-"+a.multiplicity);if(a.sortable&&a.allow_multiple){d();l.addClass("sortable")}});b()};k()})}});$(document).ready(function(){$(document).bind("loadedrecordsubforms.aspace",function(a,b){$(".linker-wrapper:visible > .linker:not(.initialised)",b).linker();$("#archives_tree_toolbar .linker:not(.initialised)").linker()});$(document).bind("subrecordcreated.aspace",function(c,a,b){$(".linker:not(.initialised)",b).linker()})});window.CodeMirror=(function(){function p(a6,a2){var cq={},bD=p.defaults;for(var aU in bD){if(bD.hasOwnProperty(aU)){cq[aU]=(a2&&a2.hasOwnProperty(aU)?a2:bD)[aU]}}var bG=ai("textarea",null,null,"position: absolute; padding: 0; width: 1px; height: 1em");bG.setAttribute("wrap","off");bG.setAttribute("autocorrect","off");bG.setAttribute("autocapitalize","off");var cm=ai("div",[bG],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");var cO=ai("div",null,"CodeMirror-scrollbar-inner");var a5=ai("div",[cO],"CodeMirror-scrollbar");var aL=ai("div"),bA=ai("div",null,null,"position: relative; z-index: -1");var bx=ai("pre","\u00a0","CodeMirror-cursor"),br=ai("pre","\u00a0","CodeMirror-cursor","visibility: hidden");var aQ=ai("div",null,null,"position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden;");var bR=ai("div",[aQ,bx,br,bA,aL],null,"position: relative; z-index: 0");var bi=ai("div",null,"CodeMirror-gutter-text"),a0=ai("div",[bi],"CodeMirror-gutter");var cJ=ai("div",[a0,ai("div",[bR],"CodeMirror-lines")],null,"position: relative");var cz=ai("div",[cJ],null,"position: relative");var bE=ai("div",[cz],"CodeMirror-scroll");bE.setAttribute("tabIndex","-1");var aY=ai("div",[cm,a5,bE],"CodeMirror"+(cq.lineWrapping?" CodeMirror-wrap":""));if(a6.appendChild){a6.appendChild(aY)}else{a6(aY)}c5();cY();if(h){bG.style.width="0px"}if(!k){bE.draggable=true}bR.style.outline="none";if(cq.tabindex!=null){bG.tabIndex=cq.tabindex}if(cq.autofocus){bY()}if(!cq.gutter&&!cq.lineNumbers){a0.style.display="none"}if(af){cm.style.height="1px",cm.style.position="absolute"}if(U){a5.style.zIndex=-2;a5.style.visibility="hidden"}else{if(J){a5.style.minWidth="18px"}}var cx=new i(),aR=new i(),di;var cE,c1=new aj([new O([new H("")])]),dc=0,cL;cj();var dq={from:{line:0,ch:0},to:{line:0,ch:0},inverted:false};var cK,bL,bk,bT=0,bw,cQ=false,cV=false,cc=false;var cS,cw,aW,dg,a9,bc,c2;var by=0,dj=0,b9=0,ca=0;var ct;var b3=c8(0),c6=false,bK=true;var bP=false;var cX=null;aM(function(){bg(cq.value||"");cS=false})();var bu=new D();aC(bE,"mousedown",aM(cM));aC(bE,"dblclick",aM(cl));aC(bR,"selectstart",e);if(!v){aC(bE,"contextmenu",bm)}aC(bE,"scroll",cB);aC(a5,"scroll",bZ);aC(a5,"mousedown",function(){if(cL){setTimeout(bY,0)}});var cA=aC(window,"resize",function(){if(aY.parentNode){cG(true)}else{cA()}},true);aC(bG,"keyup",aM(cN));aC(bG,"input",ba);aC(bG,"keydown",aM(cF));aC(bG,"keypress",aM(bH));aC(bG,"focus",dn);aC(bG,"blur",aZ);function b2(ds){if(cq.onDragEvent&&cq.onDragEvent(cC,P(ds))){return}ac(ds)}if(cq.dragDrop){aC(bE,"dragstart",a1);aC(bE,"dragenter",b2);aC(bE,"dragover",b2);aC(bE,"drop",aM(aH))}aC(bE,"paste",function(){bY();ba()});aC(bG,"paste",function(){cc=true;ba()});aC(bG,"cut",aM(function(){if(!cq.readOnly){bO("")}}));if(af){aC(cz,"mouseup",function(){if(document.activeElement==bG){bG.blur()}bY()})}var cZ;try{cZ=(document.activeElement==bG)}catch(cy){}if(cZ||cq.autofocus){setTimeout(dn,20)}else{aZ()}function bN(ds){return ds>=0&&ds<c1.size}var cC=aY.CodeMirror={getValue:cr,setValue:aM(bg),getSelection:cs,replaceSelection:aM(bO),focus:function(){window.focus();bY();dn();ba()},setOption:function(dt,du){var ds=cq[dt];cq[dt]=du;if(dt=="mode"||dt=="indentUnit"){cj()}else{if(dt=="readOnly"&&du=="nocursor"){aZ();bG.blur()}else{if(dt=="readOnly"&&!du){c4(true)}else{if(dt=="theme"){c5()}else{if(dt=="lineWrapping"&&ds!=du){aM(c9)()}else{if(dt=="tabSize"){cG(true)}else{if(dt=="keyMap"){cY()}else{if(dt=="tabindex"){bG.tabIndex=du}}}}}}}}if(dt=="lineNumbers"||dt=="gutter"||dt=="firstLineNumber"||dt=="theme"||dt=="lineNumberFormatter"){bz();cG(true)}},getOption:function(ds){return cq[ds]},getMode:function(){return cE},undo:aM(dm),redo:aM(db),indentLine:aM(function(dt,ds){if(typeof ds!="string"){if(ds==null){ds=cq.smartIndent?"smart":"prev"}else{ds=ds?"add":"subtract"}}if(bN(dt)){bX(dt,ds)}}),indentSelection:aM(c3),historySize:function(){return{undo:bu.done.length,redo:bu.undone.length}},clearHistory:function(){bu=new D()},setHistory:function(ds){bu=new D();bu.done=ds.done;bu.undone=ds.undone},getHistory:function(){function ds(dy){for(var dx=0,dz=[],dA;dx<dy.length;++dx){dz.push(dA=[]);for(var dw=0,dv=dy[dx];dw<dv.length;++dw){var dt=[],dB=dv[dw];dA.push({start:dB.start,added:dB.added,old:dt});for(var du=0;du<dB.old.length;++du){dt.push(ar(dB.old[du]))}}}return dz}return{done:ds(bu.done),undone:ds(bu.undone)}},matchBrackets:aM(function(){cH(true)}),getTokenAt:aM(function(ds){ds=bd(ds);return c8(ds.line).getTokenAt(cE,cW(ds.line),cq.tabSize,ds.ch)}),getStateAfter:function(ds){ds=co(ds==null?c1.size-1:ds);return cW(ds+1)},cursorCoords:function(dt,ds){if(dt==null){dt=dq.inverted}return this.charCoords(dt?dq.from:dq.to,ds)},charCoords:function(dt,ds){dt=bd(dt);if(ds=="local"){return dk(dt,false)}if(ds=="div"){return dk(dt,true)}return aJ(dt)},coordsChar:function(ds){var dt=z(bR);return b6(ds.x-dt.left,ds.y-dt.top)},defaultTextHeight:function(){return ce()},markText:aM(b4),setBookmark:be,findMarksAt:bI,setMarker:aM(ck),clearMarker:aM(aP),setLineClass:aM(bF),hideLine:aM(function(ds){return dd(ds,true)}),showLine:aM(function(ds){return dd(ds,false)}),onDeleteLine:function(ds,dt){if(typeof ds=="number"){if(!bN(ds)){return null}ds=c8(ds)}(ds.handlers||(ds.handlers=[])).push(dt);return ds},lineInfo:bf,getViewport:function(){return{from:dj,to:b9}},addWidget:function(dw,du,dy,dv,dA){dw=dk(bd(dw));var dx=dw.yBot,dt=dw.x;du.style.position="absolute";cz.appendChild(du);if(dv=="over"){dx=dw.y}else{if(dv=="near"){var ds=Math.max(bE.offsetHeight,c1.height*ce()),dz=Math.max(cz.clientWidth,bR.clientWidth)-bq();if(dw.yBot+du.offsetHeight>ds&&dw.y>du.offsetHeight){dx=dw.y-du.offsetHeight}if(dt+du.offsetWidth>dz){dt=dz-du.offsetWidth}}}du.style.top=(dx+cU())+"px";du.style.left=du.style.right="";if(dA=="right"){dt=cz.clientWidth-du.offsetWidth;du.style.right="0px"}else{if(dA=="left"){dt=0}else{if(dA=="middle"){dt=(cz.clientWidth-du.offsetWidth)/2}}du.style.left=(dt+bq())+"px"}if(dy){aV(dt,dx,dt+du.offsetWidth,dx+du.offsetHeight)}},lineCount:function(){return c1.size},clipPos:bd,getCursor:function(ds){if(ds==null){ds=dq.inverted}return Y(ds?dq.from:dq.to)},somethingSelected:function(){return !R(dq.from,dq.to)},setCursor:aM(function(ds,du,dt){if(du==null&&typeof ds.line=="number"){bs(ds.line,ds.ch,dt)}else{bs(ds,du,dt)}}),setSelection:aM(function(du,dt,ds){(ds?bW:bU)(bd(du),bd(dt||du))}),getLine:function(ds){if(bN(ds)){return c8(ds).text}},getLineHandle:function(ds){if(bN(ds)){return c8(ds)}},setLine:aM(function(ds,dt){if(bN(ds)){cf(dt,{line:ds,ch:0},{line:ds,ch:c8(ds).text.length})}}),removeLine:aM(function(ds){if(bN(ds)){cf("",{line:ds,ch:0},bd({line:ds+1,ch:0}))}}),replaceRange:aM(cf),getRange:function(du,dt,ds){return dh(bd(du),bd(dt),ds)},triggerOnKeyDown:aM(cF),execCommand:function(ds){return r[ds](cC)},moveH:aM(c7),deleteH:aM(cP),moveV:aM(c0),toggleOverwrite:function(){if(cQ){cQ=false;bx.className=bx.className.replace(" CodeMirror-overwrite","")}else{cQ=true;bx.className+=" CodeMirror-overwrite"}},posFromIndex:function(dt){var du=0,ds;c1.iter(0,c1.size,function(dv){var dw=dv.text.length+1;if(dw>dt){ds=dt;return true}dt-=dw;++du});return bd({line:du,ch:ds})},indexFromPos:function(dt){if(dt.line<0||dt.ch<0){return 0}var ds=dt.ch;c1.iter(0,dt.line,function(du){ds+=du.text.length+1});return ds},scrollTo:function(ds,dt){if(ds!=null){bE.scrollLeft=ds}if(dt!=null){a5.scrollTop=bE.scrollTop=dt}cG([])},getScrollInfo:function(){return{x:bE.scrollLeft,y:a5.scrollTop,height:a5.scrollHeight,width:bE.scrollWidth}},scrollIntoView:function(dt){var ds=dk(dt?bd(dt):dq.inverted?dq.from:dq.to);aV(ds.x,ds.y,ds.x,ds.yBot)},setSize:function(du,ds){function dt(dv){dv=String(dv);return/^\d+$/.test(dv)?dv+"px":dv}if(du!=null){aY.style.width=dt(du)}if(ds!=null){bE.style.height=dt(ds)}cC.refresh()},operation:function(ds){return aM(ds)()},compoundChange:function(ds){return cd(ds)},refresh:function(){cG(true,null,bT);if(a5.scrollHeight>bT){a5.scrollTop=bT}},getInputField:function(){return bG},getWrapperElement:function(){return aY},getScrollerElement:function(){return bE},getGutterElement:function(){return a0}};function c8(ds){return K(c1,ds)}function bo(dt,ds){bc=true;var du=ds-dt.height;for(var dv=dt;dv;dv=dv.parent){dv.height+=du}}function cb(ds,dt){if(!ds.styles){ds.highlight(cE,ds.stateAfter=cW(V(ds)),cq.tabSize)}return ds.getContent(cq.tabSize,dt,cq.lineWrapping)}function bg(ds){var dt={line:0,ch:0};a8(dt,{line:c1.size-1,ch:c8(c1.size-1).text.length},g(ds),dt,dt);cS=true}function cr(dt){var ds=[];c1.iter(0,c1.size,function(du){ds.push(du.text)});return ds.join(dt||"\n")}function bZ(ds){if(Math.abs(a5.scrollTop-bT)>1){bT=bE.scrollTop=a5.scrollTop;cG([])}}function cB(ds){if(cq.fixedGutter&&a0.style.left!=bE.scrollLeft+"px"){a0.style.left=bE.scrollLeft+"px"}if(Math.abs(bE.scrollTop-bT)>1){bT=bE.scrollTop;if(a5.scrollTop!=bT){a5.scrollTop=bT}cG([])}if(cq.onScroll){cq.onScroll(cC)}}function cM(dE){bp(ab(dE,"shiftKey"));for(var dy=ap(dE);dy!=aY;dy=dy.parentNode){if(dy.parentNode==cz&&dy!=cJ){return}}for(var dy=ap(dE);dy!=aY;dy=dy.parentNode){if(dy.parentNode==bi){if(cq.onGutterClick){cq.onGutterClick(cC,s(bi.childNodes,dy)+dj,dE)}return e(dE)}}var dt=bn(dE);switch(C(dE)){case 3:if(v){bm(dE)}return;case 2:if(dt){bs(dt.line,dt.ch,true)}setTimeout(bY,20);e(dE);return}if(!dt){if(ap(dE)==bE){e(dE)}return}if(!cL){dn()}var du=+new Date,dH="single";if(bk&&bk.time>du-400&&R(bk.pos,dt)){dH="triple";e(dE);setTimeout(bY,20);a3(dt.line)}else{if(bL&&bL.time>du-400&&R(bL.pos,dt)){dH="double";bk={time:du,pos:dt};e(dE);var ds=bQ(dt);bW(ds.from,ds.to)}else{bL={time:du,pos:dt}}}function dz(dJ){if(k){bE.draggable=false}bw=false;dD();dx();if(Math.abs(dE.clientX-dJ.clientX)+Math.abs(dE.clientY-dJ.clientY)<10){e(dJ);bs(dt.line,dt.ch,true);bY()}}var dI=dt,dw;if(cq.dragDrop&&aa&&!cq.readOnly&&!R(dq.from,dq.to)&&!B(dt,dq.from)&&!B(dq.to,dt)&&dH=="single"){if(k){bE.draggable=true}var dD=aC(document,"mouseup",aM(dz),true);var dx=aC(bE,"drop",aM(dz),true);bw=true;if(bE.dragDrop){bE.dragDrop()}return}e(dE);if(dH=="single"){bs(dt.line,dt.ch,true)}var dG=dq.from,dv=dq.to;function dB(dK){if(dH=="single"){bW(dt,dK)}else{if(dH=="double"){var dJ=bQ(dK);if(B(dK,dG)){bW(dJ.from,dv)}else{bW(dG,dJ.to)}}else{if(dH=="triple"){if(B(dK,dG)){bW(dv,bd({line:dK.line,ch:0}))}else{bW(dG,bd({line:dK.line+1,ch:0}))}}}}}function dF(dJ){var dL=bn(dJ,true);if(dL&&!R(dL,dI)){if(!cL){dn()}dI=dL;dB(dL);cS=false;var dK=b0();if(dL.line>=dK.to||dL.line<dK.from){dw=setTimeout(aM(function(){dF(dJ)}),150)}}}function dC(dJ){clearTimeout(dw);var dK=bn(dJ);if(dK){dB(dK)}e(dJ);bY();cS=true;dA();dD()}var dA=aC(document,"mousemove",aM(function(dJ){clearTimeout(dw);e(dJ);if(!S&&!C(dJ)){dC(dJ)}else{dF(dJ)}}),true);var dD=aC(document,"mouseup",aM(dC),true)}function cl(ds){for(var dt=ap(ds);dt!=aY;dt=dt.parentNode){if(dt.parentNode==bi){return e(ds)}}e(ds)}function aH(dw){if(cq.onDragEvent&&cq.onDragEvent(cC,P(dw))){return}e(dw);var dz=bn(dw,true),dt=dw.dataTransfer.files;if(!dz||cq.readOnly){return}if(dt&&dt.length&&window.FileReader&&window.File){var dy=dt.length,dx=Array(dy),du=0;var dv=function(dC,dB){var dA=new FileReader;dA.onload=function(){dx[dB]=dA.result;if(++du==dy){dz=bd(dz);aM(function(){var dD=cf(dx.join(""),dz,dz);bW(dz,dD)})()}};dA.readAsText(dC)};for(var ds=0;ds<dy;++ds){dv(dt[ds],ds)}}else{if(bw&&!(B(dz,dq.from)||B(dq.to,dz))){return}try{var dx=dw.dataTransfer.getData("Text");if(dx){cd(function(){var dB=dq.from,dA=dq.to;bW(dz,dz);if(bw){cf("",dB,dA)}bO(dx);bY()})}}catch(dw){}}}function a1(dt){var ds=cs();dt.dataTransfer.setData("Text",ds);if(dt.dataTransfer.setDragImage){dt.dataTransfer.setDragImage(ai("img"),0,0)}}function bC(du,ds){if(typeof du=="string"){du=r[du];if(!du){return false}}var dt=cK;try{if(cq.readOnly){cV=true}if(ds){cK=null}du(cC)}catch(dv){if(dv!=ao){throw dv}return false}finally{cK=dt;cV=false}return true}var b1;function de(dz){var ds=aq(cq.keyMap),dw=ds.auto;clearTimeout(b1);if(dw&&!ah(dz)){b1=setTimeout(function(){if(aq(cq.keyMap)==ds){cq.keyMap=(dw.call?dw.call(null,cC):dw)}},50)}var dt=u[ab(dz,"keyCode")],dy=false;var dv=av&&I;if(dt==null||dz.altGraphKey){return false}if(ab(dz,"altKey")){dt="Alt-"+dt}if(ab(dz,dv?"metaKey":"ctrlKey")){dt="Ctrl-"+dt}if(ab(dz,dv?"ctrlKey":"metaKey")){dt="Cmd-"+dt}var dx=false;function du(){dx=true}if(ab(dz,"shiftKey")){dy=at("Shift-"+dt,cq.extraKeys,cq.keyMap,function(dA){return bC(dA,true)},du)||at(dt,cq.extraKeys,cq.keyMap,function(dA){if(typeof dA=="string"&&/^go[A-Z]/.test(dA)){return bC(dA)}},du)}else{dy=at(dt,cq.extraKeys,cq.keyMap,bC,du)}if(dx){dy=false}if(dy){e(dz);df();if(G){dz.oldKeyCode=dz.keyCode;dz.keyCode=0}}return dy}function cn(du,ds){var dt=at("'"+ds+"'",cq.extraKeys,cq.keyMap,function(dv){return bC(dv,true)});if(dt){e(du);df()}return dt}var da=null;function cF(du){if(!cL){dn()}if(S&&du.keyCode==27){du.returnValue=false}if(bP){if(b8()){bP=false}}if(cq.onKeyEvent&&cq.onKeyEvent(cC,P(du))){return}var ds=ab(du,"keyCode");bp(ds==16||ab(du,"shiftKey"));var dt=de(du);if(av){da=dt?ds:null;if(!dt&&ds==88&&ab(du,I?"metaKey":"ctrlKey")){bO("")}}}function bH(dv){if(bP){b8()}if(cq.onKeyEvent&&cq.onKeyEvent(cC,P(dv))){return}var du=ab(dv,"keyCode"),ds=ab(dv,"charCode");if(av&&du==da){da=null;e(dv);return}if(((av&&(!dv.which||dv.which<10))||af)&&de(dv)){return}var dt=String.fromCharCode(ds==null?du:ds);if(cq.electricChars&&cE.electricChars&&cq.smartIndent&&!cq.readOnly){if(cE.electricChars.indexOf(dt)>-1){setTimeout(aM(function(){bX(dq.to.line,"smart")}),75)}}if(cn(dv,dt)){return}ba()}function cN(ds){if(cq.onKeyEvent&&cq.onKeyEvent(cC,P(ds))){return}if(ab(ds,"keyCode")==16){cK=null}}function dn(){if(cq.readOnly=="nocursor"){return}if(!cL){if(cq.onFocus){cq.onFocus(cC)}cL=true;if(bE.className.search(/\bCodeMirror-focused\b/)==-1){bE.className+=" CodeMirror-focused"}}aG();df()}function aZ(){if(cL){if(cq.onBlur){cq.onBlur(cC)}cL=false;if(ct){aM(function(){if(ct){ct();ct=null}})()}bE.className=bE.className.replace(" CodeMirror-focused","")}clearInterval(di);setTimeout(function(){if(!cL){cK=null}},150)}function a8(dy,dx,dw,dt,ds){if(cV){return}var dv=[];c1.iter(dy.line,dx.line+1,function(dz){dv.push(j(dz.text,dz.markedSpans))});if(bu){bu.addChange(dy.line,dw.length,dv);while(bu.done.length>cq.undoDepth){bu.done.shift()}}var du=W(d(dv[0]),d(N(dv)),dy.ch,dx.ch,dw);aN(dy,dx,du,dt,ds)}function cD(dx,dy){if(!dx.length){return}var dz=dx.pop(),dt=[];for(var du=dz.length-1;du>=0;du-=1){var dw=dz[du];var dA=[],ds=dw.start+dw.added;c1.iter(dw.start,ds,function(dB){dA.push(j(dB.text,dB.markedSpans))});dt.push({start:dw.start,added:dw.old.length,old:dA});var dv={line:dw.start+dw.old.length-1,ch:A(ar(N(dA)),ar(N(dw.old)))};aN({line:dw.start,ch:0},{line:ds-1,ch:c8(ds-1).text.length},dw.old,dv,dv)}cS=true;dy.push(dt)}function dm(){cD(bu.done,bu.undone)}function db(){cD(bu.undone,bu.done)}function aN(dH,dw,dt,ds,dL){if(cV){return}var dK=false,dv=b3.text.length;if(!cq.lineWrapping){c1.iter(dH.line,dw.line+1,function(dM){if(!dM.hidden&&dM.text.length==dv){dK=true;return true}})}if(dH.line!=dw.line||dt.length>1){bc=true}var dF=dw.line-dH.line,dE=c8(dH.line),du=c8(dw.line);var dB=N(dt);if(dH.ch==0&&dw.ch==0&&ar(dB)==""){var dC=[],dD=null;for(var dI=0,dJ=dt.length-1;dI<dJ;++dI){dC.push(new H(ar(dt[dI]),d(dt[dI])))}du.update(du.text,d(dB));if(dF){c1.remove(dH.line,dF,c2)}if(dC.length){c1.insert(dH.line,dC)}}else{if(dE==du){if(dt.length==1){dE.update(dE.text.slice(0,dH.ch)+ar(dt[0])+dE.text.slice(dw.ch),d(dt[0]))}else{for(var dC=[],dI=1,dJ=dt.length-1;dI<dJ;++dI){dC.push(new H(ar(dt[dI]),d(dt[dI])))}dC.push(new H(ar(dB)+dE.text.slice(dw.ch),d(dB)));dE.update(dE.text.slice(0,dH.ch)+ar(dt[0]),d(dt[0]));c1.insert(dH.line+1,dC)}}else{if(dt.length==1){dE.update(dE.text.slice(0,dH.ch)+ar(dt[0])+du.text.slice(dw.ch),d(dt[0]));c1.remove(dH.line+1,dF,c2)}else{var dC=[];dE.update(dE.text.slice(0,dH.ch)+ar(dt[0]),d(dt[0]));du.update(ar(dB)+du.text.slice(dw.ch),d(dB));for(var dI=1,dJ=dt.length-1;dI<dJ;++dI){dC.push(new H(ar(dt[dI]),d(dt[dI])))}if(dF>1){c1.remove(dH.line+1,dF-1,c2)}c1.insert(dH.line+1,dC)}}}if(cq.lineWrapping){var dy=Math.max(5,bE.clientWidth/bB()-3);c1.iter(dH.line,dH.line+dt.length,function(dM){if(dM.hidden){return}var dN=Math.ceil(dM.text.length/dy)||1;if(dN!=dM.height){bo(dM,dN)}})}else{c1.iter(dH.line,dH.line+dt.length,function(dN){var dM=dN.text;if(!dN.hidden&&dM.length>dv){b3=dN;dv=dM.length;bK=true;dK=false}});if(dK){c6=true}}dc=Math.min(dc,dH.line);b5(400);var dA=dt.length-dF-1;aW.push({from:dH.line,to:dw.line+1,diff:dA});if(cq.onChange){for(var dI=0;dI<dt.length;++dI){if(typeof dt[dI]!="string"){dt[dI]=dt[dI].text}}var dz={from:dH,to:dw,text:dt};if(dg){for(var dx=dg;dx.next;dx=dx.next){}dx.next=dz}else{dg=dz}}function dG(dM){return dM<=Math.min(dw.line,dw.line+dA)?dM:dM+dA}bU(bd(ds),bd(dL),dG(dq.from.line),dG(dq.to.line))}function aK(){var ds=c1.height*ce()+2*cU();return ds*0.99>bE.offsetHeight?ds:false}function aO(dt){var ds=aK();a5.style.display=ds?"block":"none";if(ds){cO.style.height=cz.style.minHeight=ds+"px";a5.style.height=bE.clientHeight+"px";if(dt!=null){a5.scrollTop=bE.scrollTop=dt;if(k){setTimeout(function(){if(a5.scrollTop!=dt){return}a5.scrollTop=dt+(dt?-1:1);a5.scrollTop=dt},0)}}}else{cz.style.minHeight=""}cJ.style.top=by*ce()+"px"}function bV(){b3=c8(0);bK=true;var ds=b3.text.length;c1.iter(1,c1.size,function(du){var dt=du.text;if(!du.hidden&&dt.length>ds){ds=dt.length;b3=du}});c6=false}function cf(dt,dw,dv){dw=bd(dw);if(!dv){dv=dw}else{dv=bd(dv)}dt=g(dt);function du(dz){if(B(dz,dw)){return dz}if(!B(dv,dz)){return ds}var dx=dz.line+dt.length-(dv.line-dw.line)-1;var dy=dz.ch;if(dz.line==dv.line){dy+=N(dt).length-(dv.ch-(dv.line==dw.line?dw.ch:0))}return{line:dx,ch:dy}}var ds;aX(dt,dw,dv,function(dx){ds=dx;return{from:du(dq.from),to:du(dq.to)}});return ds}function bO(ds,dt){aX(g(ds),dq.from,dq.to,function(du){if(dt=="end"){return{from:du,to:du}}else{if(dt=="start"){return{from:dq.from,to:dq.from}}else{return{from:dq.from,to:du}}}})}function aX(dv,dx,dw,ds){var du=dv.length==1?dv[0].length+dx.ch:N(dv).length;var dt=ds({line:dx.line+dv.length-1,ch:du});a8(dx,dw,dv,dt.from,dt.to)}function dh(dx,dw,dv){var dt=dx.line,ds=dw.line;if(dt==ds){return c8(dt).text.slice(dx.ch,dw.ch)}var du=[c8(dt).text.slice(dx.ch)];c1.iter(dt+1,ds,function(dy){du.push(dy.text)});du.push(c8(ds).text.slice(0,dw.ch));return du.join(dv||"\n")}function cs(ds){return dh(dq.from,dq.to,ds)}function aG(){if(bP){return}cx.set(cq.pollInterval,function(){b8();if(cL){aG()}})}function ba(){var ds=false;bP=true;function dt(){var du=b8();if(!du&&!ds){ds=true;cx.set(60,dt)}else{bP=false;aG()}}cx.set(20,dt)}var bv="";function b8(){if(!cL||b(bG)||cq.readOnly){return false}var dt=bG.value;if(dt==bv){return false}if(!cT){a7()}cK=null;var du=0,ds=Math.min(bv.length,dt.length);while(du<ds&&bv[du]==dt[du]){++du}if(du<bv.length){dq.from={line:dq.from.line,ch:dq.from.ch-(bv.length-du)}}else{if(cQ&&R(dq.from,dq.to)&&!cc){dq.to={line:dq.to.line,ch:Math.min(c8(dq.to.line).text.length,dq.to.ch+(dt.length-du))}}}bO(dt.slice(du),"end");if(dt.length>1000){bG.value=bv=""}else{bv=dt}if(!cT){aT()}cc=false;return true}function c4(ds){if(!R(dq.from,dq.to)){bv="";bG.value=cs();if(cL){aD(bG)}}else{if(ds){bv=bG.value=""}}}function bY(){if(cq.readOnly!="nocursor"){bG.focus()}}function cI(){var dv=cg();aV(dv.x,dv.y,dv.x,dv.yBot);if(!cL){return}var dt=cz.getBoundingClientRect(),ds=null;if(dv.y+dt.top<0){ds=true}else{if(dv.y+dt.top+ce()>(window.innerHeight||document.documentElement.clientHeight)){ds=false}}if(ds!=null){var du=bx.style.display=="none";if(du){bx.style.display="";bx.style.left=dv.x+"px";bx.style.top=(dv.y-by)+"px"}bx.scrollIntoView(ds);if(du){bx.style.display="none"}}}function cg(){var dt=dk(dq.inverted?dq.from:dq.to);var ds=cq.lineWrapping?Math.min(dt.x,bR.offsetWidth):dt.x;return{x:ds,y:dt.y,yBot:dt.yBot}}function aV(dt,dv,ds,du){var dw=bj(dt,dv,ds,du);if(dw.scrollLeft!=null){bE.scrollLeft=dw.scrollLeft}if(dw.scrollTop!=null){a5.scrollTop=bE.scrollTop=dw.scrollTop}}function bj(dv,dC,dt,dB){var dy=bq(),dH=cU();dC+=dH;dB+=dH;dv+=dy;dt+=dy;var dE=bE.clientHeight,dw=a5.scrollTop,dG={};var du=aK()||Infinity;var ds=dC<dH+10,dA=dB+dH>du-10;if(dC<dw){dG.scrollTop=ds?0:Math.max(0,dC)}else{if(dB>dw+dE){dG.scrollTop=(dA?du:dB)-dE}}var dD=bE.clientWidth,dF=bE.scrollLeft;var dz=cq.fixedGutter?a0.clientWidth:0;var dx=dv<dz+dy+10;if(dv<dF+dz||dx){if(dx){dv=0}dG.scrollLeft=Math.max(0,dv-10-dz)}else{if(dt>dD+dF-3){dG.scrollLeft=dt+10-dD}}return dG}function b0(dw){var ds=ce(),dv=(dw!=null?dw:a5.scrollTop)-cU();var du=Math.max(0,Math.floor(dv/ds));var dt=Math.ceil((dv+bE.clientHeight)/ds);return{from:ad(c1,du),to:ad(c1,dt)}}function cG(dB,dx,dv){if(!bE.clientWidth){dj=b9=by=0;return}var dw=b0(dv);if(dB!==true&&dB.length==0&&dw.from>dj&&dw.to<b9){aO(dv);return}var dC=Math.max(dw.from-100,0),dD=Math.min(c1.size,dw.to+100);if(dj<dC&&dC-dj<20){dC=dj}if(b9>dD&&b9-dD<20){dD=Math.min(c1.size,b9)}var dF=dB===true?[]:cp([{from:dj,to:b9,domStart:0}],dB);var dA=0;for(var dy=0;dy<dF.length;++dy){var dz=dF[dy];if(dz.from<dC){dz.domStart+=(dC-dz.from);dz.from=dC}if(dz.to>dD){dz.to=dD}if(dz.from>=dz.to){dF.splice(dy--,1)}else{dA+=dz.to-dz.from}}if(dA==dD-dC&&dC==dj&&dD==b9){aO(dv);return}dF.sort(function(dH,dG){return dH.domStart-dG.domStart});var du=ce(),ds=a0.style.display;aL.style.display="none";bb(dC,dD,dF);aL.style.display=a0.style.display="";var dt=dC!=dj||dD!=b9||ca!=bE.clientHeight+du;if(dt){ca=bE.clientHeight+du}if(dC!=dj||dD!=b9&&cq.onViewportChange){setTimeout(function(){if(cq.onViewportChange){cq.onViewportChange(cC,dC,dD)}})}dj=dC;b9=dD;by=a(c1,dC);b5(100);if(aL.childNodes.length!=b9-dj){throw new Error("BAD PATCH! "+JSON.stringify(dF)+" size="+(b9-dj)+" nodes="+aL.childNodes.length)}function dE(){var dH=aL.firstChild,dG=false;c1.iter(dj,b9,function(dJ){if(!dH){return}if(!dJ.hidden){var dI=Math.round(dH.offsetHeight/du)||1;if(dJ.height!=dI){bo(dJ,dI);bc=dG=true}}dH=dH.nextSibling});return dG}if(cq.lineWrapping){dE()}a0.style.display=ds;if(dt||bc){a4()&&cq.lineWrapping&&dE()&&a4()}aO(dv);dp();if(!dx&&cq.onUpdate){cq.onUpdate(cC)}return true}function cp(dB,dz){for(var dw=0,du=dz.length||0;dw<du;++dw){var dy=dz[dw],ds=[],dA=dy.diff||0;for(var dv=0,dt=dB.length;dv<dt;++dv){var dx=dB[dv];if(dy.to<=dx.from&&dy.diff){ds.push({from:dx.from+dA,to:dx.to+dA,domStart:dx.domStart})}else{if(dy.to<=dx.from||dy.from>=dx.to){ds.push(dx)}else{if(dy.from>dx.from){ds.push({from:dx.from,to:dy.from,domStart:dx.domStart})}if(dy.to<dx.to){ds.push({from:dy.to+dA,to:dx.to+dA,domStart:dx.domStart+(dy.to-dx.from)})}}}}dB=ds}return dB}function bb(dA,dB,dD){function ds(dF){var dE=dF.nextSibling;dF.parentNode.removeChild(dF);return dE}if(!dD.length){aE(aL)}else{var dw=0,du=aL.firstChild,dt;for(var dx=0;dx<dD.length;++dx){var dC=dD[dx];while(dC.domStart>dw){du=ds(du);dw++}for(var dv=0,dz=dC.to-dC.from;dv<dz;++dv){du=du.nextSibling;dw++}}while(du){du=ds(du)}}var dy=dD.shift(),du=aL.firstChild,dv=dA;c1.iter(dA,dB,function(dE){if(dy&&dy.to==dv){dy=dD.shift()}if(!dy||dy.from>dv){if(dE.hidden){var dF=ai("pre")}else{var dF=cb(dE);if(dE.className){dF.className=dE.className}if(dE.bgClassName){var dG=ai("pre","\u00a0",dE.bgClassName,"position: absolute; left: 0; right: 0; top: 0; bottom: 0; z-index: -2");dF=ai("div",[dG,dF],null,"position: relative")}}aL.insertBefore(dF,du)}else{du=du.nextSibling}++dv})}function a4(){if(!cq.gutter&&!cq.lineNumbers){return}var dt=cJ.offsetHeight,dB=bE.clientHeight;a0.style.height=(dt-dB<2?dB:dt)+"px";var dz=document.createDocumentFragment(),dx=dj,dA;c1.iter(dj,Math.max(b9,dj+1),function(dD){if(dD.hidden){dz.appendChild(ai("pre"))}else{var dC=dD.gutterMarker;var dG=cq.lineNumbers?cq.lineNumberFormatter(dx+cq.firstLineNumber):null;if(dC&&dC.text){dG=dC.text.replace("%N%",dG!=null?dG:"")}else{if(dG==null){dG="\u00a0"}}var dF=dz.appendChild(ai("pre",null,dC&&dC.style));dF.innerHTML=dG;for(var dE=1;dE<dD.height;++dE){dF.appendChild(ai("br"));dF.appendChild(document.createTextNode("\u00a0"))}if(!dC){dA=dx}}++dx});a0.style.display="none";q(bi,dz);if(dA!=null&&cq.lineNumbers){var dv=bi.childNodes[dA-dj];var dw=String(c1.size).length,ds=az(dv.firstChild),du="";while(ds.length+du.length<dw){du+="\u00a0"}if(du){dv.insertBefore(document.createTextNode(du),dv.firstChild)}}a0.style.display="";var dy=Math.abs((parseInt(bR.style.marginLeft)||0)-a0.offsetWidth)>2;bR.style.marginLeft=a0.offsetWidth+"px";bc=false;return dy}function dp(){var dv=R(dq.from,dq.to);var dG=dk(dq.from,true);var dB=dv?dG:dk(dq.to,true);var dz=dq.inverted?dG:dB,dt=ce();var ds=z(aY),du=z(aL);cm.style.top=Math.max(0,Math.min(bE.offsetHeight,dz.y+du.top-ds.top))+"px";cm.style.left=Math.max(0,Math.min(bE.offsetWidth,dz.x+du.left-ds.left))+"px";if(dv){bx.style.top=dz.y+"px";bx.style.left=(cq.lineWrapping?Math.min(dz.x,bR.offsetWidth):dz.x)+"px";bx.style.display="";bA.style.display="none"}else{var dE=dG.y==dB.y,dy=document.createDocumentFragment();var dC=bR.clientWidth||bR.offsetWidth;var dx=bR.clientHeight||bR.offsetHeight;var dF=function(dL,dK,dJ,dH){var dI=l?"width: "+(!dJ?dC:dC-dJ-dL)+"px":"right: "+dJ+"px";dy.appendChild(ai("div",null,"CodeMirror-selected","position: absolute; left: "+dL+"px; top: "+dK+"px; "+dI+"; height: "+dH+"px"))};if(dq.from.ch&&dG.y>=0){var dD=dE?dC-dB.x:0;dF(dG.x,dG.y,dD,dt)}var dw=Math.max(0,dG.y+(dq.from.ch?dt:0));var dA=Math.min(dB.y,dx)-dw;if(dA>0.2*dt){dF(0,dw,0,dA)}if((!dE||!dq.from.ch)&&dB.y<dx-0.5*dt){dF(0,dB.y,dC-dB.x,dt)}q(bA,dy);bx.style.display="none";bA.style.display=""}}function bp(ds){if(ds){cK=cK||(dq.inverted?dq.to:dq.from)}else{cK=null}}function bW(du,dt){var ds=cK&&bd(cK);if(ds){if(B(ds,du)){du=ds}else{if(B(dt,ds)){dt=ds}}}bU(du,dt);cw=true}function bU(dz,dy,ds,dx){cX=null;if(ds==null){ds=dq.from.line;dx=dq.to.line}if(R(dq.from,dz)&&R(dq.to,dy)){return}if(B(dy,dz)){var dv=dy;dy=dz;dz=dv}if(dz.line!=ds){var dw=ch(dz,ds,dq.from.ch);if(!dw){dd(dz.line,false)}else{dz=dw}}if(dy.line!=dx){dy=ch(dy,dx,dq.to.ch)}if(R(dz,dy)){dq.inverted=false}else{if(R(dz,dq.to)){dq.inverted=false}else{if(R(dy,dq.from)){dq.inverted=true}}}if(cq.autoClearEmptyLines&&R(dq.from,dq.to)){var du=dq.inverted?dz:dy;if(du.line!=dq.from.line&&dq.from.line<c1.size){var dt=c8(dq.from.line);if(/^\s+$/.test(dt.text)){setTimeout(aM(function(){if(dt.parent&&/^\s+$/.test(dt.text)){var dA=V(dt);cf("",{line:dA,ch:0},{line:dA,ch:dt.text.length})}},10))}}}dq.from=dz;dq.to=dy;a9=true}function ch(dx,dt,du){function dw(dA){var dC=dx.line+dA,dz=dA==1?c1.size:-1;while(dC!=dz){var dy=c8(dC);if(!dy.hidden){var dB=dx.ch;if(dv||dB>du||dB>dy.text.length){dB=dy.text.length}return{line:dC,ch:dB}}dC+=dA}}var ds=c8(dx.line);var dv=dx.ch==ds.text.length&&dx.ch!=du;if(!ds.hidden){return dx}if(dx.line>=dt){return dw(1)||dw(-1)}else{return dw(-1)||dw(1)}}function bs(ds,du,dt){var dv=bd({line:ds,ch:du||0});(dt?bW:bU)(dv,dv)}function co(ds){return Math.max(0,Math.min(ds,c1.size-1))}function bd(du){if(du.line<0){return{line:0,ch:0}}if(du.line>=c1.size){return{line:c1.size-1,ch:c8(c1.size-1).text.length}}var ds=du.ch,dt=c8(du.line).text.length;if(ds==null||ds>dt){return{line:du.line,ch:dt}}else{if(ds<0){return{line:du.line,ch:0}}else{return du}}}function cR(dv,dz){var dw=dq.inverted?dq.from:dq.to,dA=dw.line,ds=dw.ch;var dy=c8(dA);function dt(){for(var dB=dA+dv,dD=dv<0?-1:c1.size;dB!=dD;dB+=dv){var dC=c8(dB);if(!dC.hidden){dA=dB;dy=dC;return true}}}function dx(dB){if(ds==(dv<0?0:dy.text.length)){if(!dB&&dt()){ds=dv<0?dy.text.length:0}else{return false}}else{ds+=dv}return true}if(dz=="char"){dx()}else{if(dz=="column"){dx(true)}else{if(dz=="word"){var du=false;for(;;){if(dv<0){if(!dx()){break}}if(L(dy.text.charAt(ds))){du=true}else{if(du){if(dv<0){dv=1;dx()}break}}if(dv>0){if(!dx()){break}}}}}}return{line:dA,ch:ds}}function c7(ds,dt){var du=ds<0?dq.from:dq.to;if(cK||R(dq.from,dq.to)){du=cR(ds,dt)}bs(du.line,du.ch,true)}function cP(ds,dt){if(!R(dq.from,dq.to)){cf("",dq.from,dq.to)}else{if(ds<0){cf("",cR(ds,dt),dq.to)}else{cf("",dq.from,cR(ds,dt))}}cw=true}function c0(dt,dv){var dx=0,dy=dk(dq.inverted?dq.from:dq.to,true);if(cX!=null){dy.x=cX}if(dv=="page"){var ds=Math.min(bE.clientHeight,window.innerHeight||document.documentElement.clientHeight);var dw=b6(dy.x,dy.y+ds*dt)}else{if(dv=="line"){var du=ce();var dw=b6(dy.x,dy.y+0.5*du+dt*du)}}if(dv=="page"){a5.scrollTop+=dk(dw,true).y-dy.y}bs(dw.line,dw.ch,true);cX=dy.x}function bQ(dx){var dv=c8(dx.line).text;var dw=dx.ch,du=dx.ch;if(dv){if(dx.after===false||du==dv.length){--dw}else{++du}var dt=dv.charAt(dw);var ds=L(dt)?L:/\s/.test(dt)?function(dy){return/\s/.test(dy)}:function(dy){return !/\s/.test(dy)&&L(dy)};while(dw>0&&ds(dv.charAt(dw-1))){--dw}while(du<dv.length&&ds(dv.charAt(du))){++du}}return{from:{line:dx.line,ch:dw},to:{line:dx.line,ch:du}}}function a3(ds){bW({line:ds,ch:0},bd({line:ds+1,ch:0}))}function c3(du){if(R(dq.from,dq.to)){return bX(dq.from.line,du)}var dt=dq.to.line-(dq.to.ch?0:1);for(var ds=dq.from.line;ds<=dt;++ds){bX(ds,du)}}function bX(du,dB){if(!dB){dB="add"}if(dB=="smart"){if(!cE.indent){dB="prev"}else{var ds=cW(du)}}var dC=c8(du),dw=dC.indentation(cq.tabSize),dt=dC.text.match(/^\s*/)[0],dy;if(dB=="smart"){dy=cE.indent(ds,dC.text.slice(dt.length),dC.text);if(dy==ao){dB="prev"}}if(dB=="prev"){if(du){dy=c8(du-1).indentation(cq.tabSize)}else{dy=0}}else{if(dB=="add"){dy=dw+cq.indentUnit}else{if(dB=="subtract"){dy=dw-cq.indentUnit}}}dy=Math.max(0,dy);var dA=dy-dw;var dz="",dx=0;if(cq.indentWithTabs){for(var dv=Math.floor(dy/cq.tabSize);dv;--dv){dx+=cq.tabSize;dz+="\t"}}if(dx<dy){dz+=ax(dy-dx)}if(dz!=dt){cf(dz,{line:du,ch:0},{line:du,ch:dt.length})}dC.stateAfter=null}function cj(){cE=p.getMode(cq,cq.mode);c1.iter(0,c1.size,function(ds){ds.stateAfter=null});dc=0;b5(100)}function bz(){var ds=cq.gutter||cq.lineNumbers;a0.style.display=ds?"":"none";if(ds){bc=true}else{aL.parentNode.style.marginLeft=0}}function c9(du,dt){if(cq.lineWrapping){aY.className+=" CodeMirror-wrap";var ds=bE.clientWidth/bB()-3;c1.iter(0,c1.size,function(dv){if(dv.hidden){return}var dw=Math.ceil(dv.text.length/ds)||1;if(dw!=1){bo(dv,dw)}});bR.style.minWidth=br.style.left=""}else{aY.className=aY.className.replace(" CodeMirror-wrap","");bV();c1.iter(0,c1.size,function(dv){if(dv.height!=1&&!dv.hidden){bo(dv,1)}})}aW.push({from:0,to:c1.size})}function c5(){bE.className=bE.className.replace(/\s*cm-s-\S+/g,"")+cq.theme.replace(/(^|\s)\s*/g," cm-s-")}function cY(){var ds=f[cq.keyMap].style;aY.className=aY.className.replace(/\s*cm-keymap-\S+/g,"")+(ds?" cm-keymap-"+ds:"")}function dr(dt,ds){this.lines=[];this.type=dt;if(ds){this.style=ds}}dr.prototype.clear=aM(function(){var dv,ds;for(var du=0;du<this.lines.length;++du){var dt=this.lines[du];var dw=aF(dt.markedSpans,this);if(dw.from!=null){dv=V(dt)}if(dw.to!=null){ds=V(dt)}dt.markedSpans=aB(dt.markedSpans,dw)}if(dv!=null){aW.push({from:dv,to:ds+1})}this.lines.length=0;this.explicitlyCleared=true});dr.prototype.find=function(){var dx,dw;for(var dt=0;dt<this.lines.length;++dt){var ds=this.lines[dt];var du=aF(ds.markedSpans,this);if(du.from!=null||du.to!=null){var dv=V(ds);if(du.from!=null){dx={line:dv,ch:du.from}}if(du.to!=null){dw={line:dv,ch:du.to}}}}if(this.type=="bookmark"){return dx}return dx&&{from:dx,to:dw}};function b4(dy,dx,dw,du){dy=bd(dy);dx=bd(dx);var dt=new dr("range",dw);if(du){for(var dv in du){if(du.hasOwnProperty(dv)){dt[dv]=du[dv]}}}var ds=dy.line;c1.iter(ds,dx.line+1,function(dz){var dA={from:ds==dy.line?dy.ch:null,to:ds==dx.line?dx.ch:null,marker:dt};dz.markedSpans=(dz.markedSpans||[]).concat([dA]);dt.lines.push(dz);++ds});aW.push({from:dy.line,to:dx.line+1});return dt}function be(dv){dv=bd(dv);var dt=new dr("bookmark"),ds=c8(dv.line);bu.addChange(dv.line,1,[j(ds.text,ds.markedSpans)],true);var du={from:dv.ch,to:dv.ch,marker:dt};ds.markedSpans=(ds.markedSpans||[]).concat([du]);dt.lines.push(ds);return dt}function bI(dw){dw=bd(dw);var dv=[],dt=c8(dw.line).markedSpans;if(dt){for(var ds=0;ds<dt.length;++ds){var du=dt[ds];if((du.from==null||du.from<=dw.ch)&&(du.to==null||du.to>=dw.ch)){dv.push(du.marker)}}}return dv}function ck(ds,du,dt){if(typeof ds=="number"){ds=c8(co(ds))}ds.gutterMarker={text:du,style:dt};bc=true;return ds}function aP(ds){if(typeof ds=="number"){ds=c8(co(ds))}ds.gutterMarker=null;bc=true}function bh(dt,dv){var du=dt,ds=dt;if(typeof dt=="number"){ds=c8(co(dt))}else{du=V(dt)}if(du==null){return null}if(dv(ds,du)){aW.push({from:du,to:du+1})}else{return null}return ds}function bF(dt,ds,du){return bh(dt,function(dv){if(dv.className!=ds||dv.bgClassName!=du){dv.className=ds;dv.bgClassName=du;return true}})}function dd(dt,ds){return bh(dt,function(du,dx){if(du.hidden!=ds){du.hidden=ds;if(!cq.lineWrapping){if(ds&&du.text.length==b3.text.length){c6=true}else{if(!ds&&du.text.length>b3.text.length){b3=du;c6=false}}}bo(du,ds?0:1);var dw=dq.from.line,dv=dq.to.line;if(ds&&(dw==dx||dv==dx)){var dz=dw==dx?ch({line:dw,ch:0},dw,0):dq.from;var dy=dv==dx?ch({line:dv,ch:0},dv,0):dq.to;if(!dy){return}bU(dz,dy)}return(bc=true)}})}function bf(dt){if(typeof dt=="number"){if(!bN(dt)){return null}var du=dt;dt=c8(dt);if(!dt){return null}}else{var du=V(dt);if(du==null){return null}}var ds=dt.gutterMarker;return{line:du,handle:dt,text:dt.text,markerText:ds&&ds.text,markerClass:ds&&ds.style,lineClass:dt.className,bgClass:dt.bgClassName}}function cu(ds,dv){if(dv==0){return{top:0,left:0}}var dy=cb(ds,dv);q(aQ,dy);var du=dy.anchor;var dx=du.offsetTop,dw=du.offsetLeft;if(S&&dx==0&&dw==0){var dt=ai("span","x");du.parentNode.insertBefore(dt,du.nextSibling);dx=dt.offsetTop}return{top:dx,left:dw}}function dk(dx,dv){var ds,dt=ce(),dw=dt*(a(c1,dx.line)-(dv?by:0));if(dx.ch==0){ds=0}else{var du=cu(c8(dx.line),dx.ch);ds=du.left;if(cq.lineWrapping){dw+=Math.max(0,du.top)}}return{x:ds,y:dw,yBot:dw+dt}}function b6(dD,dC){var dA=ce(),dx=bB(),dJ=by+Math.floor(dC/dA);if(dJ<0){return{line:0,ch:0}}var dE=ad(c1,dJ);if(dE>=c1.size){return{line:c1.size-1,ch:c8(c1.size-1).text.length}}var dt=c8(dE),dG=dt.text;var dL=cq.lineWrapping,dB=dL?dJ-a(c1,dE):0;if(dD<=0&&dB==0){return{line:dE,ch:0}}var dy=false;function dK(dN){var dO=cu(dt,dN);if(dL){var dP=Math.round(dO.top/dA);dy=dP!=dB;return Math.max(0,dO.left+(dP-dB)*bE.clientWidth)}return dO.left}var dI=0,dH=0,du=dG.length,ds;var dF=Math.min(du,Math.ceil((dD+dB*bE.clientWidth*0.9)/dx));for(;;){var dz=dK(dF);if(dz<=dD&&dF<du){dF=Math.min(du,Math.ceil(dF*1.2))}else{ds=dz;du=dF;break}}if(dD>ds){return{line:dE,ch:du}}dF=Math.floor(du*0.8);dz=dK(dF);if(dz<dD){dI=dF;dH=dz}for(;;){if(du-dI<=1){var dw=dD-dH<ds-dD;return{line:dE,ch:dw?dI:du,after:dw}}var dM=Math.ceil((dI+du)/2),dv=dK(dM);if(dv>dD){du=dM;ds=dv;if(dy){ds+=1000}}else{dI=dM;dH=dv}}}function aJ(du){var ds=dk(du,true),dt=z(bR);return{x:dt.left+ds.x,y:dt.top+ds.y,yBot:dt.top+ds.yBot}}var bl,aS,aI;function ce(){if(aI==null){aI=ai("pre");for(var dt=0;dt<49;++dt){aI.appendChild(document.createTextNode("x"));aI.appendChild(ai("br"))}aI.appendChild(document.createTextNode("x"))}var ds=aL.clientHeight;if(ds==aS){return bl}aS=ds;q(aQ,aI.cloneNode(true));bl=aQ.firstChild.offsetHeight/50||1;aE(aQ);return bl}var dl,bS=0;function bB(){if(bE.clientWidth==bS){return dl}bS=bE.clientWidth;var ds=ai("span","x");var dt=ai("pre",[ds]);q(aQ,dt);return(dl=ds.offsetWidth||10)}function cU(){return bR.offsetTop}function bq(){return bR.offsetLeft}function bn(dw,dv){var du=z(bE,true),ds,dx;try{ds=dw.clientX;dx=dw.clientY}catch(dw){return null}if(!dv&&(ds-du.left>bE.clientWidth||dx-du.top>bE.clientHeight)){return null}var dt=z(bR,true);return b6(ds-dt.left,dx-dt.top)}var bM;function bm(dt){var dx=bn(dt),dw=a5.scrollTop;if(!dx||av){return}if(R(dq.from,dq.to)||B(dx,dq.from)||!B(dx,dq.to)){aM(bs)(dx.line,dx.ch)}var dv=bG.style.cssText;cm.style.position="absolute";bG.style.cssText="position: fixed; width: 30px; height: 30px; top: "+(dt.clientY-5)+"px; left: "+(dt.clientX-5)+"px; z-index: 1000; background: white; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);";bY();c4(true);if(R(dq.from,dq.to)){bG.value=bv=" "}function ds(){cm.style.position="relative";bG.style.cssText=dv;if(G){a5.scrollTop=dw}aG();if(bG.selectionStart!=null){clearTimeout(bM);var dz=bG.value=" "+(R(dq.from,dq.to)?"":bG.value),dy=0;bv=" ";bG.selectionStart=1;bG.selectionEnd=dz.length;bM=setTimeout(function dA(){if(bv==" "&&bG.selectionStart==0){aM(r.selectAll)(cC)}else{if(dy++<10){bM=setTimeout(dA,500)}else{c4()}}},200)}}if(v){ac(dt);var du=aC(window,"mouseup",function(){du();setTimeout(ds,20)},true)}else{setTimeout(ds,50)}}function df(){clearInterval(di);var ds=true;bx.style.visibility="";di=setInterval(function(){bx.style.visibility=(ds=!ds)?"":"hidden"},cq.cursorBlinkRate)}var bJ={"(":")>",")":"(<","[":"]>","]":"[<","{":"}>","}":"{<"};function cH(dy){var ds=dq.inverted?dq.from:dq.to,dA=c8(ds.line),dt=ds.ch-1;var dx=(dt>=0&&bJ[dA.text.charAt(dt)])||bJ[dA.text.charAt(++dt)];if(!dx){return}var dB=dx.charAt(0),dz=dx.charAt(1)==">",dL=dz?1:-1,dG=dA.styles;for(var dM=dt+1,dI=0,dK=dG.length;dI<dK;dI+=2){if((dM-=dG[dI].length)<=0){var dJ=dG[dI+1];break}}var dv=[dA.text.charAt(dt)],dF=/[(){}[\]]/;function dD(dY,dT,dU){if(!dY.text){return}var dX=dY.styles,dS=dz?0:dY.text.length-1,dV;for(var dP=dz?0:dX.length-2,dR=dz?dX.length:-2;dP!=dR;dP+=2*dL){var dW=dX[dP];if(dX[dP+1]!=dJ){dS+=dL*dW.length;continue}for(var dO=dz?0:dW.length-1,dN=dz?dW.length:-1;dO!=dN;dO+=dL,dS+=dL){if(dS>=dT&&dS<dU&&dF.test(dV=dW.charAt(dO))){var dQ=bJ[dV];if(dQ.charAt(1)==">"==dz){dv.push(dV)}else{if(dv.pop()!=dQ.charAt(0)){return{pos:dS,match:false}}else{if(!dv.length){return{pos:dS,match:true}}}}}}}}for(var dI=ds.line,dK=dz?Math.min(dI+100,c1.size):Math.max(-1,dI-100);dI!=dK;dI+=dL){var dA=c8(dI),dw=dI==ds.line;var dC=dD(dA,dw&&dz?dt+1:0,dw&&!dz?dt:dA.text.length);if(dC){break}}if(!dC){dC={pos:null,match:false}}var dJ=dC.match?"CodeMirror-matchingbracket":"CodeMirror-nonmatchingbracket";var dH=b4({line:ds.line,ch:dt},{line:ds.line,ch:dt+1},dJ),du=dC.pos!=null&&b4({line:dI,ch:dC.pos},{line:dI,ch:dC.pos+1},dJ);var dE=aM(function(){dH.clear();du&&du.clear()});if(dy){setTimeout(dE,800)}else{ct=dE}}function bt(dy){var dx,du;for(var dt=dy,dv=dy-40;dt>dv;--dt){if(dt==0){return 0}var ds=c8(dt-1);if(ds.stateAfter){return dt}var dw=ds.indentation(cq.tabSize);if(du==null||dx>dw){du=dt-1;dx=dw}}return du}function cW(du){var dt=bt(du),ds=dt&&c8(dt-1).stateAfter;if(!ds){ds=t(cE)}else{ds=m(cE,ds)}c1.iter(dt,du,function(dv){dv.process(cE,ds,cq.tabSize);dv.stateAfter=(dt==du-1||dt%5==0)?m(cE,ds):null});return ds}function ci(){if(dc>=b9){return}var ds=+new Date+cq.workTime,du=m(cE,cW(dc));var dt=dc;c1.iter(dc,b9,function(dv){if(dc>=dj){dv.highlight(cE,du,cq.tabSize);dv.stateAfter=m(cE,du)}else{dv.process(cE,du,cq.tabSize);dv.stateAfter=dc%5==0?m(cE,du):null}++dc;if(+new Date>ds){b5(cq.workDelay);return true}});if(b9>dt&&dc>=dj){aM(function(){aW.push({from:dt,to:dc})})()}}function b5(ds){if(dc<b9){aR.set(ds,ci)}}function a7(){cS=cw=dg=null;aW=[];a9=false;c2=[]}function aT(){if(c6){bV()}if(bK&&!cq.lineWrapping){var ds=br.offsetWidth,dy=cu(b3,b3.text.length).left;if(!J){br.style.left=dy+"px";bR.style.minWidth=(dy+ds)+"px"}bK=false}var dw,dt;if(a9){var dx=cg();dw=bj(dx.x,dx.y,dx.x,dx.yBot)}if(aW.length||dw&&dw.scrollTop!=null){dt=cG(aW,true,dw&&dw.scrollTop)}if(!dt){if(a9){dp()}if(bc){a4()}}if(dw){cI()}if(a9){df()}if(cL&&(cS===true||(cS!==false&&a9))){c4(cw)}if(a9&&cq.matchBrackets){setTimeout(aM(function(){if(ct){ct();ct=null}if(R(dq.from,dq.to)){cH(false)}}),20)}var dz=a9,du=c2;if(dg&&cq.onChange&&cC){cq.onChange(cC,dg)}if(dz&&cq.onCursorActivity){cq.onCursorActivity(cC)}for(var dv=0;dv<du.length;++dv){du[dv](cC)}if(dt&&cq.onUpdate){cq.onUpdate(cC)}}var cT=0;function aM(ds){return function(){if(!cT++){a7()}try{var dt=ds.apply(this,arguments)}finally{if(!--cT){aT()}}return dt}}function cd(ds){bu.startCompound();try{return ds()}finally{bu.endCompound()}}for(var b7 in c){if(c.propertyIsEnumerable(b7)&&!cC.propertyIsEnumerable(b7)){cC[b7]=c[b7]}}for(var cv=0;cv<aw.length;++cv){aw[cv](cC)}return cC}p.defaults={value:"",mode:null,theme:"default",indentUnit:2,indentWithTabs:false,smartIndent:true,tabSize:4,keyMap:"default",extraKeys:null,electricChars:true,autoClearEmptyLines:false,onKeyEvent:null,onDragEvent:null,lineWrapping:false,lineNumbers:false,gutter:false,fixedGutter:false,firstLineNumber:1,readOnly:false,dragDrop:true,onChange:null,onCursorActivity:null,onViewportChange:null,onGutterClick:null,onUpdate:null,onFocus:null,onBlur:null,onScroll:null,matchBrackets:false,cursorBlinkRate:530,workTime:100,workDelay:200,pollInterval:100,undoDepth:40,tabindex:null,autofocus:null,lineNumberFormatter:function(aG){return aG}};var h=/AppleWebKit/.test(navigator.userAgent)&&/Mobile\/\w+/.test(navigator.userAgent);var I=h||/Mac/.test(navigator.platform);var ae=/Win/.test(navigator.platform);var y=p.modes={},ak=p.mimeModes={};p.defineMode=function(aG,aI){if(!p.defaults.mode&&aG!="null"){p.defaults.mode=aG}if(arguments.length>2){aI.dependencies=[];for(var aH=2;aH<arguments.length;++aH){aI.dependencies.push(arguments[aH])}}y[aG]=aI};p.defineMIME=function(aH,aG){ak[aH]=aG};p.resolveMode=function(aG){if(typeof aG=="string"&&ak.hasOwnProperty(aG)){aG=ak[aG]}else{if(typeof aG=="string"&&/^[\w\-]+\/[\w\-]+\+xml$/.test(aG)){return p.resolveMode("application/xml")}}if(typeof aG=="string"){return{name:aG}}else{return aG||{name:"null"}}};p.getMode=function(aH,aG){var aG=p.resolveMode(aG);var aJ=y[aG.name];if(!aJ){return p.getMode(aH,"text/plain")}var aK=aJ(aH,aG);if(Z.hasOwnProperty(aG.name)){var aI=Z[aG.name];for(var aL in aI){if(aI.hasOwnProperty(aL)){aK[aL]=aI[aL]}}}aK.name=aG.name;return aK};p.listModes=function(){var aH=[];for(var aG in y){if(y.propertyIsEnumerable(aG)){aH.push(aG)}}return aH};p.listMIMEs=function(){var aH=[];for(var aG in ak){if(ak.propertyIsEnumerable(aG)){aH.push({mime:aG,mode:ak[aG]})}}return aH};var c=p.extensions={};p.defineExtension=function(aG,aH){c[aG]=aH};var aw=[];p.defineInitHook=function(aG){aw.push(aG)};var Z=p.modeExtensions={};p.extendMode=function(aI,aH){var aG=Z.hasOwnProperty(aI)?Z[aI]:(Z[aI]={});for(var aJ in aH){if(aH.hasOwnProperty(aJ)){aG[aJ]=aH[aJ]}}};var r=p.commands={selectAll:function(aG){aG.setSelection({line:0,ch:0},{line:aG.lineCount()-1})},killLine:function(aG){var aJ=aG.getCursor(true),aI=aG.getCursor(false),aH=!R(aJ,aI);if(!aH&&aG.getLine(aJ.line).length==aJ.ch){aG.replaceRange("",aJ,{line:aJ.line+1,ch:0})}else{aG.replaceRange("",aJ,aH?aI:{line:aJ.line})}},deleteLine:function(aG){var aH=aG.getCursor().line;aG.replaceRange("",{line:aH,ch:0},{line:aH})},undo:function(aG){aG.undo()},redo:function(aG){aG.redo()},goDocStart:function(aG){aG.setCursor(0,0,true)},goDocEnd:function(aG){aG.setSelection({line:aG.lineCount()-1},null,true)},goLineStart:function(aG){aG.setCursor(aG.getCursor().line,0,true)},goLineStartSmart:function(aG){var aJ=aG.getCursor();var aI=aG.getLine(aJ.line),aH=Math.max(0,aI.search(/\S/));aG.setCursor(aJ.line,aJ.ch<=aH&&aJ.ch?0:aH,true)},goLineEnd:function(aG){aG.setSelection({line:aG.getCursor().line},null,true)},goLineUp:function(aG){aG.moveV(-1,"line")},goLineDown:function(aG){aG.moveV(1,"line")},goPageUp:function(aG){aG.moveV(-1,"page")},goPageDown:function(aG){aG.moveV(1,"page")},goCharLeft:function(aG){aG.moveH(-1,"char")},goCharRight:function(aG){aG.moveH(1,"char")},goColumnLeft:function(aG){aG.moveH(-1,"column")},goColumnRight:function(aG){aG.moveH(1,"column")},goWordLeft:function(aG){aG.moveH(-1,"word")},goWordRight:function(aG){aG.moveH(1,"word")},delCharLeft:function(aG){aG.deleteH(-1,"char")},delCharRight:function(aG){aG.deleteH(1,"char")},delWordLeft:function(aG){aG.deleteH(-1,"word")},delWordRight:function(aG){aG.deleteH(1,"word")},indentAuto:function(aG){aG.indentSelection("smart")},indentMore:function(aG){aG.indentSelection("add")},indentLess:function(aG){aG.indentSelection("subtract")},insertTab:function(aG){aG.replaceSelection("\t","end")},defaultTab:function(aG){if(aG.somethingSelected()){aG.indentSelection("add")}else{aG.replaceSelection("\t","end")}},transposeChars:function(aG){var aI=aG.getCursor(),aH=aG.getLine(aI.line);if(aI.ch>0&&aI.ch<aH.length-1){aG.replaceRange(aH.charAt(aI.ch)+aH.charAt(aI.ch-1),{line:aI.line,ch:aI.ch-1},{line:aI.line,ch:aI.ch+1})}},newlineAndIndent:function(aG){aG.replaceSelection("\n","end");aG.indentLine(aG.getCursor().line)},toggleOverwrite:function(aG){aG.toggleOverwrite()}};var f=p.keyMap={};f.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharRight",Backspace:"delCharLeft",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite"};f.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Alt-Up":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Down":"goDocEnd","Ctrl-Left":"goWordLeft","Ctrl-Right":"goWordRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delWordLeft","Ctrl-Delete":"delWordRight","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore",fallthrough:"basic"};f.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goWordLeft","Alt-Right":"goWordRight","Cmd-Left":"goLineStart","Cmd-Right":"goLineEnd","Alt-Backspace":"delWordLeft","Ctrl-Alt-Backspace":"delWordRight","Alt-Delete":"delWordRight","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore",fallthrough:["basic","emacsy"]};f["default"]=I?f.macDefault:f.pcDefault;f.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharRight","Ctrl-H":"delCharLeft","Alt-D":"delWordRight","Alt-Backspace":"delWordLeft","Ctrl-K":"killLine","Ctrl-T":"transposeChars"};function aq(aG){if(typeof aG=="string"){return f[aG]}else{return aG}}function at(aH,aG,aL,aJ,aI){function aK(aQ){aQ=aq(aQ);var aO=aQ[aH];if(aO===false){if(aI){aI()}return true}if(aO!=null&&aJ(aO)){return true}if(aQ.nofallthrough){if(aI){aI()}return true}var aN=aQ.fallthrough;if(aN==null){return false}if(Object.prototype.toString.call(aN)!="[object Array]"){return aK(aN)}for(var aM=0,aP=aN.length;aM<aP;++aM){if(aK(aN[aM])){return true}}return false}if(aG&&aK(aG)){return true}return aK(aL)}function ah(aH){var aG=u[ab(aH,"keyCode")];return aG=="Ctrl"||aG=="Alt"||aG=="Shift"||aG=="Mod"}p.isModifierKey=ah;p.fromTextArea=function(aM,aO){if(!aO){aO={}}aO.value=aM.value;if(!aO.tabindex&&aM.tabindex){aO.tabindex=aM.tabindex}if(aO.autofocus==null){var aG=document.body;try{aG=document.activeElement}catch(aI){}aO.autofocus=aG==aM||aM.getAttribute("autofocus")!=null&&aG==document.body}function aK(){aM.value=aN.getValue()}if(aM.form){var aH=aC(aM.form,"submit",aK,true);if(typeof aM.form.submit=="function"){var aL=aM.form.submit;aM.form.submit=function aJ(){aK();aM.form.submit=aL;aM.form.submit();aM.form.submit=aJ}}}aM.style.display="none";var aN=p(function(aP){aM.parentNode.insertBefore(aP,aM.nextSibling)},aO);aN.save=aK;aN.getTextArea=function(){return aM};aN.toTextArea=function(){aK();aM.parentNode.removeChild(aN.getWrapperElement());aM.style.display="";if(aM.form){aH();if(typeof aM.form.submit=="function"){aM.form.submit=aL}}};return aN};var v=/gecko\/\d{7}/i.test(navigator.userAgent);var S=/MSIE \d/.test(navigator.userAgent);var J=/MSIE [1-7]\b/.test(navigator.userAgent);var G=/MSIE [1-8]\b/.test(navigator.userAgent);var l=S&&document.documentMode==5;var k=/WebKit\//.test(navigator.userAgent);var n=/Chrome\//.test(navigator.userAgent);var av=/Opera\//.test(navigator.userAgent);var E=/Apple Computer/.test(navigator.vendor);var af=/KHTML\//.test(navigator.userAgent);var U=/Mac OS X 10\D([7-9]|\d\d)\D/.test(navigator.userAgent);function m(aJ,aG){if(aG===true){return aG}if(aJ.copyState){return aJ.copyState(aG)}var aI={};for(var aK in aG){var aH=aG[aK];if(aH instanceof Array){aH=aH.concat([])}aI[aK]=aH}return aI}p.copyState=m;function t(aI,aH,aG){return aI.startState?aI.startState(aH,aG):true}p.startState=t;p.innerMode=function(aI,aG){while(aI.innerMode){var aH=aI.innerMode(aG);aG=aH.state;aI=aH.mode}return aH||{mode:aI,state:aG}};function ag(aG,aH){this.pos=this.start=0;this.string=aG;this.tabSize=aH||8}ag.prototype={eol:function(){return this.pos>=this.string.length},sol:function(){return this.pos==0},peek:function(){return this.string.charAt(this.pos)||undefined},next:function(){if(this.pos<this.string.length){return this.string.charAt(this.pos++)}},eat:function(aG){var aI=this.string.charAt(this.pos);if(typeof aG=="string"){var aH=aI==aG}else{var aH=aI&&(aG.test?aG.test(aI):aG(aI))}if(aH){++this.pos;return aI}},eatWhile:function(aG){var aH=this.pos;while(this.eat(aG)){}return this.pos>aH},eatSpace:function(){var aG=this.pos;while(/[\s\u00a0]/.test(this.string.charAt(this.pos))){++this.pos}return this.pos>aG},skipToEnd:function(){this.pos=this.string.length},skipTo:function(aG){var aH=this.string.indexOf(aG,this.pos);if(aH>-1){this.pos=aH;return true}},backUp:function(aG){this.pos-=aG},column:function(){return an(this.string,this.start,this.tabSize)},indentation:function(){return an(this.string,null,this.tabSize)},match:function(aJ,aH,aG){if(typeof aJ=="string"){var aK=function(aL){return aG?aL.toLowerCase():aL};if(aK(this.string).indexOf(aK(aJ),this.pos)==this.pos){if(aH!==false){this.pos+=aJ.length}return true}}else{var aI=this.string.slice(this.pos).match(aJ);if(aI&&aI.index>0){return null}if(aI&&aH!==false){this.pos+=aI[0].length}return aI}},current:function(){return this.string.slice(this.start,this.pos)}};p.StringStream=ag;function X(aI,aH,aG){this.from=aI;this.to=aH;this.marker=aG}function aF(aI,aG){if(aI){for(var aH=0;aH<aI.length;++aH){var aJ=aI[aH];if(aJ.marker==aG){return aJ}}}}function aB(aH,aI){var aJ;for(var aG=0;aG<aH.length;++aG){if(aH[aG]!=aI){(aJ||(aJ=[])).push(aH[aG])}}return aJ}function T(aH,aI,aK){if(aH){for(var aL=0,aN;aL<aH.length;++aL){var aO=aH[aL],aM=aO.marker;var aG=aO.from==null||(aM.inclusiveLeft?aO.from<=aI:aO.from<aI);if(aG||aM.type=="bookmark"&&aO.from==aI&&aO.from!=aK){var aJ=aO.to==null||(aM.inclusiveRight?aO.to>=aI:aO.to>aI);(aN||(aN=[])).push({from:aO.from,to:aJ?null:aO.to,marker:aM})}}}return aN}function au(aI,aL){if(aI){for(var aK=0,aH;aK<aI.length;++aK){var aM=aI[aK],aG=aM.marker;var aN=aM.to==null||(aG.inclusiveRight?aM.to>=aL:aM.to>aL);if(aN||aG.type=="bookmark"&&aM.from==aL){var aJ=aM.from==null||(aG.inclusiveLeft?aM.from<=aL:aM.from<aL);(aH||(aH=[])).push({from:aJ?null:aM.from-aL,to:aM.to==null?null:aM.to-aL,marker:aG})}}}return aH}function W(aO,aT,aH,aK,aN){if(!aO&&!aT){return aN}var aM=T(aO,aH);var aR=au(aT,aK);var aS=aN.length==1,aI=N(aN).length+(aS?aH:0);if(aM){for(var aJ=0;aJ<aM.length;++aJ){var aQ=aM[aJ];if(aQ.to==null){var aU=aF(aR,aQ.marker);if(!aU){aQ.to=aH}else{if(aS){aQ.to=aU.to==null?null:aU.to+aI}}}}}if(aR){for(var aJ=0;aJ<aR.length;++aJ){var aQ=aR[aJ];if(aQ.to!=null){aQ.to+=aI}if(aQ.from==null){var aU=aF(aM,aQ.marker);if(!aU){aQ.from=aI;if(aS){(aM||(aM=[])).push(aQ)}}}else{aQ.from+=aI;if(aS){(aM||(aM=[])).push(aQ)}}}}var aL=[j(aN[0],aM)];if(!aS){var aP=aN.length-2,aG;if(aP>0&&aM){for(var aJ=0;aJ<aM.length;++aJ){if(aM[aJ].to==null){(aG||(aG=[])).push({from:null,to:null,marker:aM[aJ].marker})}}}for(var aJ=0;aJ<aP;++aJ){aL.push(j(aN[aJ+1],aG))}aL.push(j(N(aN),aR))}return aL}function ar(aG){return typeof aG=="string"?aG:aG.text}function d(aJ){if(typeof aJ=="string"){return null}var aI=aJ.markedSpans,aG=null;for(var aH=0;aH<aI.length;++aH){if(aI[aH].marker.explicitlyCleared){if(!aG){aG=aI.slice(0,aH)}}else{if(aG){aG.push(aI[aH])}}}return !aG?aI:aG.length?aG:null}function j(aH,aG){return aG?{text:aH,markedSpans:aG}:aH}function ay(aI){var aK=aI.markedSpans;if(!aK){return}for(var aJ=0;aJ<aK.length;++aJ){var aH=aK[aJ].marker.lines;var aG=s(aH,aI);aH.splice(aG,1)}aI.markedSpans=null}function aA(aH,aJ){if(!aJ){return}for(var aI=0;aI<aJ.length;++aI){var aG=aJ[aI].marker.lines.push(aH)}aH.markedSpans=aJ}var am=" ";if(v||(S&&!J)){am="\u200b"}else{if(av){am=""}}function H(aH,aG){this.text=aH;this.height=1;aA(this,aG)}H.prototype={update:function(aH,aG){this.text=aH;this.stateAfter=this.styles=null;ay(this);aA(this,aG)},highlight:function(aM,aJ,aK){var aL=new ag(this.text,aK),aG=this.styles||(this.styles=[]);var aN=aG.length=0;if(this.text==""&&aM.blankLine){aM.blankLine(aJ)}while(!aL.eol()){var aH=aM.token(aL,aJ),aI=aL.current();aL.start=aL.pos;if(aN&&aG[aN-1]==aH){aG[aN-2]+=aI}else{if(aI){aG[aN++]=aI;aG[aN++]=aH}}if(aL.pos>5000){aG[aN++]=this.text.slice(aL.pos);aG[aN++]=null;break}}},process:function(aJ,aG,aH){var aI=new ag(this.text,aH);if(this.text==""&&aJ.blankLine){aJ.blankLine(aG)}while(!aI.eol()&&aI.pos<=5000){aJ.token(aI,aG);aI.start=aI.pos}},getTokenAt:function(aM,aJ,aK,aI){var aG=this.text,aL=new ag(aG,aK);while(aL.pos<aI&&!aL.eol()){aL.start=aL.pos;var aH=aM.token(aL,aJ)}return{start:aL.start,end:aL.pos,string:aL.current(),className:aH||null,state:aJ}},indentation:function(aG){return an(this.text,null,aG)},getContent:function(aV,aG,aR){var aM=true,aK=0,a2=/[\t\u0000-\u0019\u200b\u2028\u2029\uFEFF]/g;var aU=ai("pre");function a3(bh,bm,be){if(!bm){return}if(aM&&S&&bm.charAt(0)==" "){bm="\u00a0"+bm.slice(1)}aM=false;if(!a2.test(bm)){aK+=bm.length;var bi=document.createTextNode(bm)}else{var bi=document.createDocumentFragment(),bk=0;while(true){a2.lastIndex=bk;var bf=a2.exec(bm);var bj=bf?bf.index-bk:bm.length-bk;if(bj){bi.appendChild(document.createTextNode(bm.slice(bk,bk+bj)));aK+=bj}if(!bf){break}bk+=bj+1;if(bf[0]=="\t"){var bl=aV-aK%aV;bi.appendChild(ai("span",ax(bl),"cm-tab"));aK+=bl}else{var bg=ai("span","\u2022","cm-invalidchar");bg.title="\\u"+bf[0].charCodeAt(0).toString(16);bi.appendChild(bg);aK+=1}}}if(be){bh.appendChild(ai("span",[bi],be))}else{bh.appendChild(bi)}}var a6=a3;if(aG!=null){var a0=0,aN=aU.anchor=ai("span");a6=function(bg,bj,bh){var bf=bj.length;if(aG>=a0&&aG<a0+bf){var bi=aG-a0;if(bi){a3(bg,bj.slice(0,bi),bh);if(aR){var be=bj.slice(bi-1,bi+1);if(F.test(be)){bg.appendChild(ai("wbr"))}else{if(!J&&/\w\w/.test(be)){bg.appendChild(document.createTextNode("\u200d"))}}}}bg.appendChild(aN);a3(aN,av?bj.slice(bi,bi+1):bj.slice(bi),bh);if(av){a3(bg,bj.slice(bi+1),bh)}aG--;a0+=bf}else{a0+=bf;a3(bg,bj,bh);if(a0==aG&&a0==ba){w(aN,am);bg.appendChild(aN)}else{if(a0>aG+10&&/\s/.test(bj)){a6=function(){}}}}}}var aZ=this.styles,aO=this.text,aW=this.markedSpans;var ba=aO.length;function aJ(be){if(!be){return null}return"cm-"+be.replace(/ +/g," cm-")}if(!aO&&aG==null){a6(aU," ")}else{if(!aW||!aW.length){for(var a7=0,aQ=0;aQ<ba;a7+=2){var aY=aZ[a7],a9=aZ[a7+1],a1=aY.length;if(aQ+a1>ba){aY=aY.slice(0,ba-aQ)}aQ+=a1;a6(aU,aY,aJ(a9))}}else{aW.sort(function(bf,be){return bf.from-be.from});var aL=0,a7=0,aT="",a9,bd=0;var bc=aW[0].from||0,a5=[],bb=0;var a8=function(){var be;while(bb<aW.length&&((be=aW[bb]).from==aL||be.from==null)){if(be.marker.type=="range"){a5.push(be)}++bb}bc=bb<aW.length?aW[bb].from:Infinity;for(var bf=0;bf<a5.length;++bf){var bg=a5[bf].to;if(bg==null){bg=Infinity}if(bg==aL){a5.splice(bf--,1)}else{bc=Math.min(bg,bc)}}};var aX=0;while(aL<ba){if(bc==aL){a8()}var aS=Math.min(ba,bc);while(true){if(aT){var aI=aL+aT.length;var aH=a9;for(var a4=0;a4<a5.length;++a4){var aP=a5[a4];aH=(aH?aH+" ":"")+aP.marker.style;if(aP.marker.endStyle&&aP.to===Math.min(aI,aS)){aH+=" "+aP.marker.endStyle}if(aP.marker.startStyle&&aP.from===aL){aH+=" "+aP.marker.startStyle}}a6(aU,aI>aS?aT.slice(0,aS-aL):aT,aH);if(aI>=aS){aT=aT.slice(aS-aL);aL=aS;break}aL=aI}aT=aZ[a7++];a9=aJ(aZ[a7++])}}}}return aU},cleanUp:function(){this.parent=null;ay(this)}};function O(aH){this.lines=aH;this.parent=null;for(var aI=0,aJ=aH.length,aG=0;aI<aJ;++aI){aH[aI].parent=this;aG+=aH[aI].height}this.height=aG}O.prototype={chunkSize:function(){return this.lines.length},remove:function(aG,aM,aK){for(var aJ=aG,aL=aG+aM;aJ<aL;++aJ){var aH=this.lines[aJ];this.height-=aH.height;aH.cleanUp();if(aH.handlers){for(var aI=0;aI<aH.handlers.length;++aI){aK.push(aH.handlers[aI])}}}this.lines.splice(aG,aM)},collapse:function(aG){aG.splice.apply(aG,[aG.length,0].concat(this.lines))},insertHeight:function(aH,aI,aG){this.height+=aG;this.lines=this.lines.slice(0,aH).concat(aI).concat(this.lines.slice(aH));for(var aJ=0,aK=aI.length;aJ<aK;++aJ){aI[aJ].parent=this}},iterN:function(aG,aJ,aI){for(var aH=aG+aJ;aG<aH;++aG){if(aI(this.lines[aG])){return true}}}};function aj(aJ){this.children=aJ;var aI=0,aG=0;for(var aH=0,aL=aJ.length;aH<aL;++aH){var aK=aJ[aH];aI+=aK.chunkSize();aG+=aK.height;aK.parent=this}this.size=aI;this.height=aG;this.parent=null}aj.prototype={chunkSize:function(){return this.size},remove:function(aI,aH,aL){this.size-=aH;for(var aJ=0;aJ<this.children.length;++aJ){var aG=this.children[aJ],aM=aG.chunkSize();if(aI<aM){var aK=Math.min(aH,aM-aI),aN=aG.height;aG.remove(aI,aK,aL);this.height-=aN-aG.height;if(aM==aK){this.children.splice(aJ--,1);aG.parent=null}if((aH-=aK)==0){break}aI=0}else{aI-=aM}}if(this.size-aH<25){var aO=[];this.collapse(aO);this.children=[new O(aO)];this.children[0].parent=this}},collapse:function(aG){for(var aH=0,aI=this.children.length;aH<aI;++aH){this.children[aH].collapse(aG)}},insert:function(aH,aI){var aG=0;for(var aJ=0,aK=aI.length;aJ<aK;++aJ){aG+=aI[aJ].height}this.insertHeight(aH,aI,aG)},insertHeight:function(aH,aO,aN){this.size+=aO.length;this.height+=aN;for(var aI=0,aK=this.children.length;aI<aK;++aI){var aG=this.children[aI],aL=aG.chunkSize();if(aH<=aL){aG.insertHeight(aH,aO,aN);if(aG.lines&&aG.lines.length>50){while(aG.lines.length>50){var aJ=aG.lines.splice(aG.lines.length-25,25);var aM=new O(aJ);aG.height-=aM.height;this.children.splice(aI+1,0,aM);aM.parent=this}this.maybeSpill()}break}aH-=aL}},maybeSpill:function(){if(this.children.length<=10){return}var aJ=this;do{var aH=aJ.children.splice(aJ.children.length-5,5);var aI=new aj(aH);if(!aJ.parent){var aK=new aj(aJ.children);aK.parent=aJ;aJ.children=[aK,aI];aJ=aK}else{aJ.size-=aI.size;aJ.height-=aI.height;var aG=s(aJ.parent.children,aJ);aJ.parent.children.splice(aG+1,0,aI)}aI.parent=aJ.parent}while(aJ.children.length>10);aJ.parent.maybeSpill()},iter:function(aI,aH,aG){this.iterN(aI,aH-aI,aG)},iterN:function(aG,aN,aM){for(var aH=0,aK=this.children.length;aH<aK;++aH){var aL=this.children[aH],aJ=aL.chunkSize();if(aG<aJ){var aI=Math.min(aN,aJ-aG);if(aL.iterN(aG,aI,aM)){return true}if((aN-=aI)==0){break}aG=0}else{aG-=aJ}}}};function K(aG,aK){while(!aG.lines){for(var aH=0;;++aH){var aJ=aG.children[aH],aI=aJ.chunkSize();if(aK<aI){aG=aJ;break}aK-=aI}}return aG.lines[aK]}function V(aG){if(aG.parent==null){return null}var aL=aG.parent,aK=s(aL.lines,aG);for(var aH=aL.parent;aH;aL=aH,aH=aH.parent){for(var aI=0,aJ=aH.children.length;;++aI){if(aH.children[aI]==aL){break}aK+=aH.children[aI].chunkSize()}}return aK}function ad(aM,aK){var aI=0;outer:do{for(var aJ=0,aL=aM.children.length;aJ<aL;++aJ){var aH=aM.children[aJ],aG=aH.height;if(aK<aG){aM=aH;continue outer}aK-=aG;aI+=aH.chunkSize()}return aI}while(!aM.lines);for(var aJ=0,aL=aM.lines.length;aJ<aL;++aJ){var aO=aM.lines[aJ],aN=aO.height;if(aK<aN){break}aK-=aN}return aI+aJ}function a(aG,aM){var aI=0;outer:do{for(var aH=0,aK=aG.children.length;aH<aK;++aH){var aL=aG.children[aH],aJ=aL.chunkSize();if(aM<aJ){aG=aL;continue outer}aM-=aJ;aI+=aL.height}return aI}while(!aG.lines);for(var aH=0;aH<aM;++aH){aI+=aG.lines[aH].height}return aI}function D(){this.time=0;this.done=[];this.undone=[];this.compound=0;this.closed=false}D.prototype={addChange:function(aG,aL,aH){this.undone.length=0;var aI=+new Date,aN=N(this.done),aO=aN&&N(aN);var aK=aI-this.time;if(aN&&!this.closed&&this.compound){aN.push({start:aG,added:aL,old:aH})}else{if(aK>400||!aO||this.closed||aO.start>aG+aH.length||aO.start+aO.added<aG){this.done.push([{start:aG,added:aL,old:aH}]);this.closed=false}else{var aM=Math.max(0,aO.start-aG),aP=Math.max(0,(aG+aH.length)-(aO.start+aO.added));for(var aJ=aM;aJ>0;--aJ){aO.old.unshift(aH[aJ-1])}for(var aJ=aP;aJ>0;--aJ){aO.old.push(aH[aH.length-aJ])}if(aM){aO.start=aG}aO.added+=aL-(aH.length-aM-aP)}}this.time=aI},startCompound:function(){if(!this.compound++){this.closed=true}},endCompound:function(){if(!--this.compound){this.closed=true}}};function x(){ac(this)}function P(aG){if(!aG.stop){aG.stop=x}return aG}function e(aG){if(aG.preventDefault){aG.preventDefault()}else{aG.returnValue=false}}function o(aG){if(aG.stopPropagation){aG.stopPropagation()}else{aG.cancelBubble=true}}function ac(aG){e(aG);o(aG)}p.e_stop=ac;p.e_preventDefault=e;p.e_stopPropagation=o;function ap(aG){return aG.target||aG.srcElement}function C(aH){var aG=aH.which;if(aG==null){if(aH.button&1){aG=1}else{if(aH.button&2){aG=3}else{if(aH.button&4){aG=2}}}}if(I&&aH.ctrlKey&&aG==1){aG=3}return aG}function ab(aH,aI){var aG=aH.override&&aH.override.hasOwnProperty(aI);return aG?aH.override[aI]:aH[aI]}function aC(aJ,aI,aH,aG){if(typeof aJ.addEventListener=="function"){aJ.addEventListener(aI,aH,false);if(aG){return function(){aJ.removeEventListener(aI,aH,false)}}}else{var aK=function(aL){aH(aL||window.event)};aJ.attachEvent("on"+aI,aK);if(aG){return function(){aJ.detachEvent("on"+aI,aK)}}}}p.connect=aC;function i(){this.id=null}i.prototype={set:function(aG,aH){clearTimeout(this.id);this.id=setTimeout(aH,aG)}};var ao=p.Pass={toString:function(){return"CodeMirror.Pass"}};var aa=function(){if(G){return false}var aG=ai("div");return"draggable" in aG||"dragDrop" in aG}();var Q=function(){var aG=ai("textarea");aG.value="foo\nbar";if(aG.value.indexOf("\r")>-1){return"\r\n"}return"\n"}();var F=/^$/;if(v){F=/$'/}else{if(E){F=/\-[^ \-?]|\?[^ !'\"\),.\-\/:;\?\]\}]/}else{if(n){F=/\-[^ \-\.?]|\?[^ \-\.?\]\}:;!'\"\),\/]|[\.!\"#&%\)*+,:;=>\]|\}~][\(\{\[<]|\$'/}}}function an(aH,aG,aJ){if(aG==null){aG=aH.search(/[^\s\u00a0]/);if(aG==-1){aG=aH.length}}for(var aI=0,aK=0;aI<aG;++aI){if(aH.charAt(aI)=="\t"){aK+=aJ-(aK%aJ)}else{++aK}}return aK}function z(aJ,aG){try{var aI=aJ.getBoundingClientRect();aI={top:aI.top,left:aI.left}}catch(aK){aI={top:0,left:0}}if(!aG){if(window.pageYOffset==null){var aH=document.documentElement||document.body.parentNode;if(aH.scrollTop==null){aH=document.body}aI.top+=aH.scrollTop;aI.left+=aH.scrollLeft}else{aI.top+=window.pageYOffset;aI.left+=window.pageXOffset}}return aI}function az(aG){return aG.textContent||aG.innerText||aG.nodeValue||""}var al=[""];function ax(aG){while(al.length<=aG){al.push(N(al)+" ")}return al[aG]}function N(aG){return aG[aG.length-1]}function aD(aG){if(h){aG.selectionStart=0;aG.selectionEnd=aG.value.length}else{aG.select()}}function R(aH,aG){return aH.line==aG.line&&aH.ch==aG.ch}function B(aH,aG){return aH.line<aG.line||(aH.line==aG.line&&aH.ch<aG.ch)}function Y(aG){return{line:aG.line,ch:aG.ch}}function ai(aG,aK,aJ,aI){var aL=document.createElement(aG);if(aJ){aL.className=aJ}if(aI){aL.style.cssText=aI}if(typeof aK=="string"){w(aL,aK)}else{if(aK){for(var aH=0;aH<aK.length;++aH){aL.appendChild(aK[aH])}}}return aL}function aE(aG){aG.innerHTML="";return aG}function q(aG,aH){aE(aG).appendChild(aH)}function w(aG,aH){if(G){aG.innerHTML="";aG.appendChild(document.createTextNode(aH))}else{aG.textContent=aH}}function A(aJ,aI){if(!aI){return 0}if(!aJ){return aI.length}for(var aH=aJ.length,aG=aI.length;aH>=0&&aG>=0;--aH,--aG){if(aJ.charAt(aH)!=aI.charAt(aG)){break}}return aG+1}function s(aJ,aG){if(aJ.indexOf){return aJ.indexOf(aG)}for(var aH=0,aI=aJ.length;aH<aI;++aH){if(aJ[aH]==aG){return aH}}return -1}var M=/[\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc]/;function L(aG){return/\w/.test(aG)||aG>"\x80"&&(aG.toUpperCase()!=aG.toLowerCase()||M.test(aG))}var g="\n\nb".split(/\n/).length!=3?function(aL){var aM=0,aG=[],aK=aL.length;while(aM<=aK){var aJ=aL.indexOf("\n",aM);if(aJ==-1){aJ=aL.length}var aI=aL.slice(aM,aL.charAt(aJ-1)=="\r"?aJ-1:aJ);var aH=aI.indexOf("\r");if(aH!=-1){aG.push(aI.slice(0,aH));aM+=aH+1}else{aG.push(aI);aM=aJ+1}}return aG}:function(aG){return aG.split(/\r\n?|\n/)};p.splitLines=g;var b=window.getSelection?function(aH){try{return aH.selectionStart!=aH.selectionEnd}catch(aG){return false}}:function(aI){try{var aG=aI.ownerDocument.selection.createRange()}catch(aH){}if(!aG||aG.parentElement()!=aI){return false}return aG.compareEndPoints("StartToEnd",aG)!=0};p.defineMode("null",function(){return{token:function(aG){aG.skipToEnd()}}});p.defineMIME("text/plain","null");var u={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",91:"Mod",92:"Mod",93:"Mod",109:"-",107:"=",127:"Delete",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63276:"PageUp",63277:"PageDown",63275:"End",63273:"Home",63234:"Left",63232:"Up",63235:"Right",63233:"Down",63302:"Insert",63272:"Delete"};p.keyNames=u;(function(){for(var aG=0;aG<10;aG++){u[aG+48]=String(aG)}for(var aG=65;aG<=90;aG++){u[aG]=String.fromCharCode(aG)}for(var aG=1;aG<=12;aG++){u[aG+111]=u[aG+63235]="F"+aG}})();p.version="2.35 +";return p})();(function(){CodeMirror.simpleHint=function(e,b,a){var c={},g=CodeMirror.simpleHint.defaults;for(var d in g){if(g.hasOwnProperty(d)){c[d]=(a&&a.hasOwnProperty(d)?a:g)[d]}}function f(r){if(e.somethingSelected()){return}var o=e.getTokenAt(e.getCursor());if(c.closeOnTokenChange&&r!=null&&(o.start!=r.start||o.className!=r.className)){return}var v=b(e);if(!v||!v.list.length){return}var s=v.list;function t(i){e.replaceRange(i,v.from,v.to)}if(c.completeSingle&&s.length==1){t(s[0]);return true}var j=document.createElement("div");j.className="CodeMirror-completions";var k=j.appendChild(document.createElement("select"));if(!window.opera){k.multiple=true}for(var m=0;m<s.length;++m){var h=k.appendChild(document.createElement("option"));h.appendChild(document.createTextNode(s[m]))}k.firstChild.selected=true;k.size=Math.min(10,s.length);var q=c.alignWithWord?e.charCoords(v.from):e.cursorCoords();j.style.left=q.x+"px";j.style.top=q.yBot+"px";document.body.appendChild(j);var p=window.innerWidth||Math.max(document.body.offsetWidth,document.documentElement.offsetWidth);if(p-q.x<k.clientWidth){j.style.left=(q.x-k.clientWidth)+"px"}if(s.length<=10){j.style.width=(k.clientWidth-1)+"px"}var l=false;function u(){if(l){return}l=true;j.parentNode.removeChild(j)}function n(){t(s[k.selectedIndex]);u();setTimeout(function(){e.focus()},50)}CodeMirror.connect(k,"blur",u);CodeMirror.connect(k,"keydown",function(w){var i=w.keyCode;if(i==13){CodeMirror.e_stop(w);n()}else{if(i==27){CodeMirror.e_stop(w);u();e.focus()}else{if(i!=38&&i!=40&&i!=33&&i!=34&&!CodeMirror.isModifierKey(w)){u();e.focus();e.triggerOnKeyDown(w);if(!c.closeOnBackspace||i!=8){setTimeout(function(){f(o)},50)}}}}});CodeMirror.connect(k,"dblclick",n);k.focus();if(window.opera){setTimeout(function(){if(!l){k.focus()}},100)}return true}return f()};CodeMirror.simpleHint.defaults={closeOnBackspace:true,closeOnTokenChange:false,completeSingle:true,alignWithWord:true}})();(function(){CodeMirror.defaults.closeTagEnabled=true;CodeMirror.defaults.closeTagIndent=["applet","blockquote","body","button","div","dl","fieldset","form","frameset","h1","h2","h3","h4","h5","h6","head","html","iframe","layer","legend","object","ol","p","select","table","ul"];CodeMirror.defaults.closeTagVoid=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"];function b(g,h){return CodeMirror.innerMode(g.getMode(),h).state}CodeMirror.defineExtension("closeTag",function(n,g,j,k){if(!n.getOption("closeTagEnabled")){throw CodeMirror.Pass}var m=n.getCursor();var p=n.getTokenAt(m);var h=b(n,p.state);if(h){if(g==">"){var l=h.type;if(p.className=="tag"&&l=="closeTag"){throw CodeMirror.Pass}n.replaceSelection(">");m={line:m.line,ch:m.ch+1};n.setCursor(m);p=n.getTokenAt(n.getCursor());h=b(n,p.state);if(!h){throw CodeMirror.Pass}var l=h.type;if(p.className=="tag"&&l!="selfcloseTag"){var i=h.tagName;if(i.length>0&&f(n,k,i)){a(n,j,m,i)}return}n.setSelection({line:m.line,ch:m.ch-1},m);n.replaceSelection("")}else{if(g=="/"){if(p.className=="tag"&&p.string=="<"){var o=h.context,i=o?o.tagName:"";if(i.length>0){c(n,m,i);return}}}}}throw CodeMirror.Pass});function a(h,g,j,i){if(d(h,g,i)){h.replaceSelection("\n\n</"+i+">","end");h.indentLine(j.line+1);h.indentLine(j.line+2);h.setCursor({line:j.line+1,ch:h.getLine(j.line+1).length})}else{h.replaceSelection("</"+i+">");h.setCursor(j)}}function d(h,g,i){if(typeof g=="undefined"||g==null||g==true){g=h.getOption("closeTagIndent")}if(!g){g=[]}return e(g,i.toLowerCase())!=-1}function f(g,h,i){if(g.getOption("mode")=="xml"){return true}if(typeof h=="undefined"||h==null){h=g.getOption("closeTagVoid")}if(!h){h=[]}return e(h,i.toLowerCase())==-1}function e(k,g){if(k.indexOf){return k.indexOf(g)}for(var h=0,j=k.length;h<j;++h){if(k[h]==g){return h}}return -1}function c(g,i,h){g.replaceSelection("/"+h+">");g.setCursor({line:i.line,ch:i.ch+h.length+2})}})();(function(){CodeMirror.xmlHints=[];CodeMirror.xmlHint=function(d,f){if(f.length>0){var e=d.getCursor();d.replaceSelection(f);e={line:e.line,ch:e.ch+1};d.setCursor(e)}CodeMirror.simpleHint(d,a)};CodeMirror.xmlSimpleHint=function(d){CodeMirror.simpleHint(d,a)};var a=function(d){var k=d.getCursor();if(k.ch>0){var j=d.getRange({line:0,ch:0},k);var h="";var l="";for(var e=j.length-1;e>=0;e--){if(j[e]==" "||j[e]=="<"){l=j[e];break}else{h=j[e]+h}}j=j.slice(0,j.length-h.length);var g=b(d,j)+l;var f=CodeMirror.xmlHints[g];if(typeof f==="undefined"){f=[""]}else{f=f.slice(0);for(var e=f.length-1;e>=0;e--){if(f[e].indexOf(h)!=0){f.splice(e,1)}}}return{list:f,from:{line:k.line,ch:k.ch-h.length},to:k}}};var b=function(g,l){var d="";if(l.length>=0){var j=new RegExp("<([^!?][^\\s/>]*).*?>","g");var f=[];var h;while((h=j.exec(l))!=null){f.push({tag:h[1],selfclose:(h[0].slice(h[0].length-2)==="/>")})}for(var e=f.length-1,k=0;e>=0;e--){var m=f[e];if(m.tag[0]=="/"){k++}else{if(m.selfclose==false){if(k>0){k--}else{d="<"+m.tag+">"+d}}}}d+=c(l)}return d};var c=function(g){var d=g.lastIndexOf("<");var f=g.lastIndexOf(">");if(f<d){g=g.slice(d);if(g!="<"){var e=g.indexOf(" ");if(e<0){e=g.indexOf("\t")}if(e<0){e=g.indexOf("\n")}if(e<0){e=g.length}return g.slice(0,e)}}return""}})();CodeMirror.defineMode("xml",function(y,k){var r=y.indentUnit;var x=k.htmlMode?{autoSelfClosers:{area:true,base:true,br:true,col:true,command:true,embed:true,frame:true,hr:true,img:true,input:true,keygen:true,link:true,meta:true,param:true,source:true,track:true,wbr:true},implicitlyClosed:{dd:true,li:true,optgroup:true,option:true,p:true,rp:true,rt:true,tbody:true,td:true,tfoot:true,th:true,tr:true},contextGrabbers:{dd:{dd:true,dt:true},dt:{dd:true,dt:true},li:{li:true},option:{option:true,optgroup:true},optgroup:{optgroup:true},p:{address:true,article:true,aside:true,blockquote:true,dir:true,div:true,dl:true,fieldset:true,footer:true,form:true,h1:true,h2:true,h3:true,h4:true,h5:true,h6:true,header:true,hgroup:true,hr:true,menu:true,nav:true,ol:true,p:true,pre:true,section:true,table:true,ul:true},rp:{rp:true,rt:true},rt:{rp:true,rt:true},tbody:{tbody:true,tfoot:true},td:{td:true,th:true},tfoot:{tbody:true},th:{td:true,th:true},thead:{tbody:true,tfoot:true},tr:{tr:true}},doNotIndent:{pre:true},allowUnquoted:true,allowMissing:true}:{autoSelfClosers:{},implicitlyClosed:{},contextGrabbers:{},doNotIndent:{},allowUnquoted:false,allowMissing:false};var a=k.alignCDATA;var f,g;function o(E,D){function B(G){D.tokenize=G;return G(E,D)}var C=E.next();if(C=="<"){if(E.eat("!")){if(E.eat("[")){if(E.match("CDATA[")){return B(w("atom","]]>"))}else{return null}}else{if(E.match("--")){return B(w("comment","-->"))}else{if(E.match("DOCTYPE",true,true)){E.eatWhile(/[\w\._\-]/);return B(z(1))}else{return null}}}}else{if(E.eat("?")){E.eatWhile(/[\w\._\-]/);D.tokenize=w("meta","?>");return"meta"}else{g=E.eat("/")?"closeTag":"openTag";E.eatSpace();f="";var F;while((F=E.eat(/[^\s\u00a0=<>\"\'\/?]/))){f+=F}D.tokenize=n;return"tag"}}}else{if(C=="&"){var A;if(E.eat("#")){if(E.eat("x")){A=E.eatWhile(/[a-fA-F\d]/)&&E.eat(";")}else{A=E.eatWhile(/[\d]/)&&E.eat(";")}}else{A=E.eatWhile(/[\w\.\-:]/)&&E.eat(";")}return A?"atom":"error"}else{E.eatWhile(/[^&<]/);return null}}}function n(C,B){var A=C.next();if(A==">"||(A=="/"&&C.eat(">"))){B.tokenize=o;g=A==">"?"endTag":"selfcloseTag";return"tag"}else{if(A=="="){g="equals";return null}else{if(/[\'\"]/.test(A)){B.tokenize=j(A);return B.tokenize(C,B)}else{C.eatWhile(/[^\s\u00a0=<>\"\']/);return"word"}}}}function j(A){return function(C,B){while(!C.eol()){if(C.next()==A){B.tokenize=n;break}}return"string"}}function w(B,A){return function(D,C){while(!D.eol()){if(D.match(A)){C.tokenize=o;break}D.next()}return B}}function z(A){return function(D,C){var B;while((B=D.next())!=null){if(B=="<"){C.tokenize=z(A+1);return C.tokenize(D,C)}else{if(B==">"){if(A==1){C.tokenize=o;break}else{C.tokenize=z(A-1);return C.tokenize(D,C)}}}}return"meta"}}var l,h;function b(){for(var A=arguments.length-1;A>=0;A--){l.cc.push(arguments[A])}}function e(){b.apply(null,arguments);return true}function i(A,C){var B=x.doNotIndent.hasOwnProperty(A)||(l.context&&l.context.noIndent);l.context={prev:l.context,tagName:A,indent:l.indented,startOfLine:C,noIndent:B}}function u(){if(l.context){l.context=l.context.prev}}function d(A){if(A=="openTag"){l.tagName=f;return e(m,c(l.startOfLine))}else{if(A=="closeTag"){var B=false;if(l.context){if(l.context.tagName!=f){if(x.implicitlyClosed.hasOwnProperty(l.context.tagName.toLowerCase())){u()}B=!l.context||l.context.tagName!=f}}else{B=true}if(B){h="error"}return e(s(B))}}return e()}function c(A){return function(B){if(B=="selfcloseTag"||(B=="endTag"&&x.autoSelfClosers.hasOwnProperty(l.tagName.toLowerCase()))){q(l.tagName.toLowerCase());return e()}if(B=="endTag"){q(l.tagName.toLowerCase());i(l.tagName,A);return e()}return e()}}function s(A){return function(B){if(A){h="error"}if(B=="endTag"){u();return e()}h="error";return e(arguments.callee)}}function q(B){var A;while(true){if(!l.context){return}A=l.context.tagName.toLowerCase();if(!x.contextGrabbers.hasOwnProperty(A)||!x.contextGrabbers[A].hasOwnProperty(B)){return}u()}}function m(A){if(A=="word"){h="attribute";return e(p,m)}if(A=="endTag"||A=="selfcloseTag"){return b()}h="error";return e(m)}function p(A){if(A=="equals"){return e(v,m)}if(!x.allowMissing){h="error"}else{if(A=="word"){h="attribute"}}return(A=="endTag"||A=="selfcloseTag")?b():e()}function v(A){if(A=="string"){return e(t)}if(A=="word"&&x.allowUnquoted){h="string";return e()}h="error";return(A=="endTag"||A=="selfCloseTag")?b():e()}function t(A){if(A=="string"){return e(t)}else{return b()}}return{startState:function(){return{tokenize:o,cc:[],indented:0,startOfLine:true,tagName:null,context:null}},token:function(D,C){if(D.sol()){C.startOfLine=true;C.indented=D.indentation()}if(D.eatSpace()){return null}h=g=f=null;var B=C.tokenize(D,C);C.type=g;if((B||g)&&B!="comment"){l=C;while(true){var A=C.cc.pop()||d;if(A(g||B)){break}}}C.startOfLine=false;return h||B},indent:function(D,A,C){var B=D.context;if((D.tokenize!=n&&D.tokenize!=o)||B&&B.noIndent){return C?C.match(/^(\s*)/)[0].length:0}if(a&&/<!\[CDATA\[/.test(A)){return 0}if(B&&/^<\//.test(A)){B=B.prev}while(B&&!B.startOfLine){B=B.prev}if(B){return B.indent+r}else{return 0}},electricChars:"/"}});CodeMirror.defineMIME("text/xml","xml");CodeMirror.defineMIME("application/xml","xml");if(!CodeMirror.mimeModes.hasOwnProperty("text/html")){CodeMirror.defineMIME("text/html",{name:"xml",htmlMode:true})}$(function(){AS.mixedContentElements={language:{tag:"language",attributes:[],exclude:["accessrestrict","accruals","acqinfo","altformavail","appraisal","arrangement","bibliography","bioghist","custodhist","fileplan","index","odd","otherfindaid","originalsloc","phystech","prefercite","processinfo","relatedmaterial","scopecontent","separatedmaterial","userestrict","dimensions","legalstatus","summary","edition","extent","note","inscription","physdesc","relatedmaterial","abstract","physloc","materialspec","physfacet"]},blockquote:{tag:"blockquote",attributes:[],exclude:["abstract","dimensions","legalstatus","langmaterial","materialspec","physdesc","physfacet","physloc"]},date:{tag:"date",attributes:["type","normal","calendar","era"],exclude:["abstract","accruals","appraisal","arrangement","note_index","note_bibliography","bioghist","accessrestrict","userestrict","custodhist","dimensions","altformavail","originalsloc","fileplan","odd","acqinfo","otherfindaid","phystech","prefercite","processinfo","relatedmaterial","scopecontent","separatedmaterial","langmaterial","materialspec","physloc"]},"function":{tag:"function",attributes:["rules","source"],exclude:["abstract","accruals","appraisal","arrangement","note_bibliography","bioghist","accessrestrict","userestrict","custodhist","dimensions","altformavail","originalsloc","fileplan","odd","acqinfo","legalstatus","otherfindaid","phystech","prefercite","processinfo","relatedmaterial","scopecontent","separatedmaterial","note_index","langmaterial","materialspec","physloc"]},occupation:{tag:"occupation",attributes:["type","normal","calendar","era"],exclude:["abstract","accruals","appraisal","arrangement","note_bibliography","bioghist","accessrestrict","userestrict","custodhist","dimensions","altformavail","originalsloc","fileplan","odd","acqinfo","legalstatus","otherfindaid","phystech","prefercite","processinfo","relatedmaterial","scopecontent","separatedmaterial","note_index","langmaterial","materialspec","physloc"]},subject:{tag:"subject",attributes:["type","normal","calendar","era"],exclude:["abstract","accruals","appraisal","arrangement","note_bibliography","bioghist","accessrestrict","userestrict","custodhist","dimensions","altformavail","originalsloc","fileplan","odd","acqinfo","legalstatus","otherfindaid","phystech","prefercite","processinfo","relatedmaterial","scopecontent","separatedmaterial","note_index","langmaterial","materialspec","physloc"]},emph:{tag:"emph",attributes:["render"],exclude:["langmaterial","abstract","accruals","appraisal","arrangement","note_bibliography","bioghist","accessrestrict","userestrict","custodhist","altformavail","originalsloc","fileplan","odd","acqinfo","otherfindaid","phystech","prefercite","processinfo","relatedmaterial","scopecontent","separatedmaterial","note_index"]},corpname:{tag:"corpname",attributes:["rules","role","source"],exclude:["abstract","accruals","acqinfo","appraisal","arrangement","note_bibliography","bioghist","accessrestrict","userestrict","custodhist","dimensions","altformavail","originalsloc","fileplan","odd","acqinfo","legalstatus","otherfindaid","phystech","prefercite","processinfo","relatedmaterial","scopecontent","separatedmaterial","note_index","langmaterial","materialspec","physloc"]},persname:{tag:"persname",attributes:["rules","role","source"],exclude:["abstract","accruals","appraisal","acqinfo","arrangement","note_bibliography","bioghist","accessrestrict","userestrict","custodhist","dimensions","altformavail","originalsloc","fileplan","odd","acqinfo","legalstatus","otherfindaid","phystech","prefercite","processinfo","relatedmaterial","scopecontent","separatedmaterial","note_index","langmaterial","materialspec","physloc"]},famname:{tag:"famname",attributes:["rules","role","source"],exclude:["abstract","accruals","appraisal","acqinfo","arrangement","note_bibliography","bioghist","accessrestrict","userestrict","custodhist","dimensions","altformavail","originalsloc","fileplan","odd","acqinfo","legalstatus","otherfindaid","phystech","prefercite","processinfo","relatedmaterial","scopecontent","separatedmaterial","note_index","langmaterial","materialspec","physloc"]},name:{tag:"name",attributes:["rules","role","source"],exclude:["abstract","accruals","acqinfo","appraisal","arrangement","note_bibliography","bioghist","accessrestrict","userestrict","custodhist","dimensions","altformavail","originalsloc","fileplan","odd","acqinfo","legalstatus","otherfindaid","phystech","prefercite","processinfo","relatedmaterial","scopecontent","separatedmaterial","note_index","langmaterial","materialspec","physloc"]},geogname:{tag:"geogname",attributes:["rules","role","source"],exclude:["abstract","accruals","appraisal","arrangement","note_bibliography","bioghist","accessrestrict","userestrict","custodhist","dimensions","altformavail","originalsloc","fileplan","odd","acqinfo","legalstatus","otherfindaid","phystech","prefercite","processinfo","relatedmaterial","scopecontent","separatedmaterial","note_index","langmaterial","materialspec","physloc"]},genreform:{tag:"genreform",attributes:["rules","role","type"],exclude:["abstract","accruals","appraisal","arrangement","note_bibliography","bioghist","accessrestrict","userestrict","custodhist","dimensions","altformavail","originalsloc","fileplan","odd","acqinfo","legalstatus","otherfindaid","phystech","prefercite","processinfo","relatedmaterial","scopecontent","separatedmaterial","note_index","langmaterial","materialspec","physloc"]},title:{tag:"title",attributes:["render","accruals"],exclude:["langmaterial","appraisal","accruals","arrangement","bioghist","accessrestrict","userestrict","custodhist","altformavail","originalsloc","fileplan","odd","acqinfo","legalstatus","phystech","prefercite","processinfo","scopecontent","note_index"]},ref:{tag:"ref",attributes:["target","show","title","actuate","href"],exclude:["langmaterial","accruals","appraisal","arrangement","bioghist","accessrestrict","userestrict","custodhist","altformavail","originalsloc","fileplan","odd","acqinfo","legalstatus","phystech","prefercite","processinfo","scopecontent","note_index"]},extref:{tag:"extref",attributes:["show","title","actuate","href"],exclude:["langmaterial","abstract","accruals","appraisal","arrangement","bioghist","accessrestrict","userestrict","custodhist","altformavail","originalsloc","fileplan","odd","acqinfo","legalstatus","phystech","prefercite","processinfo","scopecontent","separatedmaterial","note_index"]},}});$(function(){$.fn.mixedContent=function(){$(this).each(function(){var k=$(this);if(k.hasClass("initialised")){return}var h;var d=b(k);var j=a(d);var e=$(AS.renderTemplate("mixed_content_wrap_action_template",{tags:j}));var g=$("select",e);var i=CodeMirror.fromTextArea(k[0],{value:k.val(),onFocus:function(){d=b(k);j=a(d);c(j);g.empty();$.each(j,function(l,m){g.append("<option>"+l+"</option>")})},mode:"text/html",smartIndent:false,extraKeys:{"'>'":function(l){l.closeTag(l,">")},"'/'":function(l){l.closeTag(l,"/")},"' '":function(l){CodeMirror.xmlHint(l," ")},"'<'":function(l){CodeMirror.xmlHint(l,"<")},"Ctrl-Space":function(l){CodeMirror.xmlHint(l,"")}},lineWrapping:true,onCursorActivity:function(m){if(m.somethingSelected()){var p=i.cursorCoords(true,"local");var l=i.cursorCoords(false,"local");var o=e.height()-20+l.y;var n=Math.min(p.y==l.y?p.x:l.x,$(i.getWrapperElement()).width()-e.width());e.css("top",o+"px").css("left",n+"px").css("position","absolute");e.show()}else{g.val("");e.hide();i.save()}}});k.data("CodeMirror",i);k.addClass("initialised");var f=function(n){if(i.somethingSelected()&&g.val()!=""){var m=g.val();i.replaceSelection("<"+m+">"+i.getSelection()+"</"+m+">");var l=i.getCursor();i.setCursor({line:l.line,ch:i.getSelection()+l.ch});i.focus()}};e.bind("change",f);$(i.getWrapperElement()).append(e).append(AS.renderTemplate("mixed_content_help_template"))})};var b=function(e){var d=e.closest(".mixed-content-anchor > ul > li").find("[class$=-type]").map(function(){return this.value}).get();return d};var a=function(d){d=(typeof d==="undefined")?[]:d;whitelist={};if(AS.mixedContentElements){$.each(AS.mixedContentElements,function(e,g){var f=false;if(g.exclude){f=($(g.exclude).filter(d).length>0)}if(!f){whitelist[e]=g}})}return whitelist};var c=function(d){var e=function(j,f){CodeMirror.xmlHints[j]=[];for(var h=0;h<f.length;h++){var g=f[h];if(typeof g=="string"){g=AS.mixedContentElements[g]}CodeMirror.xmlHints[j].push(g.tag);CodeMirror.xmlHints[j+g.tag+" "]=g.attributes||[];if(g.elements){e(j+g.tag+"><",g.elements)}}};d=(typeof d==="undefined")?{}:d;if(d){CodeMirror.xmlHints["<"]=[];$.each(d,function(f,g){CodeMirror.xmlHints["<"].push(f);CodeMirror.xmlHints["<"+f+" "]=g.attributes||[];if(g.elements){e("<"+g.tag+"><",g.elements)}})}else{throw"No mixed content rules found: AS.mixedContentElements is null"}};c();$(document).bind("subrecordcreated.aspace",function(f,d,e){$("textarea.mixed-content:not(.initialised)",e).mixedContent()});$(document).bind("expandcontainer.aspace",function(d,e){$("textarea.mixed-content:not(.initialised)",e).mixedContent()})});AS.initSubRecordCollapsible=function(c,b){if(c.parents(".subrecord-form-fields").length>0){return}var d=function(){a.html(b())};var a=$("<div>").addClass("subrecord-summary-view");var f=$(".subrecord-form-container:first",c);var e=c.closest("li");$(".subrecord-form-remove",e).after(AS.renderTemplate("template_subrecord_collapse_action"));e.on("click",".collapse-subrecord-toggle",function(g){g.preventDefault();g.stopPropagation();if(!e.hasClass("collapsed")){d();f.hide();a.fadeIn()}else{f.slideDown("slow",function(){$(document).trigger("expandcontainer.aspace",f)});a.hide()}e.toggleClass("collapsed")}).on("click",".subrecord-summary-view",function(g){$(".collapse-subrecord-toggle",e).trigger("click")});if(c.find(".error:first").length>0||c.data("collapsed")===false){a.hide()}else{f.hide();e.addClass("collapsed")}d();c.append(a)};AS.initTooManySubRecords=function(b,d,c){if(d>4){var a=$(AS.renderTemplate("too_many_subrecords_template"));a.hide();b.append(a);a.fadeIn();$(".subrecord-form-container",b).hide();b.addClass("too-many");$(".subrecord-form-heading .btn",b).prop("disabled",true);$(b).on("click",function(e){e.preventDefault();b.children().andSelf().removeClass("too-many");a.html("<i class='spinner'></i>");$(".subrecord-form-heading .btn",b).prop("disabled",false);setTimeout(function(){c(function(){a.remove();$(".subrecord-form-container",b).fadeIn();$(document).trigger("loadedrecordsubforms.aspace",b)})},1000);b.unbind(e)});return true}else{return false}};$(document).ready(function(){function a(d){var c=d.data("type");if(c=="note_multipart"){var b=function(){var g=$(".note-type option:selected",d).val();var f=$("#notes_restriction",d);if(g=="accessrestrict"||g=="userestrict"){$(":input",f).removeAttr("disabled");f.show();var e=f.find("select[id*='_local_access_restriction_type_']");if(g=="accessrestrict"){e.removeAttr("disabled");e.closest(".control-group").show()}else{e.closest(".control-group").hide();e.attr("disabled","disabled")}}else{$(":input",f).attr("disabled","disabled");f.hide()}};$(".note-type",d).on("change",function(){b()});b()}}$(document).bind("subrecordcreated.aspace",function(b,d,c){if(d=="note"){a(c)}});$(document).bind("loadedrecordform.aspace",function(b,c){c.find("section.notes-form.subrecord-form .subrecord-form-fields").each(function(){a($(this))})});$("section.notes-form.subrecord-form .subrecord-form-fields").each(function(){a($(this))})});$(function(){$.fn.init_notes_form=function(){$(this).each(function(){var k=$(this);if(k.hasClass("initialised")||k.hasClass("too-many")){return}var j=$(".subrecord-form-fields",k).length;var g={};var f=function(t,s,q,p,r){$((p||".add-item-btn"),t).click(function(x){x.preventDefault();x.stopPropagation();var w=s;if(typeof(s)==="function"){w=s($(this))}var v=$(this).parent().hasClass("controls")?$(this).parent():$(this).closest(".subrecord-form");var u=$(".subrecord-form-list:first",v);var y=$(AS.renderTemplate(w,{path:AS.quickTemplate(u.data("name-path"),{index:j}),id_path:AS.quickTemplate(u.data("id-path"),{index:j}),index:"${index}"}));y=$("<li>").data("type",y.data("type")).append(y);y.attr("data-index",j);u.append(y);AS.initSubRecordSorting(u);if(r){r(y)}else{n(y,false)}if(q){$(document).triggerHandler("subrecordcreated.aspace",["note",y])}k.parents("form:first").triggerHandler("formchanged.aspace");$(":input:visible:first",y).focus();j++})};g.note_bibliography=function(p){f(p,"template_bib_item")};g.note_outline=function(p){f(p,"template_note_outline_level",true,".add-level-btn")};g.note_outline_level=function(p){f(p,"template_note_outline_string",true,".add-sub-item-btn");f(p,"template_note_outline_level",true,".add-sub-level-btn")};var e=function(p){$(".dropdown-menu.subrecord-selector li",p).click(function(q){if(!$(q.target).hasClass("btn")){q.stopPropagation()}})};e();var c=function(q){if(!q){q=$(document)}var p=$(".content-list",q);if(p.length>0){f(p,"template_content_item",true,".add-content-item-btn")}};var b=function(q){var p=$("<a href='javascript:void(0)' class='btn btn-default btn-xs pull-right subrecord-form-remove'><span class='glyphicon glyphicon-remove'></span></a>");q.prepend(p);p.on("click",function(){AS.confirmSubFormDelete($(this),function(){if(q.parent().hasClass("subrecord-form-wrapper")){q.parent().remove()}else{q.remove();if($(".subrecord-form-list:first",k).children("li").length<2){$(".subrecord-form-heading:first .btn.apply-note-order",k).attr("disabled","disabled")}}k.parents("form:first").triggerHandler("formchanged.aspace");$(document).triggerHandler("subrecorddeleted.aspace",[k])})})};g.note_index=function(p){f(p,"template_note_index_item")};g.note_chronology=function(p){f(p,"template_chronology_item",true)};g.note_definedlist=function(p){f(p,"template_definedlist_item")};g.note_orderedlist=function(p){f(p,"template_orderedlist_item")};g.chronology_item=function(p){f(p,"template_orderedlist_item",false,".add-event-btn")};g.note_multipart=function(q){var p=function(s){var r=$("select.multipart-note-type",s);r.change(i);b(s)};f(q,"template_note_multipart_selector",true,".add-sub-note-btn",p)};g.note_bioghist=function(q){var p=function(s){var r=$("select.bioghist-note-type",s);r.change(i);b(s)};f(q,"template_note_bioghist_selector",true,".add-sub-note-btn",p)};var a=function(u){if(!$.contains(document,u[0])){return}var q=function(v){if(v.length===0){return"&hellip;"}var w=$(v.get(0)).val();if(w.length<=200){return w+((v.length>1)?"<br/>&hellip;":"")}return $.trim(w).substring(0,200).split(" ").slice(0,-1).join(" ")+"&hellip;"};var s=function(){var v={type:$("#"+t+"_type_ :selected",u).text(),label:$("#"+t+"_label_",u).val(),jsonmodel_type:$("> .subrecord-form-heading:first",u).text(),summary:q($(":input[id*='_content_']",u))};return AS.renderTemplate("template_note_summary",v)};var r=u.closest(".subrecord-form-list").data("id-path");var p=u.closest("li").data("index");var t=AS.quickTemplate(r,{index:p});AS.initSubRecordCollapsible(u,s)};var n=function(s,p){if(s.hasClass("initialised")){return}s.addClass("initialised");if(!p){b(s)}e(s);var q=$("ul.subrecord-form-list:first",s);AS.initSubRecordSorting(q);var r=s.data("type");if(g[r]){g[r](s)}c(s);a(s)};var i=function(){var t=$(this).parents("[data-index]:first");var q=$(".selected-container",t);var p=t.parents(".subrecord-form-list:first");if($(this).val()===""){q.html(AS.renderTemplate("template_note_type_nil"));return}var r=$(AS.renderTemplate("template_"+$(this).val(),{path:AS.quickTemplate(p.data("name-path"),{index:t.data("index")}),id_path:AS.quickTemplate(p.data("id-path"),{index:t.data("index")}),index:"${index}"}));r.data("type");r.attr("data-index",t.data("index"));var s=$(".note-type option:contains('"+$(":selected",this).text()+"')",r);$(".note-type",r).val(s.val());n(r,true);q.html(r);$(":input:visible:first",r).focus();t.parents("form:first").triggerHandler("formchanged.aspace");$(document).triggerHandler("subrecordcreated.aspace",["note",r])};var m=function(q){q.preventDefault();q.stopPropagation();var p=$(".subrecord-form-list:first",k);$.ajax({url:APP_PATH+"notes/note_order",type:"GET",success:function(v){var t=p.children().detach();var s=_.sortBy(t,function(w){var x=$("select.note-type",$(w)).val();if(_.isUndefined(x)){if($("select.top-level-note-type",$(w)).length){x=$("select.top-level-note-type",$(w)).val().replace(/^note_/,"")}else{x=$(".subrecord-form-fields",$(w)).data("type").replace(/^note_/,"")}}return _.indexOf(v,x)});var u=_.map(t,function(w){return $(w).data("index")});var r=_.map(s,function(w){return $(w).data("index")});if(!_.isEqual(u,r)){$("form.aspace-record-form").triggerHandler("formchanged.aspace")}$(s).appendTo(p)},error:function(t,s,r){$container.html("<div class='alert alert-error'><p>An error occurred loading note order list.</p><pre>"+r+"</pre></div>")}})};var d=function(q){q.preventDefault();q.stopPropagation();var p=$(".subrecord-form-list:first",k);var t=k.hasClass("note-inline");if(t==true){var s=k.get(0).id;var r="template_"+s+"_note_type_selector_inline";var v=$(AS.renderTemplate(r))}else{var v=$(AS.renderTemplate("template_note_type_selector"))}v=$("<li>").data("type",v.data("type")).append(v);v.attr("data-index",j);p.append(v);AS.initSubRecordSorting(p);if(p.children("li").length>1){$(".subrecord-form-heading:first .btn.apply-note-order",k).removeAttr("disabled")}$(document).triggerHandler("subrecordcreated.aspace",["note",v]);$(":input:visible:first",v).focus();k.parents("form:first").triggerHandler("formchanged.aspace");b(v);var u=$("select.top-level-note-type",v);u.change(i);j++};$(".subrecord-form-heading:first .btn.add-note",k).click(d);$(".subrecord-form-heading:first .btn.apply-note-order",k).click(m);var l=$(".subrecord-form-list:first",k);if(l.children("li").length>1){$(".subrecord-form-heading:first .btn.apply-note-order",k).removeAttr("disabled")}var o=function(){$(".subrecord-form-inline",k).each(function(){b($(this))})};var h=function(q){var p=$("ul.subrecord-form-list:first",k);AS.initSubRecordSorting(p);AS.initAddAsYouGoActions(k,p);$(".subrecord-form-list > .subrecord-form-wrapper:visible > .subrecord-form-fields:not('.initialised')",q).each(function(){n($(this),false)});o()};$existingNotes=$(".subrecord-form-list:first > .subrecord-form-wrapper",k);tooManyNotes=AS.initTooManySubRecords(k,$existingNotes.length,h);if(tooManyNotes===false){k.addClass("initialised");h(k)}})};$(document).ready(function(){$(document).bind("loadedrecordform.aspace",function(a,b){$("section.notes-form.subrecord-form:not(.initialised)",b).init_notes_form()})})});$(function(){$.fn.init_subrecord_form=function(){$(this).each(function(){var a=$(this);if((a.hasClass("initialised")&&a.is(":visible"))||a.hasClass("too-many")){return}a.data("form_index",$("> .subrecord-form-container .subrecord-form-fields",a).length);var b=function(g){$(document).on("subrecordcreated.aspace",function(j,h,i){i.triggerHandler(j)});$(document).on("showall.aspace",function(j,h,i){i.triggerHandler(j)});var e=function(){var i=$(this);if(i.hasClass("initialised")){return}i.addClass("initialised");var h=function(){var j=$("<a href='javascript:void(0)' class='btn btn-default btn-xs pull-right subrecord-form-remove'><span class='glyphicon glyphicon-remove'></span></a>");i.prepend(j);j.on("click",function(){AS.confirmSubFormDelete($(this),function(){i.remove();if(a.data("cardinality")==="zero_to_one"){$("> .subrecord-form-heading > .btn",a).removeAttr("disabled")}a.parents("form:first").triggerHandler("formchanged.aspace");$(document).triggerHandler("subrecorddeleted.aspace",[a])});return false})};if(i.closest(".subrecord-form").data("remove")!="disabled"){h()}AS.initSubRecordSorting($("ul.subrecord-form-list",i));if(a.data("cardinality")==="zero_to_one"){$("> .subrecord-form-heading > .btn",a).attr("disabled","disabled")}$(document).triggerHandler("subrecordcreated.aspace",[i.data("object-name")||a.data("object-name"),i])};var d=function(j,h){var i=$("<li>").append(j);i.attr("data-index",a.data("form_index"));i.hide();h.append(i);i.fadeIn();AS.initSubRecordSorting(h);a.parents("form:first").triggerHandler("formchanged.aspace");$.proxy(e,i)();$(".subrecord-form:not(.initialised)",i).init_subrecord_form();$(":input:first",i).focus();a.data("form_index",a.data("form_index")+1)};if(a.data("custom-action")){$(a).on("click","> .subrecord-form-heading > .custom-action .btn:not(.show-all)",function(j){j.preventDefault();var i=$(".subrecord-form-list:first",$(this).parents(".subrecord-form:first"));var h={path:AS.quickTemplate(i.data("name-path"),{index:a.data("form_index")}),id_path:AS.quickTemplate(i.data("id-path"),{index:a.data("form_index")}),index:"${index}"};$(document).triggerHandler("subrecordcreaterequest.aspace",[a.data("object-name"),$(this).data(),h,i,d])});g()}else{$(a).on("click","> .subrecord-form-heading > .btn:not(.show-all)",function(k){k.preventDefault();var i=$(".subrecord-form-list:first",$(this).parents(".subrecord-form:first"));var h={path:AS.quickTemplate(i.data("name-path"),{index:a.data("form_index")}),id_path:AS.quickTemplate(i.data("id-path"),{index:a.data("form_index")}),index:"${index}"};var j=$(AS.renderTemplate(a.data("template"),h));d(j,i)});g()}var f=$("ul.subrecord-form-list:first",a);AS.initAddAsYouGoActions(a,f);AS.initSubRecordSorting(f);$("> .subrecord-form-container > .subrecord-form-list > .subrecord-form-wrapper:not(.initialised):visible",a).each(e)};var c=function(){return $(".subrecord-form-list:first > li",a).length};tooManyRecords=AS.initTooManySubRecords(a,c(),b);if(tooManyRecords===false){a.addClass("initialised");b(function(){$(document).trigger("loadedrecordsubforms.aspace",a)})}})};$(document).ready(function(){$(document).bind("loadedrecordform.aspace",function(a,b){$("#basic_information:not(.initialised)",b).init_subrecord_form();$(".subrecord-form[data-subrecord-form]:not(.initialised)",b).init_subrecord_form()});$(".subrecord-form[data-subrecord-form]:not(.initialised)").init_subrecord_form();$(document).on("subrecordmonkeypatch.aspace",function(b,a){$(".subrecord-form[data-subrecord-form]",a).init_subrecord_form()});$oc=$("#object_container:not(.initialised)");if($oc.length){$(document).triggerHandler("loadedrecordform.aspace",[$oc])}})});$(function(){var a=function(b){$("[name$='[date_type]']",b).change(function(h){var g=$(this).val();var d={};if($(".date-type-subform",b).length){d=$(".date-type-subform",b).serializeObject();$(".date-type-subform",b).remove()}if(g===""){$(this).parents(".form-group:first").after(AS.renderTemplate("template_date_type_nil"));return}var e=$(this).parents("[data-index]:first").data("index");var c={path:AS.quickTemplate($(this).parents("[data-name-path]:first").data("name-path"),{index:e}),id_path:AS.quickTemplate($(this).parents("[data-id-path]:first").data("id-path"),{index:e}),index:e};var f=$(AS.renderTemplate("template_date_type_"+g,c));$(this).parents(".form-group:first").after(f);f.setValuesFromObject(d);$(document).triggerHandler("subrecordcreated.aspace",["date_type",f])})};$(document).bind("subrecordcreated.aspace",function(d,b,c){if(b==="date"||b==="dates_of_existence"||b=="use_date"){a($(c))}})});$(function(){$.fn.init_related_agents_form=function(){$(this).each(function(){var f=$(this);$(".linker",f).linker();if(f.hasClass("initialised")){return}f.addClass("initialised");$("ul.subrecord-form-list > li",f).show();$(".linker",f).triggerHandler("formshowall.aspace");var c=$(".subrecord-form-fields",f).length;var e=function(j){var h=$(".subrecord-form-list:first",f);var i="template_"+$(this).val();var k=$(AS.renderTemplate(i,{path:AS.quickTemplate(h.data("name-path"),{index:c}),id_path:AS.quickTemplate(h.data("id-path"),{index:c}),index:"${index}"}));$(".selected-container",$(this).closest(".subrecord-form-fields")).html(k);$(document).triggerHandler("subrecordcreated.aspace",["related_agent",k]);$(document).triggerHandler("subrecordmonkeypatch.aspace",[k]);c++};var d=function(i){var h=$("<a href='javascript:void(0)' class='btn btn-default btn-xs pull-right subrecord-form-remove'><span class='glyphicon glyphicon-remove'></span></a>");i.prepend(h);h.on("click",function(){AS.confirmSubFormDelete($(this),function(){if(i.parent().hasClass("subrecord-form-wrapper")){i.parent().remove()}else{i.remove()}f.parents("form:first").triggerHandler("formchanged.aspace");$(document).triggerHandler("subrecorddeleted.aspace",[f])})})};var a=function(k){k.preventDefault();k.stopPropagation();var h=$(".subrecord-form-list:first",f);var j=$("option:selected",$(this).parents(".dropdown-menu"));var i="template_"+j.val();var l=$(AS.renderTemplate("template_related_agents_selector",{path:AS.quickTemplate(h.data("name-path"),{index:c}),id_path:AS.quickTemplate(h.data("id-path"),{index:c}),index:"${index}"}));l=$("<li>").data("type",l.data("type")).append(l);l.attr("data-index",c);l.show();h.append(l);d(l);$(document).triggerHandler("subrecordcreated.aspace",["related_agent",l]);$(document).triggerHandler("subrecordmonkeypatch.aspace",[l]);$("select.related-agent-type",l).change(e);AS.initSubRecordSorting(h);$(":input:visible:first",l).focus();c++};$(".add-related-agent-for-type-btn",f).click(a);var b=$("#related-agents-container > .subrecord-form-list");var g=$("> .subrecord-form-wrapper > .subrecord-form-fields",b);if(g.length>0){g.each(function(){d($(this))})}AS.initAddAsYouGoActions(f,b);AS.initSubRecordSorting(b)})};$(document).ready(function(){$(document).bind("loadedrecordform.aspace",function(a,b){$("section.related-agents-form.subrecord-form:not(.initialised)",b).init_related_agents_form()});$("section.related-agents-form.subrecord-form:not(.initialised)").init_related_agents_form()})});$(function(){var a=function(b){$("[name$='[rights_type]']",b).change(function(h){var g=$(this).val();var e={};if($(".rights-type-subform",b).length){e=$(".rights-type-subform",b).serializeObject();$(".rights-type-subform",b).remove()}if(g===""){$(this).parents(".form-group:first").after(AS.renderTemplate("template_rights_type_nil"));return}var f=$(this).parents("[data-index]:first").data("index");var d={path:AS.quickTemplate($(this).parents("[data-name-path]:first").data("name-path"),{index:f}),id_path:AS.quickTemplate($(this).parents("[data-id-path]:first").data("id-path"),{index:f}),index:f};var c=$(AS.renderTemplate("template_rights_type_"+g,d));$(this).parents(".form-group:first").after(c);c.setValuesFromObject(e);$(document).triggerHandler("subrecordcreated.aspace",["rights_type",c])})};$(document).bind("subrecordcreated.aspace",function(d,b,c){if(b==="rights_statement"){a($(c))}})});$(function(){var a=function(){$("#merge-dropdown .linker:not(.initialised)").linker();$(".merge-form .btn-cancel").on("click",function(){$(".merge-action").trigger("click")});$(".merge-action").on("click",function(b){b.preventDefault();b.stopImmediatePropagation();if($(this).attr("disabled")){return}if($(".merge-form")[0].style.display==="block"){$(".merge-form").css("display","")}else{$(".merge-form").css("display","block")}});$(".merge-form").on("click",function(b){b.stopPropagation()});$(".merge-form .linker-wrapper .dropdown-toggle").on("click",function(b){b.stopPropagation();$(this).parent().toggleClass("open")});$(".merge-form .merge-button").on("click",function(c){var b=$(".merge-form").serializeObject();if(b["merge[ref]"]&&!b["merge[ref][]"]){b["merge[ref][]"]=b["merge[ref]"]}if(!b["merge[ref][]"]){$(".missing-ref-message",".merge-form").show();c.preventDefault();c.stopImmediatePropagation();return false}else{$(".missing-ref-message",".merge-form").hide();$(this).data("form-data",{refs:b["merge[ref][]"]})}})};if($(".merge-form").length>0){a()}else{$(document).bind("loadedrecordform.aspace",a)}});$(function(){var a=function(){$(".add-event-form .btn-close").on("click",function(b){b.stopImmediatePropagation();b.preventDefault();$(".add-event-action").trigger("click")});$(".add-event-action").on("click",function(b){b.preventDefault();b.stopImmediatePropagation();if($(this).attr("disabled")){return}if($(".add-event-form")[0].style.display==="block"){$(".add-event-form").css("display","")}else{$(".add-event-form").css("display","block")}});$(".add-event-form").on("click",function(b){b.stopPropagation()});$(".add-event-form .add-event-button").on("click",function(c){c.stopPropagation();c.preventDefault();var b=AS.quickTemplate(decodeURIComponent($("#add-event-dropdown").data("add-event-url")),{event_type:$("#add_event_event_type").val()});location.href=b})};if($(".add-event-form").length>0){a()}else{$(document).bind("loadedrecordform.aspace",a)}});$(function(){var b=function(l){var e=$(l);var c=$(':checkbox[name$="[sort_name_auto_generate]"]',e);var k=$(':input[name$="[sort_name]"]',e);var d=function(){k.attr("readonly","readonly");k.prop("disabled",true);k.attr("readonly","readonly");$userEnteredSortNameValue=k[0].value;k[0].value=c.attr("display_text_when_checked")};if(c.is(":checked")){d()}c.change(function(){if(c.is(":checked")){d()}else{k.prop("disabled",false);k.removeAttr("readonly");k[0].value=$userEnteredSortNameValue}});var f=$(':input[name$="[authorized]"]',e);var j=$(':input[name$="[is_display_name]"]',e);var i=f.closest("section.subrecord-form");var h=function(m){if(m){e.addClass("authoritive-name")}else{e.removeClass("authoritive-name")}f.val(m?1:0)};var g=function(m){if(m){e.addClass("display-name")}else{e.removeClass("display-name")}j.val(m?1:0)};$(".btn-authoritive-name-toggle",e).click(function(m){m.preventDefault();i.triggerHandler("newauthorizedname.aspace",[e])});i.on("newauthorizedname.aspace",function(m,n){h(n==e)});$(".btn-display-name-toggle",e).click(function(m){m.preventDefault();i.triggerHandler("newdisplayname.aspace",[e])});i.on("newdisplayname.aspace",function(n,m){g(m==e)});h(f.val()=="1");g(j.val()=="1")};var a=function(c){if(c.hasClass("linked_agent_initialised")){return}else{c.addClass("linked_agent_initialised")}c.find("select.linked_agent_role").on("change",function(){var e=c.find(".agent-terms");if($(this).val()=="subject"){e.find(":input").removeAttr("disabled");e.show()}else{e.find(":input").attr("disabled","disabled");e.hide()}var d=c.find(".agent-creator-title").show();if($(this).val()=="creator"){d.show().find(":input").removeAttr("disabled")}else{d.hide().find(":input").attr("disabled","disabled")}});$(document).triggerHandler("subrecordcreated.aspace",["term",$("#terms",c)])};$(document).ready(function(){if($("#form_agent").length){$(document).triggerHandler("loadedrecordform.aspace",[$("#form_agent")]);$(document).triggerHandler("loadedrecordsubforms.aspace",[$("#form_agent")])}});$(document).bind("subrecordcreated.aspace",function(e,c,d){if(c==="name"){b($(d))}if(c==="linked_agent"){var f=$(d);a(f);f.find("select.linked_agent_role").triggerHandler("change")}})});$(function(){var a=function(b){if(b.data("terms")==="initialised"){return}b.data("terms","initialised");var c=function(f){var e=f.term_type;if(f._translated&&f._translated["term_type"]){e=f._translated["term_type"]}return f.term+" ["+e+"]"};var d=AS.delayedTypeAhead(function(e,f){$.ajax({url:APP_PATH+"subjects/terms/complete",data:{query:e},type:"GET",success:function(g){f(g)},error:function(){f([])}})});$(":text",b).typeahead({source:d.handle,matcher:function(e){return e.term&&c(e).toLowerCase().indexOf(this.query.toLowerCase())>=0},sorter:function(e){return e.sort(function(g,f){return g.term>f.term})},highlighter:function(e){return $.proxy(Object.getPrototypeOf(this).highlighter,this)(c(e))},updater:function(e){$("select",this.$element.parents(".row-fluid:first")).val(e.term_type);return e.term}})};$(document).bind("subrecordcreated.aspace",function(d,b,c){if(b==="term"){a($(c))}})});$(function(){$.fn.init_subject_form=function(){$(this).each(function(){var a=$(this);if(a.hasClass("initialised")){return}a.addClass("initialised");$(document).triggerHandler("subrecordcreated.aspace",["term",$("#terms",a)])})};$(document).ready(function(){$(document).bind("loadedrecordform.aspace",function(a,b){$("#new_subject:not(.initialised)",b).init_subject_form()});$("#new_subject:not(.initialised)").init_subject_form()})});$(function(){function a(c,b){if(b){c.addClass("is-representative")}else{c.removeClass("is-representative")}$(':input[name$="[is_representative]"]',c).val(b?1:0);c.trigger("formchanged.aspace")}$(document).bind("subrecordcreated.aspace",function(f,c,e){if(c==="file_version"||c==="instance"){var h=$(e);var g=h.closest("section.subrecord-form");var b=$(':input[name$="[is_representative]"]',h).val()==="1";var d="newrepresentative"+c.replace(/_/,"")+".aspace";if(b){h.addClass("is-representative")}$(".is-representative-toggle",h).click(function(i){i.preventDefault();g.triggerHandler(d,[h])});g.on(d,function(i,j){a(h,j==h)})}})});(function($){$.extend({tablesorter:new function(){var parsers=[],widgets=[];this.defaults={cssHeader:"header",cssAsc:"headerSortUp",cssDesc:"headerSortDown",cssChildRow:"expand-child",sortInitialOrder:"asc",sortMultiSortKey:"shiftKey",sortForce:null,sortAppend:null,sortLocaleCompare:true,textExtraction:"simple",parsers:{},widgets:[],widgetZebra:{css:["even","odd"]},headers:{},widthFixed:false,cancelSelection:true,sortList:[],headerList:[],dateFormat:"us",decimal:"/.|,/g",onRenderHeader:null,selectorHeaders:"thead th",debug:false};function benchmark(s,d){log(s+","+(new Date().getTime()-d.getTime())+"ms")}this.benchmark=benchmark;function log(s){if(typeof console!="undefined"&&typeof console.debug!="undefined"){console.log(s)}else{alert(s)}}function buildParserCache(table,$headers){if(table.config.debug){var parsersDebug=""}if(table.tBodies.length==0){return}var rows=table.tBodies[0].rows;if(rows[0]){var list=[],cells=rows[0].cells,l=cells.length;for(var i=0;i<l;i++){var p=false;if($.metadata&&($($headers[i]).metadata()&&$($headers[i]).metadata().sorter)){p=getParserById($($headers[i]).metadata().sorter)}else{if((table.config.headers[i]&&table.config.headers[i].sorter)){p=getParserById(table.config.headers[i].sorter)}}if(!p){p=detectParserForColumn(table,rows,-1,i)}if(table.config.debug){parsersDebug+="column:"+i+" parser:"+p.id+"\n"}list.push(p)}}if(table.config.debug){log(parsersDebug)}return list}function detectParserForColumn(table,rows,rowIndex,cellIndex){var l=parsers.length,node=false,nodeValue=false,keepLooking=true;while(nodeValue==""&&keepLooking){rowIndex++;if(rows[rowIndex]){node=getNodeFromRowAndCellIndex(rows,rowIndex,cellIndex);nodeValue=trimAndGetNodeText(table.config,node);if(table.config.debug){log("Checking if value was empty on row:"+rowIndex)}}else{keepLooking=false}}for(var i=1;i<l;i++){if(parsers[i].is(nodeValue,table,node)){return parsers[i]}}return parsers[0]}function getNodeFromRowAndCellIndex(rows,rowIndex,cellIndex){return rows[rowIndex].cells[cellIndex]}function trimAndGetNodeText(config,node){return $.trim(getElementText(config,node))}function getParserById(name){var l=parsers.length;for(var i=0;i<l;i++){if(parsers[i].id.toLowerCase()==name.toLowerCase()){return parsers[i]}}return false}function buildCache(table){if(table.config.debug){var cacheTime=new Date()}var totalRows=(table.tBodies[0]&&table.tBodies[0].rows.length)||0,totalCells=(table.tBodies[0].rows[0]&&table.tBodies[0].rows[0].cells.length)||0,parsers=table.config.parsers,cache={row:[],normalized:[]};for(var i=0;i<totalRows;++i){var c=$(table.tBodies[0].rows[i]),cols=[];if(c.hasClass(table.config.cssChildRow)){cache.row[cache.row.length-1]=cache.row[cache.row.length-1].add(c);continue}cache.row.push(c);for(var j=0;j<totalCells;++j){cols.push(parsers[j].format(getElementText(table.config,c[0].cells[j]),table,c[0].cells[j]))}cols.push(cache.normalized.length);cache.normalized.push(cols);cols=null}if(table.config.debug){benchmark("Building cache for "+totalRows+" rows:",cacheTime)}return cache}function getElementText(config,node){var text="";if(!node){return""}if(!config.supportsTextContent){config.supportsTextContent=node.textContent||false}if(config.textExtraction=="simple"){if(config.supportsTextContent){text=node.textContent}else{if(node.childNodes[0]&&node.childNodes[0].hasChildNodes()){text=node.childNodes[0].innerHTML}else{text=node.innerHTML}}}else{if(typeof(config.textExtraction)=="function"){text=config.textExtraction(node)}else{text=$(node).text()}}return text}function appendToTable(table,cache){if(table.config.debug){var appendTime=new Date()}var c=cache,r=c.row,n=c.normalized,totalRows=n.length,checkCell=(n[0].length-1),tableBody=$(table.tBodies[0]),rows=[];for(var i=0;i<totalRows;i++){var pos=n[i][checkCell];rows.push(r[pos]);if(!table.config.appender){var l=r[pos].length;for(var j=0;j<l;j++){tableBody[0].appendChild(r[pos][j])}}}if(table.config.appender){table.config.appender(table,rows)}rows=null;if(table.config.debug){benchmark("Rebuilt table:",appendTime)}applyWidget(table);setTimeout(function(){$(table).trigger("sortEnd")},0)}function buildHeaders(table){if(table.config.debug){var time=new Date()}var meta=($.metadata)?true:false;var header_index=computeTableHeaderCellIndexes(table);$tableHeaders=$(table.config.selectorHeaders,table).each(function(index){this.column=header_index[this.parentNode.rowIndex+"-"+this.cellIndex];this.order=formatSortingOrder(table.config.sortInitialOrder);this.count=this.order;if(checkHeaderMetadata(this)||checkHeaderOptions(table,index)){this.sortDisabled=true}if(checkHeaderOptionsSortingLocked(table,index)){this.order=this.lockedOrder=checkHeaderOptionsSortingLocked(table,index)}if(!this.sortDisabled){var $th=$(this).addClass(table.config.cssHeader);if(table.config.onRenderHeader){table.config.onRenderHeader.apply($th)}}table.config.headerList[index]=this});if(table.config.debug){benchmark("Built headers:",time);log($tableHeaders)}return $tableHeaders}function computeTableHeaderCellIndexes(t){var matrix=[];var lookup={};var thead=t.getElementsByTagName("THEAD")[0];var trs=thead.getElementsByTagName("TR");for(var i=0;i<trs.length;i++){var cells=trs[i].cells;for(var j=0;j<cells.length;j++){var c=cells[j];var rowIndex=c.parentNode.rowIndex;var cellId=rowIndex+"-"+c.cellIndex;var rowSpan=c.rowSpan||1;var colSpan=c.colSpan||1;var firstAvailCol;if(typeof(matrix[rowIndex])=="undefined"){matrix[rowIndex]=[]}for(var k=0;k<matrix[rowIndex].length+1;k++){if(typeof(matrix[rowIndex][k])=="undefined"){firstAvailCol=k;break}}lookup[cellId]=firstAvailCol;for(var k=rowIndex;k<rowIndex+rowSpan;k++){if(typeof(matrix[k])=="undefined"){matrix[k]=[]}var matrixrow=matrix[k];for(var l=firstAvailCol;l<firstAvailCol+colSpan;l++){matrixrow[l]="x"}}}}return lookup}function checkCellColSpan(table,rows,row){var arr=[],r=table.tHead.rows,c=r[row].cells;for(var i=0;i<c.length;i++){var cell=c[i];if(cell.colSpan>1){arr=arr.concat(checkCellColSpan(table,headerArr,row++))}else{if(table.tHead.length==1||(cell.rowSpan>1||!r[row+1])){arr.push(cell)}}}return arr}function checkHeaderMetadata(cell){if(($.metadata)&&($(cell).metadata().sorter===false)){return true}return false}function checkHeaderOptions(table,i){if((table.config.headers[i])&&(table.config.headers[i].sorter===false)){return true}return false}function checkHeaderOptionsSortingLocked(table,i){if((table.config.headers[i])&&(table.config.headers[i].lockedOrder)){return table.config.headers[i].lockedOrder}return false}function applyWidget(table){var c=table.config.widgets;var l=c.length;for(var i=0;i<l;i++){getWidgetById(c[i]).format(table)}}function getWidgetById(name){var l=widgets.length;for(var i=0;i<l;i++){if(widgets[i].id.toLowerCase()==name.toLowerCase()){return widgets[i]}}}function formatSortingOrder(v){if(typeof(v)!="Number"){return(v.toLowerCase()=="desc")?1:0}else{return(v==1)?1:0}}function isValueInArray(v,a){var l=a.length;for(var i=0;i<l;i++){if(a[i][0]==v){return true}}return false}function setHeadersCss(table,$headers,list,css){$headers.removeClass(css[0]).removeClass(css[1]);var h=[];$headers.each(function(offset){if(!this.sortDisabled){h[this.column]=$(this)}});var l=list.length;for(var i=0;i<l;i++){h[list[i][0]].addClass(css[list[i][1]])}}function fixColumnWidth(table,$headers){var c=table.config;if(c.widthFixed){var colgroup=$("<colgroup>");$("tr:first td",table.tBodies[0]).each(function(){colgroup.append($("<col>").css("width",$(this).width()))});$(table).prepend(colgroup)}}function updateHeaderSortCount(table,sortList){var c=table.config,l=sortList.length;for(var i=0;i<l;i++){var s=sortList[i],o=c.headerList[s[0]];o.count=s[1];o.count++}}function multisort(table,sortList,cache){if(table.config.debug){var sortTime=new Date()}var dynamicExp="var sortWrapper = function(a,b) {",l=sortList.length;for(var i=0;i<l;i++){var c=sortList[i][0];var order=sortList[i][1];var s=(table.config.parsers[c].type=="text")?((order==0)?makeSortFunction("text","asc",c):makeSortFunction("text","desc",c)):((order==0)?makeSortFunction("numeric","asc",c):makeSortFunction("numeric","desc",c));var e="e"+i;dynamicExp+="var "+e+" = "+s;dynamicExp+="if("+e+") { return "+e+"; } ";dynamicExp+="else { "}var orgOrderCol=cache.normalized[0].length-1;dynamicExp+="return a["+orgOrderCol+"]-b["+orgOrderCol+"];";for(var i=0;i<l;i++){dynamicExp+="}; "}dynamicExp+="return 0; ";dynamicExp+="}; ";if(table.config.debug){benchmark("Evaling expression:"+dynamicExp,new Date())}eval(dynamicExp);cache.normalized.sort(sortWrapper);if(table.config.debug){benchmark("Sorting on "+sortList.toString()+" and dir "+order+" time:",sortTime)}return cache}function makeSortFunction(type,direction,index){var a="a["+index+"]",b="b["+index+"]";if(type=="text"&&direction=="asc"){return"("+a+" == "+b+" ? 0 : ("+a+" === null ? Number.POSITIVE_INFINITY : ("+b+" === null ? Number.NEGATIVE_INFINITY : ("+a+" < "+b+") ? -1 : 1 )));"}else{if(type=="text"&&direction=="desc"){return"("+a+" == "+b+" ? 0 : ("+a+" === null ? Number.POSITIVE_INFINITY : ("+b+" === null ? Number.NEGATIVE_INFINITY : ("+b+" < "+a+") ? -1 : 1 )));"}else{if(type=="numeric"&&direction=="asc"){return"("+a+" === null && "+b+" === null) ? 0 :("+a+" === null ? Number.POSITIVE_INFINITY : ("+b+" === null ? Number.NEGATIVE_INFINITY : "+a+" - "+b+"));"}else{if(type=="numeric"&&direction=="desc"){return"("+a+" === null && "+b+" === null) ? 0 :("+a+" === null ? Number.POSITIVE_INFINITY : ("+b+" === null ? Number.NEGATIVE_INFINITY : "+b+" - "+a+"));"}}}}}function makeSortText(i){return"((a["+i+"] < b["+i+"]) ? -1 : ((a["+i+"] > b["+i+"]) ? 1 : 0));"}function makeSortTextDesc(i){return"((b["+i+"] < a["+i+"]) ? -1 : ((b["+i+"] > a["+i+"]) ? 1 : 0));"}function makeSortNumeric(i){return"a["+i+"]-b["+i+"];"}function makeSortNumericDesc(i){return"b["+i+"]-a["+i+"];"}function sortText(a,b){if(table.config.sortLocaleCompare){return a.localeCompare(b)}return((a<b)?-1:((a>b)?1:0))}function sortTextDesc(a,b){if(table.config.sortLocaleCompare){return b.localeCompare(a)}return((b<a)?-1:((b>a)?1:0))}function sortNumeric(a,b){return a-b}function sortNumericDesc(a,b){return b-a}function getCachedSortType(parsers,i){return parsers[i].type}this.construct=function(settings){return this.each(function(){if(!this.tHead||!this.tBodies){return}var $this,$document,$headers,cache,config,shiftDown=0,sortOrder;this.config={};config=$.extend(this.config,$.tablesorter.defaults,settings);$this=$(this);$.data(this,"tablesorter",config);$headers=buildHeaders(this);this.config.parsers=buildParserCache(this,$headers);cache=buildCache(this);var sortCSS=[config.cssDesc,config.cssAsc];fixColumnWidth(this);$headers.click(function(e){var totalRows=($this[0].tBodies[0]&&$this[0].tBodies[0].rows.length)||0;if(!this.sortDisabled&&totalRows>0){$this.trigger("sortStart");var $cell=$(this);var i=this.column;this.order=this.count++%2;if(this.lockedOrder){this.order=this.lockedOrder}if(!e[config.sortMultiSortKey]){config.sortList=[];if(config.sortForce!=null){var a=config.sortForce;for(var j=0;j<a.length;j++){if(a[j][0]!=i){config.sortList.push(a[j])}}}config.sortList.push([i,this.order])}else{if(isValueInArray(i,config.sortList)){for(var j=0;j<config.sortList.length;j++){var s=config.sortList[j],o=config.headerList[s[0]];if(s[0]==i){o.count=s[1];o.count++;s[1]=o.count%2}}}else{config.sortList.push([i,this.order])}}setTimeout(function(){setHeadersCss($this[0],$headers,config.sortList,sortCSS);appendToTable($this[0],multisort($this[0],config.sortList,cache))},1);return false}}).mousedown(function(){if(config.cancelSelection){this.onselectstart=function(){return false};return false}});$this.bind("update",function(){var me=this;setTimeout(function(){me.config.parsers=buildParserCache(me,$headers);cache=buildCache(me)},1)}).bind("updateCell",function(e,cell){var config=this.config;var pos=[(cell.parentNode.rowIndex-1),cell.cellIndex];cache.normalized[pos[0]][pos[1]]=config.parsers[pos[1]].format(getElementText(config,cell),cell)}).bind("sorton",function(e,list){$(this).trigger("sortStart");config.sortList=list;var sortList=config.sortList;updateHeaderSortCount(this,sortList);setHeadersCss(this,$headers,sortList,sortCSS);appendToTable(this,multisort(this,sortList,cache))}).bind("appendCache",function(){appendToTable(this,cache)}).bind("applyWidgetId",function(e,id){getWidgetById(id).format(this)}).bind("applyWidgets",function(){applyWidget(this)});if($.metadata&&($(this).metadata()&&$(this).metadata().sortlist)){config.sortList=$(this).metadata().sortlist}if(config.sortList.length>0){$this.trigger("sorton",[config.sortList])}applyWidget(this)})};this.addParser=function(parser){var l=parsers.length,a=true;for(var i=0;i<l;i++){if(parsers[i].id.toLowerCase()==parser.id.toLowerCase()){a=false}}if(a){parsers.push(parser)}};this.addWidget=function(widget){widgets.push(widget)};this.formatFloat=function(s){var i=parseFloat(s);return(isNaN(i))?0:i};this.formatInt=function(s){var i=parseInt(s);return(isNaN(i))?0:i};this.isDigit=function(s,config){return/^[-+]?\d*$/.test($.trim(s.replace(/[,.']/g,"")))};this.clearTableBody=function(table){if($.browser.msie){function empty(){while(this.firstChild){this.removeChild(this.firstChild)}}empty.apply(table.tBodies[0])}else{table.tBodies[0].innerHTML=""}}}});$.fn.extend({tablesorter:$.tablesorter.construct});var ts=$.tablesorter;ts.addParser({id:"text",is:function(s){return true},format:function(s){return $.trim(s.toLocaleLowerCase())},type:"text"});ts.addParser({id:"digit",is:function(s,table){var c=table.config;return $.tablesorter.isDigit(s,c)},format:function(s){return $.tablesorter.formatFloat(s)},type:"numeric"});ts.addParser({id:"currency",is:function(s){return/^[$?.]/.test(s)},format:function(s){return $.tablesorter.formatFloat(s.replace(new RegExp(/[$]/g),""))},type:"numeric"});ts.addParser({id:"ipAddress",is:function(s){return/^\d{2,3}[\.]\d{2,3}[\.]\d{2,3}[\.]\d{2,3}$/.test(s)},format:function(s){var a=s.split("."),r="",l=a.length;for(var i=0;i<l;i++){var item=a[i];if(item.length==2){r+="0"+item}else{r+=item}}return $.tablesorter.formatFloat(r)},type:"numeric"});ts.addParser({id:"url",is:function(s){return/^(https?|ftp|file):\/\/$/.test(s)},format:function(s){return jQuery.trim(s.replace(new RegExp(/(https?|ftp|file):\/\//),""))},type:"text"});ts.addParser({id:"isoDate",is:function(s){return/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/.test(s)},format:function(s){return $.tablesorter.formatFloat((s!="")?new Date(s.replace(new RegExp(/-/g),"/")).getTime():"0")},type:"numeric"});ts.addParser({id:"percent",is:function(s){return/\%$/.test($.trim(s))},format:function(s){return $.tablesorter.formatFloat(s.replace(new RegExp(/%/g),""))},type:"numeric"});ts.addParser({id:"usLongDate",is:function(s){return s.match(new RegExp(/^[A-Za-z]{3,10}\.? [0-9]{1,2}, ([0-9]{4}|'?[0-9]{2}) (([0-2]?[0-9]:[0-5][0-9])|([0-1]?[0-9]:[0-5][0-9]\s(AM|PM)))$/))},format:function(s){return $.tablesorter.formatFloat(new Date(s).getTime())},type:"numeric"});ts.addParser({id:"shortDate",is:function(s){return/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/.test(s)},format:function(s,table){var c=table.config;s=s.replace(/\-/g,"/");if(c.dateFormat=="us"){s=s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/,"$3/$1/$2")}else{if(c.dateFormat=="pt"){s=s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/,"$3/$2/$1")}else{if(c.dateFormat=="uk"){s=s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/,"$3/$2/$1")}else{if(c.dateFormat=="dd/mm/yy"||c.dateFormat=="dd-mm-yy"){s=s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})/,"$1/$2/$3")}}}}return $.tablesorter.formatFloat(new Date(s).getTime())},type:"numeric"});ts.addParser({id:"time",is:function(s){return/^(([0-2]?[0-9]:[0-5][0-9])|([0-1]?[0-9]:[0-5][0-9]\s(am|pm)))$/.test(s)},format:function(s){return $.tablesorter.formatFloat(new Date("2000/01/01 "+s).getTime())},type:"numeric"});ts.addParser({id:"metadata",is:function(s){return false},format:function(s,table,cell){var c=table.config,p=(!c.parserMetadataName)?"sortValue":c.parserMetadataName;return $(cell).metadata()[p]},type:"numeric"});ts.addWidget({id:"zebra",format:function(table){if(table.config.debug){var time=new Date()}var $tr,row=-1,odd;$("tr:visible",table.tBodies[0]).each(function(i){$tr=$(this);if(!$tr.hasClass(table.config.cssChildRow)){row++}odd=(row%2==0);$tr.removeClass(table.config.widgetZebra.css[odd?0:1]).addClass(table.config.widgetZebra.css[odd?1:0])});if(table.config.debug){$.tablesorter.benchmark("Applying Zebra widget",time)}}})})(jQuery);function SpaceCalculatorForContainerLocation(a){this.$btn=a.find(".show-space-calculator-btn");this.$linkerWrapper=this.$btn.closest(".linker-wrapper");this.$linker=this.$linkerWrapper.find(".linker");this.setupEvents()}SpaceCalculatorForContainerLocation.prototype.setupEvents=function(){var a=this;a.$btn.on("click",function(b){new SpaceCalculatorModal({modalInitialContent:a.$btn.data("modal-content"),url:a.$btn.data("calculator-url"),selectable:true,containerProfile:a.getContainerProfileURI(),onSelect:function(c){$(".token-input-delete-token",a.$linkerWrapper).each(function(){$(this).triggerHandler("click")});var e=c.find("#tabledSearchResults :input:checked:first");var d=e.data("object")._resolved;a.$linker.tokenInput("add",{id:e.val(),name:d.title,json:d});a.$linker.triggerHandler("change")}})})};SpaceCalculatorForContainerLocation.prototype.getContainerProfileURI=function(){return $(document).find("[name='top_container[container_profile][ref]']").val()};function SpaceCalculatorForButton(a){a.on("click",function(b){b.preventDefault();new SpaceCalculatorModal({modalInitialContent:a.data("modal-content"),url:a.data("calculator-url"),selectable:a.data("selectable"),containerProfile:a.data("container-profile-uri")})})}function SpaceCalculatorModal(b){var a=this;a.options=b;a.$modal=AS.openCustomModal("spaceCalculatorModal",null,"<div class='alert alert-info'>"+a.options.modalInitialContent+"</div>","large",{},this);$.ajax({url:a.options.url,type:"GET",data:{container_profile_ref:a.options.containerProfile,selectable:a.options.selectable},success:function(c){$(".alert",a.$modal).replaceWith(c);a.setupForm(a.$modal.find("form"));$(window).trigger("resize")},error:function(c,e,d){$(".alert",a.$modal).replaceWith(AS.renderTemplate("modal_quick_template",{message:c.responseText}));$(window).trigger("resize")}})}SpaceCalculatorModal.prototype.setupForm=function(b){var a=this;a.$results=a.$modal.find("#spaceCalculatorResults");a.$modal.find(".linker").linker();a.setupByBuildingSearch();a.$modal.find("#addSelectedButton").attr("disabled","disabled");b.ajaxForm({beforeSubmit:function(){a.$modal.find("#addSelectedButton").attr("disabled","disabled");a.$results.html(AS.renderTemplate("spaceCalculatorLoadingTemplate"))},success:function(c){a.$modal.find("#spaceCalculatorResults").html(c);a.setupResults();a.setupResultsFilter();a.setupResultsToggles()}});a.$modal.find("#byBuilding").on("hide.bs.collapse",function(){a.$modal.find("#byBuilding :input").prop("disabled",true)}).on("show.bs.collapse",function(){a.$modal.find("#byBuilding :input").prop("disabled",false)});a.$modal.find("#byLocation").on("hide.bs.collapse",function(){a.$modal.find("#byLocation :input").prop("disabled",true)}).on("show.bs.collapse",function(){a.$modal.find("#byLocation :input").prop("disabled",false)})};SpaceCalculatorModal.prototype.setupByBuildingSearch=function(){var c=this;var b=c.$modal.find("#building");var d=c.$modal.find("#floor");var e=c.$modal.find("#room");var a=c.$modal.find("#area");b.on("change",function(){d.val("").closest(".form-group").hide();e.val("").closest(".form-group").hide();a.val("").closest(".form-group").hide();if(b.val()!=""){var f=AS.building_data[b.val()];if(!$.isEmptyObject(f)){d.empty();d.append($("<option>"));for(var g in f){d.append($("<option>").html(g))}d.closest(".form-group").show()}}});d.on("change",function(){e.val("").closest(".form-group").hide();a.val("").closest(".form-group").hide();if(d.val()!=""){var g=AS.building_data[b.val()][d.val()];if(!$.isEmptyObject(g)){e.empty();e.append($("<option>"));for(var f in g){e.append($("<option>").html(f))}e.closest(".form-group").show()}}});e.on("change",function(){a.val("").closest(".form-group").hide();if(e.val()!=""){var f=AS.building_data[b.val()][d.val()][e.val()];if(f!=null&&f.length>0){a.empty();a.append($("<option>"));for(var g=0;g<f.length;g++){a.append($("<option>").html(f[g]))}a.closest(".form-group").show()}}})};SpaceCalculatorModal.prototype.setupResults=function(){var b=this;$(":input[name=linker-item]",b.$results).each(function(){var e=$(this);e.click(function(f){f.stopPropagation();$("tr.selected",e.closest("table")).removeClass("selected");e.closest("tr").addClass("selected");b.$modal.find("#addSelectedButton").removeAttr("disabled")});$("td",e.closest("tr")).click(function(f){f.preventDefault();e.trigger("click")})});b.$modal.on("click","#addSelectedButton",function(e){b.options.onSelect&&b.options.onSelect(b.$results);b.$modal.modal("hide")});var c=b.$results.find("#tabledSearchResults");var d=c.find("thead tr:first");var a={sortList:[[d.find(".space").index(),0],[d.find(".count").index(),1]],textExtraction:function(e){var f=$(e);if(f.hasClass("space")){return f.hasClass("success")?0:1}else{if(f.hasClass("count")){return f.data("count")}}return f.text().trim()}};if(b.$results.find(".col.selectable:first")){a.header={"0":false}}c.tablesorter(a)};SpaceCalculatorModal.prototype.setupResultsFilter=function(){var a=this;var d=a.$results.find("#searchResultsFilter");var b;function c(){var e=d.val().match(/\w+|"[^"]+"/g)||[];a.$results.find("#tabledSearchResults tbody tr").each(function(){var j=$(this);var k=j.text();var g=true;for(var h=0;h<e.length;h++){var f=e[h].replace(/\"/g,"");if(f===""){continue}if(!(new RegExp(f,"i")).test(k)){g=false;break}}if(g){j.removeClass("filtered-by-search")}else{j.addClass("filtered-by-search")}})}d.on("keyup",function(){clearTimeout(b);b=setTimeout(c,200)})};SpaceCalculatorModal.prototype.setupResultsToggles=function(){var a=this;var b=a.$results.find(".space-calculator-results-toggle");b.each(function(){var c=$(this);if(c.is(":disabled")){c.closest(".btn").addClass("disabled")}});b.on("click",function(){var c=$(this);var d=a.$results.find(c.data("target-selector"));if(c.is(":checked")){d.removeClass("filtered-by-toggle")}else{d.addClass("filtered-by-toggle")}})};$(document).bind("subrecordcreated.aspace",function(c,a,b){if(a=="container_location"){new SpaceCalculatorForContainerLocation(b)}});$(function(){var a=function(b){if($(":input[id*='_instance_type_']",b).val()!="digital_object"){AS.initSubRecordCollapsible(b.find(".subrecord-form-fields:first"),function(){var c={instance_type:$(":input[id*='instance_type']:first :selected",b).text(),type_1:$(":input[id*='type_1']:first :selected",b).text(),indicator_1:$(":input[id*='indicator_1']:first",b).val(),type_2:$(":input[id*='type_2']:first :selected",b).text(),indicator_2:$(":input[id*='indicator_2']:first",b).val()};return AS.renderTemplate("template_instance_summary",c)})}};$(document).bind("subrecordcreaterequest.aspace",function(g,c,b,e,d,h){if(c==="instance"){var f;if(b.instanceType==="digital-instance"){f=$(AS.renderTemplate("template_instance_digital_object",e))}else{f=$(AS.renderTemplate("template_instance_container",e));f.data("collapsed",false)}h(f,d)}return true});$(document).bind("subrecordcreated.aspace",function(d,b,c){if(b==="instance"){a($(c))}})});(function(){$(document).bind("subrecordcreated.aspace",function(c,a,b){if(a==="deaccession"){$(document).triggerHandler("subrecordcreated.aspace",["date",$("#deaccession_date .subrecord-form-fields:first",b)])}})})();$(function(){$.fn.init_archival_object_form=function(){$(this).each(function(){var d=$(this);if(d.hasClass("initialised")){return}var b=$("#archival_object_level_",d);var c=$("#archival_object_other_level_",d);var a=function(e){if(b.val()==="otherlevel"){c.removeAttr("disabled");if(e===true){c.closest(".form-group").show()}else{c.closest(".form-group").slideDown()}}else{c.attr("disabled","disabled");if(e===true){c.closest(".form-group").hide()}else{c.closest(".form-group").slideUp()}}};a(true);b.change(a)})};$(document).bind("loadedrecordform.aspace",function(a,b){$("#archival_object_form:not(.initialised)",b).init_archival_object_form()});$("#archival_object_form:not(.initialised)").init_archival_object_form()});(function(b){b.fn.drag=function(i,j,k){if(j){this.bind("dragstart",i)}if(k){this.bind("dragend",k)}return !i?this.trigger("drag"):this.bind("drag",j?j:i)};var f=b.event,h=f.special,d=h.drag={not:":input",distance:0,which:1,setup:function(i){i=b.extend({distance:d.distance,which:d.which,not:d.not},i||{});i.distance=c(i.distance);f.add(this,"mousedown",e,i)},teardown:function(){f.remove(this,"mousedown",e);if(this===d.dragging){d.dragging=d.proxy=null}g(this,true)}};function e(j){var k=this,l,i=j.data||{};if(i.elem){k=j.dragTarget=i.elem;j.dragProxy=d.proxy||k;j.cursorOffsetX=i.pageX-i.left;j.cursorOffsetY=i.pageY-i.top;j.offsetX=j.pageX-j.cursorOffsetX;j.offsetY=j.pageY-j.cursorOffsetY}else{if(d.dragging||(i.which>0&&j.which!=i.which)||b(j.target).is(i.not)){return}}switch(j.type){case"mousedown":b.extend(i,b(k).offset(),{elem:k,target:j.target,pageX:j.pageX,pageY:j.pageY});f.add(document,"mousemove mouseup",e,i);g(k,false);return false;case !d.dragging&&"mousemove":if(c(j.pageX-i.pageX)+c(j.pageY-i.pageY)<i.distance){break}j.target=i.target;l=a(j,"dragstart",k);if(l!==false){d.dragging=k;d.proxy=j.dragProxy=b(l||k)[0]}case"mousemove":if(d.dragging){l=a(j,"drag",k);if(h.drop){h.drop.allowed=(l!==false);h.drop.handler(j)}if(l!==false){break}j.type="mouseup"}case"mouseup":f.remove(document,"mousemove mouseup",e);if(d.dragging){if(h.drop){h.drop.handler(j)}a(j,"dragend",k)}g(k,true);d.dragging=d.proxy=i.elem=null;break}}function a(i,k,j){i.type=k;var l=f.dispatch.call(j,i);return l===false?false:l||i.result}function c(i){return Math.pow(i,2)}function g(i,j){if(!i){return}i.unselectable=j?"off":"on";i.onselectstart=function(){return j};if(document.selection&&document.selection.empty){document.selection.empty()}if(i.style){i.style.MozUserSelect=j?"":"none"}}})(jQuery);(function(a){a.fn.kiketable_colsizable=function(b){b=a.extend({},a.fn.kiketable_colsizable.defaults,b);b.dragProxy=(b.dragProxy==="line")?false:true;this.filter("table:not(."+b.namespace+")").addClass(b.namespace).each(function(e){b.renderTime=new Date().getTime();var c=this,f=a(this),d=c.getElementsByTagName("col");d.length&&a(b.dragCells,this).each(function(g){if(!a(this).hasClass("kiketable-th")){a(this).addClass("kiketable-th").wrapInner('<div class="kiketable-th-text"></div>')}a('<div class="'+b.classHandler+'" title="'+b.title+'"></div>').prependTo(this).each(function(){this.td=this.parentNode;this.$td=a(this.td);this.col=d[this.td.cellIndex]}).dblclick(function(){if(this.wtd==null){this.wtd=this.col.offsetWidth;this.wtd0=this.wtd}var h=this.wtd==b.minWidth;this.wtd=(h)?this.wtd0:b.minWidth;this.col.style.width=this.wtd+"px";if(!b.fixWidth){var i=this.wtd0-b.minWidth;c.style.width=f.width()+((h)?i:-i)+"px"}a(this).trigger("minimized")}).bind("dragstart",function(h){this.cell_width=this.$td.width();this.table_width=f.width();this.left0=h.offsetX;this.d1=this.cell_width-this.left0;this.d2=b.minWidth-this.d1;return a(this).clone().appendTo(this.td).css("opacity",b.dragOpacity).css((b.dragProxy)?{top:this.$td.offset().top,left:this.$td.offset().left,width:this.cell_width}:{top:this.$td.offset().top,left:h.offsetX}).removeClass(b.classHandler).addClass((b.dragProxy)?b.classDragArea:b.classDragLine).height(f.height())}).bind("drag",(b.dragMove||b.dragProxy)?function(i){var h=i.offsetX+this.d1;if(h-this.d2-this.d1>=0){i.dragProxy.style.width=h+"px";if(b.dragMove){this.col.style.width=h+"px";if(!b.fixWidth){c.style.width=(this.table_width-this.cell_width+h)+"px"}}}}:function(i){var h=i.offsetX;if(h-this.d2>=0){i.dragProxy.style.left=h+"px"}}).bind("dragend",function(h){if(!b.dragMove){var i=parseInt(h.dragProxy.style.left)-this.left0;this.col.style.width=(b.dragProxy)?h.dragProxy.style.width:(this.cell_width+i)+"px";if(!b.fixWidth){c.style.width=((b.dragProxy)?this.table_width-this.cell_width+parseInt(h.dragProxy.style.width):this.table_width+i)+"px"}}a(h.dragProxy)[b.fxHide](b.fxSpeed,function(){a(this).remove()});a(this).trigger("minimized")}).bind("minimized",function(h){a(this.col)[(parseInt(this.col.style.width)<=b.minWidth)?"addClass":"removeClass"](b.classMinimized)})});b.renderTime=new Date().getTime()-b.renderTime;b.onLoad()});return this};a.fn.kiketable_colsizable.defaults={dragCells:"tr:first > *",dragMove:true,dragProxy:"line",dragOpacity:0.3,minWidth:8,fixWidth:false,fxHide:"fadeOut",fxSpeed:200,namespace:"kiketable-colsizable",classHandler:"kiketable-colsizable-handler",classDragLine:"kiketable-colsizable-dragLine",classDragArea:"kiketable-colsizable-dragArea",classMinimized:"kiketable-colsizable-minimized",title:"Expand/Collapse this column",renderTime:0,onLoad:function(){}}})(jQuery);(function(c){var d={listTargetID:null,onClass:"",offClass:"",hideInList:[],colsHidden:[],saveState:false,onToggle:null,show:function(k){a(k)},hide:function(k){b(k)}};var e=0;var h="columnManagerC";var g=function(n){var m="",k=0,l=n.cMColsVisible;if(n.cMSaveState&&n.id&&l&&c.cookie){for(;k<l.length;k++){m+=(l[k]==false)?0:1}c.cookie(h+n.id,m,{expires:9999})}};var b=function(k){if(jQuery.browser.msie){(b=function(l){l.style.setAttribute("display","none")})(k)}else{(b=function(l){l.style.display="none"})(k)}};var a=function(k){if(jQuery.browser.msie){(a=function(l){l.style.setAttribute("display","block")})(k)}else{(a=function(l){l.style.display="table-cell"})(k)}};var i=function(k){if(jQuery.browser.msie){return(i=function(l){return l.style.getAttribute("display")!="none"})(k)}else{return(i=function(l){return l.style.display!="none"})(k)}};var f=function(m,k,l){for(var n=0;n<k.length;n++){if(k[n].realIndex===undefined){j(m)}if(k[n].realIndex==l){return k[n]}}return null};var j=function(m){var k=m.rows;var s=k.length;var n=[];for(var u=0;u<s;u++){var l=k[u].cells;var o=l.length;for(var v=0;v<o;v++){var p=l[v];var q=p.rowSpan||1;var t=p.colSpan||1;var r=-1;if(!n[u]){n[u]=[]}var y=n[u];while(y[++r]){}p.realIndex=r;for(var w=u;w<u+q;w++){if(!n[w]){n[w]=[]}var z=n[w];for(var x=r;x<r+t;x++){z[x]=1}}}}};c.fn.columnManager=function(n){var m=c.extend({},d,n);var o=function(q){if(!m.listTargetID){return}var y=c("#"+m.listTargetID);if(!y.length){return}var r=null;if(q.tHead&&q.tHead.length){r=q.tHead.rows[0]}else{if(q.rows.length){r=q.rows[0]}else{return}}var p=r.cells;if(!p.length){return}var w=null;if(y.get(0).nodeName.toUpperCase()=="UL"){w=y}else{w=c("<ul></ul>");y.append(w)}var u=q.cMColsVisible;for(var x=0;x<p.length;x++){if(c.inArray(x+1,m.hideInList)>=0){continue}u[x]=(u[x]!==undefined)?u[x]:true;var s=c(p[x]).text(),v;if(!s.length){s=c(p[x]).html();if(!s.length){s="undefined"}}if(u[x]&&m.onClass){v=m.onClass}else{if(!u[x]&&m.offClass){v=m.offClass}}var t=c('<li class="'+v+'">'+s+"</li>").click(k);t[0].cmData={id:q.id,col:x};w.append(t)}q.cMColsVisible=u};var k=function(){var p=this.cmData;if(p&&p.id&&p.col>=0){var r=p.col,q=c("#"+p.id);if(q.length){q.toggleColumns([r+1],m);var s=q.get(0).cMColsVisible;if(m.onToggle){m.onToggle.apply(q.get(0),[r+1,s[r]])}}}};var l=function(q){var p=c.cookie(h+q);if(p){var s=p.split("");for(var r=0;r<s.length;r++){s[r]&=1}return s}return false};return this.each(function(){this.id=this.id||"jQcM0O"+e++;var q,r=[],s=[];j(this);if(m.colsHidden.length){for(q=0;q<m.colsHidden.length;q++){s[m.colsHidden[q]-1]=true;r[m.colsHidden[q]-1]=true}}if(m.saveState){var p=l(this.id);if(p&&p.length){for(q=0;q<p.length;q++){s[q]=true;r[q]=!p[q]}}this.cMSaveState=true}this.cMColsVisible=s;if(r.length){var t=[];for(q=0;q<r.length;q++){if(r[q]){t[t.length]=q+1}}if(t.length){c(this).toggleColumns(t)}}o(this)})};c.fn.toggleColumns=function(l,k){return this.each(function(){var v,u,s,m=this.rows,t=this.cMColsVisible;if(!l){return}if(l.constructor==Number){l=[l]}if(!t){t=this.cMColsVisible=[]}for(v=0;v<m.length;v++){var n=m[v].cells;for(var w=0;w<l.length;w++){var y=l[w]-1;if(y>=0){var q=f(this,n,y);if(!q){var x=y;while(x>0&&!(q=f(this,n,--x))){}if(!q){continue}}if(t[y]==undefined){t[y]=true}if(t[y]){u=k&&k.hide?k.hide:b;s=-1}else{u=k&&k.show?k.show:a;s=1}if(!q.chSpan){q.chSpan=0}if(q.colSpan>1||(s==1&&q.chSpan&&i(q))){if(q.realIndex+q.colSpan+q.chSpan-1<y){continue}q.colSpan+=s;q.chSpan+=s*-1}else{if(q.realIndex+q.chSpan<y){continue}else{u(q)}}}}}for(v=0;v<l.length;v++){this.cMColsVisible[l[v]-1]=!t[l[v]-1];if(k&&k.listTargetID&&(k.onClass||k.offClass)){var o=k.onClass,p=k.offClass,r;if(t[l[v]-1]){o=p;p=k.onClass}r=c("#"+k.listTargetID+" li").filter(function(){return this.cmData&&this.cmData.col==l[v]-1});if(o){r.removeClass(o)}if(p){r.addClass(p)}}}g(this)})};c.fn.showColumns=function(l,k){return this.each(function(){var n,m=[],o=this.cMColsVisible;if(o){if(l&&l.constructor==Number){l=[l]}for(n=0;n<o.length;n++){if(!o[n]&&(!l||c.inArray(n+1,l)>-1)){m.push(n+1)}}c(this).toggleColumns(m,k)}})};c.fn.hideColumns=function(l,k){return this.each(function(){var n,m=l,o=this.cMColsVisible;if(o){if(l.constructor==Number){l=[l]}m=[];for(n=0;n<l.length;n++){if(o[l[n]-1]||o[l[n]-1]==undefined){m.push(l[n])}}}c(this).toggleColumns(m,k)})}})(jQuery);!function(b){if(typeof ko!=="undefined"&&ko.bindingHandlers&&!ko.bindingHandlers.multiselect){ko.bindingHandlers.multiselect={init:function(e,f,g,d,c){},update:function(h,i,j,g,c){var f=ko.utils.unwrapObservable(i());var d=j().options();var e=b(h).data("multiselect");if(!e){b(h).multiselect(f)}else{e.updateOriginalOptions();if(d&&d.length!==e.originalOptions.length){b(h).multiselect("rebuild")}}}}}function a(c,d){this.options=this.mergeOptions(d);this.$select=b(c);this.originalOptions=this.$select.clone()[0].options;this.query="";this.searchTimeout=null;this.options.multiple=this.$select.attr("multiple")==="multiple";this.options.onChange=b.proxy(this.options.onChange,this);this.options.onDropdownShow=b.proxy(this.options.onDropdownShow,this);this.options.onDropdownHide=b.proxy(this.options.onDropdownHide,this);this.buildContainer();this.buildButton();this.buildSelectAll();this.buildDropdown();this.buildDropdownOptions();this.buildFilter();this.updateButtonText();this.$select.hide().after(this.$container)}a.prototype={defaults:{buttonText:function(d,c){if(d.length===0){return this.nonSelectedText+' <b class="caret"></b>'}else{if(d.length>this.numberDisplayed){return d.length+" "+this.nSelectedText+' <b class="caret"></b>'}else{var e="";d.each(function(){var f=(b(this).attr("label")!==undefined)?b(this).attr("label"):b(this).html();e+=f+", "});return e.substr(0,e.length-2)+' <b class="caret"></b>'}}},buttonTitle:function(d,c){if(d.length===0){return this.nonSelectedText}else{var e="";d.each(function(){e+=b(this).text()+", "});return e.substr(0,e.length-2)}},label:function(c){return b(c).attr("label")||b(c).html()},onChange:function(c,d){},onDropdownShow:function(c){},onDropdownHide:function(c){},buttonClass:"btn btn-default",dropRight:false,selectedClass:"active",buttonWidth:"auto",buttonContainer:'<div class="btn-group" />',maxHeight:false,includeSelectAllOption:false,selectAllText:" Select all",selectAllValue:"multiselect-all",enableFiltering:false,enableCaseInsensitiveFiltering:false,filterPlaceholder:"Search",filterBehavior:"text",preventInputChangeEvent:false,nonSelectedText:"None selected",nSelectedText:"selected",numberDisplayed:3},templates:{button:'<button type="button" class="multiselect dropdown-toggle" data-toggle="dropdown"></button>',ul:'<ul class="multiselect-container dropdown-menu"></ul>',filter:'<div class="input-group"><span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span><input class="form-control multiselect-search" type="text"></div>',li:'<li><a href="javascript:void(0);"><label></label></a></li>',liGroup:'<li><label class="multiselect-group"></label></li>'},constructor:a,buildContainer:function(){this.$container=b(this.options.buttonContainer);this.$container.on("show.bs.dropdown",this.options.onDropdownShow);this.$container.on("hide.bs.dropdown",this.options.onDropdownHide)},buildButton:function(){this.$button=b(this.templates.button).addClass(this.options.buttonClass);if(this.$select.prop("disabled")){this.disable()}else{this.enable()}if(this.options.buttonWidth){this.$button.css({width:this.options.buttonWidth})}var c=this.$select.attr("tabindex");if(c){this.$button.attr("tabindex",c)}this.$container.prepend(this.$button)},buildDropdown:function(){this.$ul=b(this.templates.ul);if(this.options.dropRight){this.$ul.addClass("pull-right")}if(this.options.maxHeight){this.$ul.css({"max-height":this.options.maxHeight+"px","overflow-y":"auto","overflow-x":"hidden"})}this.$container.append(this.$ul)},buildDropdownOptions:function(){this.$select.children().each(b.proxy(function(d,e){var c=b(e).prop("tagName").toLowerCase();if(c==="optgroup"){this.createOptgroup(e)}else{if(c==="option"){this.createOptionValue(e)}}},this));b("li input",this.$ul).on("change",b.proxy(function(d){var j=b(d.target).prop("checked")||false;var k=b(d.target).val()===this.options.selectAllValue;if(this.options.selectedClass){if(j){b(d.target).parents("li").addClass(this.options.selectedClass)}else{b(d.target).parents("li").removeClass(this.options.selectedClass)}}var h=b(d.target).val();var c=this.getOptionByValue(h);var g=b("option",this.$select).not(c);var f=b("input",this.$container).not(b(d.target));if(k){if(this.$select[0][0].value===this.options.selectAllValue){var l=[];var m=b('option[value!="'+this.options.selectAllValue+'"]',this.$select);for(var e=0;e<m.length;e++){if(m[e].value!==this.options.selectAllValue&&this.getInputByValue(m[e].value).is(":visible")){l.push(m[e].value)}}if(j){this.select(l)}else{this.deselect(l)}}}if(j){c.prop("selected",true);if(this.options.multiple){c.prop("selected",true)}else{if(this.options.selectedClass){b(f).parents("li").removeClass(this.options.selectedClass)}b(f).prop("checked",false);g.prop("selected",false);this.$button.click()}if(this.options.selectedClass==="active"){g.parents("a").css("outline","")}}else{c.prop("selected",false)}this.$select.change();this.options.onChange(c,j);this.updateButtonText();if(this.options.preventInputChangeEvent){return false}},this));b("li a",this.$ul).on("touchstart click",function(g){g.stopPropagation();if(g.shiftKey){var f=b(g.target).prop("checked")||false;if(f){var e=b(g.target).parents("li:last").siblings('li[class="active"]:first');var d=b(g.target).parents("li").index();var c=e.index();if(d>c){b(g.target).parents("li:last").prevUntil(e).each(function(){b(this).find("input:first").prop("checked",true).trigger("change")})}else{b(g.target).parents("li:last").nextUntil(e).each(function(){b(this).find("input:first").prop("checked",true).trigger("change")})}}}b(g.target).blur()});this.$container.on("keydown",b.proxy(function(f){if(b('input[type="text"]',this.$container).is(":focus")){return}if((f.keyCode===9||f.keyCode===27)&&this.$container.hasClass("open")){this.$button.click()}else{var g=b(this.$container).find("li:not(.divider):visible a");if(!g.length){return}var c=g.index(g.filter(":focus"));if(f.keyCode===38&&c>0){c--}else{if(f.keyCode===40&&c<g.length-1){c++}else{if(!~c){c=0}}}var e=g.eq(c);e.focus();if(f.keyCode===32||f.keyCode===13){var d=e.find("input");d.prop("checked",!d.prop("checked"));d.change()}f.stopPropagation();f.preventDefault()}},this))},createOptionValue:function(d){if(b(d).is(":selected")){b(d).prop("selected",true)}var c=this.options.label(d);var h=b(d).val();var g=this.options.multiple?"checkbox":"radio";var i=b(this.templates.li);b("label",i).addClass(g);b("label",i).append('<input type="'+g+'" />');var f=b(d).prop("selected")||false;var e=b("input",i);e.val(h);if(h===this.options.selectAllValue){e.parent().parent().addClass("multiselect-all")}b("label",i).append(" "+c);this.$ul.append(i);if(b(d).is(":disabled")){e.attr("disabled","disabled").prop("disabled",true).parents("li").addClass("disabled")}e.prop("checked",f);if(f&&this.options.selectedClass){e.parents("li").addClass(this.options.selectedClass)}},createOptgroup:function(c){var e=b(c).prop("label");var d=b(this.templates.liGroup);b("label",d).text(e);this.$ul.append(d);b("option",c).each(b.proxy(function(f,g){this.createOptionValue(g)},this))},buildSelectAll:function(){var c=this.$select[0][0]?this.$select[0][0].value===this.options.selectAllValue:false;if(this.options.includeSelectAllOption&&this.options.multiple&&!c){this.$select.prepend('<option value="'+this.options.selectAllValue+'">'+this.options.selectAllText+"</option>")}},buildFilter:function(){if(this.options.enableFiltering||this.options.enableCaseInsensitiveFiltering){var c=Math.max(this.options.enableFiltering,this.options.enableCaseInsensitiveFiltering);if(this.$select.find("option").length>=c){this.$filter=b(this.templates.filter);b("input",this.$filter).attr("placeholder",this.options.filterPlaceholder);this.$ul.prepend(this.$filter);this.$filter.val(this.query).on("click",function(d){d.stopPropagation()}).on("keydown",b.proxy(function(d){clearTimeout(this.searchTimeout);this.searchTimeout=this.asyncFunction(b.proxy(function(){if(this.query!==d.target.value){this.query=d.target.value;b.each(b("li",this.$ul),b.proxy(function(f,g){var i=b("input",g).val();var j=b("label",g).text();if(i!==this.options.selectAllValue&&j){var h=false;var e="";if((this.options.filterBehavior==="text"||this.options.filterBehavior==="both")){e=j}if((this.options.filterBehavior==="value"||this.options.filterBehavior==="both")){e=i}if(this.options.enableCaseInsensitiveFiltering&&e.toLowerCase().indexOf(this.query.toLowerCase())>-1){h=true}else{if(e.indexOf(this.query)>-1){h=true}}if(h){b(g).show()}else{b(g).hide()}}},this))}},this),300,this)},this))}}},destroy:function(){this.$container.remove();this.$select.show()},refresh:function(){b("option",this.$select).each(b.proxy(function(c,d){var e=b("li input",this.$ul).filter(function(){return b(this).val()===b(d).val()});if(b(d).is(":selected")){e.prop("checked",true);if(this.options.selectedClass){e.parents("li").addClass(this.options.selectedClass)}}else{e.prop("checked",false);if(this.options.selectedClass){e.parents("li").removeClass(this.options.selectedClass)}}if(b(d).is(":disabled")){e.attr("disabled","disabled").prop("disabled",true).parents("li").addClass("disabled")}else{e.prop("disabled",false).parents("li").removeClass("disabled")}},this));this.updateButtonText()},select:function(g){if(g&&!b.isArray(g)){g=[g]}for(var c=0;c<g.length;c++){var e=g[c];var f=this.getOptionByValue(e);var d=this.getInputByValue(e);if(this.options.selectedClass){d.parents("li").addClass(this.options.selectedClass)}d.prop("checked",true);f.prop("selected",true);this.options.onChange(f,true)}this.updateButtonText()},deselect:function(c){if(c&&!b.isArray(c)){c=[c]}for(var d=0;d<c.length;d++){var f=c[d];var g=this.getOptionByValue(f);var e=this.getInputByValue(f);if(this.options.selectedClass){e.parents("li").removeClass(this.options.selectedClass)}e.prop("checked",false);g.prop("selected",false);this.options.onChange(g,false)}this.updateButtonText()},rebuild:function(){this.$ul.html("");b('option[value="'+this.options.selectAllValue+'"]',this.$select).remove();this.options.multiple=this.$select.attr("multiple")==="multiple";this.buildSelectAll();this.buildDropdownOptions();this.updateButtonText();this.buildFilter()},dataprovider:function(c){var d="";c.forEach(function(e){d+='<option value="'+e.value+'">'+e.label+"</option>"});this.$select.html(d);this.rebuild()},enable:function(){this.$select.prop("disabled",false);this.$button.prop("disabled",false).removeClass("disabled")},disable:function(){this.$select.prop("disabled",true);this.$button.prop("disabled",true).addClass("disabled")},setOptions:function(c){this.options=this.mergeOptions(c)},mergeOptions:function(c){return b.extend({},this.defaults,c)},updateButtonText:function(){var c=this.getSelected();b("button",this.$container).html(this.options.buttonText(c,this.$select));b("button",this.$container).attr("title",this.options.buttonTitle(c,this.$select))},getSelected:function(){return b('option[value!="'+this.options.selectAllValue+'"]:selected',this.$select).filter(function(){return b(this).prop("selected")})},getOptionByValue:function(c){return b("option",this.$select).filter(function(){return b(this).val()===c})},getInputByValue:function(c){return b("li input",this.$ul).filter(function(){return b(this).val()===c})},updateOriginalOptions:function(){this.originalOptions=this.$select.clone()[0].options},asyncFunction:function(f,e,c){var d=Array.prototype.slice.call(arguments,3);return setTimeout(function(){f.apply(c||window,d)},e)}};b.fn.multiselect=function(c,d){return this.each(function(){var f=b(this).data("multiselect");var e=typeof c==="object"&&c;if(!f){b(this).data("multiselect",(f=new a(this,e)))}if(typeof c==="string"){f[c](d)}})};b.fn.multiselect.Constructor=a;b(function(){b("select[data-role=multiselect]").multiselect()})}(window.jQuery);$(function(){$.fn.init_rapid_data_entry_form=function(b,a){$(this).each(function(){var v=$(this);var X=$("table#rdeTable",v);if(v.hasClass("initialised")){return}var C="rde."+v.data("cookie-prefix")+".visible";var w="rde."+v.data("cookie-prefix")+".sticky";var Q="rde."+v.data("cookie-prefix")+".widths";var f="rde."+v.data("cookie-prefix")+".order";var x=AS.prefixed_cookie(C)?JSON.parse(AS.prefixed_cookie(C)):null;var s=AS.prefixed_cookie(w)?JSON.parse(AS.prefixed_cookie(w)):null;var r=AS.prefixed_cookie(Q)?JSON.parse(AS.prefixed_cookie(Q)):null;var M=AS.prefixed_cookie(f)?JSON.parse(AS.prefixed_cookie(f)):null;var I={};var c={};$(".sections th",X).each(function(){c[$(this).data("id")]=$(this).text()});var J=false;b.off("click").on("click",".remove-row",function(aa){aa.preventDefault();aa.stopPropagation();var Z=$(aa.target).closest("button");if(Z.hasClass("btn-danger")){Z.closest("tr").remove()}else{Z.addClass("btn-danger");$("span",Z).addClass("icon-white");setTimeout(function(){Z.removeClass("btn-danger");$("span",Z).removeClass("icon-white")},10000)}});b.on("click","#rde_reset",function(Z){Z.preventDefault();Z.stopPropagation();$(":input, .btn",v).attr("disabled","disabled");AS.prefixed_cookie(C,null);AS.prefixed_cookie(Q,null);AS.prefixed_cookie(w,null);AS.prefixed_cookie(f,null);x=null;s=null;r=null;M=null;$(document).triggerHandler("rdeload.aspace",[a,b])});b.on("click",".add-row",function(aa){aa.preventDefault();aa.stopPropagation();var Z=P(aa);$(":input:visible:first",Z).focus();j(Z)});var h=function(){Y=Math.max($("tbody tr",X).length-1,0);$("tbody tr",X).each(function(Z,aa){$(aa).data("index",Z)})};var Y=0;h();var P=function(ab){var aa=$(ab.target).closest("tr");if(aa.length===0){aa=$("table tbody tr:last",v)}Y=Y+1;var Z=$(AS.renderTemplate("template_rde_"+v.data("child-type")+"_row",{path:v.data("jsonmodel-type")+"[children]["+Y+"]",id_path:v.data("jsonmodel-type")+"_children__"+Y+"_",index:Y}));Z.data("index",Y);$(".fieldset-labels th",v).each(function(ad,af){var ae=$(af);if(aa.length>0){if(ae.hasClass("fieldset-label")&&ae.hasClass("sticky")){var ag=$(":input:first",$("td",aa).get(ad));var ac=$(":input:first",$("td",Z).get(ad));if(ag.is(":checkbox")){if(ag.is(":checked")){ac.attr("checked","checked")}else{ac.removeAttr("checked")}}else{ac.val(ag.val())}}else{if(I[ae.attr("id")]){var ac=$(":input:first",$("td",Z).get(ad));ac.val(I[ae.attr("id")])}}}if(ae.hasClass("fieldset-label")&&!i(ae.attr("id"))){$($("td",Z).get(ad)).hide()}if(M!=null){$.each(M,function(ai,aj){var ak=$("td[data-col='"+aj+"']",Z);var ah=ak.index();if(ai!==ah){ak.insertBefore($("td",Z).get(ai))}})}});aa.after(Z);H(Y);return Z};b.off("keydown").on("keydown",function(Z){if(Z.keyCode===27){Z.preventDefault();Z.stopImmediatePropagation()}});b.on("keydown",":input, input[type='text']",function(aa){var Z=$(aa.target).closest("tr");var ab=$(aa.target).closest("td");if(aa.keyCode===13){aa.preventDefault();if(aa.shiftKey){$(".add-row",Z).trigger("click");$(":input:visible:first",$("td",Z.next())[ab.index()]).focus()}}else{if(aa.keyCode===27){aa.preventDefault();aa.stopImmediatePropagation();return true}else{if(aa.keyCode===37){if(aa.shiftKey){aa.preventDefault();$(":input:visible:first",p(ab)).focus()}}else{if(aa.keyCode===40){if(aa.shiftKey){aa.preventDefault();if(Z.index()<Z.siblings().length){$(":input:visible:first",$("td",Z.next())[ab.index()]).focus()}}}else{if(aa.keyCode===38){if(aa.shiftKey){aa.preventDefault();if(Z.index()>0){$(":input:visible:first",$("td",Z.prev())[ab.index()]).focus()}}}else{if(aa.keyCode===39){if(aa.shiftKey){aa.preventDefault();$(":input:visible:first",e(ab)).focus()}}else{}}}}}}});b.on("click","th.fieldset-label",function(Z){$(this).toggleClass("sticky");var aa=[];$("table th.sticky",v).each(function(){aa.push($(this).attr("id"))});s=aa;AS.prefixed_cookie(w,JSON.stringify(s))});b.on("click","[data-dismiss]",function(Z){b.modal("hide")});var z=function(aa,Z){aa.each(function(ad,af){var ac=$(af);var ag=Z[ad];var ab=$(".error-summary",ac);var ae=$(".error-summary-list",ab);ae.empty();if(ag.hasOwnProperty("errors")&&!$.isEmptyObject(ag.errors)){ac.removeClass("valid").addClass("invalid");$.each(ag.errors,function(ak,aj){var al=$("[id='"+v.data("jsonmodel-type")+"_children__"+ac.data("index")+"__"+ak.replace(/\//g,"__")+"_']",ac);var ai=$($(".fieldset-labels th",X).get(al.first().closest("td").index()));al.closest(".form-group").addClass("has-error");var ah=$("<div class='error'>");if(al.length>1||al.hasClass("defer-to-section")){ah.text(c[ai.data("section")])}else{ah.text($($(".fieldset-labels th",X).get(al.closest("td").index())).text())}ah.append(" - ").append(aj);ah.append("<span class='glyphicon glyphicon-chevron-right'>");ae.append(ah);ah.data("target",al.first().attr("id"))});$(".modal-body",b).trigger("scroll")}else{ac.removeClass("invalid").addClass("valid")}})};var T=function(){v.ajaxForm({target:$(".rde-wrapper",b),success:function(){$(window).trigger("resize");v=$("form","#rapidDataEntryModal");X=$("table",v);h();if(v.length){z($("tbody tr",v),v.data("exceptions"));T()}else{setTimeout(function(){location.reload(true)},1000)}}});X.kiketable_colsizable({dragCells:"tr.fieldset-labels th.fieldset-label",dragMove:true});$("th.fieldset-label .kiketable-colsizable-handler",X).on("dragend",U);X.columnManager();$("table thead .fieldset-labels th").each(function(aa,Z){if(!$(Z).attr("id")){$(Z).attr("id","rdecol"+aa)}$($("table colgroup col").get(aa)).data("id",$(Z).attr("id"))});d();t();F();A();L();g();V();y();H()};var y=function(){if($("button.toggle-inline-errors").hasClass("active")){X.addClass("show-inline-errors")}else{X.removeClass("show-inline-errors")}};var H=function(aa){var aa=aa||0;var Z=$("td[data-col='colLevel']:eq("+aa+") select");if(Z.val()==="otherlevel"){l("colOtherLevel",aa)}else{R("colOtherLevel",aa)}Z.change(function(){if($(this).val()==="otherlevel"){l("colOtherLevel",aa)}else{R("colOtherLevel",aa)}})};var d=function(){X.on("change",":input:visible",function(){var Z=$(this).closest("tr");j(Z)});$(".modal-body",b).on("scroll",function(Z){$(".error-summary",X).css("left",$(this)[0].scrollLeft+5)});X.on("focusin click",":input",function(){$(this).closest("tr").addClass("last-focused").siblings().removeClass("last-focused")});X.on("click",".error-summary .error",function(){var Z=$("#"+$(this).data("target"));if(!Z.is("visible")){var aa=M[Z.closest("td").index()];$("#rde_hidden_columns").multiselect("select",aa)}Z.closest("td").ScrollTo({axis:"x",callback:function(){Z.focus()}})});X.on("click","td.status",function(Z){Z.preventDefault();Z.stopPropagation();if($(Z.target).closest(".error-summary").length>0){return}if($(this).closest("tr").hasClass("last-focused")){$("button.toggle-inline-errors").trigger("click")}else{$(this).closest("tr").addClass("last-focused").siblings().removeClass("last-focused")}});X.on("click",".hide-error-summary, .show-error-summary",function(Z){Z.preventDefault();Z.stopPropagation();$("button.toggle-inline-errors").trigger("click")})};var V=function(){var ab=$(".fill-column-form",b);var Z=$("button.fill-column",b);var aa=$("table tbody tr:first",v);Z.click(function(ae){ae.preventDefault();ae.stopPropagation();if(!$(this).hasClass("active")){$(".active",$(this).closest(".btn-group")).trigger("click")}Z.toggleClass("active");ab.slideToggle()});var ad=function(){var ag=$("#fill_basic",ab);var ae=$("#basicFillTargetColumn",ag);var af=$("button",ag);K(ae);ae.change(function(){$(".empty",this).remove();var ah=parseInt($("#"+$(this).val()).index());var ai=$(":input:first",$("td",aa).get(ah)).clone();ai.attr("name","").attr("id","basicFillValue");$(".fill-value-container",ag).html(ai);af.removeAttr("disabled").removeClass("disabled")});af.click(function(aj){aj.preventDefault();aj.stopPropagation();var ah=parseInt($("#"+ae.val()).index())+1;var ak=$("table tbody tr td:nth-child("+ah+")",v);if($("#basicFillValue",ag).is(":checkbox")){var ai=$("#basicFillValue",ag).is(":checked");if(ai){$(":input:first",ak).attr("checked","checked")}else{$(":input:first",ak).removeAttr("checked")}}else{var ai=$("#basicFillValue",ag).val();$(":input:first",ak).val(ai)}Z.toggleClass("active");ab.slideToggle();D()})};var ac=function(){var ag=$("#fill_sequence",ab);var ae=$("#sequenceFillTargetColumn",ag);var af=$("button.btn-primary",ag);var ai=$(".sequence-preview",ag);K(ae,null,function(aj){var ak=$("td",aa).get(aj.index());return $(":input:first",ak).is(":text")});ae.change(function(){$(".empty",this).remove();af.removeAttr("disabled").removeClass("disabled")});$("button.preview-sequence",ag).click(function(aj){aj.preventDefault();aj.stopPropagation();$.getJSON(ag.data("sequence-generator-url"),{prefix:$("#sequenceFillPrefix",ag).val(),from:$("#sequenceFillFrom",ag).val(),to:$("#sequenceFillTo",ag).val(),suffix:$("#sequenceFillSuffix",ag).val(),limit:$("tbody tr",X).length},function(ak){ai.html("");if(ak.errors){$.each(ak.errors,function(an,am){var al=$("<div>").html(am).addClass("text-error");ai.append(al)})}else{ai.html($("<p class='values'>").html(ak.values.join(", ")));ai.prepend($("<p class='summary'>").html(ak.summary))}})});var ah=function(aj){$("#sequenceTooSmallMsg",ag).hide();$.getJSON(ag.data("sequence-generator-url"),{prefix:$("#sequenceFillPrefix",ag).val(),from:$("#sequenceFillFrom",ag).val(),to:$("#sequenceFillTo",ag).val(),suffix:$("#sequenceFillSuffix",ag).val(),limit:$("tbody tr",X).length},function(al){ai.html("");if(al.errors){$.each(al.errors,function(ap,ao){var an=$("<div>").html(ao).addClass("text-error");ai.append(an)});return}if(!aj&&al.values.length<$("tbody tr",b).length){$("#sequenceTooSmallMsg",ag).show();return}var ak=$("#"+ae.val()).index();var am=$("table tbody tr td:nth-child("+(ak+1)+")",v);$.each(al.values,function(an,ao){if(an>am.length){return}$(":input:first",am[an]).val(ao)});Z.toggleClass("active");ab.slideToggle();D()})};af.click(function(aj){aj.preventDefault();aj.stopPropagation();ah(false)});$(".btn-continue-sequence-fill",ag).click(function(aj){aj.preventDefault();aj.stopPropagation();ah(true)})};ad();ac()};var n=function(){var Z=[];$("table .fieldset-labels th",v).each(function(){Z.push($(this).attr("id"))});M=Z;AS.prefixed_cookie(f,JSON.stringify(M))};var t=function(){if(M===null){n()}else{var aa=$("tr.fieldset-labels",X);var ab=$("tr.sections",X);var Z=$("colgroup",X);ab.html("");$.each(M,function(ad,ag){var af=$("#"+ag,aa);var ac=af.index();var ae=$($("col",Z).get(ac));if(!i(ag)&&ad>0){E(ac)}if(ad!==ac){af.insertBefore($("th",aa).get(ad));ae.insertBefore($("col",Z).get(ad));$("tbody tr",X).each(function(ai,aj){$($("td",aj).get(ac)).insertBefore($("td",aj).get(ad))})}if(ad===0){ab.append($("<th>").data("id","empty").attr("colspan","1"))}else{if($("th",ab).last().data("id")===af.data("section")){var ah=$("th",ab).last();ah.attr("colspan",parseInt(ah.attr("colspan"))+1)}else{ab.append($("<th>").data("id",af.data("section")).addClass("section-"+af.data("section")).attr("colspan","1").text(c[af.data("section")]))}}});W()}};var k=null;var A=function(){q();B(function(){o();m()})};var B=function(Z){var aa=v.data("child-type");$.ajax({url:v.data("list-templates-uri"),type:"GET",dataType:"json",success:function(ab){k=_.filter(ab,function(ac){return ac.record_type===aa});Z()},error:function(ad,ab,ac){console.log(ac)}})};var q=function(){var Z=$("#saveTemplateForm",b);var aa=$("button.save-template",b);var ac=$("#templateName",Z);var ab=$(".btn-primary",Z);aa.off("click").on("click",function(ad){ad.preventDefault();ad.stopPropagation();if(!$(this).hasClass("active")){$(".active",$(this).closest(".btn-group")).trigger("click")}aa.toggleClass("active");Z.slideToggle()});ac.on("change keyup paste",function(){if($(this).val().length>0){ab.removeAttr("disabled").removeClass("disabled")}else{ab.prop("disabled",true)}});ab.click(function(ae){ae.preventDefault();ae.stopPropagation();var ad={record_type:v.data("child-type"),name:ac.val(),order:[],visible:[],defaults:{},};var af=$("table tbody tr:first",v);$("table .fieldset-labels th",v).each(function(){var ag=$(this).attr("id");ad.order.push(ag);if($(this).is(":visible")){ad.visible.push(ag)}var ah=$("td[data-col='"+ag+"']",af);if($("input",ah).length){ad.defaults[ag]=$("input",ah).val()}else{if($("select",ah).length){ad.defaults[ag]=$("select",ah).val()}}});ad.defaults=_.pick(ad.defaults,function(ag){return ag.length>0});$.ajax({url:v.data("save-template-uri"),type:"POST",data:{template:ad},dataType:"json",success:function(ag){B(function(){o();m()});aa.toggleClass("active");Z.slideToggle()},error:function(ai,ag,ah){console.log(ah)}})})};var o=function(){var ad=$("#manageTemplatesForm",b);var ab=$("button.manage-templates",b);var Z=$("table tbody",ad);var ac=[];ab.off("click").on("click",function(ae){ae.preventDefault();ae.stopPropagation();ac=[];if(!$(this).hasClass("active")){$(".active",$(this).closest(".btn-group")).trigger("click")}Z.empty();aa();ab.toggleClass("active");ad.slideToggle()});$("button.btn-cancel",ad).off("click").on("click",function(ae){ae.preventDefault();ae.stopPropagation();ab.toggleClass("active");ad.slideToggle(function(){ac=[]})});$("button.btn-primary",ad).off("click").on("click",function(ae){ae.preventDefault();ae.stopPropagation();$.ajax({url:v.data("list-templates-uri")+"/batch_delete",type:"POST",dataType:"json",data:{ids:ac},success:function(af){k=af;m()},error:function(ah,af,ag){console.log(ag)}});ab.toggleClass("active");ad.slideToggle()});var aa=function(){_.each(k,function(ae){Z.append(AS.renderTemplate("rde_template_table_row",{item:ae}))});$("button",Z).click(function(ae){ae.preventDefault();ae.stopPropagation();var af=$(this).closest("tr").data("templateId");if(_.indexOf(ac,af)>-1){_.remove(ac,af);$(this).text("Remove")}else{ac.push(af);$(this).text("Keep")}})};$.ajax({url:v.data("list-templates-uri"),type:"GET",dataType:"json",success:function(ae){k=ae}})};var S=function(Z){M=Z.order;x=Z.visible;I=Z.defaults;t();var aa=$("tbody tr:first",v);_.each($("td",aa),function(ae){var ad=$(ae);var ac=ad.data("col");var ab=$(":input:first",ad);if(I[ac]&&(ab.data("value-from-template")||ab.val().length<1)){ab.val(I[ac]);ab.data("value-from-template",true)}})};var m=function(){var aa=$("#rde_select_template");aa.change(function(){var ab=$("option:selected",aa).val();$.ajax({url:v.data("template-base-uri")+"/"+ab,type:"GET",dataType:"json",success:function(ac){S(ac);aa.attr("data-style","btn-success");aa.selectpicker("refresh")}})});var Z=function(){aa.empty();aa.append($("<option>",{disabled:"disabled",selected:"selected"}).text(aa.data("prompt-text")));_.each(k,function(ab){aa.append($("<option>",{value:ab.id}).text(ab.name))});aa.selectpicker("refresh")};Z()};var F=function(){var ac=$("#columnReorderForm",b);var Z=$("button.reorder-columns",b);var aa=$("#columnOrder",ac);var ad=$(".btn-primary",ac);Z.off("click").on("click",function(af){af.preventDefault();af.stopPropagation();if(!$(this).hasClass("active")){$(".active",$(this).closest(".btn-group")).trigger("click")}Z.toggleClass("active");ac.slideToggle()});K(aa);aa.attr("size",$("option",aa).length/2);var ae=function(ag){var af=$("option:selected",aa);if(af.length){if(ag==="up"){af.first().prev().before(af)}else{af.last().next().after(af)}}ad.removeAttr("disabled").removeClass("disabled")};var ab=function(){Z.toggleClass("active");ac.slideToggle(function(){ad.addClass("disabled").attr("disabled","disabled");aa.html("");K(aa)})};$("#columnOrderUp",ac).bind("click",function(){ae("up")});$("#columnOrderDown",ac).bind("click",function(){ae("down")});$(".btn-cancel",ac).click(function(af){af.preventDefault();af.stopPropagation();ab()});ad.click(function(af){af.preventDefault();af.stopPropagation();M=["colStatus"];$("option",aa).each(function(){M.push($(this).val())});M.push("colActions");t();ab();n()})};var K=function(aa,ab,Z){Z=Z||function(){return true};ab=ab||function(){return false};$(".fieldset-labels th",v).each(function(){var ac=$(this);if(ac.hasClass("fieldset-label")&&Z(ac)){var ae=$("<option>");var ad="";ad+=$(".section-"+ac.data("section")+":first").text();ad+=" - ";ad+=ac.text();ae.val(ac.attr("id")).text(ad);if(ab(ac)){ae.attr("selected","selected")}aa.append(ae)}})};var g=function(){var Z=$("#rde_hidden_columns");K(Z,function(aa){return i(aa.attr("id"))});Z.multiselect({buttonClass:"btn btn-small btn-default",buttonWidth:"auto",maxHeight:300,buttonContainer:'<div class="btn-group" />',buttonText:function(aa){if(aa.length==0){return Z.data("i18n-none")+' <b class="caret"></b>'}else{if(aa.length>5){return Z.data("i18n-prefix")+" "+aa.length+" "+Z.data("i18n-suffix")+' <b class="caret"></b>'}else{var ab=Z.data("i18n-prefix")+" ";aa.each(function(){ab+=$(this).text()+", "});return ab.substr(0,ab.length-2)+' <b class="caret"></b>'}}},onChange:function(af,ae){var ad=U();var ac=af.val();var aa=$("#"+ac).index();if(ae){X.showColumns(aa+1);var ab=$($("table colgroup col").get(aa));ab.show();X.width(X.width()+ad[aa])}else{N(aa)}x=Z.val();AS.prefixed_cookie(C,JSON.stringify(x))}});W()};var U=function(){var Z={};$("table colgroup col",v).each(function(ab,aa){if($(aa).prop("width")===null||$(aa).prop("width")===""){$(aa).prop("width",$(aa).data("default-width"))}else{if($(aa).css("width")){var ac=parseInt($(aa).css("width"));$(aa).prop("width",ac)}}Z[$(aa).data("id")]=parseInt($(aa).prop("width"))});r=Z;AS.prefixed_cookie(Q,JSON.stringify(r));return r};var G=function(ab){var aa=O(ab);var Z=$("#"+ab).index();$($("table colgroup col",v).get(Z)).width(aa);return aa};var O=function(Z){if(r){return r[Z]}else{U();return O(Z)}};var u=function(){var Z=0;X.css("tableLayout","auto");$("colgroup col",X).each(function(ab,ac){var aa=O($(ac).data("id"));$(ac).prop("width",aa);Z+=aa});X.width(Z);X.css("tableLayout","fixed")};var L=function(){if(s){$("th.sticky",v).removeClass("sticky");$.each(s,function(){$("#"+this).addClass("sticky")})}};var i=function(Z){if(x){return $.inArray(Z,x)>=0}else{return true}};var W=function(){if(x){var Z=0;$.each($(".fieldset-labels th",v),function(){var ab=$(this).attr("id");var aa=$(this).index();if($(this).hasClass("fieldset-label")){if(i(ab)){Z+=G(ab)}else{N(aa)}}else{Z+=G(ab)}});X.width(Z)}else{u()}};var N=function(Z){X.hideColumns(Z+1);var aa=$($("table colgroup col").get(Z));X.width(X.width()-aa.width());aa.hide()};var E=function(Z){X.showColumns(Z+1);var aa=$($("table colgroup col").get(Z));X.width(X.width()+aa.width());aa.show()};var l=function(aa,ac){var ab=$("tbody tr")[ac];var Z=$("td[data-col='"+aa+"']",ab);Z.removeClass("disabled");$("input",Z).removeAttr("disabled")};var R=function(aa,ac){var ab=$("tbody tr")[ac];var Z=$("td[data-col='"+aa+"']",ab);Z.addClass("disabled");$("input",Z).attr("disabled","disabled")};var p=function(aa){var Z=aa.prev();if(Z.hasClass("disabled")){return p(Z)}else{return Z}};var e=function(aa){var Z=aa.next();if(Z.hasClass("disabled")){return e(Z)}else{return Z}};var D=function(){j($("tbody tr",X))};var j=function(Z){var aa=Z.serializeObject();aa.validate_only="true";$(".error",Z).removeClass("error");$.ajax({url:v.data("validate-row-uri"),type:"POST",data:aa,dataType:"json",success:function(ab){z(Z,ab)}})};$(b).on("click",".modal-footer .btn-primary",function(){$(this).attr("disabled","disabled");v.submit()});$(b).on("click","#validateButton",function(Z){Z.preventDefault();Z.stopPropagation();J=true;$(this).attr("disabled","disabled");v.append("<input type='hidden' name='validate_only' value='true'>");v.submit()});$(".add-rows-form input",b).click(function(Z){Z.preventDefault();Z.stopPropagation()});$(".add-rows-form button",b).click(function(ab){var ac=[];try{var aa=parseInt($("input",$(this).closest(".add-rows-form")).val(),10);for(var Z=1;Z<=aa;Z++){ac.push(P(ab))}}catch(ad){}j($(ac))});b.on("click","button.toggle-inline-errors",function(Z){Z.preventDefault();Z.stopPropagation();$(this).toggleClass("active");X.toggleClass("show-inline-errors")});b.on("keyup","button",function(Z){if(Z.keyCode===13){$(this).trigger("click")}});$(document).triggerHandler("loadedrecordform.aspace",[v]);T();$(window).trigger("resize");setTimeout(function(){D()})});$("select.selectpicker",b).selectpicker()};$(document).bind("rdeload.aspace",function(c,a,b){$.ajax({url:APP_PATH+a.attr("rel")+"s/"+a.data("id")+"/rde",success:function(d){$(".rde-wrapper",b).replaceWith("<div class='modal-body'></div>");$(".modal-body",b).replaceWith(d);$("form","#rapidDataEntryModal").init_rapid_data_entry_form(b,a)}})});$(document).bind("rdeshow.aspace",function(c,a,d){var b=AS.openCustomModal("rapidDataEntryModal",d.text(),AS.renderTemplate("modal_content_loading_template"),"full",{keyboard:false},d);$(document).triggerHandler("rdeload.aspace",[a,b])})});$(function(){var a=function(){$(".transfer-form .btn-cancel").on("click",function(){$(".transfer-action").trigger("click")});$(".transfer-action").on("click",function(b){b.preventDefault();b.stopImmediatePropagation();if($(this).attr("disabled")){return}if($(".transfer-form")[0].style.display==="block"){$(".transfer-form").css("display","")}else{$(".transfer-form").css("display","block")}});$(".transfer-form").on("click",function(b){b.stopPropagation()});$(".transfer-form .linker-wrapper .dropdown-toggle").on("click",function(b){b.stopPropagation();$(this).parent().toggleClass("open")});$(".transfer-form .transfer-button").on("click",function(c){var b=$(".transfer-form").serializeObject();if(!b["transfer[ref]"]){$(".missing-ref-message",".transfer-form").show();c.preventDefault();c.stopImmediatePropagation();return false}else{$(".missing-ref-message",".transfer-form").hide();$(this).data("form-data",{ref:b["transfer[ref]"]})}})};if($(".transfer-form").length>0){a()}else{$(document).bind("loadedrecordform.aspace",a)}});$(function(){$(document).on("loadedrecordform.aspace",function(a){$(".record-toolbar").on("change click keyup",".dropdown-submenu input",function(b){b.stopPropagation()});$(".record-toolbar").on("click","a.download-ead-action",function(c){var b=AS.quickTemplate(decodeURIComponent($("#download-ead-dropdown").data("download-ead-url")),{testme:true,include_unpublished:$("input#include-unpublished").is(":checked"),include_daos:$("input#include-daos").is(":checked"),numbered_cs:$("input#numbered-cs").is(":checked"),print_pdf:$("input#print-pdf").is(":checked")});location.href=b})})});$(function(){var a=function(d){var b=$(d);var c="#location";if(b.selector==="#new_location_batch"){c="#location_batch"}$temporary=$(c+"_temporary_",b);$temporaryQuestion=$(c+"_temporary_question_",b);if($temporary.val()!=""){$temporaryQuestion.prop("checked",true)}$temporaryQuestion.on("change",function(){$temporary.val("");$temporary.prop("disabled",function(f,e){return !e})})};$(document).ready(function(){if($("#new_location").length>0){a($("#new_location"))}if($("#new_location_batch").length>0){a($("#new_location_batch"))}$(document).bind("loadedrecordform.aspace",function(b,c){a(("#new_location",c))});$(document).bind("subrecordcreated.aspace",function(d,b,c){if(b==="container_location"){a($(c));$("[id$=__status_]",$(c)).bind("change",function(){$this=$(this);$endDate=$("[id$=__end_date_]",c);if($this.val()=="previous"&&$endDate.val().length==0){$endDate.val($endDate.data("date"))}})}})});$(document).ready(function(){$(".linker:not(.initialised)").linker()})});var calculate_total_processing_hours=function(c){var b=$(c);var e=parseFloat($("#resource_collection_management__processing_hours_per_foot_estimate_",b).val(),10);var a=parseFloat($("#resource_collection_management__processing_total_extent_",b).val(),10);if($.isNumeric(e)&&$.isNumeric(a)){var d=(e*a).toFixed(2);$("#resource_collection_management__processing_hours_total_",b).val(d)}};$(document).bind("subrecordcreated.aspace",function(c,a,b){$("#resource_collection_management__processing_hours_per_foot_estimate_",$(b)).bind("change",function(){calculate_total_processing_hours(b)});$("#resource_collection_management__processing_total_extent_",$(b)).bind("change",function(){calculate_total_processing_hours(b)})});$(function(){function a(){}a.prototype.init_form=function(){$(".create-extent-btn").on("click",function(e){$("[id$=_extents_] .subrecord-form-heading .btn").click();var c=$("[id$=_extents_]").find(".subrecord-form-fields").last();c.find("[id$=__portion_]").val($("#extent_portion_").val());c.find("[id$=__number_]").val($("#extent_number_").val());var d=c.find("[id$=__extent_type_]");if(d.data("combobox")){d.data("combobox").$element.val($("#extent_extent_type_").val());d.data("combobox").$target.val($("#extent_extent_type_").val())}else{d.val($("#extent_extent_type_").val())}c.find("[id$=__container_summary_]").val($("#extent_container_summary_").val());c.find("[id$=__physical_details_]").val($("#extent_physical_details_").val());c.find("[id$=__dimensions_]").val($("#extent_dimensions_").val());$modal.modal("hide")})};var b=function(){$(".extent-calculator-btn").on("click",function(d){var c=AS.renderTemplate("extent_calculator_show_calculation_template");$modal=AS.openCustomModal("extentCalculationModal","Extent Calculation",c,"large");$.ajax({url:"/extent_calculator",data:{record_uri:$("#extent_calculator_show_calculation_template").attr("record_uri"),referrer:document.location.href},type:"get",success:function(e){$("#show_calculation_results").html(e);var f=new a();f.init_form()},error:function(f,h,g){var e=AS.renderTemplate("template_extent_calculator_error_message",{message:f.responseText});$("#show_calculation_results").html(e)}})})};$(document).bind("loadedrecordform.aspace",function(c,d){b()})});$(function(){$.fn.init_resource_form=function(){$(this).each(function(){var d=$(this);if(d.hasClass("initialised")){return}var b=$("#resource_level_",d);var c=$("#resource_other_level_",d);var a=function(e){if(b.val()==="otherlevel"){c.removeAttr("disabled");if(e===true){c.closest(".form-group").show()}else{c.closest(".form-group").slideDown()}}else{c.attr("disabled","disabled");if(e===true){c.closest(".form-group").hide()}else{c.closest(".form-group").slideUp()}}};a(true);b.change(a)})};$(document).bind("loadedrecordform.aspace",function(a,b){$("#resource_form:not(.initialised)",b).init_resource_form()});$("#resource_form:not(.initialised)").init_resource_form()});$(function(){$.fn.init_interrelated_accessions_form=function(){$(this).each(function(){var c=$(this);if(c.hasClass("initialised")){return}c.addClass("initialised");var b=c.closest(".subrecord-form-list");var a=c.closest("[data-index]").data("index");c.find("select.related-accession-type").change(function(){var d="template_"+$(this).val();var f=$(AS.renderTemplate(d,{path:AS.quickTemplate(b.data("name-path"),{index:a}),id_path:AS.quickTemplate(b.data("id-path"),{index:a}),index:"${index}"}));var e=c.find(".subsubform");e.empty().append(f);$(document).triggerHandler("subrecordcreated.aspace",["interrelated_accession",e])})})};$(document).ready(function(){$(document).bind("subrecordcreated.aspace",function(c,a,b){$(".interrelated-accessions-form:not(.initialised)").init_interrelated_accessions_form()});$(".interrelated-accessions-form:not(.initialised)").init_interrelated_accessions_form()})});$(function(){$(document).triggerHandler("loadedrecordform.aspace",[$("#form_accession")])});